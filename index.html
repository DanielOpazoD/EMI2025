<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resumen – Endocrinología</title>
  <style>
    /* ===== Variables de tema ===== */
    :root {
      --theme-primary: #0d6efd;
      --theme-primary-dark: #0b5ed7;
      --theme-primary-light: #6ea8fe;
      --zoom-level: 1;
    }

    body.theme-blue {
      --theme-primary: #0d6efd;
      --theme-primary-dark: #0b5ed7;
      --theme-primary-light: #6ea8fe;
    }

    body.theme-green {
      --theme-primary: #198754;
      --theme-primary-dark: #157347;
      --theme-primary-light: #75b798;
    }

    body.theme-purple {
      --theme-primary: #6f42c1;
      --theme-primary-dark: #59359a;
      --theme-primary-light: #9d7cd4;
    }

    body.theme-orange {
      --theme-primary: #fd7e14;
      --theme-primary-dark: #dc6502;
      --theme-primary-light: #fda861;
    }

    /* ===== Base ===== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f8f9fa;
      color: #212529;
      margin: 0;
      padding: 0;
      line-height: 1.3;
      font-size: 10.5px;
      transition: all 0.3s ease;
    }

    /* ===== Modo lectura ===== */
    body.reading-mode {
      background: #fafafa;
    }

    body.reading-mode .topbar,
    body.reading-mode .edit-toolbar {
      display: none !important;
    }

    body.reading-mode .page {
      margin-top: 20px;
      box-shadow: 0 0 5px rgba(0, 0, 0, .05);
      max-width: 800px;
    }

    .reading-mode-exit {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    body.reading-mode .reading-mode-exit {
      display: flex;
    }

    .reading-mode-exit:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.1);
    }

    /* ===== Topbar ===== */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 4000;
      height: 36px;
      background: #000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, .25);
      font-size: calc(11px * var(--zoom-level));
    }

    .topbar-left {
      position: absolute;
      left: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar-center {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 90%;
    }

    .topbar-topic {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: #222;
      color: #ddd;
      max-width: 60vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .topbar-btn {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: opacity .15s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .topbar-btn:hover {
      opacity: .9
    }

    .topbar-btn.active {
      background: var(--theme-primary);
      border-color: var(--theme-primary);
    }

    .topbar-btn-label {
      font-size: 9px;
      display: none;
    }

    @media (min-width: 768px) {
      .topbar-btn-label {
        display: inline;
      }
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .zoom-value {
      min-width: 45px;
      text-align: center;
      font-size: 10px;
      background: #222;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* ===== Barra de herramientas mejorada ===== */
    .edit-toolbar {
      position: fixed;
      top: calc(38px / var(--zoom-level));
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 6px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
      display: none;
      z-index: 3500;
      justify-content: center;
      font-size: calc(10px * var(--zoom-level));
    }

    .edit-toolbar.show {
      display: flex;
    }

    .toolbar-content {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      align-items: center;
      justify-content: center;
      max-width: 1400px;
    }

    .edit-toolbar button, .edit-toolbar select {
      padding: 3px 6px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 10px;
      line-height: 1.2;
    }

    .edit-toolbar button:hover {
      background: #f8f9fa;
    }

    .edit-toolbar button.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .edit-toolbar select {
      min-width: 70px;
      font-size: 10px;
    }

    .toolbar-separator {
      width: 1px;
      height: 20px;
      background: #dee2e6;
      margin: 0 2px;
    }

    .toolbar-group {
      display: flex;
      gap: 3px;
      align-items: center;
      padding: 2px;
      background: #f8f9fa;
      border-radius: 3px;
      position: relative;
    }

    .toolbar-label {
      font-size: 9px;
      color: #6c757d;
      font-weight: 600;
      margin-right: 3px;
    }

    /* Paleta de colores */
    .color-palette {
      display: grid;
      grid-template-columns: repeat(8, 20px);
      gap: 3px;
      padding: 6px;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      position: fixed;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
    }

    .color-palette.show {
      display: grid;
    }

    .color-swatch {
      width: 20px;
      height: 20px;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .color-swatch:hover {
      transform: scale(1.15);
      border-color: #495057;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* ===== Panel de herramientas de imagen ===== */
    .image-toolbar {
      position: absolute;
      background: #fff;
      border: 2px solid var(--theme-primary);
      border-radius: 6px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 3600;
      min-width: 220px;
    }

    .image-toolbar.show {
      display: flex;
    }

    .image-toolbar-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .image-toolbar button {
      padding: 4px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.15s;
    }

    .image-toolbar button:hover {
      background: #f8f9fa;
    }

    .image-toolbar button.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .image-toolbar label {
      font-size: 9px;
      color: #6c757d;
      font-weight: 600;
      min-width: 40px;
    }

    .image-toolbar input[type="range"] {
      flex: 1;
      min-width: 120px;
    }

    .image-toolbar .size-display {
      font-size: 9px;
      color: #495057;
      min-width: 60px;
      text-align: right;
    }

    img.selected-image {
      outline: 2px solid var(--theme-primary);
      outline-offset: 2px;
      cursor: move;
    }

    img.float-left {
      float: left;
      margin: 0 10px 10px 0;
    }

    img.float-right {
      float: right;
      margin: 0 0 10px 10px;
    }

    img.center-block {
      display: block;
      margin: 10px auto;
      float: none;
    }

    img.inline-image {
      display: inline;
      vertical-align: middle;
      margin: 0 5px;
    }

    #loadHtmlInput {
      display: none;
    }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--theme-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
      line-height: 1;
    }

    .modal-body {
      margin-bottom: 15px;
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding-top: 10px;
      border-top: 1px solid #dee2e6;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-btn.primary {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .modal-btn.danger {
      background: #dc3545;
      color: #fff;
      border-color: #dc3545;
    }

    .modal-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    .modal-textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      min-height: 200px;
      resize: vertical;
      box-sizing: border-box;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid var(--theme-primary);
    }

    .stat-label {
      font-size: 11px;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #212529;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .template-card {
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-card:hover {
      border-color: var(--theme-primary);
      background: #f8f9fa;
    }

    .template-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: var(--theme-primary);
    }

    .template-preview {
      font-size: 10px;
      color: #6c757d;
      border: 1px dashed #dee2e6;
      padding: 6px;
      border-radius: 3px;
      min-height: 40px;
    }

    /* ===== Panel lateral ===== */
    .topic-panel {
      position: fixed;
      top: 36px;
      left: 0;
      width: 340px;
      max-width: 90vw;
      height: calc(100vh - 36px);
      background: #fff;
      border-right: 1px solid #e5e7eb;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .08);
      transform: translateX(-100%);
      transition: transform .2s ease;
      z-index: 4500;
      display: flex;
      flex-direction: column
    }

    .topic-panel.open {
      transform: translateX(0)
    }

    /* ===== Tabla de contenidos ===== */
    .toc-panel {
      position: fixed;
      top: 36px;
      right: 0;
      width: 300px;
      max-width: 90vw;
      height: calc(100vh - 36px);
      background: #fff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -4px 4px 10px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .2s ease;
      z-index: 4500;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .toc-panel.open {
      transform: translateX(0);
    }

    .toc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .toc-header strong {
      font-size: 13px;
      color: #212529;
    }

    .toc-list {
      list-style: none;
      padding: 10px;
      margin: 0;
    }

    .toc-item {
      padding: 4px 0;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 2px solid transparent;
      padding-left: 8px;
    }

    .toc-item:hover {
      background: #f8f9fa;
      border-left-color: var(--theme-primary);
    }

    .toc-item.h1 {
      font-size: 11px;
      font-weight: 600;
      color: var(--theme-primary);
      margin-top: 8px;
    }

    .toc-item.h2 {
      font-size: 10px;
      font-weight: 500;
      color: #495057;
      padding-left: 20px;
    }

    .toc-item.h3 {
      font-size: 9px;
      color: #6c757d;
      padding-left: 32px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
    }

    .panel-header strong {
      font-size: 13px;
      color: #212529;
    }

    .panel-header-actions {
      display: flex;
      gap: 4px;
    }

    .panel-header-btn {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 3px 6px;
      cursor: pointer;
      font-size: 10px;
      color: #495057;
    }

    .panel-header-btn:hover {
      background: #e9ecef;
    }

    .panel-header-btn.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .panel-actions {
      padding: 6px 10px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .panel-action-btn {
      flex: 1;
      min-width: 70px;
      padding: 4px 6px;
      border: 1px solid #dee2e6;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
    }

    .panel-action-btn:hover {
      background: #f8f9fa;
    }

    .sections-container {
      overflow-y: auto;
      flex: 1;
    }

    .section-item {
      border-bottom: 1px solid #f1f3f5;
    }

    .section-header {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      background: #f8f9fa;
      font-weight: 600;
      font-size: 11px;
      gap: 6px;
      border-bottom: 1px solid #e9ecef;
    }

    .section-toggle {
      font-size: 9px;
      transition: transform 0.2s;
      cursor: pointer;
      user-select: none;
      min-width: 12px;
    }

    .section-item.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-name {
      flex: 1;
      cursor: pointer;
    }

    .section-name:hover {
      color: var(--theme-primary);
    }

    .section-actions {
      display: flex;
      gap: 4px;
    }

    .section-action-btn {
      padding: 2px 5px;
      border: 1px solid #dee2e6;
      background: #fff;
      border-radius: 3px;
      cursor: pointer;
      font-size: 9px;
    }

    .section-action-btn:hover {
      background: #e9ecef;
    }

    .section-count {
      font-size: 9px;
      color: #6c757d;
      font-weight: normal;
    }

    .topic-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: none;
    }

    .section-item:not(.collapsed) .topic-list {
      display: block;
    }

    .topic-list li {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px 5px 30px;
      border-bottom: 1px dashed #f8f9fa;
      font-size: 10px;
    }

    .topic-list li:hover {
      background: #f8f9fa;
    }

    .topic-list li.active {
      background: #e7f3ff;
      border-left: 3px solid var(--theme-primary);
    }

    .topic-number {
      font-weight: 600;
      color: var(--theme-primary);
      min-width: 20px;
    }

    .topic-list .topic-action {
      font-size: 10px;
      border: 1px solid #d0d7de;
      background: #fff;
      border-radius: 3px;
      padding: 2px 5px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .topic-list .topic-action:hover {
      background: #f8f9fa;
    }

    .topic-list span.topic-title {
      white-space: nowrap;
      overflow: hidden;
      cursor: pointer;
      text-overflow: ellipsis;
      flex: 1;
    }

    .topic-context-menu {
      position: absolute;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 6000;
      padding: 4px 0;
    }

    .topic-context-menu.show {
      display: flex;
    }

    .topic-context-menu button {
      background: none;
      border: none;
      text-align: left;
      padding: 8px 14px;
      font-size: 11px;
      color: #212529;
      cursor: pointer;
      width: 100%;
    }

    .topic-context-menu button:hover {
      background: #f1f3f5;
    }

    .topic-context-menu button.danger {
      color: #dc3545;
    }

    .panel-backdrop {
      position: fixed;
      top: 36px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .15);
      backdrop-filter: saturate(120%) blur(1px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
      z-index: 4400;
    }

    .panel-backdrop.show {
      opacity: 1;
      pointer-events: auto
    }

    /* ===== Páginas con zoom CORREGIDO ===== */
    .page {
      width: 210mm;
      min-height: 297mm;
      padding: 12mm;
      margin: calc((56px + (20px * var(--zoom-level))) * var(--zoom-level)) auto calc((20px * var(--zoom-level)));
      box-sizing: border-box;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, .1);
      page-break-after: always;
      overflow-wrap: break-word;
      position: relative;
      transform: scale(var(--zoom-level));
      transform-origin: top center;
    }

    .page[contenteditable="true"] {
      outline: 2px solid #d1d5db;
      outline-offset: 4px;
    }

    /* ===== Icono mágico en el título ===== */
    h1 {
      font-size: 18px;
      color: var(--theme-primary);
      margin: 0 0 6px 0;
      padding-bottom: 3px;
      border-bottom: 3px solid var(--theme-primary);
      line-height: 1.2;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    h1 .topic-title-text {
      flex: 1;
      cursor: pointer;
    }

    .magic-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      font-size: 16px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 50%;
      transition: all 0.3s ease;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .magic-icon:hover {
      background: var(--theme-primary);
      transform: scale(1.15) rotate(15deg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    h2 {
      font-size: 13px;
      color: var(--theme-primary-dark);
      margin: 8px 0 3px 0;
      font-weight: 600;
      line-height: 1.2
    }

    h3 {
      font-size: 11px;
      color: var(--theme-primary);
      margin: 6px 0 2px 0;
      font-weight: 600;
      line-height: 1.2
    }

    h4 {
      font-size: 11px;
      color: var(--theme-primary-dark);
      margin: 6px 0 2px 0;
      font-weight: 600;
      line-height: 1.2
    }

    p {
      margin: 2px 0;
      text-align: justify
    }

    ul, ol {
      margin: 3px 0;
      padding-left: 18px
    }

    ul li, ol li {
      margin: 1px 0
    }

    strong {
      font-weight: 600;
      color: #343a40
    }

    .small-text {
      font-size: 9px;
      color: #6c757d
    }

    .highlight {
      background: #fff3cd;
      padding: 1px 3px;
      border-radius: 3px;
      font-weight: 600;
      color: #664d03
    }

    .box {
      background: transparent;
      border: 1px solid #dee2e6;
      border-left: 4px solid var(--theme-primary);
      padding: 6px 10px;
      margin: 6px 0;
      border-radius: 0 4px 4px 0
    }

    .pearl {
      border-left-color: #fd7e14
    }

    .pearl::before {
      content: "💡 ";
      font-weight: 700
    }

    .table-wrap {
      overflow-x: auto;
      max-width: 100%
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      font-size: 10px;
      margin: 6px 0;
      line-height: 1.25;
      table-layout: fixed
    }

    table th, table td {
      border: 1px solid #dee2e6;
      padding: 3px 5px;
      text-align: left;
      word-wrap: break-word
    }

    table th {
      background: #e9ecef;
      font-weight: 600
    }

    .columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 6px 0
    }

    /* ===== Visor Mágico ===== */
    .magic-view {
      position: fixed;
      top: 36px;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f8f9fa;
      display: none;
      flex-direction: column;
      z-index: 3000;
      color: #212529;
      overflow: auto
    }

    body.magic-open .magic-view {
      display: flex
    }

    .magic-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb
    }

    .magic-close {
      background: transparent;
      border: none;
      font-size: 22px;
      line-height: 1;
      color: #444;
      cursor: pointer
    }

    .magic-page {
      width: 210mm;
      min-height: 297mm;
      padding: 12mm;
      margin: calc(20px * var(--zoom-level)) auto;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, .1);
      box-sizing: border-box;
      overflow-wrap: break-word;
      transform: scale(var(--zoom-level));
      transform-origin: top center;
    }

    .magic-page[contenteditable="true"] {
      outline: 2px solid #d1d5db;
      outline-offset: 4px;
    }

    .magic-page * {
      max-width: 100%
    }

    .magic-title {
      font-size: 18px;
      color: var(--theme-primary);
      margin: 0 0 6px 0;
      padding-bottom: 3px;
      border-bottom: 2px solid var(--theme-primary);
      line-height: 1.2
    }

    .magic-section {
      margin: 10px 0
    }

    .magic-section h4 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: var(--theme-primary-dark);
    }

    .mini-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      font-size: 9.5px;
      line-height: 1.15;
      margin: 6px 0;
      background: #ffffff;
      color: #212529;
      table-layout: fixed
    }

    .mini-table th, .mini-table td {
      border: 1px solid #dee2e6;
      padding: 2px 4px;
      text-align: left;
      word-wrap: break-word
    }

    .mini-table th {
      background: #e9ecef;
      color: #212529;
      font-weight: 600
    }

    .tight-list {
      margin: 0;
      padding-left: 16px
    }

    .tight-list li {
      margin: 0
    }

    /* ===== Impresión SIN RESTRICCIONES ===== */
    @media print {
      body {
        background: #fff;
        margin: 0;
        padding: 0;
      }

      .topbar,
      .magic-view,
      .topic-panel,
      .toc-panel,
      .panel-backdrop,
      .edit-toolbar,
      .image-toolbar,
      .reading-mode-exit,
      .magic-icon {
        display: none !important;
      }

      .page, .magic-page {
        box-shadow: none;
        page-break-after: always;
        outline: none !important;
        transform: none !important;
        margin: 0 !important;
        width: 100%;
        min-height: auto;
      }

      @page {
        size: auto;
        margin: 10mm;
      }
    }
  </style>
</head>
<body class="theme-blue">
  <!-- build:topics {"especialidad":"Endocrinología","secciones":[{"id":"seccion-1","nombre":"Endocrinología","temas":[{"id":"sindrome-metabolico","titulo":"Síndrome Metabólico"},{"id":"diabetes-mellitus-2","titulo":"Diabetes Mellitus tipo II"}]}]} -->
  
  <div class="topbar">
    <div class="topbar-left">
      <button class="topbar-btn topbar-plus" title="Abrir panel de navegación"><span>☰</span> <span class="topbar-btn-label">Menú</span></button>
    </div>
    <div class="topbar-center">
      <span id="specialtyTitle" class="topbar-topic" title="Especialidad">Endocrinología</span>
      <div class="zoom-controls">
        <button class="topbar-btn" id="zoomOutBtn" title="Reducir zoom">-</button>
        <span class="zoom-value" id="zoomValue">100%</span>
        <button class="topbar-btn" id="zoomInBtn" title="Aumentar zoom">+</button>
      </div>
      <button class="topbar-btn" id="tocBtn" title="Tabla de contenidos"><span>📑</span> <span class="topbar-btn-label">Índice</span></button>
      <button class="topbar-btn" id="readingModeBtn" title="Modo lectura"><span>📖</span> <span class="topbar-btn-label">Lectura</span></button>
      <button class="topbar-btn" id="statsBtn" title="Estadísticas"><span>📊</span> <span class="topbar-btn-label">Stats</span></button>
      <button class="topbar-btn" id="loadHtmlBtn" title="Cargar archivo HTML"><span>📂</span> <span class="topbar-btn-label">Abrir</span></button>
      <button class="topbar-btn" id="editBtn" title="Modo edición"><span>✏️</span> <span class="topbar-btn-label">Editar</span></button>
      <button class="topbar-btn" id="saveHtmlBtn" style="display:none;" title="Guardar como HTML"><span>💾</span> <span class="topbar-btn-label">Guardar</span></button>
      <button class="topbar-btn" id="exportMarkdownBtn" title="Exportar a Markdown"><span>⬇️</span> <span class="topbar-btn-label">MD</span></button>
      <button class="topbar-btn" id="copyHtmlBtn" title="Copiar HTML completo"><span>📋</span> <span class="topbar-btn-label">Copiar</span></button>
      <button class="topbar-btn" id="printCurrentBtn" title="Imprimir documento"><span>🖨️</span> <span class="topbar-btn-label">Imprimir</span></button>
    </div>
  </div>

  <button class="reading-mode-exit" id="readingModeExit" title="Salir del modo lectura">✕</button>

  <input type="file" id="loadHtmlInput" accept=".html" multiple />

  <!-- Barra de herramientas -->
  <div class="edit-toolbar" id="editToolbar">
    <div class="toolbar-content">
      <div class="toolbar-group">
        <span class="toolbar-label">HISTORIAL</span>
        <button id="undoBtn" title="Deshacer (Ctrl+Z)">↶</button>
        <button id="redoBtn" title="Rehacer (Ctrl+Y)">↷</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">FORMATO</span>
        <select id="fontSizeSelect" title="Tamaño">
          <option value="">Tamaño</option>
          <option value="1">Muy pequeño</option>
          <option value="2">Pequeño</option>
          <option value="3">Normal</option>
          <option value="4">Mediano</option>
          <option value="5">Grande</option>
          <option value="6">Muy grande</option>
          <option value="7">Enorme</option>
        </select>
        <button id="boldBtn" title="Negrita (Ctrl+B)"><strong>B</strong></button>
        <button id="italicBtn" title="Cursiva (Ctrl+I)"><em>I</em></button>
        <button id="underlineBtn" title="Subrayado (Ctrl+U)"><u>U</u></button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">SANGRÍA</span>
        <button id="indentBtn" title="Aumentar">→</button>
        <button id="outdentBtn" title="Disminuir">←</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">DESTACAR</span>
        <button id="highlightBtn" title="Destacar">🖍️</button>
      </div>

      <div class="toolbar-group">
        <span class="toolbar-label">COLOR</span>
        <button id="textColorBtn" title="Color">A</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">INSERTAR</span>
        <button id="insertTableBtn" title="Tabla">📊</button>
        <button id="insertUlBtn" title="Lista">•</button>
        <button id="insertOlBtn" title="Numerada">1.</button>
        <button id="insertHtmlBtn" title="HTML personalizado">&lt;/&gt;</button>
        <button id="insertTemplateBtn" title="Plantillas">📝</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">AVANZADO</span>
        <button id="copyHtmlSelectionBtn" title="Copiar HTML">&lt;&gt;</button>
        <button id="findReplaceBtn" title="Buscar">🔍</button>
        <button id="removeFormatBtn" title="Limpiar">🧹</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">TEMA</span>
        <select id="themeSelect" title="Esquema">
          <option value="theme-blue">Azul</option>
          <option value="theme-green">Verde</option>
          <option value="theme-purple">Morado</option>
          <option value="theme-orange">Naranja</option>
        </select>
        <button id="duplicateTopicBtn" title="Duplicar">📑</button>
        <button id="exportTopicBtn" title="Exportar">💾</button>
      </div>
    </div>
  </div>

  <!-- Paletas de color -->
  <div class="color-palette" id="highlightPalette"></div>
  <div class="color-palette" id="textColorPalette"></div>

  <!-- Panel de herramientas de imagen -->
  <div class="image-toolbar" id="imageToolbar">
    <div class="image-toolbar-row">
      <button id="alignLeftBtn" title="Izquierda">⬅️</button>
      <button id="alignCenterBtn" title="Centro">⬌</button>
      <button id="alignRightBtn" title="Derecha">➡️</button>
      <button id="inlineBtn" title="En línea">↔️</button>
    </div>
    <div class="image-toolbar-row">
      <label>Ancho:</label>
      <input type="range" id="imageWidthSlider" min="50" max="800" step="10">
      <span class="size-display" id="widthDisplay">200px</span>
    </div>
    <div class="image-toolbar-row">
      <label>Alto:</label>
      <input type="range" id="imageHeightSlider" min="50" max="800" step="10">
      <span class="size-display" id="heightDisplay">auto</span>
    </div>
    <div class="image-toolbar-row">
      <button id="deleteImageBtn" title="Eliminar" style="color: #dc3545; flex: 1;">🗑️ Eliminar</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <!-- Panel de navegación -->
  <aside id="topic-panel" class="topic-panel">
    <div class="panel-header">
      <strong>Navegación</strong>
      <div class="panel-header-actions">
        <button class="panel-header-btn" id="editPanelBtn" title="Editar secciones">✏️</button>
        <button class="panel-header-btn" id="addSectionBtn" title="Nueva sección">➕</button>
        <button class="panel-close">&times;</button>
      </div>
    </div>
    <div class="panel-actions">
      <button class="panel-action-btn" id="toggleAllBtn" title="Expandir/Colapsar todo">⊞</button>
      <button class="panel-action-btn" id="sortAlphaBtn">🔤</button>
      <button class="panel-action-btn" id="sortNumBtn">🔢</button>
    </div>
    <div class="sections-container" id="sectionsContainer"></div>
  </aside>

  <!-- Tabla de contenidos -->
  <aside id="toc-panel" class="toc-panel">
    <div class="toc-header">
      <strong>Tabla de Contenidos</strong>
      <button class="panel-close" id="tocClose">&times;</button>
    </div>
    <ul class="toc-list" id="tocList"></ul>
  </aside>

  <div id="panel-backdrop" class="panel-backdrop"></div>
  
  <aside id="magic-view" class="magic-view">
  </aside>

  <!-- Contenido mágico -->
  <div class="magic-content-container" style="display:none">
    <div id="magic-sindrome-metabolico" class="magic-topic">
      <section class="magic-section"><h4>Contenido de ejemplo</h4>
        <p>Este es contenido mágico de ejemplo.</p>
      </section>
    </div>
  </div>

  <!-- Páginas -->
  <section class="page" data-topic-id="sindrome-metabolico" data-section-id="seccion-1">
    <h1>
      <span>Síndrome Metabólico</span>
      <span class="magic-icon" title="Ver contenido mágico">✨</span>
    </h1>
    <h2>Definición</h2>
    <p>El síndrome metabólico (SM) es un conjunto de alteraciones metabólicas interrelacionadas.</p>
  </section>

  <script>
    (function() {
      let isEditMode = false;
      let isPanelEditMode = false;
      let isReadingMode = false;
      let pages = [...document.querySelectorAll('.page')];
      let globalTopicCounter = 1;
      let selectedImage = null;
      let currentZoom = 1;
      let allSectionsExpanded = true;
      let savedSelection = null;
      
      let sections = [
        {
          id: 'seccion-1',
          nombre: 'Endocrinología',
          collapsed: false,
          temas: []
        }
      ];
      
      const panel = document.getElementById('topic-panel');
      const tocPanel = document.getElementById('toc-panel');
      const sectionsContainer = document.getElementById('sectionsContainer');
      const plusBtn = document.querySelector('.topbar-plus');
      const panelClose = document.querySelectorAll('.panel-close');
      const tocClose = document.getElementById('tocClose');
      const panelBackdrop = document.getElementById('panel-backdrop');
      const magic = document.getElementById('magic-view');
      const specialtySpan = document.getElementById('specialtyTitle');
      const modalOverlay = document.getElementById('modalOverlay');
      const modalContent = document.getElementById('modalContent');
      
      const editBtn = document.getElementById('editBtn');
      const saveHtmlBtn = document.getElementById('saveHtmlBtn');
      const loadHtmlBtn = document.getElementById('loadHtmlBtn');
      const loadHtmlInput = document.getElementById('loadHtmlInput');
      const editToolbar = document.getElementById('editToolbar');
      const statsBtn = document.getElementById('statsBtn');
      const editPanelBtn = document.getElementById('editPanelBtn');
      const tocBtn = document.getElementById('tocBtn');
      const readingModeBtn = document.getElementById('readingModeBtn');
      const readingModeExit = document.getElementById('readingModeExit');
      const exportMarkdownBtn = document.getElementById('exportMarkdownBtn');
      const imageToolbar = document.getElementById('imageToolbar');
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const zoomValue = document.getElementById('zoomValue');
      const highlightPalette = document.getElementById('highlightPalette');
      const textColorPalette = document.getElementById('textColorPalette');

      const pastelColors = [
        '#FFB6C1', '#FFD1DC', '#FFC8DD', '#E7C6FF', '#C8B6FF', '#B4D4FF', '#AEC6CF', '#B2DFDB',
        '#C5E1A5', '#FFF9C4', '#FFE082', '#FFCCBC', '#D7CCC8', '#F5F5F5', '#CFD8DC', '#E1BEE7'
      ];

      const topicMenu = document.createElement('div');
      topicMenu.id = 'topicContextMenu';
      topicMenu.className = 'topic-context-menu';
      topicMenu.innerHTML = `
        <button data-action="rename">Cambiar título</button>
        <button data-action="move">Mover tema</button>
        <button data-action="duplicate">Duplicar tema</button>
        <button data-action="delete" class="danger">Eliminar tema</button>
      `;
      document.body.appendChild(topicMenu);

      let topicMenuContext = null;
      let topicMenuJustOpened = false;

      function hideTopicMenu() {
        topicMenu.classList.remove('show');
        topicMenuContext = null;
        topicMenuJustOpened = false;
      }

      function getTopicTitle(page) {
        if (!page) return '';
        const h1 = page.querySelector('h1');
        const titleSpan = h1?.querySelector('span:first-child');
        return (titleSpan?.textContent || h1?.textContent || '').trim();
      }

      function showTopicMenu(event, tema) {
        if (!tema || !tema.page) return;
        hideTopicMenu();

        const page = tema.page;
        const title = (tema.titulo || getTopicTitle(page) || 'Tema').trim();
        topicMenuContext = { page, titulo: title };

        const pageX = event.pageX || (event.clientX + window.scrollX);
        const pageY = event.pageY || (event.clientY + window.scrollY);

        topicMenu.style.left = pageX + 'px';
        topicMenu.style.top = pageY + 'px';
        topicMenu.classList.add('show');

        const rect = topicMenu.getBoundingClientRect();
        let newLeft = rect.left;
        let newTop = rect.top;

        if (rect.right > window.innerWidth) {
          newLeft = window.innerWidth - rect.width - 12;
        }
        if (rect.bottom > window.innerHeight) {
          newTop = window.innerHeight - rect.height - 12;
        }

        newLeft = Math.max(8, newLeft);
        newTop = Math.max(8, newTop);

        topicMenu.style.left = window.scrollX + newLeft + 'px';
        topicMenu.style.top = window.scrollY + newTop + 'px';

        topicMenuJustOpened = true;
        setTimeout(() => {
          topicMenuJustOpened = false;
        }, 0);
      }

      function renameTopicPage(page) {
        if (!page) return false;
        const h1 = page.querySelector('h1');
        const titleSpan = h1?.querySelector('span:first-child');
        const currentTitle = (titleSpan?.textContent || h1?.textContent || 'Tema').trim();
        const newTitle = prompt('Nuevo título para el tema:', currentTitle);
        if (!newTitle || !newTitle.trim()) return false;
        const cleanTitle = newTitle.trim();
        if (titleSpan) {
          titleSpan.textContent = cleanTitle;
        } else if (h1) {
          h1.textContent = cleanTitle;
        }
        page.dataset.topicTitle = cleanTitle;
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        setupMagicIcons();
        return true;
      }

      function moveTopicPage(page) {
        if (!page) return false;
        if (!sections.length) {
          initializeSections();
        }
        if (sections.length <= 1) {
          alert('No hay otras secciones disponibles para mover este tema.');
          return false;
        }

        const currentSection = sections.find(section => section.id === page.dataset.sectionId);
        const options = sections.map((section, idx) => `${idx + 1}. ${section.nombre}${section === currentSection ? ' (actual)' : ''}`).join('\n');
        const choice = prompt(`Mover tema a sección:\n${options}\nEscribe el número o nombre de la sección destino:`, currentSection?.nombre || '');
        if (!choice || !choice.trim()) return false;

        const trimmed = choice.trim().toLowerCase();
        let targetSection = sections.find((section, idx) => String(idx + 1) === trimmed);
        if (!targetSection) {
          targetSection = sections.find(section => section.nombre.toLowerCase() === trimmed);
        }

        if (!targetSection) {
          alert('No se encontró la sección indicada.');
          return false;
        }

        page.dataset.sectionId = targetSection.id;
        page.dataset.sectionName = targetSection.nombre;
        initializeSections();
        buildSectionsPanel();
        return true;
      }

      function deleteTopicPage(page) {
        if (!page) return false;
        const title = getTopicTitle(page) || 'este tema';
        if (!confirm(`¿Eliminar "${title}"?`)) {
          return false;
        }
        page.remove();
        pages = pages.filter(p => p !== page);
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        return true;
      }

      function duplicateTopicPage(page) {
        if (!page) return null;
        const clone = page.cloneNode(true);
        const titleSpan = clone.querySelector('h1 span:first-child');
        if (titleSpan) {
          const currentTitle = titleSpan.textContent.trim();
          titleSpan.textContent = currentTitle ? `${currentTitle} (Copia)` : 'Tema (Copia)';
        }
        const newId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
        clone.dataset.topicId = newId;
        clone.contentEditable = isEditMode ? 'true' : 'false';
        page.parentNode.insertBefore(clone, page.nextSibling);
        pages = [...document.querySelectorAll('.page')];
        setupMagicIcons();
        io.observe(clone);
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        clone.scrollIntoView({ behavior: 'smooth', block: 'start' });
        return clone;
      }

      topicMenu.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button || !topicMenuContext) return;
        event.preventDefault();
        event.stopPropagation();

        const { page } = topicMenuContext;
        if (!page) {
          hideTopicMenu();
          return;
        }

        switch (button.dataset.action) {
          case 'rename':
            renameTopicPage(page);
            break;
          case 'move':
            moveTopicPage(page);
            break;
          case 'duplicate':
            duplicateTopicPage(page);
            break;
          case 'delete':
            deleteTopicPage(page);
            break;
        }

        hideTopicMenu();
      });

      document.addEventListener('click', (event) => {
        if (topicMenuJustOpened) return;
        if (!topicMenu.contains(event.target)) {
          hideTopicMenu();
        }
      });

      document.addEventListener('scroll', hideTopicMenu, true);
      window.addEventListener('resize', hideTopicMenu);
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          hideTopicMenu();
        }
      });

      /* === ZOOM === */
      function updateZoom(delta) {
        currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
        document.documentElement.style.setProperty('--zoom-level', currentZoom);
        zoomValue.textContent = Math.round(currentZoom * 100) + '%';
      }

      zoomInBtn?.addEventListener('click', () => updateZoom(0.1));
      zoomOutBtn?.addEventListener('click', () => updateZoom(-0.1));

      /* === UTILIDADES === */
      function saveCurrentSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          savedSelection = selection.getRangeAt(0);
          return true;
        }
        return false;
      }

      function restoreSelection() {
        if (savedSelection) {
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(savedSelection);
          return true;
        }
        return false;
      }

      function sanitizeCitations(el) {
        if (!el) return;
        const patterns = [
          /\[(?:cite(?:_start|_end)?|refs?|reference)\b[^\]]*\]/gi,
          /\((?:\s*\[?(?:cite|ref)[^\)]*\)?)+\)/gi
        ];
        let html = el.innerHTML;
        patterns.forEach(re => {
          html = html.replace(re, '');
        });
        el.innerHTML = html;
      }

      function purgeUnwantedNotes(root) {
        if (!root) return;
        root.querySelectorAll('.box, p').forEach(node => {
          const t = node.textContent || '';
          if (/^\s*nota:\s*/i.test(t)) {
            node.textContent = t.replace(/^\s*nota:\s*/i, '');
          }
        });
        const kill = /basarse en guías chilenas e internacionales|manejo inicial es universal/i;
        root.querySelectorAll('.box,p,li').forEach(node => {
          if (kill.test(node.textContent || '')) {
            node.remove();
          }
        });
      }

      function normalizePearls(root) {
        if (!root) return;
        root.querySelectorAll('.box').forEach(node => {
          const t = (node.textContent || '').toLowerCase();
          if (/\bperla\b/.test(t)) {
            node.classList.add('pearl');
          }
        });
      }

      function afterContentSanitize(root) {
        sanitizeCitations(root);
        purgeUnwantedNotes(root);
        normalizePearls(root);
      }

      function countWords(html) {
        return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim().split(' ').filter(Boolean).length;
      }

      function getCurrentPage() {
        const viewportCenter = window.scrollY + window.innerHeight / 2;
        return pages.find(p => {
          const rect = p.getBoundingClientRect();
          const pageTop = rect.top + window.scrollY;
          const pageBottom = pageTop + rect.height;
          return viewportCenter >= pageTop && viewportCenter <= pageBottom;
        }) || pages[0];
      }

      function getCurrentMagicPage() {
        return document.querySelector('.magic-page[contenteditable="true"]');
      }

      /* === HABILITAR PEGADO DE HTML === */
      function enableHtmlPaste() {
        const editableElements = document.querySelectorAll('[contenteditable="true"]');
        editableElements.forEach(el => {
          if (el.dataset.pasteHandlerBound === 'true') return;
          el.addEventListener('paste', (e) => {
            e.preventDefault();
            const html = e.clipboardData.getData('text/html') || e.clipboardData.getData('text/plain');
            document.execCommand('insertHTML', false, html);
          });
          el.dataset.pasteHandlerBound = 'true';
        });
      }

      /* === MODAL === */
      function showModal(content) {
        hideTopicMenu();
        modalContent.innerHTML = content;
        modalOverlay.classList.add('show');
      }

      function hideModal() {
        modalOverlay.classList.remove('show');
        modalContent.innerHTML = '';
      }

      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) hideModal();
      });

      /* === INICIALIZACIÓN === */
      function initializeSections() {
        const sectionMap = new Map();
        
        pages.forEach(page => {
          const sectionId = page.dataset.sectionId || 'seccion-default';
          const topicId = page.dataset.topicId || 'topic-' + Date.now();
          const h1 = page.querySelector('h1');
          const titleSpan = h1?.querySelector('span:first-child');
          const title = (titleSpan?.textContent || h1?.textContent || 'Sin título').trim();
          
          if (!sectionMap.has(sectionId)) {
            sectionMap.set(sectionId, {
              id: sectionId,
              nombre: page.dataset.sectionName || 'Sección Principal',
              collapsed: false,
              temas: []
            });
          }
          
          sectionMap.get(sectionId).temas.push({
            id: topicId,
            titulo: title,
            page: page
          });
        });
        
        sections = Array.from(sectionMap.values());
      }

      pages.forEach(p => {
        afterContentSanitize(p);
        if (!p.dataset.sectionId) {
          p.dataset.sectionId = 'seccion-1';
        }
      });
      
      document.querySelectorAll('.magic-topic').forEach(m => afterContentSanitize(m));
      initializeSections();

      (function setSpecialtyFromBuildComment() {
        try {
          const html = document.documentElement.innerHTML;
          const m = html.match(/build:topics\s{([\s\S]*?)}/);
          if (m) {
            const json = JSON.parse('{' + m[1] + '}');
            if (json.especialidad && specialtySpan) {
              specialtySpan.textContent = json.especialidad;
            }
          }
        } catch (e) {}
      })();

      /* === ICONOS MÁGICOS EN PÁGINAS === */
      function setupMagicIcons() {
        pages.forEach(page => {
          const h1 = page.querySelector('h1');
          if (!h1) return;

          let titleSpan = h1.querySelector('.topic-title-text');
          if (!titleSpan) {
            const existingSpan = h1.querySelector('span:first-child');
            const currentTitle = (existingSpan?.textContent || h1.textContent || '').trim();
            const existingMagic = h1.querySelector('.magic-icon');

            if (existingSpan) {
              titleSpan = existingSpan;
              titleSpan.classList.add('topic-title-text');
            } else {
              titleSpan = document.createElement('span');
              titleSpan.className = 'topic-title-text';
              titleSpan.textContent = currentTitle;
            }

            h1.innerHTML = '';
            h1.appendChild(titleSpan);
            if (existingMagic) {
              h1.appendChild(existingMagic);
            }
          }

          let magicIcon = h1.querySelector('.magic-icon');
          if (!magicIcon) {
            magicIcon = document.createElement('span');
            magicIcon.className = 'magic-icon';
            magicIcon.title = 'Ver contenido mágico';
            magicIcon.textContent = '✨';
            h1.appendChild(magicIcon);
          }

          const getTitle = () => (titleSpan?.textContent || '').trim() || getTopicTitle(page) || 'Tema';

          if (!magicIcon.dataset.bound) {
            magicIcon.addEventListener('click', (e) => {
              e.stopPropagation();
              closePanel();
              activateMagicTopic(magicAnchorFor(page), getTitle());
            });
            magicIcon.dataset.bound = 'true';
          }

          if (!titleSpan.dataset.bound) {
            titleSpan.title = 'Doble clic para opciones del tema';
            titleSpan.addEventListener('dblclick', (event) => {
              event.preventDefault();
              event.stopPropagation();
              showTopicMenu(event, { page, titulo: getTitle() });
            });
            titleSpan.addEventListener('click', (event) => event.stopPropagation());
            titleSpan.dataset.bound = 'true';
          }

          if (titleSpan.nextSibling !== magicIcon) {
            h1.appendChild(magicIcon);
          }
        });
      }

      setupMagicIcons();

      /* === MODO LECTURA === */
      function toggleReadingMode() {
        isReadingMode = !isReadingMode;
        document.body.classList.toggle('reading-mode', isReadingMode);
        readingModeBtn.classList.toggle('active', isReadingMode);
        
        if (isReadingMode) {
          closePanel();
          closeTocPanel();
          if (isEditMode) {
            toggleEditMode();
          }
        }
      }

      readingModeBtn?.addEventListener('click', toggleReadingMode);
      readingModeExit?.addEventListener('click', toggleReadingMode);

      /* === TABLA DE CONTENIDOS === */
      function buildTableOfContents() {
        const tocList = document.getElementById('tocList');
        tocList.innerHTML = '';
        
        pages.forEach(page => {
          const headings = page.querySelectorAll('h1, h2, h3');
          headings.forEach(heading => {
            const li = document.createElement('li');
            li.className = `toc-item ${heading.tagName.toLowerCase()}`;
            
            // Para h1, obtener solo el texto sin el icono
            if (heading.tagName === 'H1') {
              const titleSpan = heading.querySelector('span:first-child');
              li.textContent = titleSpan ? titleSpan.textContent : heading.textContent;
            } else {
              li.textContent = heading.textContent;
            }
            
            li.addEventListener('click', () => {
              heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
              closeTocPanel();
            });
            tocList.appendChild(li);
          });
        });
      }

      function openTocPanel() {
        buildTableOfContents();
        tocPanel.classList.add('open');
        panelBackdrop.classList.add('show');
      }

      function closeTocPanel() {
        tocPanel.classList.remove('open');
        if (!panel.classList.contains('open')) {
          panelBackdrop.classList.remove('show');
        }
        hideTopicMenu();
      }

      tocBtn?.addEventListener('click', () => {
        if (tocPanel.classList.contains('open')) {
          closeTocPanel();
        } else {
          closePanel();
          openTocPanel();
        }
      });

      tocClose?.addEventListener('click', closeTocPanel);

      /* === EXPORTAR MARKDOWN === */
      exportMarkdownBtn?.addEventListener('click', () => {
        let markdown = `# ${specialtySpan?.textContent || 'Documento'}\n\n`;
        
        pages.forEach(page => {
          const clone = page.cloneNode(true);
          markdown += htmlToMarkdown(clone.innerHTML) + '\n\n---\n\n';
        });
        
        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const specialty = specialtySpan?.textContent || 'documento';
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `${specialty.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      function htmlToMarkdown(html) {
        let md = html;
        
        md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n');
        md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n');
        md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n');
        md = md.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n');
        
        md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
        md = md.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
        md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
        md = md.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
        md = md.replace(/<u[^>]*>(.*?)<\/u>/gi, '_$1_');
        
        md = md.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
        md = md.replace(/<ul[^>]*>/gi, '\n');
        md = md.replace(/<\/ul>/gi, '\n');
        md = md.replace(/<ol[^>]*>/gi, '\n');
        md = md.replace(/<\/ol>/gi, '\n');
        
        md = md.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
        
        md = md.replace(/<[^>]+>/g, '');
        
        md = md.replace(/&nbsp;/g, ' ');
        md = md.replace(/&amp;/g, '&');
        md = md.replace(/&lt;/g, '<');
        md = md.replace(/&gt;/g, '>');
        
        md = md.replace(/\n{3,}/g, '\n\n');
        
        return md.trim();
      }

      /* === MANEJO DE IMÁGENES === */
      function showImageToolbar(img) {
        selectedImage = img;
        img.classList.add('selected-image');
        
        const rect = img.getBoundingClientRect();
        imageToolbar.style.left = rect.left + 'px';
        imageToolbar.style.top = (rect.top - imageToolbar.offsetHeight - 10) + 'px';
        imageToolbar.classList.add('show');
        
        const widthSlider = document.getElementById('imageWidthSlider');
        const heightSlider = document.getElementById('imageHeightSlider');
        const widthDisplay = document.getElementById('widthDisplay');
        const heightDisplay = document.getElementById('heightDisplay');
        
        widthSlider.value = img.width || 200;
        widthDisplay.textContent = (img.width || 200) + 'px';
        
        if (img.style.height && img.style.height !== 'auto') {
          heightSlider.value = parseInt(img.style.height) || 200;
          heightDisplay.textContent = (parseInt(img.style.height) || 200) + 'px';
        } else {
          heightSlider.value = img.height || 200;
          heightDisplay.textContent = 'auto';
        }
      }

      function hideImageToolbar() {
        if (selectedImage) {
          selectedImage.classList.remove('selected-image');
          selectedImage = null;
        }
        imageToolbar.classList.remove('show');
      }

      document.addEventListener('click', (e) => {
        if (isEditMode && e.target.tagName === 'IMG') {
          e.preventDefault();
          showImageToolbar(e.target);
        } else if (!e.target.closest('#imageToolbar') && !e.target.closest('img')) {
          hideImageToolbar();
        }
      });

      document.getElementById('imageWidthSlider')?.addEventListener('input', (e) => {
        if (selectedImage) {
          const width = parseInt(e.target.value);
          selectedImage.style.width = width + 'px';
          document.getElementById('widthDisplay').textContent = width + 'px';
        }
      });

      document.getElementById('imageHeightSlider')?.addEventListener('input', (e) => {
        if (selectedImage) {
          const height = parseInt(e.target.value);
          selectedImage.style.height = height + 'px';
          document.getElementById('heightDisplay').textContent = height + 'px';
        }
      });

      document.getElementById('alignLeftBtn')?.addEventListener('click', () => {
        if (selectedImage) {
          selectedImage.className = 'float-left';
        }
      });

      document.getElementById('alignCenterBtn')?.addEventListener('click', () => {
        if (selectedImage) {
          selectedImage.className = 'center-block';
        }
      });

      document.getElementById('alignRightBtn')?.addEventListener('click', () => {
        if (selectedImage) {
          selectedImage.className = 'float-right';
        }
      });

      document.getElementById('inlineBtn')?.addEventListener('click', () => {
        if (selectedImage) {
          selectedImage.className = 'inline-image';
        }
      });

      document.getElementById('deleteImageBtn')?.addEventListener('click', () => {
        if (selectedImage && confirm('¿Eliminar esta imagen?')) {
          selectedImage.remove();
          hideImageToolbar();
        }
      });

      /* === PALETAS DE COLOR MEJORADAS === */
      function createColorPalette(paletteId, isHighlight) {
        const palette = document.getElementById(paletteId);
        if (!palette) return;

        palette.innerHTML = '';
        
        pastelColors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.backgroundColor = color;
          swatch.title = color;
          swatch.addEventListener('click', (e) => {
            e.stopPropagation();
            applyColor(color, isHighlight);
            palette.classList.remove('show');
          });
          palette.appendChild(swatch);
        });
        
        const customSwatch = document.createElement('input');
        customSwatch.type = 'color';
        customSwatch.className = 'color-swatch';
        customSwatch.title = 'Color personalizado';
        customSwatch.style.border = '2px dashed #495057';
        customSwatch.addEventListener('change', (e) => {
          e.stopPropagation();
          applyColor(e.target.value, isHighlight);
          palette.classList.remove('show');
        });
        palette.appendChild(customSwatch);
      }

      function supportsCommand(command) {
        if (typeof document.queryCommandSupported !== 'function') return true;
        try {
          return document.queryCommandSupported(command);
        } catch (e) {
          return false;
        }
      }

      function applyColor(color, isHighlight) {
        if (!restoreSelection()) {
          alert('Por favor, selecciona el texto primero');
          return;
        }

        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) {
          alert('Por favor, selecciona el texto primero');
          savedSelection = null;
          return;
        }

        const styleWithCss = supportsCommand('styleWithCSS');
        if (styleWithCss) {
          document.execCommand('styleWithCSS', false, true);
        }

        let command = 'foreColor';
        if (isHighlight) {
          if (supportsCommand('hiliteColor')) {
            command = 'hiliteColor';
          } else if (supportsCommand('backColor')) {
            command = 'backColor';
          } else {
            command = null;
          }
        }

        let applied = false;
        if (command) {
          applied = document.execCommand(command, false, color);
        }

        if (styleWithCss) {
          document.execCommand('styleWithCSS', false, false);
        }

        if (!applied) {
          const range = selection.getRangeAt(0);
          const wrapper = document.createElement('span');
          if (isHighlight) {
            wrapper.style.backgroundColor = color;
          } else {
            wrapper.style.color = color;
          }
          try {
            range.surroundContents(wrapper);
          } catch (e) {
            const fragment = range.extractContents();
            wrapper.appendChild(fragment);
            range.insertNode(wrapper);
          }
        }

        selection.removeAllRanges();
        savedSelection = null;
      }

      createColorPalette('highlightPalette', true);
      createColorPalette('textColorPalette', false);

      document.getElementById('highlightBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (!saveCurrentSelection()) {
          alert('Por favor, selecciona el texto que deseas destacar');
          return;
        }
        
        const btn = e.currentTarget;
        const btnRect = btn.getBoundingClientRect();
        
        highlightPalette.style.left = btnRect.left + 'px';
        highlightPalette.style.top = (btnRect.bottom + 5) + 'px';
        
        textColorPalette.classList.remove('show');
        highlightPalette.classList.add('show');
      });

      document.getElementById('textColorBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (!saveCurrentSelection()) {
          alert('Por favor, selecciona el texto al que deseas cambiar el color');
          return;
        }
        
        const btn = e.currentTarget;
        const btnRect = btn.getBoundingClientRect();
        
        textColorPalette.style.left = btnRect.left + 'px';
        textColorPalette.style.top = (btnRect.bottom + 5) + 'px';
        
        highlightPalette.classList.remove('show');
        textColorPalette.classList.add('show');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('#highlightBtn') && !e.target.closest('#highlightPalette')) {
          highlightPalette.classList.remove('show');
          if (highlightPalette.classList.contains('show') === false) {
            savedSelection = null;
          }
        }
        if (!e.target.closest('#textColorBtn') && !e.target.closest('#textColorPalette')) {
          textColorPalette.classList.remove('show');
          if (textColorPalette.classList.contains('show') === false) {
            savedSelection = null;
          }
        }
      });

      /* === PLANTILLAS === */
      document.getElementById('insertTemplateBtn')?.addEventListener('click', () => {
        const hasSelection = saveCurrentSelection();
        if (!hasSelection) {
          const activeEditable = document.activeElement && document.activeElement.isContentEditable ? document.activeElement : null;
          const target = activeEditable || getCurrentPage() || getCurrentMagicPage();
          if (target) {
            const range = document.createRange();
            range.selectNodeContents(target);
            range.collapse(false);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            saveCurrentSelection();
          }
        }

        showModal(`
          <div class="modal-header">
            <h3>Insertar Plantilla</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <p>Selecciona una plantilla para insertar en el documento:</p>
            <div class="template-grid" id="templateGrid"></div>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
          </div>
        `);

        const templates = [
          {
            name: 'Nota Importante',
            html: '<div class="box" style="border-left-color: #dc3545;"><strong>Nota importante:</strong> Escribe tu contenido aquí.</div>'
          },
          {
            name: 'Perla Clínica',
            html: '<div class="box pearl">Escribe tu perla clínica aquí.</div>'
          },
          {
            name: 'Cuadro Informativo',
            html: '<div class="box"><strong>Título:</strong><p>Contenido del cuadro informativo.</p></div>'
          },
          {
            name: 'Separador Simple',
            html: '<hr style="border: none; border-top: 1px solid #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Separador Doble',
            html: '<hr style="border: none; border-top: 3px double #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Separador Punteado',
            html: '<hr style="border: none; border-top: 2px dashed #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Nota de Advertencia',
            html: '<div class="box" style="background: #fff3cd; border-left-color: #ffc107;"><strong>⚠️ Advertencia:</strong> Contenido importante de advertencia.</div>'
          },
          {
            name: 'Nota de Éxito',
            html: '<div class="box" style="background: #d1e7dd; border-left-color: #198754;"><strong>✓ Éxito:</strong> Información positiva o exitosa.</div>'
          },
          {
            name: 'Lista de Verificación',
            html: '<ul><li>☐ Ítem 1</li><li>☐ Ítem 2</li><li>☐ Ítem 3</li></ul>'
          },
          {
            name: 'Dos Columnas',
            html: '<div class="columns"><div><h3>Columna 1</h3><p>Contenido de la primera columna.</p></div><div><h3>Columna 2</h3><p>Contenido de la segunda columna.</p></div></div>'
          },
          {
            name: 'Cita Destacada',
            html: '<blockquote style="border-left: 4px solid var(--theme-primary); padding-left: 15px; font-style: italic; color: #6c757d; margin: 10px 0;">"Tu cita aquí"</blockquote>'
          },
          {
            name: 'Definición',
            html: '<div class="box" style="background: #e7f3ff;"><strong>Definición:</strong> Término a definir - explicación del término.</div>'
          }
        ];

        const grid = document.getElementById('templateGrid');
        if (grid) {
          grid.innerHTML = '';
        }
        templates.forEach(template => {
          const card = document.createElement('div');
          card.className = 'template-card';
          card.innerHTML = `
            <h4>${template.name}</h4>
            <div class="template-preview">${template.html}</div>
          `;
          card.addEventListener('click', () => {
            let inserted = false;
            if (restoreSelection()) {
              execCmd('insertHTML', template.html);
              inserted = true;
            } else {
              const fallback = (document.activeElement && document.activeElement.isContentEditable)
                ? document.activeElement
                : (getCurrentPage() || getCurrentMagicPage());
              if (fallback) {
                fallback.focus();
                execCmd('insertHTML', template.html);
                inserted = true;
              }
            }

            if (!inserted) {
              alert('Selecciona un área editable antes de insertar una plantilla.');
            }

            savedSelection = null;
            hideModal();
          });
          grid?.appendChild(card);
        });
      });

      /* === PANEL LATERAL === */
      function openPanel() {
        buildSectionsPanel();
        panel.classList.add('open');
        panelBackdrop.classList.add('show');
      }

      function closePanel() {
        panel.classList.remove('open');
        if (!tocPanel.classList.contains('open')) {
          panelBackdrop.classList.remove('show');
        }
        hideTopicMenu();
      }

      function magicAnchorFor(page) {
        const tid = page.dataset.topicId || '';
        if (!tid) return '';
        
        if (document.getElementById(`magic-topic-${tid}`)) {
          return `magic-topic-${tid}`;
        }
        if (document.getElementById(`magic-${tid}`)) {
          return `magic-${tid}`;
        }
        if (document.getElementById(tid)) {
          return tid;
        }
        return '';
      }

      function closeMagicView() {
        document.body.classList.remove('magic-open');
      }

      function activateMagicTopic(anchorId, title) {
        magic.innerHTML =
          '<div class="magic-header"><strong>✨ Visor del tema</strong><button class="magic-close">&times;</button></div>';
        const magicPage = document.createElement('div');
        magicPage.className = 'magic-page';

        const h = document.createElement('h1');
        h.className = 'magic-title';
        h.textContent = title || 'Tema';
        magicPage.appendChild(h);

        const src = anchorId ? document.getElementById(anchorId) : null;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = src ? src.innerHTML : '<p>No hay contenido adicional.</p>';
        afterContentSanitize(wrapper);

        magicPage.appendChild(wrapper);
        magic.appendChild(magicPage);

        if (isEditMode) {
          magicPage.contentEditable = 'true';
          enableHtmlPaste();
        }

        magic.querySelector('.magic-close')?.addEventListener('click', () => {
          if (isEditMode && src) {
            src.innerHTML = wrapper.innerHTML;
          }
          closeMagicView();
        });

        document.body.classList.add('magic-open');
      }

      function buildSectionsPanel() {
        sectionsContainer.innerHTML = '';
        globalTopicCounter = 1;
        
        sections.forEach((section, sectionIdx) => {
          const sectionDiv = document.createElement('div');
          sectionDiv.className = 'section-item';
          if (section.collapsed) sectionDiv.classList.add('collapsed');
          
          const sectionHeader = document.createElement('div');
          sectionHeader.className = 'section-header';
          
          const toggle = document.createElement('span');
          toggle.className = 'section-toggle';
          toggle.textContent = '▼';
          toggle.addEventListener('click', () => {
            section.collapsed = !section.collapsed;
            sectionDiv.classList.toggle('collapsed');
          });
          
          const nameSpan = document.createElement('span');
          nameSpan.className = 'section-name';
          nameSpan.textContent = section.nombre;
          nameSpan.addEventListener('click', () => {
            section.collapsed = !section.collapsed;
            sectionDiv.classList.toggle('collapsed');
          });
          
          const countSpan = document.createElement('span');
          countSpan.className = 'section-count';
          countSpan.textContent = `(${section.temas.length})`;
          
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'section-actions';
          
          const printBtn = document.createElement('button');
          printBtn.className = 'section-action-btn';
          printBtn.textContent = '🖨️';
          printBtn.title = 'Imprimir sección';
          printBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            printSection(section);
          });
          
          if (isPanelEditMode) {
            const renameBtn = document.createElement('button');
            renameBtn.className = 'section-action-btn';
            renameBtn.textContent = '✏️';
            renameBtn.title = 'Renombrar';
            renameBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              renameSection(section);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'section-action-btn';
            deleteBtn.textContent = '🗑️';
            deleteBtn.title = 'Eliminar sección';
            deleteBtn.style.color = '#dc3545';
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteSection(section);
            });
            
            actionsDiv.appendChild(renameBtn);
            actionsDiv.appendChild(deleteBtn);
          }
          
          actionsDiv.appendChild(printBtn);
          
          sectionHeader.appendChild(toggle);
          sectionHeader.appendChild(nameSpan);
          sectionHeader.appendChild(countSpan);
          sectionHeader.appendChild(actionsDiv);
          
          const topicList = document.createElement('ol');
          topicList.className = 'topic-list';
          
          section.temas.forEach(tema => {
            const li = document.createElement('li');
            li.dataset.topicId = tema.id;
            
            const numSpan = document.createElement('span');
            numSpan.className = 'topic-number';
            numSpan.textContent = globalTopicCounter + '.';
            globalTopicCounter++;
            
          const btnMain = document.createElement('button');
          btnMain.className = 'topic-action';
          btnMain.title = 'Ir al tema';
          btnMain.textContent = '📄';
          btnMain.addEventListener('click', () => {
            closeMagicView();
            closePanel();
            tema.page.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });

          const titleSpan = document.createElement('span');
          titleSpan.className = 'topic-title';
          titleSpan.textContent = tema.titulo;
          titleSpan.title = 'Doble clic para opciones del tema';
          titleSpan.addEventListener('dblclick', (event) => {
            event.preventDefault();
            event.stopPropagation();
            showTopicMenu(event, tema);
          });
          titleSpan.addEventListener('click', (event) => event.stopPropagation());

          li.appendChild(numSpan);
          li.appendChild(btnMain);
          li.appendChild(titleSpan);
          topicList.appendChild(li);
        });
          
          sectionDiv.appendChild(sectionHeader);
          sectionDiv.appendChild(topicList);
          sectionsContainer.appendChild(sectionDiv);
        });
      }

      function togglePanelEditMode() {
        isPanelEditMode = !isPanelEditMode;
        document.body.classList.toggle('panel-edit-mode', isPanelEditMode);
        editPanelBtn.classList.toggle('active', isPanelEditMode);
        buildSectionsPanel();
      }

      function toggleAllSections() {
        allSectionsExpanded = !allSectionsExpanded;
        sections.forEach(s => s.collapsed = !allSectionsExpanded);
        buildSectionsPanel();
        const btn = document.getElementById('toggleAllBtn');
        btn.textContent = allSectionsExpanded ? '⊟' : '⊞';
      }

      function renameSection(section) {
        const newName = prompt('Nuevo nombre para la sección:', section.nombre);
        if (newName && newName.trim()) {
          section.nombre = newName.trim();
          section.temas.forEach(tema => {
            tema.page.dataset.sectionName = section.nombre;
          });
          buildSectionsPanel();
        }
      }

      function deleteSection(section) {
        if (!confirm(`¿Eliminar toda la sección "${section.nombre}" con ${section.temas.length} tema(s)?`)) return;
        
        section.temas.forEach(tema => {
          tema.page.remove();
        });
        
        pages = pages.filter(p => p.dataset.sectionId !== section.id);
        sections = sections.filter(s => s.id !== section.id);
        buildSectionsPanel();
      }

      function addNewSection() {
        const nombre = prompt('Nombre de la nueva sección:');
        if (!nombre || !nombre.trim()) return;
        
        const newSection = {
          id: 'seccion-' + Date.now(),
          nombre: nombre.trim(),
          collapsed: false,
          temas: []
        };
        
        sections.push(newSection);
        buildSectionsPanel();
      }

      function sortSectionsAlpha() {
        sections.sort((a, b) => a.nombre.localeCompare(b.nombre));
        buildSectionsPanel();
      }

      function sortSectionsNumeric() {
        sections.sort((a, b) => {
          const numA = parseInt(a.nombre.match(/\d+/)?.[0] || '999');
          const numB = parseInt(b.nombre.match(/\d+/)?.[0] || '999');
          return numA - numB;
        });
        buildSectionsPanel();
      }

      function printSection(section) {
        window.print();
      }

      function printCurrentTopic() {
        window.print();
      }

      editPanelBtn?.addEventListener('click', togglePanelEditMode);
      document.getElementById('addSectionBtn')?.addEventListener('click', addNewSection);
      document.getElementById('toggleAllBtn')?.addEventListener('click', toggleAllSections);
      document.getElementById('sortAlphaBtn')?.addEventListener('click', sortSectionsAlpha);
      document.getElementById('sortNumBtn')?.addEventListener('click', sortSectionsNumeric);
      document.getElementById('printCurrentBtn')?.addEventListener('click', printCurrentTopic);

      const io = new IntersectionObserver((entries) => {
        const visible = entries.filter(e => e.isIntersecting).sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
        if (!visible) return;
        const tid = visible.target.dataset.topicId || '';
        sectionsContainer.querySelectorAll('li').forEach(li => 
          li.classList.toggle('active', li.dataset.topicId === tid)
        );
      }, { root: null, threshold: [0.5, 0.75, 1] });
      
      pages.forEach(p => io.observe(p));

      plusBtn?.addEventListener('click', () => {
        if (panel.classList.contains('open')) {
          closePanel();
        } else {
          closeTocPanel();
          openPanel();
        }
      });
      panelClose.forEach(btn => btn.addEventListener('click', () => {
        closePanel();
        closeTocPanel();
      }));
      panelBackdrop?.addEventListener('click', () => {
        closePanel();
        closeTocPanel();
      });
      
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          closePanel();
          closeTocPanel();
          hideModal();
          hideImageToolbar();
          closeMagicView();
          highlightPalette.classList.remove('show');
          textColorPalette.classList.remove('show');
          savedSelection = null;
        }
      });

      /* === TEMA DE COLORES === */
      document.getElementById('themeSelect')?.addEventListener('change', function() {
        const oldTheme = document.body.className.split(' ').find(c => c.startsWith('theme-'));
        if (oldTheme) {
          document.body.classList.remove(oldTheme);
        }
        document.body.classList.add(this.value);
        if (isReadingMode) {
          document.body.classList.add('reading-mode');
        }
      });

      /* === EDICIÓN === */
      function toggleEditMode() {
        isEditMode = !isEditMode;
        hideTopicMenu();

        if (isEditMode) {
          pages.forEach(page => page.contentEditable = 'true');
          const magicPage = getCurrentMagicPage();
          if (magicPage) magicPage.contentEditable = 'true';
          editToolbar.classList.add('show');
          editBtn.classList.add('active');
          editBtn.textContent = '✏️';
          saveHtmlBtn.style.display = 'inline-block';
          enableHtmlPaste();
        } else {
          pages.forEach(page => page.contentEditable = 'false');
          const magicPages = document.querySelectorAll('.magic-page');
          magicPages.forEach(mp => mp.contentEditable = 'false');
          editToolbar.classList.remove('show');
          editBtn.classList.remove('active');
          editBtn.textContent = '✏️';
          saveHtmlBtn.style.display = 'none';
          hideImageToolbar();
        }
      }
      
      function execCmd(command, value = null) {
        document.execCommand(command, false, value);
      }
      
      editBtn?.addEventListener('click', toggleEditMode);
      
      document.getElementById('undoBtn')?.addEventListener('click', () => execCmd('undo'));
      document.getElementById('redoBtn')?.addEventListener('click', () => execCmd('redo'));
      
      document.getElementById('fontSizeSelect')?.addEventListener('change', function() {
        if (this.value) {
          execCmd('fontSize', this.value);
          this.value = '';
        }
      });
      
      document.getElementById('boldBtn')?.addEventListener('click', () => execCmd('bold'));
      document.getElementById('italicBtn')?.addEventListener('click', () => execCmd('italic'));
      document.getElementById('underlineBtn')?.addEventListener('click', () => execCmd('underline'));
      document.getElementById('removeFormatBtn')?.addEventListener('click', () => execCmd('removeFormat'));
      document.getElementById('insertUlBtn')?.addEventListener('click', () => execCmd('insertUnorderedList'));
      document.getElementById('insertOlBtn')?.addEventListener('click', () => execCmd('insertOrderedList'));
      document.getElementById('indentBtn')?.addEventListener('click', () => execCmd('indent'));
      document.getElementById('outdentBtn')?.addEventListener('click', () => execCmd('outdent'));

      /* === INSERTAR HTML PERSONALIZADO === */
      document.getElementById('insertHtmlBtn')?.addEventListener('click', () => {
        showModal(`
          <div class="modal-header">
            <h3>Insertar HTML Personalizado</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <p>Escribe el código HTML que deseas insertar en la posición del cursor:</p>
            <textarea id="customHtmlInput" class="modal-textarea" placeholder="<div>Tu código HTML aquí...</div>"></textarea>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cancelar</button>
            <button class="modal-btn primary" id="insertCustomHtmlBtn">Insertar</button>
          </div>
        `);

        setTimeout(() => {
          document.getElementById('insertCustomHtmlBtn')?.addEventListener('click', () => {
            const htmlCode = document.getElementById('customHtmlInput').value;
            if (htmlCode.trim()) {
              execCmd('insertHTML', htmlCode);
              hideModal();
            } else {
              alert('Por favor ingresa código HTML válido');
            }
          });
        }, 100);
      });

      /* === COPIAR HTML DE SELECCIÓN === */
      document.getElementById('copyHtmlSelectionBtn')?.addEventListener('click', async () => {
        const selection = window.getSelection();
        if (!selection.rangeCount) {
          alert('Primero selecciona el texto del que quieres copiar el HTML');
          return;
        }

        const range = selection.getRangeAt(0);
        const container = document.createElement('div');
        container.appendChild(range.cloneContents());
        const html = container.innerHTML;

        if (!html) {
          alert('No hay contenido HTML en la selección');
          return;
        }

        try {
          await navigator.clipboard.writeText(html);
          showModal(`
            <div class="modal-header">
              <h3>HTML Copiado</h3>
              <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
            </div>
            <div class="modal-body">
              <p>El código HTML ha sido copiado al portapapeles.</p>
              <textarea class="modal-textarea" readonly>${html.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </div>
            <div class="modal-footer">
              <button class="modal-btn primary" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
            </div>
          `);
        } catch (e) {
          alert('Error al copiar: ' + e.message);
        }
      });

      /* === INSERTAR TABLA === */
      document.getElementById('insertTableBtn')?.addEventListener('click', () => {
        showModal(`
          <div class="modal-header">
            <h3>Insertar Tabla</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <label>Filas: <input type="number" id="tableRows" class="modal-input" value="3" min="1" max="20">
</label>
            <label>Columnas: <input type="number" id="tableCols" class="modal-input" value="3" min="1" max="10"></label>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cancelar</button>
            <button class="modal-btn primary" id="insertTableConfirm">Insertar</button>
          </div>
        `);
    setTimeout(() => {
      document.getElementById('insertTableConfirm')?.addEventListener('click', () => {
        const rows = parseInt(document.getElementById('tableRows').value) || 3;
        const cols = parseInt(document.getElementById('tableCols').value) || 3;
        
        let tableHTML = '<div class="table-wrap"><table><thead><tr>';
        for (let i = 0; i < cols; i++) {
          tableHTML += `<th>Encabezado ${i + 1}</th>`;
        }
        tableHTML += '</tr></thead><tbody>';
        
        for (let i = 0; i < rows; i++) {
          tableHTML += '<tr>';
          for (let j = 0; j < cols; j++) {
            tableHTML += '<td>Celda</td>';
          }
          tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table></div>';
        
        execCmd('insertHTML', tableHTML);
        hideModal();
      });
    }, 100);
  });

  /* === BUSCAR Y REEMPLAZAR === */
  document.getElementById('findReplaceBtn')?.addEventListener('click', () => {
    showModal(`
      <div class="modal-header">
        <h3>Buscar y Reemplazar</h3>
        <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <label>Buscar: <input type="text" id="findText" class="modal-input" placeholder="Texto a buscar"></label>
        <label>Reemplazar con: <input type="text" id="replaceText" class="modal-input" placeholder="Texto de reemplazo"></label>
        <p id="findReplaceStatus" style="margin-top: 10px; color: #6c757d;"></p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
        <button class="modal-btn primary" id="replaceAllBtn">Reemplazar Todo</button>
      </div>
    `);

    setTimeout(() => {
      document.getElementById('replaceAllBtn')?.addEventListener('click', () => {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        const status = document.getElementById('findReplaceStatus');
        
        if (!findText) {
          status.textContent = 'Por favor ingresa el texto a buscar';
          return;
        }

        let count = 0;
        const currentPage = getCurrentPage() || getCurrentMagicPage();
        if (currentPage) {
          const html = currentPage.innerHTML;
          const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
          const newHtml = html.replace(regex, (match) => {
            count++;
            return replaceText;
          });
          currentPage.innerHTML = newHtml;
        }

        status.textContent = `Se reemplazaron ${count} coincidencia(s)`;
      });
    }, 100);
  });

  /* === DUPLICAR TEMA === */
  document.getElementById('duplicateTopicBtn')?.addEventListener('click', () => {
    const currentPage = getCurrentPage();
    if (!currentPage) return;
    duplicateTopicPage(currentPage);
  });

  /* === EXPORTAR TEMA === */
  function exportSingleTopic(page) {
    const h1 = page.querySelector('h1');
    const titleSpan = h1?.querySelector('span:first-child');
    const title = (titleSpan?.textContent || h1?.textContent || 'tema').trim();
    const magicId = magicAnchorFor(page);
    const magicContent = document.getElementById(magicId);
    
    const tempPage = page.cloneNode(true);
    tempPage.contentEditable = 'false';

    const currentTheme = document.body.className.split(' ').find(c => c.startsWith('theme-')) || 'theme-blue';

    const htmlDoc = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
${document.querySelector('style').textContent}
  </style>
</head>
<body class="${currentTheme}">
  ${magicContent ? '<div class="magic-content-container" style="display:none">' + magicContent.outerHTML + '</div>' : ''}
  ${tempPage.outerHTML}
</body>
</html>`;
    const blob = new Blob([htmlDoc], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.toLowerCase().replace(/\s+/g, '-')}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.getElementById('exportTopicBtn')?.addEventListener('click', () => {
    const currentPage = getCurrentPage();
    if (currentPage) {
      exportSingleTopic(currentPage);
    }
  });

  /* === ESTADÍSTICAS === */
  statsBtn?.addEventListener('click', () => {
    const totalPages = pages.length;
    const totalWords = pages.reduce((sum, p) => sum + countWords(p.innerHTML), 0);
    const avgWords = Math.round(totalWords / totalPages);
    const minWords = Math.min(...pages.map(p => countWords(p.innerHTML)));
    const maxWords = Math.max(...pages.map(p => countWords(p.innerHTML)));

    showModal(`
      <div class="modal-header">
        <h3>Estadísticas del Documento</h3>
        <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total de Temas</div>
            <div class="stat-value">${totalPages}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total de Palabras</div>
            <div class="stat-value">${totalWords.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Promedio por Tema</div>
            <div class="stat-value">${avgWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Mínimo</div>
            <div class="stat-value">${minWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Máximo</div>
            <div class="stat-value">${maxWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Secciones</div>
            <div class="stat-value">${sections.length}</div>
          </div>
        </div>
        <h4 style="margin-top: 20px;">Detalle por Tema:</h4>
        <div style="max-height: 300px; overflow-y: auto;">
          ${pages.map((p, i) => {
            const h1 = p.querySelector('h1');
            const titleSpan = h1?.querySelector('span:first-child');
            const title = (titleSpan?.textContent || h1?.textContent || `Tema ${i+1}`).trim();
            const words = countWords(p.innerHTML);
            const percentage = Math.round((words / totalWords) * 100);
            return `
              <div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <strong>${title}</strong>: ${words} palabras (${percentage}%)
                <div style="background: #dee2e6; height: 4px; border-radius: 2px; margin-top: 4px;">
                  <div style="background: var(--theme-primary); height: 100%; width: ${percentage}%; border-radius: 2px;"></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn primary" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
      </div>
    `);
  });
  
  document.addEventListener('keydown', (e) => {
    if (!isEditMode) return;
    
    if (e.ctrlKey || e.metaKey) {
      switch(e.key.toLowerCase()) {
        case 'b':
          e.preventDefault();
          execCmd('bold');
          break;
        case 'i':
          e.preventDefault();
          execCmd('italic');
          break;
        case 'u':
          e.preventDefault();
          execCmd('underline');
          break;
        case 'z':
          if (e.shiftKey) {
            e.preventDefault();
            execCmd('redo');
          } else {
            e.preventDefault();
            execCmd('undo');
          }
          break;
        case 'y':
          e.preventDefault();
          execCmd('redo');
          break;
      }
    }
  });
  
  /* === GUARDAR HTML === */
  saveHtmlBtn?.addEventListener('click', () => {
    const wasEditing = isEditMode;
    if (wasEditing) {
      pages.forEach(page => page.contentEditable = 'false');
    }
    
    const toolbarWasVisible = editToolbar.classList.contains('show');
    if (toolbarWasVisible) {
      editToolbar.classList.remove('show');
    }

    const buildData = {
      especialidad: specialtySpan?.textContent || 'documento',
      secciones: sections.map(sec => ({
        id: sec.id,
        nombre: sec.nombre,
        temas: sec.temas.map(t => ({
          id: t.id,
          titulo: t.titulo
        }))
      }))
    };
    
    const doctype = '<!DOCTYPE html>\n';
    let html = document.documentElement.outerHTML;
    
    const buildComment = `<!-- build:topics ${JSON.stringify(buildData)} -->`;
    html = html.replace(/<!-- build:topics.*?-->/s, buildComment);
    
    const fullHtml = doctype + html;
    
    if (toolbarWasVisible) {
      editToolbar.classList.add('show');
    }
    
    const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    const specialty = specialtySpan?.textContent || 'documento';
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const filename = `${specialty.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.html`;
    a.download = filename;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    if (wasEditing) {
      pages.forEach(page => page.contentEditable = 'true');
    }
    
    const btn = saveHtmlBtn;
    const oldText = btn.textContent;
    btn.textContent = '✅ Guardado';
    setTimeout(() => btn.textContent = oldText, 2000);
  });

  function importHtmlFile(file, existingTopicIds) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const htmlText = event.target.result;
          const parser = new DOMParser();
          const loadedDoc = parser.parseFromString(htmlText, 'text/html');

          let hasNewStructure = false;
          let importedSectionId = null;
          let importedSectionName = 'Importado';

          try {
            const buildMatch = htmlText.match(/build:topics\s({.*?})/s);
            if (buildMatch) {
              const buildData = JSON.parse(buildMatch[1]);
              if (buildData.secciones && buildData.secciones.length > 0) {
                hasNewStructure = true;
                importedSectionId = buildData.secciones[0].id;
                importedSectionName = buildData.secciones[0].nombre;
              }
            }
          } catch (error) {
            console.log('Archivo sin estructura de secciones');
          }

          const loadedSpecialty = loadedDoc.getElementById('specialtyTitle');
          if (loadedSpecialty && specialtySpan && loadedSpecialty.textContent.trim()) {
            specialtySpan.textContent = loadedSpecialty.textContent.trim();
          }

          const mainContainer = document.querySelector('body');
          const scriptTag = mainContainer.querySelector('script');
          const loadedPages = loadedDoc.querySelectorAll('.page');

          if (loadedPages.length === 0) {
            throw new Error(`No se encontraron secciones de contenido en ${file.name}`);
          }

          if (!hasNewStructure) {
            importedSectionId = 'seccion-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            importedSectionName = file.name.replace(/\.html$/i, '');
          }

          loadedPages.forEach(page => {
            const clonedPage = page.cloneNode(true);
            afterContentSanitize(clonedPage);

            if (!clonedPage.dataset.sectionId) {
              clonedPage.dataset.sectionId = importedSectionId;
            }
            if (!clonedPage.dataset.sectionName) {
              clonedPage.dataset.sectionName = importedSectionName;
            }

            let topicId = clonedPage.dataset.topicId;
            if (!topicId) {
              topicId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
              clonedPage.dataset.topicId = topicId;
            } else if (existingTopicIds.has(topicId)) {
              const newId = topicId + '-' + Math.random().toString(36).substr(2, 4);
              clonedPage.dataset.topicId = newId;
              topicId = newId;
            }
            existingTopicIds.add(topicId);

            clonedPage.contentEditable = isEditMode ? 'true' : 'false';
            mainContainer.insertBefore(clonedPage, scriptTag);
          });

          const magicContainer = document.querySelector('.magic-content-container');
          if (magicContainer) {
            const loadedMagicContainer = loadedDoc.querySelector('.magic-content-container');
            if (loadedMagicContainer) {
              loadedMagicContainer.querySelectorAll('.magic-topic').forEach(topic => {
                const clonedTopic = topic.cloneNode(true);
                afterContentSanitize(clonedTopic);
                magicContainer.appendChild(clonedTopic);
              });
            }
          }

          resolve();
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = () => reject(reader.error || new Error('No se pudo leer el archivo'));
      reader.readAsText(file);
    });
  }

  /* === CARGAR HTML === */
  loadHtmlBtn?.addEventListener('click', () => {
    loadHtmlInput.click();
  });

  loadHtmlInput?.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    const htmlFiles = files.filter(file => file.name.toLowerCase().endsWith('.html'));
    const ignoredFiles = files.filter(file => !file.name.toLowerCase().endsWith('.html'));

    if (!htmlFiles.length) {
      alert('Por favor selecciona archivos HTML válidos');
      e.target.value = '';
      return;
    }

    if (ignoredFiles.length) {
      alert(`Se ignoraron archivos no compatibles: ${ignoredFiles.map(f => f.name).join(', ')}`);
    }

    const existingTopicIds = new Set(pages.map(p => p.dataset.topicId).filter(Boolean));

    try {
      for (const file of htmlFiles) {
        await importHtmlFile(file, existingTopicIds);
      }

      pages = [...document.querySelectorAll('.page')];
      pages.forEach(p => {
        afterContentSanitize(p);
        if (!p.dataset.topicId) {
          p.dataset.topicId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        io.observe(p);
      });

      setupMagicIcons();
      initializeSections();
      buildSectionsPanel();
      buildTableOfContents();

      if (isEditMode) {
        pages.forEach(page => page.contentEditable = 'true');
        enableHtmlPaste();
      }

      const btn = loadHtmlBtn;
      if (btn) {
        const oldText = btn.innerHTML;
        btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Cargado</span>';
        setTimeout(() => btn.innerHTML = oldText, 2000);
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
      console.error('Error al cargar el archivo:', error);
      alert('Error al cargar archivos: ' + error.message);
    } finally {
      e.target.value = '';
    }
  });

  /* === COPIAR HTML === */
  document.getElementById('copyHtmlBtn')?.addEventListener('click', async () => {
    const doctype = '<!DOCTYPE html>\n';
    const html = doctype + document.documentElement.outerHTML;
    try {
      await navigator.clipboard.writeText(html);
      const btn = document.getElementById('copyHtmlBtn');
      const old = btn.innerHTML;
      btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Copiado</span>';
      setTimeout(() => btn.innerHTML = old, 1500);
    } catch (e) {
      alert('No se pudo copiar el HTML');
    }
  });

})();
  </script>
</body>
</html>
