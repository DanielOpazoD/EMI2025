<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resumen – Endocrinología</title>
  <style>
    /* ===== Variables de tema ===== */
    :root {
      --theme-primary: #0d6efd;
      --theme-primary-dark: #0b5ed7;
      --theme-primary-light: #6ea8fe;
      --zoom-level: 1;
      --base-font-size: 10.5px;
      --dynamic-font-size: 10.5px;
    }

    html {
      font-size: var(--dynamic-font-size, 10.5px);
    }

    body.theme-blue {
      --theme-primary: #0d6efd;
      --theme-primary-dark: #0b5ed7;
      --theme-primary-light: #6ea8fe;
    }

    body.theme-green {
      --theme-primary: #198754;
      --theme-primary-dark: #157347;
      --theme-primary-light: #75b798;
    }

    body.theme-purple {
      --theme-primary: #6f42c1;
      --theme-primary-dark: #59359a;
      --theme-primary-light: #9d7cd4;
    }

    body.theme-orange {
      --theme-primary: #fd7e14;
      --theme-primary-dark: #dc6502;
      --theme-primary-light: #fda861;
    }

    /* ===== Base ===== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f8f9fa;
      color: #212529;
      margin: 0;
      padding: 0;
      line-height: 1.3;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    /* ===== Modo lectura ===== */
    body.reading-mode {
      background: #fafafa;
    }

    body.reading-mode .topbar,
    body.reading-mode .edit-toolbar {
      display: none !important;
    }

    body.reading-mode .page {
      margin-top: 20px;
      box-shadow: 0 0 5px rgba(0, 0, 0, .05);
      max-width: 800px;
    }

    .reading-mode-exit {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    body.reading-mode .reading-mode-exit {
      display: flex;
    }

    .reading-mode-exit:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.1);
    }

    /* ===== Topbar ===== */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 4000;
      height: calc(36px * var(--zoom-level));
      background: #000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, .25);
      font-size: calc(11px * var(--zoom-level));
    }

    .topbar-left {
      position: absolute;
      left: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar-center {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 90%;
    }

    .topbar-right {
      position: absolute;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar-topic {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background: #222;
      color: #ddd;
      max-width: 60vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .topbar-btn {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: opacity .15s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .topbar-btn.dirty::after {
      content: '*';
      margin-left: 2px;
      color: #ffc107;
      font-weight: 700;
    }

    .topbar-btn:hover {
      opacity: .9
    }

    .topbar-btn.active {
      background: var(--theme-primary);
      border-color: var(--theme-primary);
    }

    .topbar-btn-label {
      font-size: 9px;
      display: none;
    }

    @media (min-width: 768px) {
      .topbar-btn-label {
        display: inline;
      }
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .zoom-value {
      min-width: 45px;
      text-align: center;
      font-size: 10px;
      background: #222;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* ===== Barra de herramientas mejorada ===== */
    .edit-toolbar {
      position: fixed;
      top: calc(38px * var(--zoom-level));
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 6px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
      display: none;
      z-index: 3500;
      justify-content: center;
      font-size: calc(10px * var(--zoom-level));
    }

    .edit-toolbar.show {
      display: flex;
    }

    .toolbar-content {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      align-items: center;
      justify-content: center;
      max-width: 1400px;
    }

    .edit-toolbar button, .edit-toolbar select {
      padding: 3px 6px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 10px;
      line-height: 1.2;
    }

    .edit-toolbar button:hover {
      background: #f8f9fa;
    }

    .edit-toolbar button.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .edit-toolbar select {
      min-width: 70px;
      font-size: 10px;
    }

    .toolbar-separator {
      width: 1px;
      height: 20px;
      background: #dee2e6;
      margin: 0 2px;
    }

    .toolbar-group {
      display: flex;
      gap: 3px;
      align-items: center;
      padding: 2px;
      background: #f8f9fa;
      border-radius: 3px;
      position: relative;
    }

    .toolbar-label {
      font-size: 9px;
      color: #6c757d;
      font-weight: 600;
      margin-right: 3px;
    }

    /* Paleta de colores */
    .color-palette {
      display: grid;
      grid-template-columns: repeat(8, 20px);
      gap: 3px;
      padding: 6px;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      position: fixed;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
    }

    .color-palette.show {
      display: grid;
    }

    .color-swatch {
      width: 20px;
      height: 20px;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .color-swatch:hover {
      transform: scale(1.15);
      border-color: #495057;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* ===== Panel de herramientas de imagen ===== */
    .image-toolbar {
      position: fixed;
      background: #fff;
      border: 2px solid var(--theme-primary);
      border-radius: 6px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 3600;
      min-width: 220px;
    }

    .image-toolbar.show {
      display: flex;
    }

    .image-frame {
      border: 2px solid rgba(13, 110, 253, 0.35);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background: rgba(13, 110, 253, 0.08);
      padding: 6px;
      border-radius: 6px;
    }

    .image-figure {
      display: inline-block;
      margin: 10px;
      text-align: center;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
    }

    .image-figure figcaption {
      margin-top: 8px;
      font-size: 0.85em;
      color: #495057;
      outline: none;
      min-width: 120px;
    }

    .image-toolbar-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .image-toolbar button {
      padding: 4px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.15s;
    }

    .image-toolbar button:hover {
      background: #f8f9fa;
    }

    .image-toolbar button.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .image-toolbar label {
      font-size: 9px;
      color: #6c757d;
      font-weight: 600;
      min-width: 40px;
    }

    .image-toolbar input[type="range"] {
      flex: 1;
      min-width: 120px;
    }

    .image-toolbar .size-display {
      font-size: 9px;
      color: #495057;
      min-width: 60px;
      text-align: right;
    }

    /* ===== Plantillas ===== */
    .template-block {
      display: block;
      margin: 8px 0;
      padding: 4px;
      border-radius: 6px;
      transition: box-shadow 0.2s ease, outline 0.2s ease;
      position: relative;
    }

    .template-block > :first-child {
      margin-top: 0;
    }

    .template-block > :last-child {
      margin-bottom: 0;
    }

    .template-block.selected-template {
      outline: 2px solid var(--theme-primary);
      outline-offset: 2px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .template-toolbar {
      position: fixed;
      background: #fff;
      border: 2px solid var(--theme-primary);
      border-radius: 6px;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 3500;
      min-width: 240px;
    }

    .template-toolbar.show {
      display: flex;
    }

    .template-toolbar-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .template-toolbar label {
      font-size: 9px;
      color: #6c757d;
      font-weight: 600;
      min-width: 64px;
    }

    .template-toolbar input[type="color"] {
      width: 36px;
      height: 24px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 0;
      background: #fff;
      cursor: pointer;
    }

    .template-toolbar input[type="range"] {
      flex: 1;
      min-width: 120px;
    }

    .template-toolbar .size-display {
      font-size: 9px;
      color: #495057;
      min-width: 52px;
      text-align: right;
    }

    .template-toolbar button {
      padding: 4px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.15s;
    }

    .template-toolbar button:hover {
      background: #f8f9fa;
    }

    .template-toolbar .template-color-palette {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .template-toolbar .template-color-swatch {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.15);
      cursor: pointer;
      position: relative;
      padding: 0;
      background: var(--swatch-color, #ffffff);
    }

    .template-toolbar .template-color-swatch::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 5px;
      border: 2px solid transparent;
      pointer-events: none;
      transition: border-color 0.2s ease;
    }

    .template-toolbar .template-color-swatch:hover {
      background: var(--swatch-color, #ffffff);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.12);
    }

    .template-toolbar .template-color-swatch.active::after {
      border-color: var(--theme-primary);
    }

    .template-toolbar .template-toolbar-row.compact {
      align-items: flex-start;
    }

    img.selected-image {
      outline: 2px solid var(--theme-primary);
      outline-offset: 2px;
      cursor: move;
    }

    img.float-left {
      float: left;
      margin: 0 10px 10px 0;
    }

    img.float-right {
      float: right;
      margin: 0 0 10px 10px;
    }

    img.center-block {
      display: block;
      margin: 10px auto;
      float: none;
    }

    img.inline-image {
      display: inline;
      vertical-align: middle;
      margin: 0 5px;
    }

    .image-figure.float-left {
      float: left;
      margin: 0 10px 10px 0;
    }

    .image-figure.float-right {
      float: right;
      margin: 0 0 10px 10px;
    }

    .image-figure.center-block {
      display: block;
      margin: 10px auto;
      float: none;
    }

    .image-figure.inline-image {
      display: inline-block;
      float: none;
      margin: 0 5px;
    }

    #loadHtmlInput,
    #importDataInput {
      display: none;
    }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--theme-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
      line-height: 1;
    }

    .modal-body {
      margin-bottom: 15px;
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding-top: 10px;
      border-top: 1px solid #dee2e6;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-btn.primary {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .modal-btn.danger {
      background: #dc3545;
      color: #fff;
      border-color: #dc3545;
    }

    .modal-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    .modal-textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      min-height: 200px;
      resize: vertical;
      box-sizing: border-box;
    }

    /* ===== Recorte de imágenes ===== */
    .image-crop-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4600;
      padding: 20px;
    }

    .image-crop-modal.show {
      display: flex;
    }

    .image-crop-dialog {
      background: #fff;
      border-radius: 8px;
      max-width: min(90vw, 720px);
      width: 100%;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .image-crop-header,
    .image-crop-footer {
      padding: 12px 16px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .image-crop-footer {
      border-bottom: none;
      border-top: 1px solid #e9ecef;
    }

    .image-crop-close {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: #495057;
    }

    .image-crop-stage {
      position: relative;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      overflow: auto;
    }

    .image-crop-stage img {
      max-width: 100%;
      height: auto;
      display: block;
      user-select: none;
      touch-action: none;
    }

    .image-crop-selection {
      position: absolute;
      border: 2px dashed var(--theme-primary);
      background: rgba(13,110,253,0.12);
      pointer-events: none;
      display: none;
    }

    .image-crop-selection.show {
      display: block;
    }

    .image-crop-instructions {
      font-size: 11px;
      color: #6c757d;
      margin: 0;
      text-align: center;
      pointer-events: none;
    }

    .image-crop-size {
      font-size: 12px;
      color: #495057;
    }

    .image-crop-actions {
      display: flex;
      gap: 8px;
    }

    .image-crop-actions button {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ced4da;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s ease;
    }

    #imageCropApplyBtn {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    #imageCropApplyBtn:disabled {
      background: #adb5bd;
      border-color: #adb5bd;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid var(--theme-primary);
    }

    .stat-label {
      font-size: 11px;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
      color: #212529;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .template-card {
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-card:hover {
      border-color: var(--theme-primary);
      background: #f8f9fa;
    }

    .template-card h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: var(--theme-primary);
    }

    .template-preview {
      font-size: 10px;
      color: #6c757d;
      border: 1px dashed #dee2e6;
      padding: 6px;
      border-radius: 3px;
      min-height: 40px;
    }

    /* ===== Panel lateral ===== */
    .topic-panel {
      position: fixed;
      top: 36px;
      left: 0;
      width: 340px;
      max-width: 90vw;
      height: calc(100vh - 36px);
      background: #fff;
      border-right: 1px solid #e5e7eb;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .08);
      transform: translateX(-100%);
      transition: transform .2s ease;
      z-index: 4500;
      display: flex;
      flex-direction: column
    }

    .topic-panel.open {
      transform: translateX(0)
    }

    /* ===== Tabla de contenidos ===== */
    .toc-panel {
      position: fixed;
      top: 36px;
      right: 0;
      width: 300px;
      max-width: 90vw;
      height: calc(100vh - 36px);
      background: #fff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -4px 4px 10px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .2s ease;
      z-index: 4500;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .toc-panel.open {
      transform: translateX(0);
    }

    .toc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .toc-header strong {
      font-size: 13px;
      color: #212529;
    }

    .toc-list {
      list-style: none;
      padding: 10px;
      margin: 0;
    }

    .toc-item {
      padding: 4px 0;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 2px solid transparent;
      padding-left: 8px;
    }

    .toc-item:hover {
      background: #f8f9fa;
      border-left-color: var(--theme-primary);
    }

    .toc-item.h1 {
      font-size: 11px;
      font-weight: 600;
      color: var(--theme-primary);
      margin-top: 8px;
    }

    .toc-item.h2 {
      font-size: 10px;
      font-weight: 500;
      color: #495057;
      padding-left: 20px;
    }

    .toc-item.h3 {
      font-size: 9px;
      color: #6c757d;
      padding-left: 32px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
    }

    .panel-header strong {
      font-size: 13px;
      color: #212529;
    }

    .panel-header-actions {
      display: flex;
      gap: 4px;
    }

    .panel-header-btn {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 3px 6px;
      cursor: pointer;
      font-size: 10px;
      color: #495057;
    }

    .panel-header-btn:hover {
      background: #e9ecef;
    }

    .panel-header-btn.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .panel-actions {
      padding: 6px 10px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .panel-action-btn {
      flex: 1;
      min-width: 70px;
      padding: 4px 6px;
      border: 1px solid #dee2e6;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
    }

    .panel-action-btn:hover {
      background: #f8f9fa;
    }

    .sections-container {
      overflow-y: auto;
      flex: 1;
    }

    .section-item {
      border-bottom: 1px solid #f1f3f5;
    }

    .section-header {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      background: #f8f9fa;
      font-weight: 600;
      font-size: 11px;
      gap: 6px;
      border-bottom: 1px solid #e9ecef;
    }

    .section-toggle {
      font-size: 9px;
      transition: transform 0.2s;
      cursor: pointer;
      user-select: none;
      min-width: 12px;
    }

    .section-item.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-name {
      flex: 1;
      cursor: pointer;
    }

    .section-name:hover {
      color: var(--theme-primary);
    }

    .section-actions {
      display: flex;
      gap: 4px;
    }

    .section-action-btn {
      padding: 2px 5px;
      border: 1px solid #dee2e6;
      background: #fff;
      border-radius: 3px;
      cursor: pointer;
      font-size: 9px;
    }

    .section-action-btn:hover {
      background: #e9ecef;
    }

    .section-count {
      font-size: 9px;
      color: #6c757d;
      font-weight: normal;
    }

    .topic-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: none;
    }

    .section-item:not(.collapsed) .topic-list {
      display: block;
    }

    .topic-list li {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px 5px 30px;
      border-bottom: 1px dashed #f8f9fa;
      font-size: 10px;
    }

    .topic-list li:hover {
      background: #f8f9fa;
    }

    .topic-list li.active {
      background: #e7f3ff;
      border-left: 3px solid var(--theme-primary);
    }

    .topic-number {
      font-weight: 600;
      color: var(--theme-primary);
      min-width: 20px;
    }

    .topic-list .topic-action {
      font-size: 10px;
      border: 1px solid #d0d7de;
      background: #fff;
      border-radius: 3px;
      padding: 2px 5px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .topic-list .topic-action:hover {
      background: #f8f9fa;
    }

    .topic-list span.topic-title {
      white-space: nowrap;
      overflow: hidden;
      cursor: pointer;
      text-overflow: ellipsis;
      flex: 1;
    }

    .topic-context-menu {
      position: absolute;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 6000;
      padding: 4px 0;
    }

    .topic-context-menu.show {
      display: flex;
    }

    .topic-context-menu button {
      background: none;
      border: none;
      text-align: left;
      padding: 8px 14px;
      font-size: 11px;
      color: #212529;
      cursor: pointer;
      width: 100%;
    }

    .topic-context-menu button:hover {
      background: #f1f3f5;
    }

    .topic-context-menu button.danger {
      color: #dc3545;
    }

    .panel-backdrop {
      position: fixed;
      top: 36px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .15);
      backdrop-filter: saturate(120%) blur(1px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
      z-index: 4400;
    }

    .panel-backdrop.show {
      opacity: 1;
      pointer-events: auto
    }

    /* ===== Páginas con zoom CORREGIDO ===== */
    .page {
      width: calc(210mm * var(--zoom-level));
      min-height: calc(297mm * var(--zoom-level));
      padding: calc(12mm * var(--zoom-level));
      margin: calc(56px * var(--zoom-level)) auto calc(20px * var(--zoom-level));
      box-sizing: border-box;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, .1);
      page-break-after: always;
      overflow-wrap: break-word;
      position: relative;
    }

    .page[contenteditable="true"] {
      outline: 2px solid #d1d5db;
      outline-offset: 4px;
    }

    /* ===== Icono mágico en el título ===== */
    h1 {
      font-size: 18px;
      color: var(--theme-primary);
      margin: 0 0 6px 0;
      padding-bottom: 3px;
      border-bottom: 3px solid var(--theme-primary);
      line-height: 1.2;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    h1 .topic-title-text {
      flex: 1;
      cursor: pointer;
    }

    .magic-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      font-size: 16px;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 50%;
      transition: all 0.3s ease;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .magic-icon:hover {
      background: var(--theme-primary);
      transform: scale(1.15) rotate(15deg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    h2 {
      font-size: 13px;
      color: var(--theme-primary-dark);
      margin: 8px 0 3px 0;
      font-weight: 600;
      line-height: 1.2
    }

    h3 {
      font-size: 11px;
      color: var(--theme-primary);
      margin: 6px 0 2px 0;
      font-weight: 600;
      line-height: 1.2
    }

    h4 {
      font-size: 11px;
      color: var(--theme-primary-dark);
      margin: 6px 0 2px 0;
      font-weight: 600;
      line-height: 1.2
    }

    p {
      margin: 2px 0;
      text-align: justify
    }

    ul, ol {
      margin: 3px 0;
      padding-left: 18px
    }

    ul li, ol li {
      margin: 1px 0
    }

    strong {
      font-weight: 600;
      color: #343a40
    }

    .small-text {
      font-size: 9px;
      color: #6c757d
    }

    .highlight {
      background: #fff3cd;
      padding: 1px 3px;
      border-radius: 3px;
      font-weight: 600;
      color: #664d03
    }

    .box {
      background: transparent;
      border: 1px solid #dee2e6;
      border-left: 4px solid var(--theme-primary);
      padding: 6px 10px;
      margin: 6px 0;
      border-radius: 0 4px 4px 0
    }

    .pearl {
      border-left-color: #fd7e14
    }

    .pearl::before {
      content: "💡 ";
      font-weight: 700
    }

    .collapse-card {
      border: 1px solid #ced4da;
      border-left-width: 4px;
      border-radius: 6px;
      background: #ffffff;
      margin: 8px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: box-shadow 0.2s ease;
    }

    .collapse-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 12px;
      background: #f1f3f5;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .collapse-card-title {
      font-weight: 600;
      color: #343a40;
      flex: 1;
    }

    .collapse-card-toggle {
      border: none;
      background: var(--theme-primary);
      color: #fff;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      line-height: 1;
      transition: background 0.2s ease;
    }

    .collapse-card-toggle:hover {
      background: var(--theme-primary-dark);
    }

    .collapse-card-body {
      padding: 10px 12px;
    }

    .collapse-card.collapsed .collapse-card-body {
      display: none;
    }

    .collapse-card.collapsed .collapse-card-toggle::after {
      content: '+';
    }

    .collapse-card-toggle::after {
      content: '−';
      font-weight: 700;
    }

    .table-wrap {
      position: relative;
      overflow-x: auto;
      max-width: 100%
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      font-size: 10px;
      margin: 6px 0;
      line-height: 1.25;
      table-layout: fixed
    }

    table th, table td {
      border: 1px solid #dee2e6;
      padding: 3px 5px;
      text-align: left;
      word-wrap: break-word
    }

    table th {
      background: #e9ecef;
      font-weight: 600
    }

    table.table-zebra tbody tr:nth-child(even) > * {
      background: rgba(13, 110, 253, 0.06);
    }

    table.table-zebra tbody tr:nth-child(odd) > * {
      background: transparent;
    }

    .table-menu-selected {
      outline: 2px solid var(--theme-primary);
      outline-offset: 2px;
    }

    .table-column-highlight {
      background: rgba(13, 110, 253, 0.1) !important;
    }

    .table-menu {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 320px;
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.18);
      display: none;
      flex-direction: column;
      font-size: 11px;
      color: #212529;
      z-index: 4100;
      max-height: calc(100vh - 40px);
      overflow: hidden;
    }

    .table-menu.show {
      display: flex;
    }

    .table-menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid #e9ecef;
      background: linear-gradient(180deg, rgba(248, 249, 250, 0.95), rgba(233, 236, 239, 0.75));
    }

    .table-menu-header-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .table-menu-title {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 10px;
      color: #6c757d;
    }

    .table-menu-size {
      font-size: 13px;
      font-weight: 600;
      color: #0d6efd;
    }

    .table-menu-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .table-menu button,
    .table-menu input,
    .table-menu select {
      font-family: inherit;
      font-size: 11px;
    }

    .table-menu button {
      cursor: pointer;
      border: 1px solid #d0d5dd;
      background: #f8f9fa;
      color: #1f2937;
      border-radius: 8px;
      padding: 6px 8px;
      transition: all 0.2s ease;
    }

    .table-menu button:hover {
      background: #e9ecef;
    }

    .table-menu button.active,
    .table-menu button[data-state="active"] {
      background: rgba(13, 110, 253, 0.14);
      border-color: rgba(13, 110, 253, 0.5);
      color: #0b5ed7;
      box-shadow: inset 0 0 0 1px rgba(13, 110, 253, 0.2);
    }

    .table-menu-resize {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
      padding: 6px 12px;
    }

    .table-menu-resize:hover {
      background: var(--theme-primary-dark);
    }

    .table-menu-close {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      padding: 0;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid transparent;
      color: #6c757d;
    }

    .table-menu-close:hover {
      border-color: #dee2e6;
      background: rgba(0, 0, 0, 0.05);
      color: #212529;
    }

    .table-menu-tabs {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 12px 0;
    }

    .table-menu-tab {
      flex: 1;
      border-radius: 10px 10px 0 0;
      border-bottom: none;
      background: #f1f3f5;
      font-size: 13px;
      padding: 8px 0;
    }

    .table-menu-tab.active {
      background: #fff;
      color: #0d6efd;
      border-color: #d0d5dd;
      border-bottom: 1px solid #fff;
      box-shadow: 0 -2px 8px rgba(15, 23, 42, 0.05);
    }

    .table-menu-body {
      padding: 12px;
      overflow-y: auto;
    }

    .table-menu-panel {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .table-menu-panel.active {
      display: flex;
    }

    .table-menu-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 10px;
      border-radius: 10px;
    }

    .table-menu-section h4 {
      margin: 0;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #6c757d;
    }

    .table-menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .table-menu-grid.two-columns {
      grid-template-columns: repeat(2, 1fr);
    }

    .table-menu-grid.single-column {
      grid-template-columns: 1fr;
    }

    .table-theme-gallery {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
    }

    .table-menu .table-theme-option {
      padding: 0;
      border: none;
      background: transparent;
    }

    .table-menu .table-theme-option .table-theme-sample {
      width: 100%;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    .table-menu .table-theme-option.active {
      background: transparent;
      border: none;
    }

    .table-menu .table-theme-option.active .table-theme-sample {
      border-color: rgba(13, 110, 253, 0.6);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.35);
    }

    .table-theme-sample {
      height: 40px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .table-slider-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .table-slider-row label {
      font-size: 11px;
      color: #6c757d;
      font-weight: 600;
    }

    .table-slider-row input[type="range"] {
      width: 100%;
    }

    .table-slider-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: #0d6efd;
    }

    .table-preset-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .table-preset-buttons button {
      flex: 1;
      min-width: 0;
    }

    .table-border-colors {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .table-border-color-btn {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      padding: 0;
    }

    .table-border-color-btn.active {
      border-width: 2px;
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.2);
    }

    .table-border-toggle {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .table-border-toggle label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: #495057;
    }

    .table-border-toggle input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }

    .table-theme-default {
      background: linear-gradient(135deg, #fff, #f1f3f5);
      color: #212529;
    }

    .table-theme-ocean {
      background: linear-gradient(135deg, #0d6efd, #6ea8fe);
      color: #fff;
    }

    .table-theme-forest {
      background: linear-gradient(135deg, #198754, #75b798);
      color: #fff;
    }

    .table-theme-sunset {
      background: linear-gradient(135deg, #fd7e14, #fda861);
      color: #fff;
    }

    .table-theme-violet {
      background: linear-gradient(135deg, #6f42c1, #9d7cd4);
      color: #fff;
    }

    table.table-theme-ocean thead th {
      background: rgba(13, 110, 253, 0.15);
      color: #0b5ed7;
    }

    table.table-theme-forest thead th {
      background: rgba(25, 135, 84, 0.15);
      color: #157347;
    }

    table.table-theme-sunset thead th {
      background: rgba(253, 126, 20, 0.18);
      color: #dc6502;
    }

    table.table-theme-violet thead th {
      background: rgba(111, 66, 193, 0.15);
      color: #59359a;
    }

    .table-resize-handle {
      position: absolute;
      width: 14px;
      height: 14px;
      bottom: -7px;
      right: -7px;
      border-radius: 4px;
      background: #0d6efd;
      border: 2px solid #fff;
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.35);
      cursor: nwse-resize;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      transform: scale(0.9);
      z-index: 2;
    }

    .table-resize-wrapper.table-resize-mode .table-resize-handle {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    .table-resize-wrapper.table-resize-active .table-resize-handle {
      transform: scale(1.1);
    }

    .table-resize-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 110, 253, 0.05);
      cursor: crosshair;
      z-index: 4050;
      display: none;
      pointer-events: none;
    }

    .table-resize-overlay.show {
      display: block;
    }

    .columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 6px 0
    }

    /* ===== Visor Mágico ===== */
    .magic-view {
      position: fixed;
      top: 36px;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f8f9fa;
      display: none;
      flex-direction: column;
      z-index: 3000;
      color: #212529;
      overflow: auto
    }

    body.magic-open .magic-view {
      display: flex
    }

    .magic-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb
    }

    .magic-close {
      background: transparent;
      border: none;
      font-size: 22px;
      line-height: 1;
      color: #444;
      cursor: pointer
    }

    .magic-page {
      width: 210mm;
      min-height: 297mm;
      padding: 12mm;
      margin: calc(20px * var(--zoom-level)) auto;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, .1);
      box-sizing: border-box;
      overflow-wrap: break-word;
      transform: scale(var(--zoom-level));
      transform-origin: top center;
    }

    .magic-page[contenteditable="true"] {
      outline: 2px solid #d1d5db;
      outline-offset: 4px;
    }

    .magic-page * {
      max-width: 100%
    }

    .magic-title {
      font-size: 18px;
      color: var(--theme-primary);
      margin: 0 0 6px 0;
      padding-bottom: 3px;
      border-bottom: 2px solid var(--theme-primary);
      line-height: 1.2
    }

    .magic-section {
      margin: 10px 0
    }

    .magic-section h4 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: var(--theme-primary-dark);
    }

    .mini-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      font-size: 9.5px;
      line-height: 1.15;
      margin: 6px 0;
      background: #ffffff;
      color: #212529;
      table-layout: fixed
    }

    .mini-table th, .mini-table td {
      border: 1px solid #dee2e6;
      padding: 2px 4px;
      text-align: left;
      word-wrap: break-word
    }

    .mini-table th {
      background: #e9ecef;
      color: #212529;
      font-weight: 600
    }

    .tight-list {
      margin: 0;
      padding-left: 16px
    }

    .tight-list li {
      margin: 0
    }

    /* ===== Impresión SIN RESTRICCIONES ===== */
    @media print {
      body {
        background: #fff;
        margin: 0;
        padding: 0;
      }

      .topbar,
      .magic-view,
      .topic-panel,
      .toc-panel,
      .panel-backdrop,
      .edit-toolbar,
      .image-toolbar,
      .reading-mode-exit,
      .magic-icon {
        display: none !important;
      }

      .page, .magic-page {
        box-shadow: none;
        page-break-after: always;
        outline: none !important;
        transform: none !important;
        margin: 0 !important;
        width: 100%;
        min-height: auto;
      }

      body[data-printing-section] .page:not([data-print-target]) {
        display: none !important;
      }

      body[data-printing-section] .page[data-print-target] {
        display: block !important;
      }

      @page {
        size: auto;
        margin: 10mm;
      }
    }
  </style>
</head>
<body>
  <!-- build:topics {"especialidad":"Endocrinología","secciones":[]} -->
  
  <div class="topbar">
    <div class="topbar-left">
      <button class="topbar-btn topbar-plus" title="Abrir panel de navegación"><span>☰</span> <span class="topbar-btn-label">Menú</span></button>
    </div>
    <div class="topbar-center">
      <span id="specialtyTitle" class="topbar-topic" title="Especialidad">Endocrinología</span>
      <div class="zoom-controls">
        <button class="topbar-btn" id="zoomOutBtn" title="Reducir zoom">-</button>
        <span class="zoom-value" id="zoomValue">100%</span>
        <button class="topbar-btn" id="zoomInBtn" title="Aumentar zoom">+</button>
      </div>
      <button class="topbar-btn" id="tocBtn" title="Tabla de contenidos"><span>📑</span> <span class="topbar-btn-label">Índice</span></button>
      <button class="topbar-btn" id="readingModeBtn" title="Modo lectura"><span>📖</span> <span class="topbar-btn-label">Lectura</span></button>
      <button class="topbar-btn" id="statsBtn" title="Estadísticas"><span>📊</span> <span class="topbar-btn-label">Stats</span></button>
      <button class="topbar-btn" id="loadHtmlBtn" title="Cargar archivo HTML"><span>📂</span> <span class="topbar-btn-label">Abrir</span></button>
      <button class="topbar-btn" id="editBtn" title="Modo edición"><span>✏️</span> <span class="topbar-btn-label">Editar</span></button>
      <button class="topbar-btn" id="exportDataBtn" title="Exportar secciones y temas" aria-label="Exportar secciones y temas"><span>📤</span></button>
      <button class="topbar-btn" id="importDataBtn" title="Importar secciones y temas" aria-label="Importar secciones y temas"><span>📥</span></button>
      <button class="topbar-btn" id="exportMarkdownBtn" title="Exportar a Markdown"><span>⬇️</span> <span class="topbar-btn-label">MD</span></button>
      <button class="topbar-btn" id="copyHtmlBtn" title="Copiar HTML completo"><span>📋</span> <span class="topbar-btn-label">Copiar</span></button>
      <button class="topbar-btn" id="printCurrentBtn" title="Imprimir documento"><span>🖨️</span> <span class="topbar-btn-label">Imprimir</span></button>
    </div>
    <div class="topbar-right">
      <button class="topbar-btn" id="saveCacheBtn" title="Guardar en este dispositivo">💾 Guardar</button>
      <button class="topbar-btn" id="saveHtmlBtn" style="display:none;" title="Guardar como HTML"><span>💾</span> <span class="topbar-btn-label">Descargar</span></button>
    </div>
  </div>

  <button class="reading-mode-exit" id="readingModeExit" title="Salir del modo lectura">✕</button>

  <input type="file" id="loadHtmlInput" accept=".html" multiple />
  <input type="file" id="importDataInput" accept="application/json" />

  <!-- Barra de herramientas -->
  <div class="edit-toolbar" id="editToolbar">
    <div class="toolbar-content">
      <div class="toolbar-group">
        <span class="toolbar-label">HISTORIAL</span>
        <button id="undoBtn" title="Deshacer (Ctrl+Z)">↶</button>
        <button id="redoBtn" title="Rehacer (Ctrl+Y)">↷</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">FORMATO</span>
        <select id="fontSizeSelect" title="Tamaño">
          <option value="">Tamaño</option>
          <option value="1">Muy pequeño</option>
          <option value="2">Pequeño</option>
          <option value="3">Normal</option>
          <option value="4">Mediano</option>
          <option value="5">Grande</option>
          <option value="6">Muy grande</option>
          <option value="7">Enorme</option>
        </select>
        <button id="boldBtn" title="Negrita (Ctrl+B)"><strong>B</strong></button>
        <button id="italicBtn" title="Cursiva (Ctrl+I)"><em>I</em></button>
        <button id="underlineBtn" title="Subrayado (Ctrl+U)"><u>U</u></button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">SANGRÍA</span>
        <button id="indentBtn" title="Aumentar">→</button>
        <button id="outdentBtn" title="Disminuir">←</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">DESTACAR</span>
        <button id="highlightBtn" title="Destacar">🖍️</button>
      </div>

      <div class="toolbar-group">
        <span class="toolbar-label">COLOR</span>
        <button id="textColorBtn" title="Color">A</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">INSERTAR</span>
        <button id="insertTableBtn" title="Tabla">📊</button>
        <button id="insertUlBtn" title="Lista">•</button>
        <button id="insertOlBtn" title="Numerada">1.</button>
        <button id="insertHtmlBtn" title="HTML personalizado">&lt;/&gt;</button>
        <button id="insertTemplateBtn" title="Plantillas">📝</button>
        <button id="insertCollapseCardBtn" title="Tarjeta colapsable">📘</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">AVANZADO</span>
        <button id="copyHtmlSelectionBtn" title="Copiar HTML">&lt;&gt;</button>
        <button id="findReplaceBtn" title="Buscar">🔍</button>
        <button id="removeFormatBtn" title="Limpiar">🧹</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">TEMA</span>
        <select id="themeSelect" title="Esquema">
          <option value="theme-blue">Azul</option>
          <option value="theme-green">Verde</option>
          <option value="theme-purple">Morado</option>
          <option value="theme-orange">Naranja</option>
        </select>
        <button id="duplicateTopicBtn" title="Duplicar">📑</button>
        <button id="exportTopicBtn" title="Exportar">💾</button>
      </div>
    </div>
  </div>

  <!-- Paletas de color -->
  <div class="color-palette" id="highlightPalette"></div>
  <div class="color-palette" id="textColorPalette"></div>

  <!-- Panel de herramientas de imagen -->
  <div class="image-toolbar" id="imageToolbar">
    <div class="image-toolbar-row">
      <button id="alignLeftBtn" title="Izquierda">⬅️</button>
      <button id="alignCenterBtn" title="Centro">⬌</button>
      <button id="alignRightBtn" title="Derecha">➡️</button>
      <button id="inlineBtn" title="En línea">↔️</button>
    </div>
    <div class="image-toolbar-row">
      <label for="imageAltInput">Alt:</label>
      <input type="text" id="imageAltInput" placeholder="Texto alternativo" style="flex:1; font-size: 11px; padding: 4px;">
      <button id="applyAltBtn" title="Aplicar texto alternativo">Aplicar</button>
    </div>
    <div class="image-toolbar-row">
      <label for="imageFrameToggle">Marco:</label>
      <input type="checkbox" id="imageFrameToggle" style="margin-right: 6px;">
      <span style="font-size: 10px; color: #495057;">Agregar marco</span>
    </div>
    <div class="image-toolbar-row">
      <button id="wrapFigureBtn" title="Agregar figura" style="flex:1;">➕ Cuadro</button>
      <button id="unwrapFigureBtn" title="Quitar figura" style="flex:1;">➖ Quitar</button>
    </div>
    <div class="image-toolbar-row">
      <label>Ancho:</label>
      <input type="range" id="imageWidthSlider" min="50" max="900" step="1">
      <span class="size-display" id="widthDisplay">200px</span>
    </div>
    <div class="image-toolbar-row">
      <label>Alto:</label>
      <input type="range" id="imageHeightSlider" min="50" max="900" step="1">
      <span class="size-display" id="heightDisplay">auto</span>
    </div>
    <div class="image-toolbar-row">
      <button id="cropImageBtn" title="Recortar imagen" style="flex: 1;">✂️ Recortar</button>
    </div>
    <div class="image-toolbar-row">
      <button id="deleteImageBtn" title="Eliminar" style="color: #dc3545; flex: 1;">🗑️ Eliminar</button>
    </div>
  </div>

  <div class="table-menu" id="tableMenu" aria-hidden="true">
    <div class="table-menu-header">
      <div class="table-menu-header-info">
        <span class="table-menu-title">Tabla seleccionada</span>
        <span class="table-menu-size" id="tableMenuSize">0 × 0</span>
      </div>
      <div class="table-menu-actions">
        <button type="button" class="table-menu-resize" id="tableResizeBtn">Tamaño</button>
        <button type="button" class="table-menu-close" id="tableMenuClose" title="Cerrar panel">×</button>
      </div>
    </div>
    <div class="table-menu-tabs" role="tablist">
      <button type="button" class="table-menu-tab active" data-tab="structure" role="tab" aria-selected="true">✏️</button>
      <button type="button" class="table-menu-tab" data-tab="style" role="tab" aria-selected="false">🎨</button>
    </div>
    <div class="table-menu-body">
      <div class="table-menu-panel active" data-panel="structure" role="tabpanel">
        <div class="table-menu-section">
          <h4>Acciones rápidas</h4>
          <div class="table-menu-grid two-columns">
            <button type="button" data-action="insert-row-above">Fila ↑</button>
            <button type="button" data-action="insert-row-below">Fila ↓</button>
            <button type="button" data-action="insert-column-left">Columna ←</button>
            <button type="button" data-action="insert-column-right">Columna →</button>
            <button type="button" data-action="delete-row">Eliminar fila</button>
            <button type="button" data-action="delete-column">Eliminar columna</button>
            <button type="button" data-action="clear-column">Limpiar columna</button>
            <button type="button" data-action="select-column">Seleccionar columna</button>
            <button type="button" data-action="toggle-header" data-stateful="true">Fila encabezado</button>
            <button type="button" data-action="toggle-zebra" data-stateful="true">Patrón cebra</button>
            <button type="button" data-action="open-tools">Más herramientas</button>
          </div>
        </div>
      </div>
      <div class="table-menu-panel" data-panel="style" role="tabpanel">
        <div class="table-menu-section">
          <h4>Temas</h4>
          <div class="table-theme-gallery">
            <button type="button" class="table-theme-option active" data-table-theme="">
              <span class="table-theme-sample table-theme-default">Base</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-ocean">
              <span class="table-theme-sample table-theme-ocean">Océano</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-forest">
              <span class="table-theme-sample table-theme-forest">Bosque</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-sunset">
              <span class="table-theme-sample table-theme-sunset">Atardecer</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-violet">
              <span class="table-theme-sample table-theme-violet">Violeta</span>
            </button>
          </div>
        </div>
        <div class="table-menu-section">
          <h4>Espaciado</h4>
          <div class="table-slider-row">
            <label for="tableLineHeight">Interlineado</label>
            <input type="range" id="tableLineHeight" min="1" max="2" step="0.05">
            <span class="table-slider-value" id="tableLineHeightValue">1.25</span>
          </div>
          <div class="table-slider-row">
            <label for="tablePaddingY">Padding vertical</label>
            <input type="range" id="tablePaddingY" min="2" max="32" step="1">
            <span class="table-slider-value" id="tablePaddingYValue">6px</span>
          </div>
          <div class="table-slider-row">
            <label for="tableMargin">Margen exterior</label>
            <input type="range" id="tableMargin" min="0" max="48" step="1">
            <span class="table-slider-value" id="tableMarginValue">6px</span>
          </div>
          <div class="table-preset-buttons">
            <button type="button" data-table-preset="compacta">Compacta</button>
            <button type="button" data-table-preset="equilibrada">Equilibrada</button>
            <button type="button" data-table-preset="amplia">Amplia</button>
          </div>
        </div>
        <div class="table-menu-section">
          <h4>Líneas divisorias</h4>
          <div class="table-border-colors">
            <button type="button" class="table-border-color-btn" style="background:#dee2e6;" data-border-color="#dee2e6"></button>
            <button type="button" class="table-border-color-btn" style="background:#adb5bd;" data-border-color="#adb5bd"></button>
            <button type="button" class="table-border-color-btn" style="background:#0d6efd;" data-border-color="#0d6efd"></button>
            <button type="button" class="table-border-color-btn" style="background:#198754;" data-border-color="#198754"></button>
            <button type="button" class="table-border-color-btn" style="background:#fd7e14;" data-border-color="#fd7e14"></button>
            <button type="button" class="table-border-color-btn" style="background:#6f42c1;" data-border-color="#6f42c1"></button>
            <input type="color" id="tableBorderColorCustom" value="#dee2e6" title="Color personalizado">
          </div>
          <div class="table-slider-row">
            <label for="tableBorderWidth">Grosor</label>
            <input type="range" id="tableBorderWidth" min="0" max="8" step="0.5">
            <span class="table-slider-value" id="tableBorderWidthValue">1px</span>
          </div>
          <div class="table-border-toggle">
            <label><input type="checkbox" id="toggleVerticalBorders"> Ocultar verticales</label>
            <label><input type="checkbox" id="toggleHorizontalBorders"> Ocultar horizontales</label>
          </div>
          <div class="table-preset-buttons">
            <button type="button" data-border-reset="true">Restablecer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-resize-overlay" id="tableResizeOverlay" aria-hidden="true"></div>

  <div class="image-crop-modal" id="imageCropModal" aria-hidden="true">
    <div class="image-crop-dialog">
      <div class="image-crop-header">
        <strong>Recortar imagen</strong>
        <button type="button" id="imageCropCloseBtn" class="image-crop-close" title="Cerrar">&times;</button>
      </div>
      <div class="image-crop-stage" id="imageCropStage">
        <img id="imageCropPreview" alt="Vista previa de la imagen a recortar" />
        <div class="image-crop-selection" id="imageCropSelection"></div>
        <p class="image-crop-instructions">Haz clic y arrastra sobre la imagen para elegir el área a conservar.</p>
      </div>
      <div class="image-crop-footer">
        <span class="image-crop-size" id="imageCropSizeLabel">0 × 0 px</span>
        <div class="image-crop-actions">
          <button type="button" id="imageCropCancelBtn">Cancelar</button>
          <button type="button" id="imageCropApplyBtn" disabled>Aplicar recorte</button>
        </div>
      </div>
    </div>
  </div>

  <div class="template-toolbar" id="templateToolbar">
    <div class="template-toolbar-row compact">
      <label for="templateBgColor">Fondo:</label>
      <div class="template-color-palette" id="templateBgPalette"></div>
      <input type="color" id="templateBgColor" value="#ffffff">
      <button id="templateClearBgBtn" title="Quitar fondo">Sin fondo</button>
    </div>
    <div class="template-toolbar-row compact">
      <label for="templateTextColor">Texto:</label>
      <div class="template-color-palette" id="templateTextPalette"></div>
      <input type="color" id="templateTextColor" value="#212529">
      <button id="templateResetTextColorBtn" title="Restablecer color">Restablecer</button>
    </div>
    <div class="template-toolbar-row">
      <label for="templateBorderWidth">Borde:</label>
      <input type="range" id="templateBorderWidth" min="0" max="12" step="1">
      <span class="size-display" id="templateBorderWidthDisplay">1px</span>
    </div>
    <div class="template-toolbar-row compact" id="templateBorderColorRow">
      <label for="templateBorderColor">Color borde:</label>
      <div class="template-color-palette" id="templateBorderPalette"></div>
      <input type="color" id="templateBorderColor" value="#ced4da">
    </div>
    <div class="template-toolbar-row compact" id="templateAccentColorRow" style="display:none;">
      <label for="templateAccentColor">Borde izq.:</label>
      <div class="template-color-palette" id="templateAccentPalette"></div>
      <input type="color" id="templateAccentColor" value="#0d6efd">
    </div>
    <div class="template-toolbar-row">
      <label for="templateFontSize">Tamaño:</label>
      <input type="range" id="templateFontSize" min="80" max="180" step="5">
      <span class="size-display" id="templateFontSizeDisplay">100%</span>
    </div>
    <div class="template-toolbar-row">
      <label for="templateMarginTop">Arriba:</label>
      <input type="range" id="templateMarginTop" min="0" max="120" step="1">
      <span class="size-display" id="templateMarginTopDisplay">0px</span>
    </div>
    <div class="template-toolbar-row">
      <label for="templateMarginBottom">Abajo:</label>
      <input type="range" id="templateMarginBottom" min="0" max="120" step="1">
      <span class="size-display" id="templateMarginBottomDisplay">0px</span>
    </div>
    <div class="template-toolbar-row">
      <button id="templateDeleteBtn" title="Eliminar plantilla" style="color:#dc3545; flex:1;">🗑️ Eliminar</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <!-- Panel de navegación -->
  <aside id="topic-panel" class="topic-panel">
    <div class="panel-header">
      <strong>Navegación</strong>
      <div class="panel-header-actions">
        <button class="panel-header-btn" id="editPanelBtn" title="Editar secciones">✏️</button>
        <button class="panel-header-btn" id="addSectionBtn" title="Nueva sección">➕</button>
        <button class="panel-close">&times;</button>
      </div>
    </div>
    <div class="panel-actions">
      <button class="panel-action-btn" id="toggleAllBtn" title="Expandir/Colapsar todo">⊞</button>
      <button class="panel-action-btn" id="sortAlphaBtn">🔤</button>
      <button class="panel-action-btn" id="sortNumBtn">🔢</button>
    </div>
    <div class="sections-container" id="sectionsContainer"></div>
  </aside>

  <!-- Tabla de contenidos -->
  <aside id="toc-panel" class="toc-panel">
    <div class="toc-header">
      <strong>Tabla de Contenidos</strong>
      <button class="panel-close" id="tocClose">&times;</button>
    </div>
    <ul class="toc-list" id="tocList"></ul>
  </aside>

  <div id="panel-backdrop" class="panel-backdrop"></div>
  
  <aside id="magic-view" class="magic-view">
  </aside>

  <!-- Contenido mágico -->
  <div class="magic-content-container" style="display:none"></div>

  <!-- Páginas -->

  <script>
    (function() {
      let isEditMode = false;
      let isPanelEditMode = false;
      let isReadingMode = false;
      let pages = [...document.querySelectorAll('.page')];
      let globalTopicCounter = 1;
      let selectedImage = null;
      let selectedTemplateBlock = null;
      let currentZoom = 1;
      let allSectionsExpanded = true;
      let savedSelection = null;
      let tableMenuAPI = null;
      const cropState = {
        image: null,
        isSelecting: false,
        startX: 0,
        startY: 0,
        currentRect: null,
        scaleX: 1,
        scaleY: 1
      };

      const BASE_FONT_SIZE = 10.5;
      const MIN_ZOOM_LEVEL = 0.5;
      const MAX_ZOOM_LEVEL = 2;
      const ZOOM_STEP = 0.1;
      const LOCAL_CACHE_KEY = 'emi2025-local-cache';
      const LOCAL_CACHE_VERSION = 1;
      const LOCAL_ZOOM_KEY = 'emi2025-zoom-level';
      const STORAGE_AVAILABLE = (() => {
        try {
          const testKey = '__emi2025-cache-test__';
          window.localStorage.setItem(testKey, '1');
          window.localStorage.removeItem(testKey);
          return true;
        } catch (error) {
          console.warn('Almacenamiento local no disponible:', error);
          return false;
        }
      })();

      let cacheSaveTimeout = null;
      let manualSaveFeedbackTimeout = null;
      let hasPendingChanges = false;
      let saveCacheBtnDefaultText = '💾 Guardar';

      let sections = [];
      let saveCacheBtn = null;

      function detachPageListeners(page) {
        if (!page) return;
        if (page.__cacheObserver) {
          page.__cacheObserver.disconnect();
          delete page.__cacheObserver;
        }
        if (page.__cacheInputHandler) {
          page.removeEventListener('input', page.__cacheInputHandler);
          delete page.__cacheInputHandler;
        }
        if (page.__cacheBlurHandler) {
          page.removeEventListener('blur', page.__cacheBlurHandler);
          delete page.__cacheBlurHandler;
        }
        delete page.dataset.cacheBound;
      }

      function attachPageListeners(page) {
        if (!page || page.dataset.cacheBound === 'true') return;
        const inputHandler = () => scheduleCacheSave();
        const blurHandler = () => scheduleCacheSave({ delay: 0 });
        page.addEventListener('input', inputHandler);
        page.addEventListener('blur', blurHandler);
        const observer = new MutationObserver(() => {
          if (!page.isConnected) {
            observer.disconnect();
            return;
          }
          scheduleCacheSave();
        });
        observer.observe(page, { childList: true, characterData: true, subtree: true });
        page.__cacheObserver = observer;
        page.__cacheInputHandler = inputHandler;
        page.__cacheBlurHandler = blurHandler;
        page.dataset.cacheBound = 'true';
      }

      function markDirty() {
        if (!STORAGE_AVAILABLE) return;
        hasPendingChanges = true;
        saveCacheBtn?.classList.add('dirty');
      }

      function clearDirty() {
        hasPendingChanges = false;
        saveCacheBtn?.classList.remove('dirty');
      }

      function scheduleCacheSave(options = {}) {
        if (!STORAGE_AVAILABLE) return;
        const { delay = 800, immediate = false, skipDirtyMark = false } = options;
        if (!skipDirtyMark) {
          markDirty();
        }
        if (cacheSaveTimeout) {
          clearTimeout(cacheSaveTimeout);
          cacheSaveTimeout = null;
        }
        if (immediate) {
          persistDocumentToCache();
          return;
        }
        cacheSaveTimeout = window.setTimeout(() => {
          cacheSaveTimeout = null;
          persistDocumentToCache();
        }, Math.max(0, delay));
      }

      function persistDocumentToCache(options = {}) {
        if (!STORAGE_AVAILABLE) return false;
        if (cacheSaveTimeout) {
          clearTimeout(cacheSaveTimeout);
          cacheSaveTimeout = null;
        }
        try {
          const data = collectDocumentData();
          data.zoom = currentZoom;
          const payload = {
            version: LOCAL_CACHE_VERSION,
            savedAt: new Date().toISOString(),
            data
          };
          window.localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify(payload));
          window.localStorage.setItem(LOCAL_ZOOM_KEY, String(currentZoom));
          clearDirty();
          if (options.notify && saveCacheBtn) {
            saveCacheBtn.textContent = '✅ Guardado';
            saveCacheBtn.classList.remove('dirty');
            if (manualSaveFeedbackTimeout) {
              clearTimeout(manualSaveFeedbackTimeout);
            }
            manualSaveFeedbackTimeout = window.setTimeout(() => {
              saveCacheBtn.textContent = saveCacheBtnDefaultText;
              if (hasPendingChanges) {
                saveCacheBtn.classList.add('dirty');
              }
            }, 2000);
          }
          return true;
        } catch (error) {
          console.error('Error al guardar localmente:', error);
          if (options.notify) {
            alert('No se pudo guardar localmente: ' + error.message);
          }
          return false;
        }
      }

      function loadDocumentFromCacheOnStartup() {
        if (!STORAGE_AVAILABLE) return;
        try {
          const raw = window.localStorage.getItem(LOCAL_CACHE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed?.data && Array.isArray(parsed.data.sections)) {
              importSectionsData(parsed.data, { skipCacheSave: true, skipZoom: true });
              if (typeof parsed.data.zoom === 'number') {
                applyZoom(parsed.data.zoom, { skipCache: true, skipPersist: true });
              }
              clearDirty();
              return;
            }
          }
          const storedZoom = parseFloat(window.localStorage.getItem(LOCAL_ZOOM_KEY));
          if (!Number.isNaN(storedZoom)) {
            applyZoom(storedZoom, { skipCache: true, skipPersist: true });
          }
        } catch (error) {
          console.error('No se pudo restaurar la información local:', error);
        }
      }
      
      const panel = document.getElementById('topic-panel');
      const tocPanel = document.getElementById('toc-panel');
      const sectionsContainer = document.getElementById('sectionsContainer');
      const plusBtn = document.querySelector('.topbar-plus');
      const panelClose = document.querySelectorAll('.panel-close');
      const tocClose = document.getElementById('tocClose');
      const panelBackdrop = document.getElementById('panel-backdrop');
      const magic = document.getElementById('magic-view');
      const specialtySpan = document.getElementById('specialtyTitle');
      const modalOverlay = document.getElementById('modalOverlay');
      const modalContent = document.getElementById('modalContent');

      saveCacheBtn = document.getElementById('saveCacheBtn');
      if (saveCacheBtn) {
        const label = saveCacheBtn.textContent?.trim();
        if (label) {
          saveCacheBtnDefaultText = saveCacheBtn.textContent;
        }
        if (!STORAGE_AVAILABLE) {
          saveCacheBtn.setAttribute('disabled', 'true');
          saveCacheBtn.title = 'El almacenamiento local no está disponible en este navegador.';
        }
      }

      const editBtn = document.getElementById('editBtn');
      const saveHtmlBtn = document.getElementById('saveHtmlBtn');
      const loadHtmlBtn = document.getElementById('loadHtmlBtn');
      const loadHtmlInput = document.getElementById('loadHtmlInput');
      const editToolbar = document.getElementById('editToolbar');
      const statsBtn = document.getElementById('statsBtn');
      const exportDataBtn = document.getElementById('exportDataBtn');
      const importDataBtn = document.getElementById('importDataBtn');
      const importDataInput = document.getElementById('importDataInput');
      const editPanelBtn = document.getElementById('editPanelBtn');
      const tocBtn = document.getElementById('tocBtn');
      const readingModeBtn = document.getElementById('readingModeBtn');
      const readingModeExit = document.getElementById('readingModeExit');
      const exportMarkdownBtn = document.getElementById('exportMarkdownBtn');
      const imageToolbar = document.getElementById('imageToolbar');
      const imageAltInput = document.getElementById('imageAltInput');
      const applyAltBtn = document.getElementById('applyAltBtn');
      const imageFrameToggle = document.getElementById('imageFrameToggle');
      const wrapFigureBtn = document.getElementById('wrapFigureBtn');
      const unwrapFigureBtn = document.getElementById('unwrapFigureBtn');
      const cropImageBtn = document.getElementById('cropImageBtn');
      const imageCropModal = document.getElementById('imageCropModal');
      const imageCropStage = document.getElementById('imageCropStage');
      const imageCropPreview = document.getElementById('imageCropPreview');
      const imageCropSelection = document.getElementById('imageCropSelection');
      const imageCropApplyBtn = document.getElementById('imageCropApplyBtn');
      const imageCropCancelBtn = document.getElementById('imageCropCancelBtn');
      const imageCropCloseBtn = document.getElementById('imageCropCloseBtn');
      const imageCropSizeLabel = document.getElementById('imageCropSizeLabel');
      const templateToolbar = document.getElementById('templateToolbar');
      const templateBgColorInput = document.getElementById('templateBgColor');
      const templateClearBgBtn = document.getElementById('templateClearBgBtn');
      const templateTextColorInput = document.getElementById('templateTextColor');
      const templateResetTextColorBtn = document.getElementById('templateResetTextColorBtn');
      const templateBgPalette = document.getElementById('templateBgPalette');
      const templateTextPalette = document.getElementById('templateTextPalette');
      const templateBorderPalette = document.getElementById('templateBorderPalette');
      const templateAccentPalette = document.getElementById('templateAccentPalette');
      const templateBorderColorInput = document.getElementById('templateBorderColor');
      const templateAccentColorInput = document.getElementById('templateAccentColor');
      const templateBorderColorRow = document.getElementById('templateBorderColorRow');
      const templateAccentColorRow = document.getElementById('templateAccentColorRow');
      const templateFontSizeSlider = document.getElementById('templateFontSize');
      const templateFontSizeDisplay = document.getElementById('templateFontSizeDisplay');
      const templateMarginTopSlider = document.getElementById('templateMarginTop');
      const templateMarginTopDisplay = document.getElementById('templateMarginTopDisplay');
      const templateMarginBottomSlider = document.getElementById('templateMarginBottom');
      const templateMarginBottomDisplay = document.getElementById('templateMarginBottomDisplay');
      const templateBorderWidthSlider = document.getElementById('templateBorderWidth');
      const templateBorderWidthDisplay = document.getElementById('templateBorderWidthDisplay');
      const templateDeleteBtn = document.getElementById('templateDeleteBtn');

      const templateBackgroundPaletteColors = ['#ffffff', '#f8f9fa', '#fef9e7', '#fff3cd', '#fde2e4', '#f8d7da', '#e7f3ff', '#d1e7dd', '#e9ecef'];
      const templateTextPaletteColors = ['#212529', '#343a40', '#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6f42c1', '#6c757d', '#ffffff'];
      const templateBorderPaletteColors = ['#ced4da', '#adb5bd', '#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6f42c1', '#0dcaf0', '#6c757d', '#212529'];
      const templateAccentPaletteColors = ['#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6f42c1', '#ffc107', '#20c997', '#0dcaf0', '#6c757d'];

      initPalette(templateBgPalette, templateBackgroundPaletteColors, color => applyTemplateBackground(color));
      initPalette(templateTextPalette, templateTextPaletteColors, color => applyTemplateTextColor(color));
      initPalette(templateBorderPalette, templateBorderPaletteColors, color => applyTemplateBorderColor(color));
      initPalette(templateAccentPalette, templateAccentPaletteColors, color => applyTemplateAccentColor(color));
      const alignButtons = {
        left: document.getElementById('alignLeftBtn'),
        center: document.getElementById('alignCenterBtn'),
        right: document.getElementById('alignRightBtn'),
        inline: document.getElementById('inlineBtn')
      };
      const floatClasses = ['float-left', 'float-right', 'center-block', 'inline-image'];
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const zoomValue = document.getElementById('zoomValue');
      const highlightPalette = document.getElementById('highlightPalette');
      const textColorPalette = document.getElementById('textColorPalette');
      const insertTemplateBtn = document.getElementById('insertTemplateBtn');
      const insertHtmlBtn = document.getElementById('insertHtmlBtn');
      const insertTableBtn = document.getElementById('insertTableBtn');
      const insertCollapseCardBtn = document.getElementById('insertCollapseCardBtn');
      const tableMenu = document.getElementById('tableMenu');
      const tableMenuSize = document.getElementById('tableMenuSize');
      const tableResizeBtn = document.getElementById('tableResizeBtn');
      const tableMenuClose = document.getElementById('tableMenuClose');
      const tableMenuTabs = Array.from(document.querySelectorAll('.table-menu-tab'));
      const tableMenuPanels = Array.from(document.querySelectorAll('.table-menu-panel'));
      const tableThemeButtons = Array.from(document.querySelectorAll('.table-theme-option'));
      const tableLineHeightInput = document.getElementById('tableLineHeight');
      const tableLineHeightValue = document.getElementById('tableLineHeightValue');
      const tablePaddingYInput = document.getElementById('tablePaddingY');
      const tablePaddingYValue = document.getElementById('tablePaddingYValue');
      const tableMarginInput = document.getElementById('tableMargin');
      const tableMarginValue = document.getElementById('tableMarginValue');
      const tablePresetButtons = Array.from(document.querySelectorAll('[data-table-preset]'));
      const tableBorderColorButtons = Array.from(document.querySelectorAll('.table-border-color-btn'));
      const tableBorderColorCustom = document.getElementById('tableBorderColorCustom');
      const tableBorderWidthInput = document.getElementById('tableBorderWidth');
      const tableBorderWidthValue = document.getElementById('tableBorderWidthValue');
      const toggleVerticalBorders = document.getElementById('toggleVerticalBorders');
      const toggleHorizontalBorders = document.getElementById('toggleHorizontalBorders');
      const tableBorderResetBtn = document.querySelector('[data-border-reset]');
      const tableResizeOverlay = document.getElementById('tableResizeOverlay');

      const pastelColors = [
        '#FFB6C1', '#FFD1DC', '#FFC8DD', '#E7C6FF', '#C8B6FF', '#B4D4FF', '#AEC6CF', '#B2DFDB',
        '#C5E1A5', '#FFF9C4', '#FFE082', '#FFCCBC', '#D7CCC8', '#F5F5F5', '#CFD8DC', '#E1BEE7'
      ];

      const tableResizers = new WeakMap();

      if (cropImageBtn) {
        cropImageBtn.disabled = true;
      }

      const topicMenu = document.createElement('div');
      topicMenu.id = 'topicContextMenu';
      topicMenu.className = 'topic-context-menu';
      topicMenu.innerHTML = `
        <button data-action="rename">Cambiar título</button>
        <button data-action="move">Mover tema</button>
        <button data-action="duplicate">Duplicar tema</button>
        <button data-action="delete" class="danger">Eliminar tema</button>
      `;
      document.body.appendChild(topicMenu);

      let topicMenuContext = null;
      let topicMenuJustOpened = false;

      function hideTopicMenu() {
        topicMenu.classList.remove('show');
        topicMenuContext = null;
        topicMenuJustOpened = false;
      }

      function getTopicTitle(page) {
        if (!page) return '';
        const h1 = page.querySelector('h1');
        const titleSpan = h1?.querySelector('span:first-child');
        return (titleSpan?.textContent || h1?.textContent || '').trim();
      }

      function showTopicMenu(event, tema) {
        if (!tema || !tema.page) return;
        hideTopicMenu();

        const page = tema.page;
        const title = (tema.titulo || getTopicTitle(page) || 'Tema').trim();
        topicMenuContext = { page, titulo: title };

        const pageX = event.pageX || (event.clientX + window.scrollX);
        const pageY = event.pageY || (event.clientY + window.scrollY);

        topicMenu.style.left = pageX + 'px';
        topicMenu.style.top = pageY + 'px';
        topicMenu.classList.add('show');

        const rect = topicMenu.getBoundingClientRect();
        let newLeft = rect.left;
        let newTop = rect.top;

        if (rect.right > window.innerWidth) {
          newLeft = window.innerWidth - rect.width - 12;
        }
        if (rect.bottom > window.innerHeight) {
          newTop = window.innerHeight - rect.height - 12;
        }

        newLeft = Math.max(8, newLeft);
        newTop = Math.max(8, newTop);

        topicMenu.style.left = window.scrollX + newLeft + 'px';
        topicMenu.style.top = window.scrollY + newTop + 'px';

        topicMenuJustOpened = true;
        setTimeout(() => {
          topicMenuJustOpened = false;
        }, 0);
      }

      function renameTopicPage(page) {
        if (!page) return false;
        const h1 = page.querySelector('h1');
        const titleSpan = h1?.querySelector('span:first-child');
        const currentTitle = (titleSpan?.textContent || h1?.textContent || 'Tema').trim();
        const newTitle = prompt('Nuevo título para el tema:', currentTitle);
        if (!newTitle || !newTitle.trim()) return false;
        const cleanTitle = newTitle.trim();
        if (titleSpan) {
          titleSpan.textContent = cleanTitle;
        } else if (h1) {
          h1.textContent = cleanTitle;
        }
        page.dataset.topicTitle = cleanTitle;
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        setupMagicIcons();
        scheduleCacheSave();
        return true;
      }

      function moveTopicPage(page) {
        if (!page) return false;
        if (!sections.length) {
          initializeSections();
        }
        if (sections.length <= 1) {
          alert('No hay otras secciones disponibles para mover este tema.');
          return false;
        }

        const currentSection = sections.find(section => section.id === page.dataset.sectionId);
        const options = sections.map((section, idx) => `${idx + 1}. ${section.nombre}${section === currentSection ? ' (actual)' : ''}`).join('\n');
        const choice = prompt(`Mover tema a sección:\n${options}\nEscribe el número o nombre de la sección destino:`, currentSection?.nombre || '');
        if (!choice || !choice.trim()) return false;

        const trimmed = choice.trim().toLowerCase();
        let targetSection = sections.find((section, idx) => String(idx + 1) === trimmed);
        if (!targetSection) {
          targetSection = sections.find(section => section.nombre.toLowerCase() === trimmed);
        }

        if (!targetSection) {
          alert('No se encontró la sección indicada.');
          return false;
        }

        page.dataset.sectionId = targetSection.id;
        page.dataset.sectionName = targetSection.nombre;
        initializeSections();
        buildSectionsPanel();
        scheduleCacheSave();
        return true;
      }

      function deleteTopicPage(page) {
        if (!page) return false;
        const title = getTopicTitle(page) || 'este tema';
        if (!confirm(`¿Eliminar "${title}"?`)) {
          return false;
        }
        detachPageListeners(page);
        page.remove();
        pages = pages.filter(p => p !== page);
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        scheduleCacheSave();
        return true;
      }

      function duplicateTopicPage(page) {
        if (!page) return null;
        const clone = page.cloneNode(true);
        const titleSpan = clone.querySelector('h1 span:first-child');
        if (titleSpan) {
          const currentTitle = titleSpan.textContent.trim();
          titleSpan.textContent = currentTitle ? `${currentTitle} (Copia)` : 'Tema (Copia)';
        }
        const newId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
        clone.dataset.topicId = newId;
        clone.contentEditable = isEditMode ? 'true' : 'false';
        page.parentNode.insertBefore(clone, page.nextSibling);
        pages = [...document.querySelectorAll('.page')];
        attachPageListeners(clone);
        setupMagicIcons();
        io.observe(clone);
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        clone.scrollIntoView({ behavior: 'smooth', block: 'start' });
        scheduleCacheSave();
        return clone;
      }

      topicMenu.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button || !topicMenuContext) return;
        event.preventDefault();
        event.stopPropagation();

        const { page } = topicMenuContext;
        if (!page) {
          hideTopicMenu();
          return;
        }

        switch (button.dataset.action) {
          case 'rename':
            renameTopicPage(page);
            break;
          case 'move':
            moveTopicPage(page);
            break;
          case 'duplicate':
            duplicateTopicPage(page);
            break;
          case 'delete':
            deleteTopicPage(page);
            break;
        }

        hideTopicMenu();
      });

      document.addEventListener('click', (event) => {
        if (topicMenuJustOpened) return;
        if (!topicMenu.contains(event.target)) {
          hideTopicMenu();
        }
      });

      document.addEventListener('scroll', hideTopicMenu, true);
      window.addEventListener('resize', hideTopicMenu);
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          hideTopicMenu();
          hideTemplateToolbar();
          hideImageToolbar();
          tableMenuAPI?.cancelResize();
          tableMenuAPI?.hide();
        }
      });

      /* === ZOOM === */
      function clampZoom(value) {
        return Math.max(MIN_ZOOM_LEVEL, Math.min(MAX_ZOOM_LEVEL, value));
      }

      function applyZoom(value, options = {}) {
        const { skipCache = false, skipPersist = false } = options;
        const clamped = clampZoom(value);
        currentZoom = clamped;
        document.documentElement.style.setProperty('--zoom-level', clamped);
        document.documentElement.style.setProperty('--dynamic-font-size', `${BASE_FONT_SIZE * clamped}px`);
        if (zoomValue) {
          zoomValue.textContent = Math.round(clamped * 100) + '%';
        }
        if (!skipPersist && STORAGE_AVAILABLE) {
          try {
            window.localStorage.setItem(LOCAL_ZOOM_KEY, String(clamped));
          } catch (error) {
            console.warn('No se pudo guardar el nivel de zoom:', error);
          }
        }
        if (!skipCache) {
          scheduleCacheSave({ skipDirtyMark: false });
        }
      }

      function updateZoom(delta) {
        applyZoom(currentZoom + delta);
      }

      zoomInBtn?.addEventListener('click', () => updateZoom(ZOOM_STEP));
      zoomOutBtn?.addEventListener('click', () => updateZoom(-ZOOM_STEP));

      saveCacheBtn?.addEventListener('click', () => {
        if (!STORAGE_AVAILABLE) return;
        persistDocumentToCache({ notify: true });
      });

      /* === UTILIDADES === */
      function saveCurrentSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          savedSelection = selection.getRangeAt(0).cloneRange();
          return true;
        }
        return false;
      }

      function restoreSelection() {
        if (savedSelection) {
          if (!document.contains(savedSelection.startContainer) || !document.contains(savedSelection.endContainer)) {
            savedSelection = null;
            return false;
          }
          const selection = window.getSelection();
          selection.removeAllRanges();
          try {
            selection.addRange(savedSelection);
            return true;
          } catch (err) {
            savedSelection = null;
          }
        }
        return false;
      }

      function ensureEditableSelection() {
        if (restoreSelection()) {
          const restored = window.getSelection();
          if (restored.rangeCount > 0) {
            return restored;
          }
        }

        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          return selection;
        }

        const activeEditable = document.activeElement && document.activeElement.isContentEditable
          ? document.activeElement
          : null;
        const preferredMagic = getCurrentMagicPage();
        const target = activeEditable || preferredMagic || getCurrentPage();
        if (!target) return null;

        const range = document.createRange();
        range.selectNodeContents(target);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
        return selection;
      }

      function insertNodeAtSelection(node) {
        const selection = ensureEditableSelection();
        if (!selection || !selection.rangeCount) return null;
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(node);
        range.setStartAfter(node);
        range.setEndAfter(node);
        selection.removeAllRanges();
        selection.addRange(range);
        savedSelection = null;
        return node;
      }

      function insertHtmlAtSelection(html) {
        const selection = ensureEditableSelection();
        if (!selection || !selection.rangeCount) return null;
        const range = selection.getRangeAt(0);
        range.deleteContents();
        const fragment = range.createContextualFragment(html);
        const nodes = Array.from(fragment.childNodes);
        range.insertNode(fragment);
        const lastNode = nodes[nodes.length - 1];
        if (lastNode) {
          range.setStartAfter(lastNode);
          range.setEndAfter(lastNode);
        }
        selection.removeAllRanges();
        selection.addRange(range);
        savedSelection = null;
        return nodes[0] || null;
      }

      function normalizeColorToHex(color, fallback = '#ffffff') {
        if (!color || color === 'transparent' || color === 'rgba(0, 0, 0, 0)' || color === 'none') {
          return fallback;
        }
        if (color.startsWith('#')) {
          if (color.length === 4) {
            return '#' + color.slice(1).split('').map(ch => ch + ch).join('');
          }
          return color;
        }
        const rgbMatch = color.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
        if (rgbMatch) {
          return '#' + rgbMatch.slice(1, 4).map(value => {
            const hex = parseInt(value, 10).toString(16);
            return hex.length === 1 ? '0' + hex : hex;
          }).join('');
        }
        const temp = document.createElement('div');
        temp.style.color = color;
        document.body.appendChild(temp);
        const computed = window.getComputedStyle(temp).color;
        document.body.removeChild(temp);
        if (computed === color) {
          return fallback;
        }
        return normalizeColorToHex(computed, fallback);
      }

      function parsePxValue(value, fallback = 0) {
        if (!value) return fallback;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? Math.round(parsed) : fallback;
      }

      function createTemplateBlock(template) {
        if (!template) return null;
        const block = document.createElement('div');
        block.className = 'template-block';
        block.dataset.templateBlock = 'true';
        if (template.name) {
          block.dataset.templateName = template.name;
        }
        block.dataset.fontScale = '100';
        block.setAttribute('tabindex', '0');
        const wrapper = document.createElement('div');
        wrapper.innerHTML = template.html;
        while (wrapper.firstChild) {
          block.appendChild(wrapper.firstChild);
        }
        return block;
      }

      function getTemplateTarget(block) {
        if (!block) return null;
        if (block.classList && block.classList.contains('box')) return block;
        return block.querySelector('.box') || block;
      }

      function setPaletteActive(container, value) {
        if (!container) return;
        const normalized = normalizeColorToHex(value || '', '').toLowerCase();
        container.querySelectorAll('.template-color-swatch').forEach(swatch => {
          const swatchValue = normalizeColorToHex(swatch.dataset.value || '', '').toLowerCase();
          swatch.classList.toggle('active', normalized && swatchValue === normalized);
        });
      }

      function updateBorderWidthDataset(block, baseWidth, accentExtra) {
        if (!block) return;
        if (Number.isFinite(baseWidth)) {
          block.dataset.borderWidth = String(baseWidth);
        }
        if (Number.isFinite(accentExtra)) {
          block.dataset.borderAccentExtra = String(accentExtra);
        }
      }

      function createCollapseCardElement() {
        const card = document.createElement('div');
        card.className = 'collapse-card';
        card.innerHTML = `
          <div class="collapse-card-header">
            <span class="collapse-card-title">Título de la tarjeta</span>
            <button type="button" class="collapse-card-toggle" aria-expanded="true"></button>
          </div>
          <div class="collapse-card-body">
            <p>Contenido de la tarjeta colapsable.</p>
          </div>
        `;
        return card;
      }

      function initializeCollapseCards(root) {
        if (!root) return;
        const cards = root.classList && root.classList.contains('collapse-card')
          ? [root]
          : Array.from(root.querySelectorAll('.collapse-card'));
        cards.forEach(card => {
          const toggle = card.querySelector('.collapse-card-toggle');
          if (toggle) {
            toggle.type = 'button';
            toggle.setAttribute('aria-expanded', card.classList.contains('collapsed') ? 'false' : 'true');
          }
          const title = card.querySelector('.collapse-card-title');
          if (title) {
            title.setAttribute('contenteditable', 'true');
          }
        });
      }

      function initPalette(container, colors, onSelect) {
        if (!container) return;
        container.innerHTML = '';
        colors.forEach(color => {
          const swatch = document.createElement('button');
          swatch.type = 'button';
          swatch.className = 'template-color-swatch';
          swatch.style.setProperty('--swatch-color', color);
          swatch.dataset.value = color;
          swatch.addEventListener('click', () => onSelect(color));
          container.appendChild(swatch);
        });
      }

      function applyTemplateBackground(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target) return;
        if (!color || color === 'transparent') {
          target.style.backgroundColor = 'transparent';
          delete selectedTemplateBlock.dataset.bgColor;
          if (templateBgColorInput) {
            templateBgColorInput.value = '#ffffff';
          }
          setPaletteActive(templateBgPalette, '');
        } else {
          target.style.backgroundColor = color;
          selectedTemplateBlock.dataset.bgColor = color;
          if (templateBgColorInput) {
            templateBgColorInput.value = normalizeColorToHex(color, '#ffffff');
          }
          setPaletteActive(templateBgPalette, color);
        }
        repositionTemplateToolbar();
      }

      function applyTemplateTextColor(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target) return;
        if (!color) {
          target.style.color = '';
          delete selectedTemplateBlock.dataset.textColor;
          if (templateTextColorInput) {
            templateTextColorInput.value = '#212529';
          }
          setPaletteActive(templateTextPalette, '');
        } else {
          target.style.color = color;
          selectedTemplateBlock.dataset.textColor = color;
          if (templateTextColorInput) {
            templateTextColorInput.value = normalizeColorToHex(color, '#212529');
          }
          setPaletteActive(templateTextPalette, color);
        }
      }

      function applyTemplateBorderColor(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target || !target.classList.contains('box')) return;
        const normalized = color || '#ced4da';
        target.style.borderStyle = 'solid';
        target.style.borderColor = normalized;
        selectedTemplateBlock.dataset.borderColor = normalized;
        if (templateBorderColorInput) {
          templateBorderColorInput.value = normalizeColorToHex(normalized, '#ced4da');
        }
        setPaletteActive(templateBorderPalette, normalized);
        if (selectedTemplateBlock.dataset.accentColor) {
          target.style.borderLeftColor = selectedTemplateBlock.dataset.accentColor;
        }
        updateTemplateToolbarState(selectedTemplateBlock);
      }

      function applyTemplateAccentColor(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target || !target.classList.contains('box')) return;
        const normalized = color || selectedTemplateBlock.dataset.borderColor || '#0d6efd';
        target.style.borderLeftColor = normalized;
        selectedTemplateBlock.dataset.accentColor = normalized;
        if (templateAccentColorInput) {
          templateAccentColorInput.value = normalizeColorToHex(normalized, '#0d6efd');
        }
        setPaletteActive(templateAccentPalette, normalized);
        updateTemplateToolbarState(selectedTemplateBlock);
      }

      function updateTemplateToolbarState(block) {
        if (!block || !templateToolbar) return;
        const target = getTemplateTarget(block);
        const computed = window.getComputedStyle(target || block);
        const isNote = target && target.classList && target.classList.contains('box');

        if (templateBgColorInput) {
          const bgValue = block.dataset.bgColor || target?.style.backgroundColor || computed.backgroundColor;
          const normalizedBg = bgValue === 'transparent' ? '#ffffff' : normalizeColorToHex(bgValue, '#ffffff');
          templateBgColorInput.value = normalizedBg;
          setPaletteActive(templateBgPalette, bgValue === 'transparent' ? '' : normalizedBg);
        }

        if (templateTextColorInput) {
          const textValue = block.dataset.textColor || target?.style.color || computed.color;
          const normalizedText = normalizeColorToHex(textValue, '#212529');
          templateTextColorInput.value = normalizedText;
          setPaletteActive(templateTextPalette, normalizedText);
        }

        if (templateFontSizeSlider && templateFontSizeDisplay) {
          const fontScale = parseInt(block.dataset.fontScale || '100', 10) || 100;
          templateFontSizeSlider.value = fontScale;
          templateFontSizeDisplay.textContent = fontScale + '%';
        }

        if (templateMarginTopSlider && templateMarginTopDisplay) {
          const topMax = parseInt(templateMarginTopSlider.max || '120', 10);
          let marginTop = block.dataset.marginTop !== undefined
            ? parseInt(block.dataset.marginTop, 10)
            : parsePxValue(block.style.marginTop || computed.marginTop, 0);
          marginTop = Number.isFinite(marginTop) ? Math.max(0, Math.min(topMax, marginTop)) : 0;
          templateMarginTopSlider.value = marginTop;
          templateMarginTopDisplay.textContent = marginTop + 'px';
        }

        if (templateMarginBottomSlider && templateMarginBottomDisplay) {
          const bottomMax = parseInt(templateMarginBottomSlider.max || '120', 10);
          let marginBottom = block.dataset.marginBottom !== undefined
            ? parseInt(block.dataset.marginBottom, 10)
            : parsePxValue(block.style.marginBottom || computed.marginBottom, 0);
          marginBottom = Number.isFinite(marginBottom) ? Math.max(0, Math.min(bottomMax, marginBottom)) : 0;
          templateMarginBottomSlider.value = marginBottom;
          templateMarginBottomDisplay.textContent = marginBottom + 'px';
        }

        if (templateBorderWidthSlider && templateBorderWidthDisplay) {
          if (!isNote) {
            templateBorderWidthSlider.disabled = true;
            templateBorderWidthDisplay.textContent = '—';
          } else {
            templateBorderWidthSlider.disabled = false;
            const sliderMax = parseInt(templateBorderWidthSlider.max || '12', 10);
            const sliderMin = parseInt(templateBorderWidthSlider.min || '0', 10);
            const storedWidth = block.dataset.borderWidth !== undefined ? parseInt(block.dataset.borderWidth, 10) : null;
            const baseWidth = Number.isFinite(storedWidth)
              ? storedWidth
              : parsePxValue(target.style.borderTopWidth || computed.borderTopWidth, 1);
            const leftWidth = parsePxValue(target.style.borderLeftWidth || computed.borderLeftWidth, baseWidth);
            const accentExtraStored = block.dataset.borderAccentExtra !== undefined ? parseInt(block.dataset.borderAccentExtra, 10) : null;
            const accentExtra = Number.isFinite(accentExtraStored)
              ? accentExtraStored
              : Math.max(0, leftWidth - baseWidth);
            const clampedWidth = Math.max(sliderMin, Math.min(sliderMax, baseWidth));
            templateBorderWidthSlider.value = clampedWidth;
            templateBorderWidthDisplay.textContent = baseWidth + 'px';
            updateBorderWidthDataset(block, baseWidth, accentExtra);
          }
        }

        if (templateBorderColorRow) {
          templateBorderColorRow.style.display = isNote ? 'flex' : 'none';
        }

        if (templateBorderColorInput) {
          const borderValue = block.dataset.borderColor || target?.style.borderTopColor || computed.borderTopColor;
          const normalizedBorder = normalizeColorToHex(borderValue, '#ced4da');
          templateBorderColorInput.value = normalizedBorder;
          setPaletteActive(templateBorderPalette, normalizedBorder);
        }

        if (templateAccentColorRow) {
          const borderTopColor = normalizeColorToHex(target?.style.borderTopColor || computed.borderTopColor, '#ced4da');
          const borderLeftColor = normalizeColorToHex(block.dataset.accentColor || target?.style.borderLeftColor || computed.borderLeftColor, borderTopColor);
          const accentExtra = parseInt(block.dataset.borderAccentExtra || '0', 10);
          const shouldShowAccent = isNote && (borderLeftColor !== borderTopColor || accentExtra > 0);
          templateAccentColorRow.style.display = shouldShowAccent ? 'flex' : 'none';
          if (templateAccentColorInput) {
            templateAccentColorInput.value = normalizeColorToHex(borderLeftColor, borderTopColor);
            setPaletteActive(templateAccentPalette, borderLeftColor);
          }
          if (shouldShowAccent && !block.dataset.accentColor) {
            block.dataset.accentColor = borderLeftColor;
          } else if (!shouldShowAccent) {
            delete block.dataset.accentColor;
          }
        }
      }

      function updateTemplateToolbarPosition(block) {
        if (!templateToolbar || !block) return;
        templateToolbar.classList.add('show');
        const rect = block.getBoundingClientRect();
        const toolbarWidth = templateToolbar.offsetWidth || 260;
        const toolbarHeight = templateToolbar.offsetHeight || 220;

        let left = rect.right + 12;
        let top = rect.top;

        if (left + toolbarWidth > window.innerWidth - 10) {
          left = rect.left - toolbarWidth - 12;
        }

        if (left < 10) {
          left = 10;
        }

        if (top + toolbarHeight > window.innerHeight - 10) {
          top = window.innerHeight - toolbarHeight - 10;
        }

        if (top < 10) {
          top = 10;
        }

        templateToolbar.style.left = left + 'px';
        templateToolbar.style.top = top + 'px';
      }

      function repositionTemplateToolbar() {
        if (selectedTemplateBlock) {
          updateTemplateToolbarPosition(selectedTemplateBlock);
        }
      }

      function showTemplateToolbar(block) {
        if (!templateToolbar || !block) return;
        if (selectedTemplateBlock && selectedTemplateBlock !== block) {
          selectedTemplateBlock.classList.remove('selected-template');
        }
        hideImageToolbar();
        selectedTemplateBlock = block;
        block.classList.add('selected-template');
        updateTemplateToolbarState(block);
        updateTemplateToolbarPosition(block);
      }

      function hideTemplateToolbar() {
        if (selectedTemplateBlock) {
          selectedTemplateBlock.classList.remove('selected-template');
          selectedTemplateBlock = null;
        }
        if (templateToolbar) {
          templateToolbar.classList.remove('show');
        }
      }

      function sanitizeCitations(el) {
        if (!el) return;
        const patterns = [
          /\[(?:cite(?:_start|_end)?|refs?|reference)\b[^\]]*\]/gi,
          /\((?:\s*\[?(?:cite|ref)[^\)]*\)?)+\)/gi
        ];
        let html = el.innerHTML;
        patterns.forEach(re => {
          html = html.replace(re, '');
        });
        el.innerHTML = html;
      }

      function purgeUnwantedNotes(root) {
        if (!root) return;
        root.querySelectorAll('.box, p').forEach(node => {
          const t = node.textContent || '';
          if (/^\s*nota:\s*/i.test(t)) {
            node.textContent = t.replace(/^\s*nota:\s*/i, '');
          }
        });
        const kill = /basarse en guías chilenas e internacionales|manejo inicial es universal/i;
        root.querySelectorAll('.box,p,li').forEach(node => {
          if (kill.test(node.textContent || '')) {
            node.remove();
          }
        });
      }

      function normalizePearls(root) {
        if (!root) return;
        root.querySelectorAll('.box').forEach(node => {
          const t = (node.textContent || '').toLowerCase();
          if (/\bperla\b/.test(t)) {
            node.classList.add('pearl');
          }
        });
      }

      function afterContentSanitize(root) {
        sanitizeCitations(root);
        purgeUnwantedNotes(root);
        normalizePearls(root);
        initializeCollapseCards(root);
      }

      function countWords(html) {
        return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim().split(' ').filter(Boolean).length;
      }

      function getCurrentPage() {
        const viewportCenter = window.scrollY + window.innerHeight / 2;
        return pages.find(p => {
          const rect = p.getBoundingClientRect();
          const pageTop = rect.top + window.scrollY;
          const pageBottom = pageTop + rect.height;
          return viewportCenter >= pageTop && viewportCenter <= pageBottom;
        }) || pages[0];
      }

      function getCurrentMagicPage() {
        return document.querySelector('.magic-page[contenteditable="true"]');
      }

      /* === HABILITAR PEGADO DE HTML === */
      function enableHtmlPaste() {
        const editableElements = document.querySelectorAll('[contenteditable="true"]');
        editableElements.forEach(el => {
          if (el.dataset.pasteHandlerBound === 'true') return;
          el.addEventListener('paste', (e) => {
            const clipboardData = e.clipboardData;
            if (!clipboardData) return;

            const items = Array.from(clipboardData.items || []);
            const imageItems = items.filter(item => item.type && item.type.startsWith('image/'));

            if (imageItems.length) {
              e.preventDefault();
              const currentSelection = window.getSelection();
              const baseRange = currentSelection && currentSelection.rangeCount
                ? currentSelection.getRangeAt(0).cloneRange()
                : null;

              imageItems.forEach(item => {
                const file = item.getAsFile();
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                  const dataUrl = event.target?.result;
                  if (!dataUrl) return;

                  const selection = window.getSelection();
                  const range = baseRange ? baseRange.cloneRange() : selection?.getRangeAt(0)?.cloneRange();
                  if (!range) return;

                  range.deleteContents();

                  const img = document.createElement('img');
                  img.src = typeof dataUrl === 'string' ? dataUrl : '';
                  range.insertNode(img);

                  range.setStartAfter(img);
                  range.collapse(true);
                  const sel = window.getSelection();
                  if (!sel) return;
                  sel.removeAllRanges();
                  sel.addRange(range);
                  if (baseRange) {
                    baseRange.setStartAfter(img);
                    baseRange.collapse(true);
                  }
                };
                reader.readAsDataURL(file);
              });
              return;
            }

            e.preventDefault();
            const html = clipboardData.getData('text/html') || clipboardData.getData('text/plain');
            document.execCommand('insertHTML', false, html);
          });
          el.dataset.pasteHandlerBound = 'true';
        });
      }

      /* === TABLAS === */
      function wrapTableIfNeeded(table) {
        if (!table) return null;
        let wrapper = table.closest('.table-wrap');
        if (!wrapper) {
          wrapper = document.createElement('div');
          wrapper.className = 'table-wrap';
          table.parentNode?.insertBefore(wrapper, table);
          wrapper.appendChild(table);
        }
        wrapper.classList.add('table-resize-wrapper');
        if (getComputedStyle(wrapper).position === 'static') {
          wrapper.style.position = 'relative';
        }
        return wrapper;
      }

      function makeTableResizable(table) {
        if (!table) return null;

        if (tableResizers.has(table)) {
          return tableResizers.get(table);
        }

        const wrapper = wrapTableIfNeeded(table);
        if (!wrapper) return null;

        let handle = wrapper.querySelector('.table-resize-handle');
        if (!handle) {
          handle = document.createElement('div');
          handle.className = 'table-resize-handle';
          wrapper.appendChild(handle);
        }

        const state = {
          active: false,
          mode: null,
          startX: 0,
          startY: 0,
          startTableWidth: 0,
          startTableHeight: 0,
          originalWidthStyle: table.style.width,
          originalHeightStyle: table.style.height,
          columnCells: [],
          rowCells: [],
          startColumnStyles: [],
          startRowStyles: [],
          callbacks: null,
          cleanup: null
        };

        const threshold = 8;

        function exitResizeMode() {
          wrapper.classList.remove('table-resize-mode');
          wrapper.classList.remove('table-resize-active');
          table.classList.remove('table-resize-ready');
          table.style.cursor = '';
          document.body.style.userSelect = '';
          document.body.classList.remove('table-resizing');
          if (tableResizeOverlay) {
            tableResizeOverlay.classList.remove('show');
          }
        }

        function restoreOriginalDimensions() {
          if (state.mode === 'table') {
            table.style.width = state.originalWidthStyle;
            table.style.height = state.originalHeightStyle;
          } else if (state.mode === 'column') {
            state.columnCells.forEach((cell, index) => {
              const info = state.startColumnStyles[index];
              if (!info) return;
              cell.style.width = info.width;
              cell.style.minWidth = info.minWidth;
            });
          } else if (state.mode === 'row') {
            state.rowCells.forEach((cell, index) => {
              const info = state.startRowStyles[index];
              if (!info) return;
              cell.style.height = info.height;
              cell.style.minHeight = info.minHeight;
            });
          }
        }

        function finishResize(cancelled) {
          if (state.cleanup) {
            state.cleanup();
            state.cleanup = null;
          }

          const callbacks = state.callbacks;
          state.active = false;
          const mode = state.mode;
          state.mode = null;
          state.columnCells = [];
          state.rowCells = [];
          state.startColumnStyles = [];
          state.startRowStyles = [];

          if (cancelled) {
            restoreOriginalDimensions();
          } else if (mode === 'table') {
            state.originalWidthStyle = table.style.width;
            state.originalHeightStyle = table.style.height;
          }

          exitResizeMode();

          if (callbacks) {
            if (cancelled) {
              callbacks.onCancel?.();
            } else {
              callbacks.onFinish?.();
            }
          }
        }

        function applyColumnResize(deltaX) {
          if (!state.columnCells.length) return;
          const baseWidth = state.startColumnStyles[0]?.numericWidth || state.columnCells[0].offsetWidth;
          const newWidth = Math.max(40, baseWidth + deltaX);
          state.columnCells.forEach(cell => {
            cell.style.width = newWidth + 'px';
            cell.style.minWidth = newWidth + 'px';
          });
        }

        function applyRowResize(deltaY) {
          if (!state.rowCells.length) return;
          const baseHeight = state.startRowStyles[0]?.numericHeight || state.rowCells[0].offsetHeight;
          const newHeight = Math.max(24, baseHeight + deltaY);
          state.rowCells.forEach(cell => {
            cell.style.height = newHeight + 'px';
            cell.style.minHeight = newHeight + 'px';
          });
        }

        function applyTableResize(deltaX, deltaY) {
          const newWidth = Math.max(160, state.startTableWidth + deltaX);
          const newHeight = Math.max(80, state.startTableHeight + deltaY);
          table.style.width = newWidth + 'px';
          table.style.height = newHeight + 'px';
          table.dataset.tableWidth = String(newWidth);
          table.dataset.tableHeight = String(newHeight);
        }

        function onMouseMove(event) {
          if (!state.active) return;
          if (state.mode === 'column') {
            applyColumnResize(event.clientX - state.startX);
          } else if (state.mode === 'row') {
            applyRowResize(event.clientY - state.startY);
          } else {
            applyTableResize(event.clientX - state.startX, event.clientY - state.startY);
          }
        }

        function onMouseUp() {
          finishResize(false);
        }

        function onKeyDown(event) {
          if (event.key === 'Escape') {
            finishResize(true);
          }
        }

        function startResize(mode, cell, event) {
          if (!isEditMode) return;
          event.preventDefault();

          state.active = true;
          state.mode = mode;
          state.startX = event.clientX;
          state.startY = event.clientY;
          state.originalWidthStyle = table.style.width;
          state.originalHeightStyle = table.style.height;
          state.columnCells = [];
          state.rowCells = [];
          state.startColumnStyles = [];
          state.startRowStyles = [];

          if (mode === 'column' && cell) {
            const index = cell.cellIndex;
            const columnCells = Array.from(table.rows).map(row => row.cells[index]).filter(Boolean);
            state.columnCells = columnCells;
            state.startColumnStyles = columnCells.map(colCell => ({
              width: colCell.style.width,
              minWidth: colCell.style.minWidth,
              numericWidth: colCell.offsetWidth
            }));
          } else if (mode === 'row' && cell) {
            const rowCells = Array.from(cell.parentElement?.cells || []);
            state.rowCells = rowCells;
            state.startRowStyles = rowCells.map(rowCell => ({
              height: rowCell.style.height,
              minHeight: rowCell.style.minHeight,
              numericHeight: rowCell.offsetHeight
            }));
          } else {
            state.startTableWidth = table.offsetWidth;
            state.startTableHeight = table.offsetHeight;
          }

          wrapper.classList.add('table-resize-active');
          if (tableResizeOverlay) {
            tableResizeOverlay.classList.add('show');
          }
          document.body.style.userSelect = 'none';
          document.body.classList.add('table-resizing');

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp, { once: true });
          document.addEventListener('keydown', onKeyDown);

          state.cleanup = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('keydown', onKeyDown);
            document.removeEventListener('mouseup', onMouseUp);
          };
        }

        function handleTableMouseMove(event) {
          if (state.active) return;
          const cell = event.target.closest('th,td');
          if (!cell) {
            table.style.cursor = '';
            return;
          }
          const rect = cell.getBoundingClientRect();
          const offsetX = event.clientX - rect.left;
          const offsetY = event.clientY - rect.top;
          const nearRight = rect.width - offsetX <= threshold;
          const nearBottom = rect.height - offsetY <= threshold;

          if (nearRight && nearBottom) {
            table.style.cursor = 'nwse-resize';
          } else if (nearRight) {
            table.style.cursor = 'col-resize';
          } else if (nearBottom) {
            table.style.cursor = 'row-resize';
          } else {
            table.style.cursor = '';
          }
        }

        function handleTableMouseDown(event) {
          if (!isEditMode || event.button !== 0) return;
          const cell = event.target.closest('th,td');
          if (!cell) return;
          const rect = cell.getBoundingClientRect();
          const offsetX = event.clientX - rect.left;
          const offsetY = event.clientY - rect.top;
          const nearRight = rect.width - offsetX <= threshold;
          const nearBottom = rect.height - offsetY <= threshold;

          if (nearRight || nearBottom) {
            startResize(nearRight ? 'column' : 'row', cell, event);
          }
        }

        handle.addEventListener('mousedown', (event) => {
          if (event.button !== 0) return;
          startResize('table', null, event);
        });

        table.addEventListener('mousemove', handleTableMouseMove);
        table.addEventListener('mouseleave', () => {
          if (!state.active) {
            table.style.cursor = '';
          }
        });
        table.addEventListener('mousedown', handleTableMouseDown);

        const controller = {
          activate(callbacks = {}) {
            state.callbacks = callbacks;
            wrapper.classList.add('table-resize-mode');
            table.classList.add('table-resize-ready');
            return controller;
          },
          cancel() {
            if (state.active) {
              finishResize(true);
            } else {
              state.callbacks = null;
              exitResizeMode();
            }
            return controller;
          },
          isActive() {
            return state.active;
          }
        };

        tableResizers.set(table, controller);
        return controller;
      }

      function initializeTableMenu() {
        if (!tableMenu) return null;

        let selectedTable = null;
        let selectedCell = null;
        let highlightedColumnIndex = null;
        let currentResizer = null;

        const actionButtons = Array.from(tableMenu.querySelectorAll('[data-action]'));

        function hideMenu(options = {}) {
          tableMenu.classList.remove('show');
          tableMenu.setAttribute('aria-hidden', 'true');
          if (!options.preserveSelection) {
            if (selectedTable) {
              selectedTable.classList.remove('table-menu-selected');
            }
            clearColumnHighlight();
            selectedTable = null;
            selectedCell = null;
          }
        }

        function showMenu(table, cell) {
          if (!isEditMode || !table) return;
          if (!table.closest('[contenteditable="true"]')) return;
          if (selectedTable && selectedTable !== table) {
            selectedTable.classList.remove('table-menu-selected');
            clearColumnHighlight();
          }
          selectedTable = table;
          if (cell) {
            selectedCell = cell;
          } else if (!selectedCell || !selectedTable.contains(selectedCell)) {
            selectedCell = selectedTable.querySelector('td,th');
          }

          if (selectedTable) {
            selectedTable.classList.add('table-menu-selected');
          }

          updateMenuState();
          tableMenu.classList.add('show');
          tableMenu.setAttribute('aria-hidden', 'false');
        }

        function clearColumnHighlight() {
          if (!selectedTable) return;
          if (highlightedColumnIndex == null) return;
          Array.from(selectedTable.rows).forEach(row => {
            const cell = row.cells[highlightedColumnIndex];
            if (cell) cell.classList.remove('table-column-highlight');
          });
          highlightedColumnIndex = null;
        }

        function highlightColumn(index) {
          clearColumnHighlight();
          if (index == null || !selectedTable) return;
          Array.from(selectedTable.rows).forEach(row => {
            const cell = row.cells[index];
            if (cell) cell.classList.add('table-column-highlight');
          });
          highlightedColumnIndex = index;
        }

        function ensureTableDefaults(table) {
          if (!table.dataset.lineHeight) table.dataset.lineHeight = '1.25';
          if (!table.dataset.paddingY) table.dataset.paddingY = '4';
          if (!table.dataset.tableMargin) table.dataset.tableMargin = '6';
          if (!table.dataset.borderColor) table.dataset.borderColor = '#dee2e6';
          if (!table.dataset.borderWidth) table.dataset.borderWidth = '1';
          if (!table.dataset.hideVerticalBorders) table.dataset.hideVerticalBorders = 'false';
          if (!table.dataset.hideHorizontalBorders) table.dataset.hideHorizontalBorders = 'false';
        }

        function countColumns(table) {
          return Array.from(table.rows).reduce((max, row) => Math.max(max, row.cells.length), 0);
        }

        function countRows(table) {
          return Array.from(table.rows).length;
        }

        function updateSizeDisplay() {
          if (!selectedTable) return;
          const rows = countRows(selectedTable);
          const cols = countColumns(selectedTable);
          tableMenuSize.textContent = `${rows} × ${cols}`;
        }

        function applySpacing() {
          if (!selectedTable) return;
          const lineHeight = parseFloat(selectedTable.dataset.lineHeight || '1.25');
          const paddingY = parseInt(selectedTable.dataset.paddingY || '4', 10);
          const margin = parseInt(selectedTable.dataset.tableMargin || '6', 10);
          const cells = selectedTable.querySelectorAll('th,td');
          cells.forEach(cell => {
            cell.style.lineHeight = lineHeight.toString();
            cell.style.paddingTop = paddingY + 'px';
            cell.style.paddingBottom = paddingY + 'px';
          });
          selectedTable.style.marginTop = margin + 'px';
          selectedTable.style.marginBottom = margin + 'px';
          selectedTable.style.marginLeft = margin + 'px';
          selectedTable.style.marginRight = margin + 'px';
        }

        function updateSpacingControls() {
          if (!selectedTable) return;
          tableLineHeightInput.value = selectedTable.dataset.lineHeight || '1.25';
          tablePaddingYInput.value = selectedTable.dataset.paddingY || '4';
          tableMarginInput.value = selectedTable.dataset.tableMargin || '6';
          tableLineHeightValue.textContent = parseFloat(tableLineHeightInput.value).toFixed(2);
          tablePaddingYValue.textContent = `${tablePaddingYInput.value}px`;
          tableMarginValue.textContent = `${tableMarginInput.value}px`;
        }

        function updateThemeButtons() {
          if (!selectedTable) return;
          const currentTheme = selectedTable.dataset.themeClass || '';
          tableThemeButtons.forEach(btn => {
            const theme = btn.dataset.tableTheme || '';
            btn.classList.toggle('active', theme === currentTheme);
          });
        }

        function applyTheme(themeClass) {
          if (!selectedTable) return;
          const previous = selectedTable.dataset.themeClass;
          if (previous) {
            selectedTable.classList.remove(previous);
          }
          if (themeClass) {
            selectedTable.classList.add(themeClass);
            selectedTable.dataset.themeClass = themeClass;
          } else {
            delete selectedTable.dataset.themeClass;
          }
          updateThemeButtons();
        }

        const spacingPresets = {
          compacta: { lineHeight: 1.15, paddingY: 3, margin: 4 },
          equilibrada: { lineHeight: 1.3, paddingY: 5, margin: 8 },
          amplia: { lineHeight: 1.5, paddingY: 8, margin: 12 }
        };

        function updatePresetButtons() {
          if (!selectedTable) return;
          const current = {
            lineHeight: parseFloat(selectedTable.dataset.lineHeight || '1.25'),
            paddingY: parseInt(selectedTable.dataset.paddingY || '4', 10),
            margin: parseInt(selectedTable.dataset.tableMargin || '6', 10)
          };
          tablePresetButtons.forEach(btn => {
            const preset = spacingPresets[btn.dataset.tablePreset];
            if (!preset) {
              btn.classList.remove('active');
              return;
            }
            const isMatch = Math.abs(preset.lineHeight - current.lineHeight) < 0.01
              && preset.paddingY === current.paddingY
              && preset.margin === current.margin;
            btn.classList.toggle('active', isMatch);
          });
        }

        function applySpacingPreset(key) {
          const preset = spacingPresets[key];
          if (!preset || !selectedTable) return;
          selectedTable.dataset.lineHeight = preset.lineHeight.toString();
          selectedTable.dataset.paddingY = preset.paddingY.toString();
          selectedTable.dataset.tableMargin = preset.margin.toString();
          applySpacing();
          updateSpacingControls();
          updatePresetButtons();
        }

        function applyBorderStyles() {
          if (!selectedTable) return;
          const color = selectedTable.dataset.borderColor || '#dee2e6';
          const width = parseFloat(selectedTable.dataset.borderWidth || '1');
          const hideVertical = selectedTable.dataset.hideVerticalBorders === 'true';
          const hideHorizontal = selectedTable.dataset.hideHorizontalBorders === 'true';
          const cells = selectedTable.querySelectorAll('th,td');

          selectedTable.style.borderColor = color;
          selectedTable.style.borderWidth = width + 'px';
          selectedTable.style.borderStyle = 'solid';

          cells.forEach(cell => {
            cell.style.borderColor = color;
            cell.style.borderStyle = 'solid';
            cell.style.borderWidth = width + 'px';
            cell.style.borderLeftWidth = hideVertical ? '0px' : width + 'px';
            cell.style.borderRightWidth = hideVertical ? '0px' : width + 'px';
            cell.style.borderTopWidth = hideHorizontal ? '0px' : width + 'px';
            cell.style.borderBottomWidth = hideHorizontal ? '0px' : width + 'px';
          });
        }

        function updateBorderControls() {
          if (!selectedTable) return;
          const color = selectedTable.dataset.borderColor || '#dee2e6';
          const width = selectedTable.dataset.borderWidth || '1';
          const hideVertical = selectedTable.dataset.hideVerticalBorders === 'true';
          const hideHorizontal = selectedTable.dataset.hideHorizontalBorders === 'true';

          tableBorderColorButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.borderColor === color);
          });
          if (tableBorderColorCustom) {
            tableBorderColorCustom.value = color;
          }
          tableBorderWidthInput.value = width;
          tableBorderWidthValue.textContent = `${width}px`;
          toggleVerticalBorders.checked = hideVertical;
          toggleHorizontalBorders.checked = hideHorizontal;
        }

        function updateStatefulButtons() {
          actionButtons.forEach(btn => {
            if (!btn.dataset.stateful) return;
            if (!selectedTable) {
              btn.classList.remove('active');
              return;
            }
            const action = btn.dataset.action;
            if (action === 'toggle-header') {
              const hasHeader = !!selectedTable.tHead;
              btn.classList.toggle('active', hasHeader);
            }
            if (action === 'toggle-zebra') {
              const isZebra = selectedTable.classList.contains('table-zebra');
              btn.classList.toggle('active', isZebra);
            }
          });
        }

        function updateMenuState() {
          if (!selectedTable) return;
          ensureTableDefaults(selectedTable);
          updateSizeDisplay();
          updateSpacingControls();
          updatePresetButtons();
          updateThemeButtons();
          updateBorderControls();
          updateStatefulButtons();
          applySpacing();
          applyBorderStyles();
        }

        function ensureCellContext() {
          if (!selectedCell || !selectedTable || !selectedTable.contains(selectedCell)) {
            selectedCell = selectedTable?.querySelector('td,th') || null;
          }
          return selectedCell;
        }

        function insertRow(relativePosition) {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const row = cell.parentElement;
          if (!row) return;
          const section = row.parentElement;
          const columnCount = countColumns(selectedTable) || row.cells.length;
          const isHeader = section?.tagName === 'THEAD';
          const newRow = document.createElement('tr');
          for (let i = 0; i < columnCount; i++) {
            const newCell = document.createElement(isHeader ? 'th' : 'td');
            newCell.innerHTML = '<br>';
            newRow.appendChild(newCell);
          }
          if (relativePosition === 'before') {
            row.parentElement?.insertBefore(newRow, row);
          } else {
            row.parentElement?.insertBefore(newRow, row.nextSibling);
          }
          selectedCell = newRow.cells[cell.cellIndex] || newRow.cells[0] || selectedCell;
        }

        function deleteRow() {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const row = cell.parentElement;
          if (!row) return;
          const section = row.parentElement;
          const isBody = section?.tagName === 'TBODY';
          const isHeader = section?.tagName === 'THEAD';

          if (isHeader) {
            const thead = selectedTable.tHead;
            if (!thead) return;
            if (thead.rows.length <= 1) {
              thead.remove();
            } else {
              row.remove();
            }
          } else if (isBody) {
            const tbody = section;
            if (tbody && tbody.rows.length <= 1) return;
            row.remove();
          } else {
            row.remove();
          }
          selectedCell = selectedTable.querySelector('td,th');
        }

        function insertColumn(position) {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const index = cell.cellIndex;
          const rows = Array.from(selectedTable.rows);
          rows.forEach(row => {
            const tag = row.parentElement?.tagName === 'THEAD' ? 'th' : 'td';
            const newCell = document.createElement(tag);
            newCell.innerHTML = '<br>';
            const reference = row.cells[index] || null;
            if (position === 'left') {
              row.insertBefore(newCell, reference);
            } else {
              if (reference) {
                row.insertBefore(newCell, reference.nextSibling);
              } else {
                row.appendChild(newCell);
              }
            }
          });
        }

        function deleteColumn() {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const index = cell.cellIndex;
          const columnCount = countColumns(selectedTable);
          if (columnCount <= 1) return;
          Array.from(selectedTable.rows).forEach(row => {
            const target = row.cells[index];
            if (target) target.remove();
          });
          selectedCell = selectedTable.querySelector('td,th');
          clearColumnHighlight();
        }

        function clearColumn() {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const index = cell.cellIndex;
          Array.from(selectedTable.rows).forEach(row => {
            const target = row.cells[index];
            if (target) target.innerHTML = '<br>';
          });
        }

        function toggleHeaderRow() {
          if (!selectedTable) return;
          if (selectedTable.tHead) {
            const headerRow = selectedTable.tHead.rows[0];
            if (headerRow) {
              const tbody = selectedTable.tBodies[0] || selectedTable.createTBody();
              const bodyRow = document.createElement('tr');
              Array.from(headerRow.cells).forEach(th => {
                const td = document.createElement('td');
                td.innerHTML = th.innerHTML;
                td.style.cssText = th.style.cssText;
                bodyRow.appendChild(td);
              });
              tbody.insertBefore(bodyRow, tbody.firstChild || null);
              selectedCell = bodyRow.cells[0] || null;
            }
            selectedTable.tHead.remove();
            selectedTable.dataset.headerRow = 'false';
          } else {
            const tbody = selectedTable.tBodies[0];
            if (!tbody || !tbody.rows.length) return;
            const firstRow = tbody.rows[0];
            const thead = selectedTable.createTHead();
            const headerRow = document.createElement('tr');
            Array.from(firstRow.cells).forEach(td => {
              const th = document.createElement('th');
              th.innerHTML = td.innerHTML;
              th.style.cssText = td.style.cssText;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            firstRow.remove();
            selectedCell = headerRow.cells[0] || null;
            selectedTable.dataset.headerRow = 'true';
          }
        }

        function toggleZebra() {
          if (!selectedTable) return;
          const isActive = selectedTable.classList.toggle('table-zebra');
          selectedTable.dataset.zebra = isActive ? 'true' : 'false';
        }

        function selectColumn() {
          const cell = ensureCellContext();
          if (!cell) return;
          highlightColumn(cell.cellIndex);
        }

        function openTools() {
          if (!selectedTable) return;
          const event = new CustomEvent('tableMenu:tools', { detail: { table: selectedTable } });
          document.dispatchEvent(event);
        }

        function handleAction(action) {
          switch (action) {
            case 'insert-row-above':
              insertRow('before');
              break;
            case 'insert-row-below':
              insertRow('after');
              break;
            case 'delete-row':
              deleteRow();
              break;
            case 'insert-column-left':
              insertColumn('left');
              break;
            case 'insert-column-right':
              insertColumn('right');
              break;
            case 'delete-column':
              deleteColumn();
              break;
            case 'clear-column':
              clearColumn();
              break;
            case 'toggle-header':
              toggleHeaderRow();
              break;
            case 'toggle-zebra':
              toggleZebra();
              break;
            case 'select-column':
              selectColumn();
              break;
            case 'open-tools':
              openTools();
              break;
          }
          updateMenuState();
        }

        actionButtons.forEach(btn => {
          btn.addEventListener('click', () => handleAction(btn.dataset.action));
        });

        tableMenuTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            if (tab.classList.contains('active')) return;
            tableMenuTabs.forEach(t => {
              t.classList.toggle('active', t === tab);
              t.setAttribute('aria-selected', t === tab ? 'true' : 'false');
            });
            const target = tab.dataset.tab;
            tableMenuPanels.forEach(panel => {
              panel.classList.toggle('active', panel.dataset.panel === target);
            });
          });
        });

        tableThemeButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            applyTheme(btn.dataset.tableTheme || '');
          });
        });

        tableLineHeightInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.lineHeight = tableLineHeightInput.value;
          tableLineHeightValue.textContent = parseFloat(tableLineHeightInput.value).toFixed(2);
          applySpacing();
        });

        tablePaddingYInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.paddingY = tablePaddingYInput.value;
          tablePaddingYValue.textContent = `${tablePaddingYInput.value}px`;
          applySpacing();
        });

        tableMarginInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.tableMargin = tableMarginInput.value;
          tableMarginValue.textContent = `${tableMarginInput.value}px`;
          applySpacing();
        });

        tablePresetButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            applySpacingPreset(btn.dataset.tablePreset);
          });
        });

        tableBorderColorButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (!selectedTable) return;
            selectedTable.dataset.borderColor = btn.dataset.borderColor || '#dee2e6';
            updateBorderControls();
            applyBorderStyles();
          });
        });

        tableBorderColorCustom?.addEventListener('input', () => {
          if (!selectedTable || !tableBorderColorCustom) return;
          selectedTable.dataset.borderColor = tableBorderColorCustom.value;
          updateBorderControls();
          applyBorderStyles();
        });

        tableBorderWidthInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.borderWidth = tableBorderWidthInput.value;
          tableBorderWidthValue.textContent = `${tableBorderWidthInput.value}px`;
          applyBorderStyles();
        });

        toggleVerticalBorders?.addEventListener('change', () => {
          if (!selectedTable) return;
          selectedTable.dataset.hideVerticalBorders = toggleVerticalBorders.checked ? 'true' : 'false';
          applyBorderStyles();
        });

        toggleHorizontalBorders?.addEventListener('change', () => {
          if (!selectedTable) return;
          selectedTable.dataset.hideHorizontalBorders = toggleHorizontalBorders.checked ? 'true' : 'false';
          applyBorderStyles();
        });

        tableBorderResetBtn?.addEventListener('click', () => {
          if (!selectedTable) return;
          selectedTable.dataset.borderColor = '#dee2e6';
          selectedTable.dataset.borderWidth = '1';
          selectedTable.dataset.hideVerticalBorders = 'false';
          selectedTable.dataset.hideHorizontalBorders = 'false';
          updateBorderControls();
          applyBorderStyles();
        });

        tableMenuClose?.addEventListener('click', () => hideMenu());

        tableResizeBtn?.addEventListener('click', () => {
          if (!selectedTable) return;
          currentResizer = makeTableResizable(selectedTable);
          currentResizer?.activate({
            onFinish: () => {
              currentResizer = null;
              showMenu(selectedTable, selectedCell);
            },
            onCancel: () => {
              currentResizer = null;
              showMenu(selectedTable, selectedCell);
            }
          });
          hideMenu({ preserveSelection: true });
        });

        function cancelResizeMode() {
          if (currentResizer) {
            currentResizer.cancel();
            currentResizer = null;
          } else if (selectedTable && tableResizers.has(selectedTable)) {
            tableResizers.get(selectedTable)?.cancel();
          }
        }

        document.addEventListener('click', (event) => {
          if (!isEditMode) return;
          if (tableMenu.contains(event.target)) return;
          const table = event.target.closest('table');
          if (!table) {
            if (!tableMenu.contains(event.target)) {
              hideMenu();
            }
            return;
          }
          const cell = event.target.closest('td,th') || table.querySelector('td,th');
          if (!cell) return;
          showMenu(table, cell);
        });

        document.addEventListener('selectionchange', () => {
          if (!isEditMode) return;
          const selection = window.getSelection();
          if (!selection || !selection.rangeCount) return;
          const node = selection.anchorNode;
          if (!node) return;
          const element = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
          if (!element) return;
          const table = element.closest('table');
          if (!table) {
            if (tableMenu.classList.contains('show')) {
              hideMenu();
            }
            return;
          }
          const cell = element.closest('td,th') || table.querySelector('td,th');
          if (!cell) return;
          showMenu(table, cell);
        });

        return {
          hide: hideMenu,
          show: showMenu,
          refresh: updateMenuState,
          cancelResize: cancelResizeMode
        };
      }

      tableMenuAPI = initializeTableMenu();

      /* === MODAL === */
      function showModal(content) {
        hideTopicMenu();
        modalContent.innerHTML = content;
        modalOverlay.classList.add('show');
      }

      function hideModal() {
        modalOverlay.classList.remove('show');
        modalContent.innerHTML = '';
      }

      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) hideModal();
      });

      /* === INICIALIZACIÓN === */
      function initializeSections() {
        const sectionMap = new Map();
        
        pages.forEach(page => {
          const sectionId = page.dataset.sectionId || 'seccion-default';
          const topicId = page.dataset.topicId || 'topic-' + Date.now();
          const h1 = page.querySelector('h1');
          const titleSpan = h1?.querySelector('span:first-child');
          const title = (titleSpan?.textContent || h1?.textContent || 'Sin título').trim();
          
          if (!sectionMap.has(sectionId)) {
            sectionMap.set(sectionId, {
              id: sectionId,
              nombre: page.dataset.sectionName || 'Sección Principal',
              collapsed: false,
              temas: []
            });
          }
          
          sectionMap.get(sectionId).temas.push({
            id: topicId,
            titulo: title,
            page: page
          });
        });
        
        sections = Array.from(sectionMap.values());
      }

      pages.forEach(p => {
        afterContentSanitize(p);
        if (!p.dataset.sectionId) {
          p.dataset.sectionId = 'seccion-1';
        }
        attachPageListeners(p);
      });
      
      document.querySelectorAll('.magic-topic').forEach(m => afterContentSanitize(m));
      initializeSections();

      (function setSpecialtyFromBuildComment() {
        try {
          const html = document.documentElement.innerHTML;
          const m = html.match(/build:topics\s{([\s\S]*?)}/);
          if (m) {
            const json = JSON.parse('{' + m[1] + '}');
            if (json.especialidad && specialtySpan) {
              specialtySpan.textContent = json.especialidad;
            }
          }
        } catch (e) {}
      })();

      /* === ICONOS MÁGICOS EN PÁGINAS === */
      function setupMagicIcons() {
        pages.forEach(page => {
          const h1 = page.querySelector('h1');
          if (!h1) return;

          let titleSpan = h1.querySelector('.topic-title-text');
          if (!titleSpan) {
            const existingSpan = h1.querySelector('span:first-child');
            const currentTitle = (existingSpan?.textContent || h1.textContent || '').trim();
            const existingMagic = h1.querySelector('.magic-icon');

            if (existingSpan) {
              titleSpan = existingSpan;
              titleSpan.classList.add('topic-title-text');
            } else {
              titleSpan = document.createElement('span');
              titleSpan.className = 'topic-title-text';
              titleSpan.textContent = currentTitle;
            }

            h1.innerHTML = '';
            h1.appendChild(titleSpan);
            if (existingMagic) {
              h1.appendChild(existingMagic);
            }
          }

          let magicIcon = h1.querySelector('.magic-icon');
          if (!magicIcon) {
            magicIcon = document.createElement('span');
            magicIcon.className = 'magic-icon';
            magicIcon.title = 'Ver contenido mágico';
            magicIcon.textContent = '✨';
            h1.appendChild(magicIcon);
          }

          const getTitle = () => (titleSpan?.textContent || '').trim() || getTopicTitle(page) || 'Tema';

          if (!magicIcon.dataset.bound) {
            magicIcon.addEventListener('click', (e) => {
              e.stopPropagation();
              closePanel();
              activateMagicTopic(magicAnchorFor(page), getTitle());
            });
            magicIcon.dataset.bound = 'true';
          }

          if (!titleSpan.dataset.bound) {
            titleSpan.title = 'Doble clic para opciones del tema';
            titleSpan.addEventListener('dblclick', (event) => {
              event.preventDefault();
              event.stopPropagation();
              showTopicMenu(event, { page, titulo: getTitle() });
            });
            titleSpan.addEventListener('click', (event) => event.stopPropagation());
            titleSpan.dataset.bound = 'true';
          }

          if (titleSpan.nextSibling !== magicIcon) {
            h1.appendChild(magicIcon);
          }
        });
      }

      setupMagicIcons();

      /* === MODO LECTURA === */
      function toggleReadingMode() {
        isReadingMode = !isReadingMode;
        document.body.classList.toggle('reading-mode', isReadingMode);
        readingModeBtn.classList.toggle('active', isReadingMode);
        
        if (isReadingMode) {
          closePanel();
          closeTocPanel();
          if (isEditMode) {
            toggleEditMode();
          }
        }
      }

      readingModeBtn?.addEventListener('click', toggleReadingMode);
      readingModeExit?.addEventListener('click', toggleReadingMode);

      /* === TABLA DE CONTENIDOS === */
      function buildTableOfContents() {
        const tocList = document.getElementById('tocList');
        tocList.innerHTML = '';
        
        pages.forEach(page => {
          const headings = page.querySelectorAll('h1, h2, h3');
          headings.forEach(heading => {
            const li = document.createElement('li');
            li.className = `toc-item ${heading.tagName.toLowerCase()}`;
            
            // Para h1, obtener solo el texto sin el icono
            if (heading.tagName === 'H1') {
              const titleSpan = heading.querySelector('span:first-child');
              li.textContent = titleSpan ? titleSpan.textContent : heading.textContent;
            } else {
              li.textContent = heading.textContent;
            }
            
            li.addEventListener('click', () => {
              heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
              closeTocPanel();
            });
            tocList.appendChild(li);
          });
        });
      }

      function openTocPanel() {
        buildTableOfContents();
        tocPanel.classList.add('open');
        panelBackdrop.classList.add('show');
      }

      function closeTocPanel() {
        tocPanel.classList.remove('open');
        if (!panel.classList.contains('open')) {
          panelBackdrop.classList.remove('show');
        }
        hideTopicMenu();
      }

      tocBtn?.addEventListener('click', () => {
        if (tocPanel.classList.contains('open')) {
          closeTocPanel();
        } else {
          closePanel();
          openTocPanel();
        }
      });

      tocClose?.addEventListener('click', closeTocPanel);

      /* === EXPORTAR MARKDOWN === */
      exportMarkdownBtn?.addEventListener('click', () => {
        let markdown = `# ${specialtySpan?.textContent || 'Documento'}\n\n`;
        
        pages.forEach(page => {
          const clone = page.cloneNode(true);
          markdown += htmlToMarkdown(clone.innerHTML) + '\n\n---\n\n';
        });
        
        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const specialty = specialtySpan?.textContent || 'documento';
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `${specialty.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      function htmlToMarkdown(html) {
        let md = html;
        
        md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n');
        md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n');
        md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n');
        md = md.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n');
        
        md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
        md = md.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
        md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
        md = md.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
        md = md.replace(/<u[^>]*>(.*?)<\/u>/gi, '_$1_');
        
        md = md.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
        md = md.replace(/<ul[^>]*>/gi, '\n');
        md = md.replace(/<\/ul>/gi, '\n');
        md = md.replace(/<ol[^>]*>/gi, '\n');
        md = md.replace(/<\/ol>/gi, '\n');
        
        md = md.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
        
        md = md.replace(/<[^>]+>/g, '');
        
        md = md.replace(/&nbsp;/g, ' ');
        md = md.replace(/&amp;/g, '&');
        md = md.replace(/&lt;/g, '<');
        md = md.replace(/&gt;/g, '>');
        
        md = md.replace(/\n{3,}/g, '\n\n');
        
        return md.trim();
      }

      /* === MANEJO DE IMÁGENES === */
      function getImageContainer(img) {
        if (img.parentElement && img.parentElement.classList.contains('image-figure')) {
          return img.parentElement;
        }
        return img;
      }

      function setActiveAlignButton(activeClass) {
        Object.values(alignButtons).forEach(btn => btn?.classList.remove('active'));
        switch (activeClass) {
          case 'float-left':
            alignButtons.left?.classList.add('active');
            break;
          case 'center-block':
            alignButtons.center?.classList.add('active');
            break;
          case 'float-right':
            alignButtons.right?.classList.add('active');
            break;
          case 'inline-image':
            alignButtons.inline?.classList.add('active');
            break;
        }
      }

      function updateToolbarPosition(img) {
        if (!imageToolbar || !img) return;

        imageToolbar.classList.add('show');

        const rect = img.getBoundingClientRect();
        const toolbarWidth = imageToolbar.offsetWidth || 240;
        const toolbarHeight = imageToolbar.offsetHeight || 160;

        let left = rect.left;
        let top = rect.top - toolbarHeight - 10;

        if (top < 10) {
          top = rect.bottom + 10;
        }

        if (top + toolbarHeight > window.innerHeight - 10) {
          top = Math.max(10, window.innerHeight - toolbarHeight - 10);
        }

        if (left + toolbarWidth > window.innerWidth - 10) {
          left = window.innerWidth - toolbarWidth - 10;
        }

        if (left < 10) {
          left = 10;
        }

        imageToolbar.style.left = left + 'px';
        imageToolbar.style.top = top + 'px';
      }

      function updateToolbarState(img) {
        if (!img) return;

        if (imageAltInput) {
          imageAltInput.value = img.getAttribute('alt') || '';
        }

        if (imageFrameToggle) {
          imageFrameToggle.checked = img.classList.contains('image-frame');
        }

        if (wrapFigureBtn && unwrapFigureBtn) {
          const isWrapped = img.parentElement?.classList.contains('image-figure') || false;
          wrapFigureBtn.disabled = isWrapped;
          unwrapFigureBtn.disabled = !isWrapped;
        }

        const container = getImageContainer(img);
        const activeFloat = floatClasses.find(cls => container.classList.contains(cls));
        setActiveAlignButton(activeFloat);

        const widthSlider = document.getElementById('imageWidthSlider');
        const heightSlider = document.getElementById('imageHeightSlider');
        const widthDisplay = document.getElementById('widthDisplay');
        const heightDisplay = document.getElementById('heightDisplay');

        if (widthSlider && widthDisplay) {
          const widthValue = parseInt(img.style.width) || img.width || 200;
          const sliderMax = parseInt(widthSlider.max || '900', 10);
          const sliderMin = parseInt(widthSlider.min || '50', 10);
          const clampedWidth = Math.max(sliderMin, Math.min(sliderMax, widthValue));
          widthSlider.value = clampedWidth;
          widthDisplay.textContent = widthValue + 'px';
        }

        if (heightSlider && heightDisplay) {
          if (img.style.height && img.style.height !== 'auto') {
            const parsedHeight = parseInt(img.style.height) || img.height || 200;
            const sliderMax = parseInt(heightSlider.max || '900', 10);
            const sliderMin = parseInt(heightSlider.min || '50', 10);
            const clampedHeight = Math.max(sliderMin, Math.min(sliderMax, parsedHeight));
            heightSlider.value = clampedHeight;
            heightDisplay.textContent = parsedHeight + 'px';
          } else {
            const autoHeight = img.height || 200;
            const sliderMax = parseInt(heightSlider.max || '900', 10);
            const sliderMin = parseInt(heightSlider.min || '50', 10);
            const clampedAuto = Math.max(sliderMin, Math.min(sliderMax, autoHeight));
            heightSlider.value = clampedAuto;
            heightDisplay.textContent = 'auto';
          }
        }

        if (cropImageBtn) {
          cropImageBtn.disabled = false;
        }
      }

      function updateCropScale() {
        if (!imageCropPreview) return;
        const rect = imageCropPreview.getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0) {
          cropState.scaleX = imageCropPreview.naturalWidth / rect.width;
          cropState.scaleY = imageCropPreview.naturalHeight / rect.height;
        }
      }

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }

      function setCropSelection(startX, startY, currentX, currentY) {
        if (!imageCropStage || !imageCropSelection || !imageCropPreview) return;
        const stageRect = imageCropStage.getBoundingClientRect();
        const imageRect = imageCropPreview.getBoundingClientRect();
        const x1 = clamp(startX, imageRect.left, imageRect.right);
        const y1 = clamp(startY, imageRect.top, imageRect.bottom);
        const x2 = clamp(currentX, imageRect.left, imageRect.right);
        const y2 = clamp(currentY, imageRect.top, imageRect.bottom);
        const left = Math.min(x1, x2);
        const top = Math.min(y1, y2);
        const width = Math.abs(x1 - x2);
        const height = Math.abs(y1 - y2);

        cropState.currentRect = { left, top, width, height };
        imageCropSelection.style.left = (left - stageRect.left) + 'px';
        imageCropSelection.style.top = (top - stageRect.top) + 'px';
        imageCropSelection.style.width = width + 'px';
        imageCropSelection.style.height = height + 'px';

        if (width < 3 || height < 3) {
          if (imageCropSizeLabel) imageCropSizeLabel.textContent = '0 × 0 px';
          if (imageCropApplyBtn) imageCropApplyBtn.disabled = true;
          return;
        }

        const naturalWidth = Math.round(width * cropState.scaleX);
        const naturalHeight = Math.round(height * cropState.scaleY);
        if (imageCropSizeLabel) {
          imageCropSizeLabel.textContent = `${naturalWidth} × ${naturalHeight} px`;
        }
        if (imageCropApplyBtn) {
          imageCropApplyBtn.disabled = !(naturalWidth > 0 && naturalHeight > 0);
        }
      }

      function openImageCropModal(img) {
        if (!imageCropModal || !imageCropPreview) return;
        cropState.image = img;
        cropState.isSelecting = false;
        cropState.currentRect = null;
        cropState.scaleX = 1;
        cropState.scaleY = 1;
        if (imageCropSelection) {
          imageCropSelection.classList.remove('show');
        }
        if (imageCropSizeLabel) {
          imageCropSizeLabel.textContent = '0 × 0 px';
        }
        if (imageCropApplyBtn) {
          imageCropApplyBtn.disabled = true;
        }
        imageCropPreview.src = img.src;
        imageCropModal.classList.add('show');
        imageCropModal.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(updateCropScale);
      }

      function closeImageCropModal() {
        if (!imageCropModal) return;
        imageCropModal.classList.remove('show');
        imageCropModal.setAttribute('aria-hidden', 'true');
        cropState.image = null;
        cropState.isSelecting = false;
        cropState.currentRect = null;
        if (imageCropSelection) {
          imageCropSelection.classList.remove('show');
        }
        if (imageCropApplyBtn) {
          imageCropApplyBtn.disabled = true;
        }
        if (imageCropSizeLabel) {
          imageCropSizeLabel.textContent = '0 × 0 px';
        }
      }

      function repositionImageToolbar() {
        if (selectedImage) {
          updateToolbarPosition(selectedImage);
        }
      }

      window.addEventListener('scroll', repositionImageToolbar, { passive: true });
      window.addEventListener('resize', repositionImageToolbar);
      window.addEventListener('scroll', repositionTemplateToolbar, { passive: true });
      window.addEventListener('resize', repositionTemplateToolbar);

      imageCropPreview?.addEventListener('load', updateCropScale);

      window.addEventListener('resize', () => {
        if (imageCropModal?.classList.contains('show')) {
          requestAnimationFrame(updateCropScale);
        }
      });

      cropImageBtn?.addEventListener('click', () => {
        if (!selectedImage) {
          alert('Selecciona una imagen para recortar.');
          return;
        }
        openImageCropModal(selectedImage);
      });

      const finishCropSelection = (event) => {
        if (!cropState.isSelecting) return;
        cropState.isSelecting = false;
        try {
          imageCropStage?.releasePointerCapture(event.pointerId);
        } catch (err) {
          /* ignore */
        }
        if (!cropState.currentRect || cropState.currentRect.width < 3 || cropState.currentRect.height < 3) {
          cropState.currentRect = null;
          imageCropSelection?.classList.remove('show');
          if (imageCropSizeLabel) imageCropSizeLabel.textContent = '0 × 0 px';
          if (imageCropApplyBtn) imageCropApplyBtn.disabled = true;
        }
      };

      imageCropStage?.addEventListener('pointerdown', (event) => {
        if (!imageCropModal?.classList.contains('show') || !cropState.image || !imageCropPreview?.complete) return;
        const imageRect = imageCropPreview.getBoundingClientRect();
        if (imageRect.width === 0 || imageRect.height === 0) return;
        const withinImage = event.clientX >= imageRect.left && event.clientX <= imageRect.right
          && event.clientY >= imageRect.top && event.clientY <= imageRect.bottom;
        if (!withinImage) return;
        cropState.isSelecting = true;
        cropState.startX = event.clientX;
        cropState.startY = event.clientY;
        setCropSelection(cropState.startX, cropState.startY, cropState.startX, cropState.startY);
        imageCropSelection?.classList.add('show');
        if (imageCropApplyBtn) imageCropApplyBtn.disabled = true;
        if (imageCropSizeLabel) imageCropSizeLabel.textContent = '0 × 0 px';
        try {
          imageCropStage.setPointerCapture(event.pointerId);
        } catch (err) {
          /* ignore */
        }
        event.preventDefault();
      });

      imageCropStage?.addEventListener('pointermove', (event) => {
        if (!cropState.isSelecting) return;
        setCropSelection(cropState.startX, cropState.startY, event.clientX, event.clientY);
        event.preventDefault();
      });

      imageCropStage?.addEventListener('pointerup', finishCropSelection);
      imageCropStage?.addEventListener('pointerleave', finishCropSelection);
      imageCropStage?.addEventListener('pointercancel', finishCropSelection);

      imageCropApplyBtn?.addEventListener('click', () => {
        if (!cropState.image || !cropState.currentRect || !imageCropPreview) return;
        const { left, top, width, height } = cropState.currentRect;
        if (width < 3 || height < 3) {
          alert('Selecciona un área mayor para recortar.');
          return;
        }
        const imageRect = imageCropPreview.getBoundingClientRect();
        const sx = Math.round((left - imageRect.left) * cropState.scaleX);
        const sy = Math.round((top - imageRect.top) * cropState.scaleY);
        const sw = Math.round(width * cropState.scaleX);
        const sh = Math.round(height * cropState.scaleY);
        if (sw <= 1 || sh <= 1) {
          alert('El recorte seleccionado es demasiado pequeño.');
          return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = sw;
        canvas.height = sh;
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          alert('No se pudo preparar el recorte.');
          return;
        }

        const source = new Image();
        source.crossOrigin = 'anonymous';
        source.onload = () => {
          try {
            ctx.drawImage(source, sx, sy, sw, sh, 0, 0, sw, sh);
            const dataUrl = canvas.toDataURL('image/png');
            cropState.image.src = dataUrl;
            cropState.image.removeAttribute('height');
            cropState.image.style.height = 'auto';
            updateToolbarState(cropState.image);
            repositionImageToolbar();
            closeImageCropModal();
          } catch (error) {
            console.error('Error al recortar la imagen:', error);
            alert('No se pudo recortar la imagen.');
          }
        };
        source.onerror = () => {
          alert('No se pudo cargar la imagen para recortar.');
        };
        source.src = cropState.image.src;
      });

      imageCropCancelBtn?.addEventListener('click', closeImageCropModal);
      imageCropCloseBtn?.addEventListener('click', closeImageCropModal);

      imageCropModal?.addEventListener('click', (event) => {
        if (event.target === imageCropModal) {
          closeImageCropModal();
        }
      });

      function showImageToolbar(img) {
        hideTemplateToolbar();
        if (selectedImage && selectedImage !== img) {
          selectedImage.classList.remove('selected-image');
        }
        selectedImage = img;
        img.classList.add('selected-image');

        updateToolbarState(img);
        updateToolbarPosition(img);
      }

      function hideImageToolbar() {
        if (selectedImage) {
          selectedImage.classList.remove('selected-image');
          selectedImage = null;
        }
        imageToolbar.classList.remove('show');
        if (cropImageBtn) {
          cropImageBtn.disabled = true;
        }
      }

      document.addEventListener('click', (e) => {
        if (isEditMode && e.target.tagName === 'IMG') {
          e.preventDefault();
          showImageToolbar(e.target);
        } else if (!e.target.closest('#imageToolbar') && !e.target.closest('img') && !e.target.closest('.image-figure')) {
          hideImageToolbar();
        }

        if (isEditMode) {
          const templateBlock = e.target.closest('.template-block');
          if (templateBlock) {
            showTemplateToolbar(templateBlock);
          } else if (!e.target.closest('#templateToolbar')) {
            hideTemplateToolbar();
          }
        } else if (!e.target.closest('#templateToolbar')) {
          hideTemplateToolbar();
        }
      });

      document.addEventListener('click', (event) => {
        const toggle = event.target.closest('.collapse-card-toggle');
        if (!toggle) return;
        const card = toggle.closest('.collapse-card');
        if (!card) return;
        const collapsed = card.classList.toggle('collapsed');
        toggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      });

      document.getElementById('imageWidthSlider')?.addEventListener('input', (e) => {
        if (selectedImage) {
          const width = parseInt(e.target.value);
          selectedImage.style.width = width + 'px';
          document.getElementById('widthDisplay').textContent = width + 'px';
          repositionImageToolbar();
        }
      });

      document.getElementById('imageHeightSlider')?.addEventListener('input', (e) => {
        if (selectedImage) {
          const height = parseInt(e.target.value);
          selectedImage.style.height = height + 'px';
          document.getElementById('heightDisplay').textContent = height + 'px';
          repositionImageToolbar();
        }
      });

      templateBgColorInput?.addEventListener('input', (e) => {
        applyTemplateBackground(e.target.value || '#ffffff');
      });

      templateClearBgBtn?.addEventListener('click', () => {
        applyTemplateBackground('transparent');
      });

      templateTextColorInput?.addEventListener('input', (e) => {
        applyTemplateTextColor(e.target.value || '#212529');
      });

      templateResetTextColorBtn?.addEventListener('click', () => {
        applyTemplateTextColor('');
      });

      templateBorderColorInput?.addEventListener('input', (e) => {
        applyTemplateBorderColor(e.target.value || '#ced4da');
      });

      templateAccentColorInput?.addEventListener('input', (e) => {
        applyTemplateAccentColor(e.target.value || '#0d6efd');
      });

      templateBorderWidthSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target || !target.classList.contains('box')) return;
        const width = parseInt(e.target.value, 10) || 0;
        const accentExtra = parseInt(selectedTemplateBlock.dataset.borderAccentExtra || '0', 10) || 0;
        if (width <= 0) {
          target.style.borderWidth = '0';
          target.style.borderStyle = 'none';
          if (accentExtra > 0) {
            target.style.borderLeftStyle = 'solid';
            target.style.borderLeftWidth = accentExtra + 'px';
          } else {
            target.style.borderLeftWidth = '0';
          }
        } else {
          target.style.borderStyle = 'solid';
          target.style.borderWidth = width + 'px';
          target.style.borderLeftWidth = (width + Math.max(0, accentExtra)) + 'px';
        }
        if (templateBorderWidthDisplay) {
          templateBorderWidthDisplay.textContent = width + 'px';
        }
        updateBorderWidthDataset(selectedTemplateBlock, width, Math.max(0, accentExtra));
      });

      templateFontSizeSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const size = parseInt(e.target.value, 10) || 100;
        selectedTemplateBlock.dataset.fontScale = String(size);
        selectedTemplateBlock.style.fontSize = size === 100 ? '' : size + '%';
        if (templateFontSizeDisplay) {
          templateFontSizeDisplay.textContent = size + '%';
        }
        repositionTemplateToolbar();
      });

      templateMarginTopSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const margin = parseInt(e.target.value, 10) || 0;
        selectedTemplateBlock.dataset.marginTop = String(margin);
        selectedTemplateBlock.style.marginTop = margin + 'px';
        if (templateMarginTopDisplay) {
          templateMarginTopDisplay.textContent = margin + 'px';
        }
        repositionTemplateToolbar();
      });

      templateMarginBottomSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const margin = parseInt(e.target.value, 10) || 0;
        selectedTemplateBlock.dataset.marginBottom = String(margin);
        selectedTemplateBlock.style.marginBottom = margin + 'px';
        if (templateMarginBottomDisplay) {
          templateMarginBottomDisplay.textContent = margin + 'px';
        }
        repositionTemplateToolbar();
      });

      templateDeleteBtn?.addEventListener('click', () => {
        if (!selectedTemplateBlock) return;
        const block = selectedTemplateBlock;
        const range = document.createRange();
        range.setStartAfter(block);
        range.collapse(true);
        block.remove();
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        savedSelection = null;
        hideTemplateToolbar();
      });

      function applyFloatClass(targetClass) {
        if (!selectedImage) return;

        const container = getImageContainer(selectedImage);

        floatClasses.forEach(cls => {
          container.classList.remove(cls);
          if (container !== selectedImage) {
            selectedImage.classList.remove(cls);
          }
        });

        if (targetClass) {
          container.classList.add(targetClass);
        }

        setActiveAlignButton(targetClass || '');
        repositionImageToolbar();
      }

      alignButtons.left?.addEventListener('click', () => {
        applyFloatClass('float-left');
      });

      alignButtons.center?.addEventListener('click', () => {
        applyFloatClass('center-block');
      });

      alignButtons.right?.addEventListener('click', () => {
        applyFloatClass('float-right');
      });

      alignButtons.inline?.addEventListener('click', () => {
        applyFloatClass('inline-image');
      });

      applyAltBtn?.addEventListener('click', () => {
        if (!selectedImage || !imageAltInput) return;
        selectedImage.alt = imageAltInput.value.trim();
        selectedImage.setAttribute('alt', selectedImage.alt);
        imageAltInput.blur();
      });

      imageAltInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          applyAltBtn?.click();
        }
      });

      imageFrameToggle?.addEventListener('change', (e) => {
        if (!selectedImage) return;
        if (e.target.checked) {
          selectedImage.classList.add('image-frame');
        } else {
          selectedImage.classList.remove('image-frame');
        }
        repositionImageToolbar();
      });

      function wrapImageWithFigure() {
        if (!selectedImage || selectedImage.parentElement?.classList.contains('image-figure')) return;

        const container = getImageContainer(selectedImage);
        const existingFloat = floatClasses.find(cls => container.classList.contains(cls));

        const figure = document.createElement('figure');
        figure.classList.add('image-figure');

        if (existingFloat) {
          container.classList.remove(existingFloat);
          figure.classList.add(existingFloat);
        }

        const caption = document.createElement('figcaption');
        caption.contentEditable = 'true';
        caption.spellcheck = true;
        caption.textContent = 'Escribe una descripción';

        const parent = selectedImage.parentElement;
        parent?.insertBefore(figure, selectedImage);
        figure.appendChild(selectedImage);
        figure.appendChild(caption);

        caption.focus();

        if (wrapFigureBtn) wrapFigureBtn.disabled = true;
        if (unwrapFigureBtn) unwrapFigureBtn.disabled = false;

        updateToolbarState(selectedImage);
        updateToolbarPosition(selectedImage);
      }

      function unwrapImageFigure() {
        if (!selectedImage) return;
        const figure = selectedImage.parentElement;
        if (!figure || !figure.classList.contains('image-figure')) return;

        const existingFloat = floatClasses.find(cls => figure.classList.contains(cls));
        const parent = figure.parentElement;
        if (!parent) return;

        parent.insertBefore(selectedImage, figure);
        figure.remove();

        if (existingFloat) {
          selectedImage.classList.add(existingFloat);
        }

        if (wrapFigureBtn) wrapFigureBtn.disabled = false;
        if (unwrapFigureBtn) unwrapFigureBtn.disabled = true;

        updateToolbarState(selectedImage);
        updateToolbarPosition(selectedImage);
      }

      wrapFigureBtn?.addEventListener('click', wrapImageWithFigure);
      unwrapFigureBtn?.addEventListener('click', unwrapImageFigure);

      document.getElementById('deleteImageBtn')?.addEventListener('click', () => {
        if (selectedImage && confirm('¿Eliminar esta imagen?')) {
          selectedImage.remove();
          hideImageToolbar();
        }
      });

      /* === PALETAS DE COLOR MEJORADAS === */
      function createColorPalette(paletteId, isHighlight) {
        const palette = document.getElementById(paletteId);
        if (!palette) return;

        palette.innerHTML = '';
        
        pastelColors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.backgroundColor = color;
          swatch.title = color;
          swatch.addEventListener('click', (e) => {
            e.stopPropagation();
            applyColor(color, isHighlight);
            palette.classList.remove('show');
          });
          palette.appendChild(swatch);
        });
        
        const customSwatch = document.createElement('input');
        customSwatch.type = 'color';
        customSwatch.className = 'color-swatch';
        customSwatch.title = 'Color personalizado';
        customSwatch.style.border = '2px dashed #495057';
        customSwatch.addEventListener('change', (e) => {
          e.stopPropagation();
          applyColor(e.target.value, isHighlight);
          palette.classList.remove('show');
        });
        palette.appendChild(customSwatch);
      }

      function supportsCommand(command) {
        if (typeof document.queryCommandSupported !== 'function') return true;
        try {
          return document.queryCommandSupported(command);
        } catch (e) {
          return false;
        }
      }

      function applyColor(color, isHighlight) {
        if (!restoreSelection()) {
          alert('Por favor, selecciona el texto primero');
          return;
        }

        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) {
          alert('Por favor, selecciona el texto primero');
          savedSelection = null;
          return;
        }

        const styleWithCss = supportsCommand('styleWithCSS');
        if (styleWithCss) {
          document.execCommand('styleWithCSS', false, true);
        }

        let command = 'foreColor';
        if (isHighlight) {
          if (supportsCommand('hiliteColor')) {
            command = 'hiliteColor';
          } else if (supportsCommand('backColor')) {
            command = 'backColor';
          } else {
            command = null;
          }
        }

        let applied = false;
        if (command) {
          applied = document.execCommand(command, false, color);
        }

        if (styleWithCss) {
          document.execCommand('styleWithCSS', false, false);
        }

        if (!applied) {
          const range = selection.getRangeAt(0);
          const wrapper = document.createElement('span');
          if (isHighlight) {
            wrapper.style.backgroundColor = color;
          } else {
            wrapper.style.color = color;
          }
          try {
            range.surroundContents(wrapper);
          } catch (e) {
            const fragment = range.extractContents();
            wrapper.appendChild(fragment);
            range.insertNode(wrapper);
          }
        }

        selection.removeAllRanges();
        savedSelection = null;
      }

      createColorPalette('highlightPalette', true);
      createColorPalette('textColorPalette', false);

      document.getElementById('highlightBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (!saveCurrentSelection()) {
          alert('Por favor, selecciona el texto que deseas destacar');
          return;
        }
        
        const btn = e.currentTarget;
        const btnRect = btn.getBoundingClientRect();
        
        highlightPalette.style.left = btnRect.left + 'px';
        highlightPalette.style.top = (btnRect.bottom + 5) + 'px';
        
        textColorPalette.classList.remove('show');
        highlightPalette.classList.add('show');
      });

      document.getElementById('textColorBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (!saveCurrentSelection()) {
          alert('Por favor, selecciona el texto al que deseas cambiar el color');
          return;
        }
        
        const btn = e.currentTarget;
        const btnRect = btn.getBoundingClientRect();
        
        textColorPalette.style.left = btnRect.left + 'px';
        textColorPalette.style.top = (btnRect.bottom + 5) + 'px';
        
        highlightPalette.classList.remove('show');
        textColorPalette.classList.add('show');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('#highlightBtn') && !e.target.closest('#highlightPalette')) {
          const wasOpen = highlightPalette.classList.contains('show');
          highlightPalette.classList.remove('show');
          if (wasOpen) {
            savedSelection = null;
          }
        }
        if (!e.target.closest('#textColorBtn') && !e.target.closest('#textColorPalette')) {
          const wasOpen = textColorPalette.classList.contains('show');
          textColorPalette.classList.remove('show');
          if (wasOpen) {
            savedSelection = null;
          }
        }
      });

      /* === PLANTILLAS === */
      insertTemplateBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertTemplateBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      insertHtmlBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertHtmlBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      insertTableBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertTableBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      insertCollapseCardBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertCollapseCardBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      document.getElementById('insertTemplateBtn')?.addEventListener('click', () => {
        if (!savedSelection) {
          const activeEditable = document.activeElement && document.activeElement.isContentEditable ? document.activeElement : null;
          const target = activeEditable || getCurrentPage() || getCurrentMagicPage();
          if (target) {
            const range = document.createRange();
            range.selectNodeContents(target);
            range.collapse(false);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            saveCurrentSelection();
          }
        }

        showModal(`
          <div class="modal-header">
            <h3>Insertar Plantilla</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <p>Selecciona una plantilla para insertar en el documento:</p>
            <div class="template-grid" id="templateGrid"></div>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
          </div>
        `);

        const templates = [
          {
            name: 'Nota Importante',
            html: '<div class="box" style="border-left-color: #dc3545;"><strong>Nota importante:</strong> Escribe tu contenido aquí.</div>'
          },
          {
            name: 'Perla Clínica',
            html: '<div class="box pearl">Escribe tu perla clínica aquí.</div>'
          },
          {
            name: 'Cuadro Informativo',
            html: '<div class="box"><strong>Título:</strong><p>Contenido del cuadro informativo.</p></div>'
          },
          {
            name: 'Separador Simple',
            html: '<hr style="border: none; border-top: 1px solid #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Separador Doble',
            html: '<hr style="border: none; border-top: 3px double #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Separador Punteado',
            html: '<hr style="border: none; border-top: 2px dashed #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Nota de Advertencia',
            html: '<div class="box" style="background: #fff3cd; border-left-color: #ffc107;"><strong>⚠️ Advertencia:</strong> Contenido importante de advertencia.</div>'
          },
          {
            name: 'Nota de Éxito',
            html: '<div class="box" style="background: #d1e7dd; border-left-color: #198754;"><strong>✓ Éxito:</strong> Información positiva o exitosa.</div>'
          },
          {
            name: 'Lista de Verificación',
            html: '<ul><li>☐ Ítem 1</li><li>☐ Ítem 2</li><li>☐ Ítem 3</li></ul>'
          },
          {
            name: 'Dos Columnas',
            html: '<div class="columns"><div><h3>Columna 1</h3><p>Contenido de la primera columna.</p></div><div><h3>Columna 2</h3><p>Contenido de la segunda columna.</p></div></div>'
          },
          {
            name: 'Cita Destacada',
            html: '<blockquote style="border-left: 4px solid var(--theme-primary); padding-left: 15px; font-style: italic; color: #6c757d; margin: 10px 0;">"Tu cita aquí"</blockquote>'
          },
          {
            name: 'Definición',
            html: '<div class="box" style="background: #e7f3ff;"><strong>Definición:</strong> Término a definir - explicación del término.</div>'
          }
        ];

        const grid = document.getElementById('templateGrid');
        if (grid) {
          grid.innerHTML = '';
        }
        templates.forEach(template => {
          const card = document.createElement('div');
          card.className = 'template-card';
          card.innerHTML = `
            <h4>${template.name}</h4>
            <div class="template-preview">${template.html}</div>
          `;
          card.addEventListener('click', () => {
            const block = createTemplateBlock(template);
            if (!block) return;
            const insertedBlock = insertNodeAtSelection(block);
            if (!insertedBlock) {
              alert('Selecciona un área editable antes de insertar una plantilla.');
              return;
            }

            showTemplateToolbar(insertedBlock);
            insertedBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            hideModal();
          });
          grid?.appendChild(card);
        });
      });

      insertCollapseCardBtn?.addEventListener('click', () => {
        const card = createCollapseCardElement();
        initializeCollapseCards(card);
        const insertedCard = insertNodeAtSelection(card);
        if (!insertedCard) {
          alert('Selecciona un área editable antes de insertar la tarjeta.');
          return;
        }
        const title = insertedCard.querySelector('.collapse-card-title');
        if (title) {
          const range = document.createRange();
          range.selectNodeContents(title);
          range.collapse(true);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
        }
        insertedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });

      /* === PANEL LATERAL === */
      function openPanel() {
        buildSectionsPanel();
        panel.classList.add('open');
        panelBackdrop.classList.add('show');
      }

      function closePanel() {
        panel.classList.remove('open');
        if (!tocPanel.classList.contains('open')) {
          panelBackdrop.classList.remove('show');
        }
        hideTopicMenu();
      }

      function magicAnchorFor(page) {
        const tid = page.dataset.topicId || '';
        if (!tid) return '';
        
        if (document.getElementById(`magic-topic-${tid}`)) {
          return `magic-topic-${tid}`;
        }
        if (document.getElementById(`magic-${tid}`)) {
          return `magic-${tid}`;
        }
        if (document.getElementById(tid)) {
          return tid;
        }
        return '';
      }

      function closeMagicView() {
        document.body.classList.remove('magic-open');
      }

      function activateMagicTopic(anchorId, title) {
        magic.innerHTML =
          '<div class="magic-header"><strong>✨ Visor del tema</strong><button class="magic-close">&times;</button></div>';
        const magicPage = document.createElement('div');
        magicPage.className = 'magic-page';

        const h = document.createElement('h1');
        h.className = 'magic-title';
        h.textContent = title || 'Tema';
        magicPage.appendChild(h);

        const src = anchorId ? document.getElementById(anchorId) : null;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = src ? src.innerHTML : '<p>No hay contenido adicional.</p>';
        afterContentSanitize(wrapper);

        magicPage.appendChild(wrapper);
        magic.appendChild(magicPage);

        if (isEditMode) {
          magicPage.contentEditable = 'true';
          enableHtmlPaste();
        }

        magic.querySelector('.magic-close')?.addEventListener('click', () => {
          if (isEditMode && src) {
            src.innerHTML = wrapper.innerHTML;
          }
          closeMagicView();
        });

        document.body.classList.add('magic-open');
      }

      function buildSectionsPanel() {
        sectionsContainer.innerHTML = '';
        globalTopicCounter = 1;
        
        sections.forEach((section, sectionIdx) => {
          const sectionDiv = document.createElement('div');
          sectionDiv.className = 'section-item';
          if (section.collapsed) sectionDiv.classList.add('collapsed');
          
          const sectionHeader = document.createElement('div');
          sectionHeader.className = 'section-header';
          
          const toggle = document.createElement('span');
          toggle.className = 'section-toggle';
          toggle.textContent = '▼';

          const nameSpan = document.createElement('span');
          nameSpan.className = 'section-name';
          nameSpan.textContent = section.nombre;

          const toggleSectionState = () => {
            section.collapsed = !section.collapsed;
            sectionDiv.classList.toggle('collapsed');
            scheduleCacheSave();
          };

          toggle.addEventListener('click', toggleSectionState);
          nameSpan.addEventListener('click', toggleSectionState);
          
          const countSpan = document.createElement('span');
          countSpan.className = 'section-count';
          countSpan.textContent = `(${section.temas.length})`;
          
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'section-actions';
          
          const printBtn = document.createElement('button');
          printBtn.className = 'section-action-btn';
          printBtn.textContent = '🖨️';
          printBtn.title = 'Imprimir sección';
          printBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            printSection(section);
          });
          
          if (isPanelEditMode) {
            const renameBtn = document.createElement('button');
            renameBtn.className = 'section-action-btn';
            renameBtn.textContent = '✏️';
            renameBtn.title = 'Renombrar';
            renameBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              renameSection(section);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'section-action-btn';
            deleteBtn.textContent = '🗑️';
            deleteBtn.title = 'Eliminar sección';
            deleteBtn.style.color = '#dc3545';
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteSection(section);
            });
            
            actionsDiv.appendChild(renameBtn);
            actionsDiv.appendChild(deleteBtn);
          }
          
          actionsDiv.appendChild(printBtn);
          
          sectionHeader.appendChild(toggle);
          sectionHeader.appendChild(nameSpan);
          sectionHeader.appendChild(countSpan);
          sectionHeader.appendChild(actionsDiv);
          
          const topicList = document.createElement('ol');
          topicList.className = 'topic-list';
          
          section.temas.forEach(tema => {
            const li = document.createElement('li');
            li.dataset.topicId = tema.id;
            
            const numSpan = document.createElement('span');
            numSpan.className = 'topic-number';
            numSpan.textContent = globalTopicCounter + '.';
            globalTopicCounter++;
            
          const btnMain = document.createElement('button');
          btnMain.className = 'topic-action';
          btnMain.title = 'Ir al tema';
          btnMain.textContent = '📄';
          btnMain.addEventListener('click', () => {
            closeMagicView();
            closePanel();
            tema.page.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });

          const titleSpan = document.createElement('span');
          titleSpan.className = 'topic-title';
          titleSpan.textContent = tema.titulo;
          titleSpan.title = 'Doble clic para opciones del tema';
          titleSpan.addEventListener('dblclick', (event) => {
            event.preventDefault();
            event.stopPropagation();
            showTopicMenu(event, tema);
          });
          titleSpan.addEventListener('click', (event) => event.stopPropagation());

          li.appendChild(numSpan);
          li.appendChild(btnMain);
          li.appendChild(titleSpan);
          topicList.appendChild(li);
        });
          
          sectionDiv.appendChild(sectionHeader);
          sectionDiv.appendChild(topicList);
          sectionsContainer.appendChild(sectionDiv);
        });
      }

      function togglePanelEditMode() {
        isPanelEditMode = !isPanelEditMode;
        document.body.classList.toggle('panel-edit-mode', isPanelEditMode);
        editPanelBtn.classList.toggle('active', isPanelEditMode);
        buildSectionsPanel();
      }

      function toggleAllSections() {
        allSectionsExpanded = !allSectionsExpanded;
        sections.forEach(s => s.collapsed = !allSectionsExpanded);
        buildSectionsPanel();
        const btn = document.getElementById('toggleAllBtn');
        btn.textContent = allSectionsExpanded ? '⊟' : '⊞';
      }

      function renameSection(section) {
        const newName = prompt('Nuevo nombre para la sección:', section.nombre);
        if (newName && newName.trim()) {
          section.nombre = newName.trim();
          section.temas.forEach(tema => {
            tema.page.dataset.sectionName = section.nombre;
          });
          buildSectionsPanel();
          scheduleCacheSave();
        }
      }

      function deleteSection(section) {
        if (!confirm(`¿Eliminar toda la sección "${section.nombre}" con ${section.temas.length} tema(s)?`)) return;

        section.temas.forEach(tema => {
          detachPageListeners(tema.page);
          tema.page.remove();
        });

        pages = pages.filter(p => p.dataset.sectionId !== section.id);
        sections = sections.filter(s => s.id !== section.id);
        buildSectionsPanel();
        scheduleCacheSave();
      }

      function addNewSection() {
        const nombre = prompt('Nombre de la nueva sección:');
        if (!nombre || !nombre.trim()) return;
        
        const newSection = {
          id: 'seccion-' + Date.now(),
          nombre: nombre.trim(),
          collapsed: false,
          temas: []
        };
        
        sections.push(newSection);
        buildSectionsPanel();
        scheduleCacheSave();
      }

      function sortSectionsAlpha() {
        sections.sort((a, b) => a.nombre.localeCompare(b.nombre));
        buildSectionsPanel();
        scheduleCacheSave();
      }

      function sortSectionsNumeric() {
        sections.sort((a, b) => {
          const numA = parseInt(a.nombre.match(/\d+/)?.[0] || '999');
          const numB = parseInt(b.nombre.match(/\d+/)?.[0] || '999');
          return numA - numB;
        });
        buildSectionsPanel();
        scheduleCacheSave();
      }

      function printSection(section) {
        if (!section || !Array.isArray(section.temas)) {
          window.print();
          return;
        }

        const pagesToPrint = section.temas
          .map(topic => topic?.page)
          .filter(page => page && page.isConnected);

        if (!pagesToPrint.length) {
          alert('No hay temas disponibles en esta sección para imprimir.');
          return;
        }

        pages.forEach(page => {
          if (pagesToPrint.includes(page)) {
            page.dataset.printTarget = 'true';
          } else {
            page.dataset.prevDisplay = page.style.display || '';
            page.style.display = 'none';
          }
        });

        document.body.dataset.printingSection = 'true';

        let cleaned = false;
        const cleanup = () => {
          if (cleaned) return;
          cleaned = true;
          delete document.body.dataset.printingSection;
          pages.forEach(page => {
            if (page.dataset.printTarget) {
              delete page.dataset.printTarget;
            }
            if (page.dataset.prevDisplay !== undefined) {
              page.style.display = page.dataset.prevDisplay;
              delete page.dataset.prevDisplay;
            }
          });
          window.removeEventListener('afterprint', cleanup);
        };

        window.addEventListener('afterprint', cleanup);
        window.print();
        setTimeout(cleanup, 1200);
      }

      function printCurrentTopic() {
        window.print();
      }

      editPanelBtn?.addEventListener('click', togglePanelEditMode);
      document.getElementById('addSectionBtn')?.addEventListener('click', addNewSection);
      document.getElementById('toggleAllBtn')?.addEventListener('click', toggleAllSections);
      document.getElementById('sortAlphaBtn')?.addEventListener('click', sortSectionsAlpha);
      document.getElementById('sortNumBtn')?.addEventListener('click', sortSectionsNumeric);
      document.getElementById('printCurrentBtn')?.addEventListener('click', printCurrentTopic);

      const io = new IntersectionObserver((entries) => {
        const visible = entries.filter(e => e.isIntersecting).sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
        if (!visible) return;
        const tid = visible.target.dataset.topicId || '';
        sectionsContainer.querySelectorAll('li').forEach(li => 
          li.classList.toggle('active', li.dataset.topicId === tid)
        );
      }, { root: null, threshold: [0.5, 0.75, 1] });
      
      pages.forEach(p => io.observe(p));

      plusBtn?.addEventListener('click', () => {
        if (panel.classList.contains('open')) {
          closePanel();
        } else {
          closeTocPanel();
          openPanel();
        }
      });
      panelClose.forEach(btn => btn.addEventListener('click', () => {
        closePanel();
        closeTocPanel();
      }));
      panelBackdrop?.addEventListener('click', () => {
        closePanel();
        closeTocPanel();
      });
      
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          closePanel();
          closeTocPanel();
          hideModal();
          hideImageToolbar();
          hideTemplateToolbar();
          closeMagicView();
          closeImageCropModal();
          highlightPalette.classList.remove('show');
          textColorPalette.classList.remove('show');
          savedSelection = null;
        }
      });

      /* === TEMA DE COLORES === */
      document.getElementById('themeSelect')?.addEventListener('change', function() {
        const oldTheme = document.body.className.split(' ').find(c => c.startsWith('theme-'));
        if (oldTheme) {
          document.body.classList.remove(oldTheme);
        }
        document.body.classList.add(this.value);
        if (isReadingMode) {
          document.body.classList.add('reading-mode');
        }
      });

      /* === EDICIÓN === */
      function toggleEditMode() {
        isEditMode = !isEditMode;
        hideTopicMenu();

        if (isEditMode) {
          pages.forEach(page => page.contentEditable = 'true');
          const magicPage = getCurrentMagicPage();
          if (magicPage) magicPage.contentEditable = 'true';
          editToolbar.classList.add('show');
          editBtn.classList.add('active');
          editBtn.textContent = '✏️';
          saveHtmlBtn.style.display = 'inline-block';
          enableHtmlPaste();
          tableMenuAPI?.refresh();
        } else {
          pages.forEach(page => page.contentEditable = 'false');
          const magicPages = document.querySelectorAll('.magic-page');
          magicPages.forEach(mp => mp.contentEditable = 'false');
          editToolbar.classList.remove('show');
          editBtn.classList.remove('active');
          editBtn.textContent = '✏️';
          saveHtmlBtn.style.display = 'none';
          hideTemplateToolbar();
          hideImageToolbar();
          tableMenuAPI?.cancelResize();
          tableMenuAPI?.hide();
        }
      }
      
      function execCmd(command, value = null) {
        document.execCommand(command, false, value);
      }
      
      editBtn?.addEventListener('click', toggleEditMode);
      
      document.getElementById('undoBtn')?.addEventListener('click', () => execCmd('undo'));
      document.getElementById('redoBtn')?.addEventListener('click', () => execCmd('redo'));
      
      document.getElementById('fontSizeSelect')?.addEventListener('change', function() {
        if (this.value) {
          execCmd('fontSize', this.value);
          this.value = '';
        }
      });
      
      document.getElementById('boldBtn')?.addEventListener('click', () => execCmd('bold'));
      document.getElementById('italicBtn')?.addEventListener('click', () => execCmd('italic'));
      document.getElementById('underlineBtn')?.addEventListener('click', () => execCmd('underline'));
      document.getElementById('removeFormatBtn')?.addEventListener('click', () => execCmd('removeFormat'));
      document.getElementById('insertUlBtn')?.addEventListener('click', () => execCmd('insertUnorderedList'));
      document.getElementById('insertOlBtn')?.addEventListener('click', () => execCmd('insertOrderedList'));
      document.getElementById('indentBtn')?.addEventListener('click', () => execCmd('indent'));
      document.getElementById('outdentBtn')?.addEventListener('click', () => execCmd('outdent'));

      /* === INSERTAR HTML PERSONALIZADO === */
      document.getElementById('insertHtmlBtn')?.addEventListener('click', () => {
        showModal(`
          <div class="modal-header">
            <h3>Insertar HTML Personalizado</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <p>Escribe el código HTML que deseas insertar en la posición del cursor:</p>
            <textarea id="customHtmlInput" class="modal-textarea" placeholder="<div>Tu código HTML aquí...</div>"></textarea>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cancelar</button>
            <button class="modal-btn primary" id="insertCustomHtmlBtn">Insertar</button>
          </div>
        `);

        setTimeout(() => {
          document.getElementById('insertCustomHtmlBtn')?.addEventListener('click', () => {
            const htmlCode = document.getElementById('customHtmlInput').value;
            if (htmlCode.trim()) {
              const insertedNode = insertHtmlAtSelection(htmlCode);
              if (insertedNode) {
                hideModal();
              } else {
                alert('Selecciona un área editable antes de insertar HTML.');
              }
            } else {
              alert('Por favor ingresa código HTML válido');
            }
          });
        }, 100);
      });

      /* === COPIAR HTML DE SELECCIÓN === */
      document.getElementById('copyHtmlSelectionBtn')?.addEventListener('click', async () => {
        const selection = window.getSelection();
        if (!selection.rangeCount) {
          alert('Primero selecciona el texto del que quieres copiar el HTML');
          return;
        }

        const range = selection.getRangeAt(0);
        const container = document.createElement('div');
        container.appendChild(range.cloneContents());
        const html = container.innerHTML;

        if (!html) {
          alert('No hay contenido HTML en la selección');
          return;
        }

        try {
          await navigator.clipboard.writeText(html);
          showModal(`
            <div class="modal-header">
              <h3>HTML Copiado</h3>
              <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
            </div>
            <div class="modal-body">
              <p>El código HTML ha sido copiado al portapapeles.</p>
              <textarea class="modal-textarea" readonly>${html.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </div>
            <div class="modal-footer">
              <button class="modal-btn primary" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
            </div>
          `);
        } catch (e) {
          alert('Error al copiar: ' + e.message);
        }
      });

      /* === INSERTAR TABLA === */
      document.getElementById('insertTableBtn')?.addEventListener('click', () => {
        showModal(`
          <div class="modal-header">
            <h3>Insertar Tabla</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <label>Filas: <input type="number" id="tableRows" class="modal-input" value="3" min="1" max="20">
</label>
            <label>Columnas: <input type="number" id="tableCols" class="modal-input" value="3" min="1" max="10"></label>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cancelar</button>
            <button class="modal-btn primary" id="insertTableConfirm">Insertar</button>
          </div>
        `);
    setTimeout(() => {
      document.getElementById('insertTableConfirm')?.addEventListener('click', () => {
        const rows = parseInt(document.getElementById('tableRows').value) || 3;
        const cols = parseInt(document.getElementById('tableCols').value) || 3;
        
        let tableHTML = '<div class="table-wrap"><table><thead><tr>';
        for (let i = 0; i < cols; i++) {
          tableHTML += `<th>Encabezado ${i + 1}</th>`;
        }
        tableHTML += '</tr></thead><tbody>';
        
        for (let i = 0; i < rows; i++) {
          tableHTML += '<tr>';
          for (let j = 0; j < cols; j++) {
            tableHTML += '<td>Celda</td>';
          }
          tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table></div>';

        const insertedNode = insertHtmlAtSelection(tableHTML);
        if (insertedNode) {
          hideModal();
        } else {
          alert('Selecciona un área editable antes de insertar una tabla.');
        }
      });
    }, 100);
  });

  /* === BUSCAR Y REEMPLAZAR === */
  document.getElementById('findReplaceBtn')?.addEventListener('click', () => {
    showModal(`
      <div class="modal-header">
        <h3>Buscar y Reemplazar</h3>
        <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <label>Buscar: <input type="text" id="findText" class="modal-input" placeholder="Texto a buscar"></label>
        <label>Reemplazar con: <input type="text" id="replaceText" class="modal-input" placeholder="Texto de reemplazo"></label>
        <p id="findReplaceStatus" style="margin-top: 10px; color: #6c757d;"></p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
        <button class="modal-btn primary" id="replaceAllBtn">Reemplazar Todo</button>
      </div>
    `);

    setTimeout(() => {
      document.getElementById('replaceAllBtn')?.addEventListener('click', () => {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        const status = document.getElementById('findReplaceStatus');
        
        if (!findText) {
          status.textContent = 'Por favor ingresa el texto a buscar';
          return;
        }

        let count = 0;
        const currentPage = getCurrentPage() || getCurrentMagicPage();
        if (currentPage) {
          const html = currentPage.innerHTML;
          const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
          const newHtml = html.replace(regex, (match) => {
            count++;
            return replaceText;
          });
          currentPage.innerHTML = newHtml;
        }

        status.textContent = `Se reemplazaron ${count} coincidencia(s)`;
      });
    }, 100);
  });

  /* === DUPLICAR TEMA === */
  document.getElementById('duplicateTopicBtn')?.addEventListener('click', () => {
    const currentPage = getCurrentPage();
    if (!currentPage) return;
    duplicateTopicPage(currentPage);
  });

  /* === EXPORTAR TEMA === */
  function exportSingleTopic(page) {
    const h1 = page.querySelector('h1');
    const titleSpan = h1?.querySelector('span:first-child');
    const title = (titleSpan?.textContent || h1?.textContent || 'tema').trim();
    const magicId = magicAnchorFor(page);
    const magicContent = document.getElementById(magicId);
    
    const tempPage = page.cloneNode(true);
    tempPage.contentEditable = 'false';

    const currentTheme = document.body.className.split(' ').find(c => c.startsWith('theme-')) || 'theme-blue';

    const htmlDoc = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
${document.querySelector('style').textContent}
  </style>
</head>
<body class="${currentTheme}">
  ${magicContent ? '<div class="magic-content-container" style="display:none">' + magicContent.outerHTML + '</div>' : ''}
  ${tempPage.outerHTML}
</body>
</html>`;
    const blob = new Blob([htmlDoc], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.toLowerCase().replace(/\s+/g, '-')}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.getElementById('exportTopicBtn')?.addEventListener('click', () => {
    const currentPage = getCurrentPage();
    if (currentPage) {
      exportSingleTopic(currentPage);
    }
  });

  /* === ESTADÍSTICAS === */
  statsBtn?.addEventListener('click', () => {
    const totalPages = pages.length;
    const totalWords = pages.reduce((sum, p) => sum + countWords(p.innerHTML), 0);
    const avgWords = Math.round(totalWords / totalPages);
    const minWords = Math.min(...pages.map(p => countWords(p.innerHTML)));
    const maxWords = Math.max(...pages.map(p => countWords(p.innerHTML)));

    showModal(`
      <div class="modal-header">
        <h3>Estadísticas del Documento</h3>
        <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total de Temas</div>
            <div class="stat-value">${totalPages}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total de Palabras</div>
            <div class="stat-value">${totalWords.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Promedio por Tema</div>
            <div class="stat-value">${avgWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Mínimo</div>
            <div class="stat-value">${minWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Máximo</div>
            <div class="stat-value">${maxWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Secciones</div>
            <div class="stat-value">${sections.length}</div>
          </div>
        </div>
        <h4 style="margin-top: 20px;">Detalle por Tema:</h4>
        <div style="max-height: 300px; overflow-y: auto;">
          ${pages.map((p, i) => {
            const h1 = p.querySelector('h1');
            const titleSpan = h1?.querySelector('span:first-child');
            const title = (titleSpan?.textContent || h1?.textContent || `Tema ${i+1}`).trim();
            const words = countWords(p.innerHTML);
            const percentage = Math.round((words / totalWords) * 100);
            return `
              <div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <strong>${title}</strong>: ${words} palabras (${percentage}%)
                <div style="background: #dee2e6; height: 4px; border-radius: 2px; margin-top: 4px;">
                  <div style="background: var(--theme-primary); height: 100%; width: ${percentage}%; border-radius: 2px;"></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn primary" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
      </div>
    `);
  });
  
  document.addEventListener('keydown', (e) => {
    if (!isEditMode) return;

    if (e.ctrlKey || e.metaKey) {
      switch(e.key.toLowerCase()) {
        case 'b':
          e.preventDefault();
          execCmd('bold');
          break;
        case 'i':
          e.preventDefault();
          execCmd('italic');
          break;
        case 'u':
          e.preventDefault();
          execCmd('underline');
          break;
        case 'z':
          if (e.shiftKey) {
            e.preventDefault();
            execCmd('redo');
          } else {
            e.preventDefault();
            execCmd('undo');
          }
          break;
        case 'y':
          e.preventDefault();
          execCmd('redo');
          break;
      }
    }
  });

  /* === IMPORTAR / EXPORTAR SECCIONES === */
  function generateUniqueId(prefix) {
    return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
  }

  function collectDocumentData() {
    const magicContainer = document.querySelector('.magic-content-container');
    const sectionMap = new Map();
    const seenPages = new Set();
    const exportedSections = [];

    sections.forEach(section => {
      const baseSectionId = section.id || section.temas.find(t => t.page)?.page?.dataset.sectionId || generateUniqueId('seccion');
      const baseSectionName = section.nombre || section.temas.find(t => t.page)?.page?.dataset.sectionName || 'Sección';
      const exportSection = {
        id: baseSectionId,
        nombre: baseSectionName,
        collapsed: !!section.collapsed,
        temas: []
      };

      sectionMap.set(baseSectionId, exportSection);
      exportedSections.push(exportSection);

      section.temas.forEach(tema => {
        const page = tema.page || pages.find(p => p.dataset.topicId === tema.id);
        if (!page) return;

        seenPages.add(page);
        page.dataset.sectionId = baseSectionId;
        if (!page.dataset.sectionName) {
          page.dataset.sectionName = baseSectionName;
        }

        let topicId = page.dataset.topicId || tema.id;
        if (!topicId) {
          topicId = generateUniqueId('topic');
          page.dataset.topicId = topicId;
        }

        const titleText = (tema.titulo || getTopicTitle(page) || '').trim() || `Tema ${exportSection.temas.length + 1}`;
        const magicId = magicAnchorFor(page);
        const magicEl = magicId ? document.getElementById(magicId) : null;

        exportSection.temas.push({
          id: topicId,
          titulo: titleText,
          html: page.innerHTML,
          sectionId: page.dataset.sectionId,
          sectionName: page.dataset.sectionName,
          magicId: magicId || null,
          magicHtml: magicEl ? magicEl.innerHTML : null
        });
      });
    });

    pages.forEach(page => {
      if (seenPages.has(page)) return;

      const sectionId = page.dataset.sectionId || generateUniqueId('seccion');
      const sectionName = page.dataset.sectionName || 'Sección';
      let exportSection = sectionMap.get(sectionId);
      if (!exportSection) {
        exportSection = {
          id: sectionId,
          nombre: sectionName,
          collapsed: false,
          temas: []
        };
        sectionMap.set(sectionId, exportSection);
        exportedSections.push(exportSection);
      }

      let topicId = page.dataset.topicId;
      if (!topicId) {
        topicId = generateUniqueId('topic');
        page.dataset.topicId = topicId;
      }

      const magicId = magicAnchorFor(page);
      const magicEl = magicId ? document.getElementById(magicId) : null;

      exportSection.temas.push({
        id: topicId,
        titulo: getTopicTitle(page) || `Tema ${exportSection.temas.length + 1}`,
        html: page.innerHTML,
        sectionId: sectionId,
        sectionName: sectionName,
        magicId: magicId || null,
        magicHtml: magicEl ? magicEl.innerHTML : null
      });
    });

    return {
      specialty: specialtySpan?.textContent || '',
      sections: exportedSections,
      magicContainerHtml: magicContainer ? magicContainer.innerHTML : '',
      zoom: currentZoom
    };
  }

  function downloadJsonFile(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importSectionsData(data, options = {}) {
    if (!data || !Array.isArray(data.sections)) {
      throw new Error('El archivo no contiene secciones válidas.');
    }

    const { skipCacheSave = false, skipZoom = false } = options;

    const mainContainer = document.body;
    const scriptTag = document.querySelector('script');
    if (!scriptTag) {
      throw new Error('No se encontró el contenedor principal.');
    }

    io.disconnect();
    pages.forEach(page => {
      detachPageListeners(page);
      page.remove();
    });

    if (specialtySpan && typeof data.specialty === 'string') {
      specialtySpan.textContent = data.specialty;
    }

    const magicContainer = document.querySelector('.magic-content-container');
    if (magicContainer && typeof data.magicContainerHtml === 'string') {
      magicContainer.innerHTML = data.magicContainerHtml;
      magicContainer.querySelectorAll('.magic-topic').forEach(topic => afterContentSanitize(topic));
    }

    const newPages = [];
    const newSections = [];

    data.sections.forEach(sectionData => {
      const sectionId = sectionData?.id ? String(sectionData.id) : generateUniqueId('seccion');
      const sectionName = sectionData?.nombre ? String(sectionData.nombre) : 'Sección';
      const sectionCollapsed = !!sectionData?.collapsed;
      const sectionInfo = { id: sectionId, nombre: sectionName, collapsed: sectionCollapsed, temas: [] };
      const topics = Array.isArray(sectionData?.temas) ? sectionData.temas : [];

      topics.forEach(topicData => {
        const topicId = topicData?.id ? String(topicData.id) : generateUniqueId('topic');
        const topicSectionName = topicData?.sectionName ? String(topicData.sectionName) : sectionName;
        const page = document.createElement('section');
        page.className = 'page';
        page.dataset.sectionId = sectionId;
        page.dataset.sectionName = topicSectionName;
        page.dataset.topicId = topicId;
        page.innerHTML = typeof topicData?.html === 'string' ? topicData.html : '';
        mainContainer.insertBefore(page, scriptTag);
        afterContentSanitize(page);
        page.contentEditable = isEditMode ? 'true' : 'false';
        attachPageListeners(page);

        const title = (topicData?.titulo && String(topicData.titulo).trim()) || getTopicTitle(page) || `Tema ${sectionInfo.temas.length + 1}`;
        sectionInfo.temas.push({ id: topicId, titulo: title, page });
        newPages.push(page);

        if (magicContainer && topicData?.magicId) {
          const magicId = String(topicData.magicId);
          let magicTopic = document.getElementById(magicId);
          if (!magicTopic) {
            magicTopic = document.createElement('div');
            magicTopic.id = magicId;
            magicTopic.className = 'magic-topic';
            magicContainer.appendChild(magicTopic);
          }
          if (typeof topicData.magicHtml === 'string') {
            magicTopic.innerHTML = topicData.magicHtml;
            afterContentSanitize(magicTopic);
          }
        }
      });

      newSections.push(sectionInfo);
    });

    pages = newPages;
    sections = newSections;
    allSectionsExpanded = sections.every(section => !section.collapsed);
    globalTopicCounter = 1;

    pages.forEach(page => io.observe(page));
    setupMagicIcons();
    buildSectionsPanel();
    buildTableOfContents();
    if (isEditMode) {
      enableHtmlPaste();
    }
    hideImageToolbar();
    hideTemplateToolbar();
    savedSelection = null;
    window.scrollTo({ top: 0 });

    if (!skipZoom && typeof data.zoom === 'number') {
      applyZoom(data.zoom, { skipCache: true });
    }

    if (!skipCacheSave) {
      scheduleCacheSave();
    }
  }

  exportDataBtn?.addEventListener('click', () => {
    try {
      const data = collectDocumentData();
      const specialtySlug = (data.specialty || 'documento').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
      const timestamp = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
      const filename = `${specialtySlug || 'documento'}-secciones-${timestamp}.json`;
      downloadJsonFile(data, filename);
      const btn = exportDataBtn;
      if (btn) {
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Exportado</span>';
        setTimeout(() => {
          btn.innerHTML = oldHtml;
        }, 2000);
      }
    } catch (error) {
      console.error('Error al exportar datos:', error);
      alert('No se pudo exportar el contenido: ' + error.message);
    }
  });

  importDataBtn?.addEventListener('click', () => {
    importDataInput?.click();
  });

  importDataInput?.addEventListener('change', async (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);
      importSectionsData(data);
      if (importDataBtn) {
        const oldHtml = importDataBtn.innerHTML;
        importDataBtn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Importado</span>';
        setTimeout(() => {
          importDataBtn.innerHTML = oldHtml;
        }, 2000);
      }
    } catch (error) {
      console.error('Error al importar datos:', error);
      alert('Error al importar datos: ' + error.message);
    } finally {
      event.target.value = '';
    }
  });

  /* === GUARDAR HTML === */
  saveHtmlBtn?.addEventListener('click', () => {
    const wasEditing = isEditMode;
    if (wasEditing) {
      pages.forEach(page => page.contentEditable = 'false');
    }
    
    const toolbarWasVisible = editToolbar.classList.contains('show');
    if (toolbarWasVisible) {
      editToolbar.classList.remove('show');
    }

    const buildData = {
      especialidad: specialtySpan?.textContent || 'documento',
      secciones: sections.map(sec => ({
        id: sec.id,
        nombre: sec.nombre,
        temas: sec.temas.map(t => ({
          id: t.id,
          titulo: t.titulo
        }))
      }))
    };
    
    const doctype = '<!DOCTYPE html>\n';
    let html = document.documentElement.outerHTML;
    
    const buildComment = `<!-- build:topics ${JSON.stringify(buildData)} -->`;
    html = html.replace(/<!-- build:topics.*?-->/s, buildComment);
    
    const fullHtml = doctype + html;
    
    if (toolbarWasVisible) {
      editToolbar.classList.add('show');
    }
    
    const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    const specialty = specialtySpan?.textContent || 'documento';
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const filename = `${specialty.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.html`;
    a.download = filename;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    if (wasEditing) {
      pages.forEach(page => page.contentEditable = 'true');
    }
    
    const btn = saveHtmlBtn;
    const oldText = btn.textContent;
    btn.textContent = '✅ Guardado';
    setTimeout(() => btn.textContent = oldText, 2000);
  });

  function importHtmlFile(file, existingTopicIds) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const htmlText = event.target.result;
          const parser = new DOMParser();
          const loadedDoc = parser.parseFromString(htmlText, 'text/html');

          let hasNewStructure = false;
          let importedSectionId = null;
          let importedSectionName = 'Importado';

          try {
            const buildMatch = htmlText.match(/build:topics\s({.*?})/s);
            if (buildMatch) {
              const buildData = JSON.parse(buildMatch[1]);
              if (buildData.secciones && buildData.secciones.length > 0) {
                hasNewStructure = true;
                importedSectionId = buildData.secciones[0].id;
                importedSectionName = buildData.secciones[0].nombre;
              }
            }
          } catch (error) {
            console.log('Archivo sin estructura de secciones');
          }

          const loadedSpecialty = loadedDoc.getElementById('specialtyTitle');
          if (loadedSpecialty && specialtySpan && loadedSpecialty.textContent.trim()) {
            specialtySpan.textContent = loadedSpecialty.textContent.trim();
          }

          const mainContainer = document.querySelector('body');
          const scriptTag = mainContainer.querySelector('script');
          const loadedPages = loadedDoc.querySelectorAll('.page');

          if (loadedPages.length === 0) {
            throw new Error(`No se encontraron secciones de contenido en ${file.name}`);
          }

          if (!hasNewStructure) {
            importedSectionId = 'seccion-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            importedSectionName = file.name.replace(/\.html$/i, '');
          }

          loadedPages.forEach(page => {
          const clonedPage = page.cloneNode(true);
          afterContentSanitize(clonedPage);

          if (!clonedPage.dataset.sectionId) {
            clonedPage.dataset.sectionId = importedSectionId;
          }
            if (!clonedPage.dataset.sectionName) {
              clonedPage.dataset.sectionName = importedSectionName;
            }

            let topicId = clonedPage.dataset.topicId;
            if (!topicId) {
              topicId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
              clonedPage.dataset.topicId = topicId;
            } else if (existingTopicIds.has(topicId)) {
              const newId = topicId + '-' + Math.random().toString(36).substr(2, 4);
              clonedPage.dataset.topicId = newId;
              topicId = newId;
            }
            existingTopicIds.add(topicId);

          clonedPage.contentEditable = isEditMode ? 'true' : 'false';
          mainContainer.insertBefore(clonedPage, scriptTag);
          attachPageListeners(clonedPage);
        });

          const magicContainer = document.querySelector('.magic-content-container');
          if (magicContainer) {
            const loadedMagicContainer = loadedDoc.querySelector('.magic-content-container');
            if (loadedMagicContainer) {
              loadedMagicContainer.querySelectorAll('.magic-topic').forEach(topic => {
                const clonedTopic = topic.cloneNode(true);
                afterContentSanitize(clonedTopic);
                magicContainer.appendChild(clonedTopic);
              });
            }
          }

          resolve();
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = () => reject(reader.error || new Error('No se pudo leer el archivo'));
      reader.readAsText(file);
    });
  }

  /* === CARGAR HTML === */
  loadHtmlBtn?.addEventListener('click', () => {
    loadHtmlInput.click();
  });

  loadHtmlInput?.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    const htmlFiles = files.filter(file => file.name.toLowerCase().endsWith('.html'));
    const ignoredFiles = files.filter(file => !file.name.toLowerCase().endsWith('.html'));

    if (!htmlFiles.length) {
      alert('Por favor selecciona archivos HTML válidos');
      e.target.value = '';
      return;
    }

    if (ignoredFiles.length) {
      alert(`Se ignoraron archivos no compatibles: ${ignoredFiles.map(f => f.name).join(', ')}`);
    }

    const existingTopicIds = new Set(pages.map(p => p.dataset.topicId).filter(Boolean));

    try {
      for (const file of htmlFiles) {
        await importHtmlFile(file, existingTopicIds);
      }

      pages = [...document.querySelectorAll('.page')];
      pages.forEach(p => {
        afterContentSanitize(p);
        if (!p.dataset.topicId) {
          p.dataset.topicId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        attachPageListeners(p);
        io.observe(p);
      });

      setupMagicIcons();
      initializeSections();
      buildSectionsPanel();
      buildTableOfContents();

      if (isEditMode) {
        pages.forEach(page => page.contentEditable = 'true');
        enableHtmlPaste();
      }

      const btn = loadHtmlBtn;
      if (btn) {
        const oldText = btn.innerHTML;
        btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Cargado</span>';
        setTimeout(() => btn.innerHTML = oldText, 2000);
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
      scheduleCacheSave();
    } catch (error) {
      console.error('Error al cargar el archivo:', error);
      alert('Error al cargar archivos: ' + error.message);
    } finally {
      e.target.value = '';
    }
  });

  /* === COPIAR HTML === */
  document.getElementById('copyHtmlBtn')?.addEventListener('click', async () => {
    const doctype = '<!DOCTYPE html>\n';
    const html = doctype + document.documentElement.outerHTML;
    try {
      await navigator.clipboard.writeText(html);
      const btn = document.getElementById('copyHtmlBtn');
      const old = btn.innerHTML;
      btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Copiado</span>';
      setTimeout(() => btn.innerHTML = old, 1500);
    } catch (e) {
      alert('No se pudo copiar el HTML');
    }
  });

  applyZoom(currentZoom, { skipCache: true, skipPersist: true });
  loadDocumentFromCacheOnStartup();

  if (STORAGE_AVAILABLE) {
    window.addEventListener('beforeunload', () => {
      if (hasPendingChanges) {
        persistDocumentToCache();
      }
    });
  }

})();
  </script>
</body>
</html>
