<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resumen – Endocrinología</title>
  <style>
    /* ===== Variables de tema ===== */
    :root {
      --theme-primary: #0d6efd;
      --theme-primary-dark: #0b5ed7;
      --theme-primary-light: #6ea8fe;
      --base-font-size: 10.5px;
      --zoom-level: 1;
      --topbar-height: 36px;
      font-size: calc(var(--base-font-size) * var(--zoom-level));
    }

    body.theme-blue,
    .page.theme-blue {
      --theme-primary: #0d6efd;
      --theme-primary-dark: #0b5ed7;
      --theme-primary-light: #6ea8fe;
    }

    body.theme-green,
    .page.theme-green {
      --theme-primary: #198754;
      --theme-primary-dark: #157347;
      --theme-primary-light: #75b798;
    }

    body.theme-purple,
    .page.theme-purple {
      --theme-primary: #6f42c1;
      --theme-primary-dark: #59359a;
      --theme-primary-light: #9d7cd4;
    }

    body.theme-orange,
    .page.theme-orange {
      --theme-primary: #fd7e14;
      --theme-primary-dark: #dc6502;
      --theme-primary-light: #fda861;
    }

    body.theme-teal,
    .page.theme-teal {
      --theme-primary: #0f766e;
      --theme-primary-dark: #0b5c55;
      --theme-primary-light: #5eead4;
    }

    body.theme-rose,
    .page.theme-rose {
      --theme-primary: #c81e5d;
      --theme-primary-dark: #99154a;
      --theme-primary-light: #f4a2c2;
    }

    body.theme-sand,
    .page.theme-sand {
      --theme-primary: #b68900;
      --theme-primary-dark: #876500;
      --theme-primary-light: #f6d365;
    }

    body.theme-slate,
    .page.theme-slate {
      --theme-primary: #475569;
      --theme-primary-dark: #334155;
      --theme-primary-light: #94a3b8;
    }

    /* ===== Base ===== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f8f9fa;
      color: #212529;
      margin: 0;
      padding: 0;
      line-height: 1.3;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    /* ===== Modo lectura ===== */
    body.reading-mode {
      background: #fafafa;
    }

    body.reading-mode .topbar,
    body.reading-mode .edit-toolbar {
      display: none !important;
    }

    body.reading-mode .page {
      margin-top: 1.9rem;
      box-shadow: 0 0 5px rgba(0, 0, 0, .05);
      max-width: 76.2rem;
    }

    .reading-mode-exit {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.905rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    body.reading-mode .reading-mode-exit {
      display: flex;
    }

    .reading-mode-exit:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.1);
    }

    /* ===== Topbar ===== */
    .topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 4000;
      height: var(--topbar-height);
      background: #000;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, .25);
      font-size: 11px;
    }

    .topbar-left {
      position: absolute;
      left: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar-center {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: calc(100% - 190px);
    }

    .topbar-right {
      position: absolute;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .topbar-topic {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 6px;
      background: #222;
      color: #ddd;
      max-width: 60vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .topbar-topic:empty {
      display: none;
    }

    .topbar-btn {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      transition: opacity .15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .topbar-btn:hover {
      opacity: .9
    }

    .topbar-btn.active {
      background: var(--theme-primary);
      border-color: var(--theme-primary);
    }

    .topbar-btn-label {
      font-size: 11px;
      display: none;
    }

    @media (min-width: 768px) {
      .topbar-btn-label {
        display: inline;
      }
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .zoom-value {
      min-width: 68px;
      text-align: center;
      font-size: 12px;
      background: #222;
      padding: 3px 6px;
      border-radius: 5px;
    }

    /* ===== Barra de herramientas mejorada ===== */
    .edit-toolbar {
      position: fixed;
      top: calc(var(--topbar-height) + 8px);
      left: 0;
      right: 0;
      background: #fff;
      border-bottom: 1px solid #dee2e6;
      padding: 6px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
      display: none;
      z-index: 3500;
      justify-content: center;
      font-size: 0.95rem;
    }

    .edit-toolbar.show {
      display: flex;
    }

    .toolbar-content {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      align-items: center;
      justify-content: center;
      max-width: 1400px;
    }

    .edit-toolbar button, .edit-toolbar select {
      padding: 3px 6px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 0.952rem;
      line-height: 1.2;
    }

    .edit-toolbar button:hover {
      background: #f8f9fa;
    }

    .edit-toolbar button.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .edit-toolbar select {
      min-width: 70px;
      font-size: 0.952rem;
    }

    .toolbar-separator {
      width: 1px;
      height: 20px;
      background: #dee2e6;
      margin: 0 2px;
    }

    .toolbar-group {
      display: flex;
      gap: 3px;
      align-items: center;
      padding: 2px;
      background: #f8f9fa;
      border-radius: 3px;
      position: relative;
    }

    .toolbar-label {
      font-size: 0.857rem;
      color: #6c757d;
      font-weight: 600;
      margin-right: 3px;
    }

    /* Paleta de colores */
    .color-palette {
      display: grid;
      grid-template-columns: repeat(8, 20px);
      gap: 3px;
      padding: 6px;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      position: fixed;
      z-index: 9999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
    }

    .color-palette.show {
      display: grid;
    }

    .color-swatch {
      width: 20px;
      height: 20px;
      border: 1px solid #dee2e6;
      border-radius: 3px;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .color-swatch:hover {
      transform: scale(1.15);
      border-color: #495057;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* ===== Panel de herramientas de imagen ===== */
    .image-toolbar {
      position: fixed;
      background: #fff;
      border: 2px solid var(--theme-primary);
      border-radius: 6px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 3600;
      min-width: 220px;
    }

    .image-toolbar.show {
      display: flex;
    }

    .image-frame {
      border: 2px solid rgba(13, 110, 253, 0.35);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background: rgba(13, 110, 253, 0.08);
      padding: 6px;
      border-radius: 6px;
    }

    .image-figure {
      display: inline-block;
      margin: 10px;
      text-align: center;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
    }

    .image-figure figcaption {
      margin-top: 8px;
      font-size: 0.85em;
      color: #495057;
      outline: none;
      min-width: 120px;
    }

    .image-toolbar-row {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .image-toolbar button {
      padding: 4px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 0.952rem;
      transition: all 0.15s;
    }

    .image-toolbar button:hover {
      background: #f8f9fa;
    }

    .image-toolbar button.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .image-toolbar label {
      font-size: 0.857rem;
      color: #6c757d;
      font-weight: 600;
      min-width: 40px;
    }

    .image-toolbar input[type="range"] {
      flex: 1;
      min-width: 120px;
    }

    .image-toolbar .size-display {
      font-size: 0.857rem;
      color: #495057;
      min-width: 60px;
      text-align: right;
    }

    .image-size-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
    }

    .image-size-btn {
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      line-height: 1;
      padding: 0;
    }

    /* ===== Plantillas ===== */
    .template-block {
      display: block;
      margin: 8px 0;
      padding: 4px;
      border-radius: 6px;
      transition: box-shadow 0.2s ease, outline 0.2s ease;
      position: relative;
    }

    .template-block > :first-child {
      margin-top: 0;
    }

    .template-block > :last-child {
      margin-bottom: 0;
    }

    .template-block.selected-template {
      outline: 2px solid var(--theme-primary);
      outline-offset: 2px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .template-toolbar {
      position: fixed;
      background: #fff;
      border: 2px solid var(--theme-primary);
      border-radius: 6px;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 3500;
      min-width: 240px;
    }

    .template-toolbar.show {
      display: flex;
    }

    .template-toolbar-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .template-toolbar label {
      font-size: 0.857rem;
      color: #6c757d;
      font-weight: 600;
      min-width: 64px;
    }

    .template-toolbar select {
      flex: 1;
      font-size: 0.952rem;
      padding: 4px 6px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background: #fff;
      color: #212529;
    }

    .template-toolbar .template-toolbar-static-label {
      font-size: 0.857rem;
      color: #6c757d;
      font-weight: 600;
      min-width: 64px;
    }

    .template-spacing-buttons {
      display: flex;
      gap: 4px;
    }

    .template-spacing-buttons button {
      flex: 1;
    }

    .template-toolbar input[type="color"] {
      width: 3.43rem;
      height: 2.29rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 0;
      background: #fff;
      cursor: pointer;
    }

    .template-toolbar input[type="range"] {
      flex: 1;
      min-width: 120px;
    }

    .template-toolbar .size-display {
      font-size: 0.857rem;
      color: #495057;
      min-width: 52px;
      text-align: right;
    }

    .template-toolbar button {
      padding: 4px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      font-size: 0.952rem;
      transition: all 0.15s;
    }

    .template-toolbar button:hover {
      background: #f8f9fa;
    }

    .template-toolbar .template-color-palette {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .template-toolbar .template-color-swatch {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.15);
      cursor: pointer;
      position: relative;
      padding: 0;
      background: var(--swatch-color, #ffffff);
    }

    .template-toolbar .template-color-swatch::after {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 5px;
      border: 2px solid transparent;
      pointer-events: none;
      transition: border-color 0.2s ease;
    }

    .template-toolbar .template-color-swatch:hover {
      background: var(--swatch-color, #ffffff);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.12);
    }

    .template-toolbar .template-color-swatch.active::after {
      border-color: var(--theme-primary);
    }

    .template-toolbar .template-toolbar-row.compact {
      align-items: flex-start;
    }

    img.selected-image {
      outline: 2px solid var(--theme-primary);
      outline-offset: 2px;
      cursor: move;
    }

    img.float-left {
      float: left;
      margin: 0 10px 10px 0;
    }

    img.float-right {
      float: right;
      margin: 0 0 10px 10px;
    }

    img.center-block {
      display: block;
      margin: 10px auto;
      float: none;
    }

    img.inline-image {
      display: inline;
      vertical-align: middle;
      margin: 0 5px;
    }

    .image-figure.float-left {
      float: left;
      margin: 0 10px 10px 0;
    }

    .image-figure.float-right {
      float: right;
      margin: 0 0 10px 10px;
    }

    .image-figure.center-block {
      display: block;
      margin: 10px auto;
      float: none;
    }

    .image-figure.inline-image {
      display: inline-block;
      float: none;
      margin: 0 5px;
    }

    #loadHtmlInput,
    #importDataInput {
      display: none;
    }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 5000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 700px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.714rem;
      color: var(--theme-primary);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 2.286rem;
      cursor: pointer;
      color: #6c757d;
      line-height: 1;
    }

    .modal-body {
      margin-bottom: 15px;
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding-top: 10px;
      border-top: 1px solid #dee2e6;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      background: #fff;
      cursor: pointer;
      font-size: 1.333rem;
    }

    .modal-btn.primary {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .modal-btn.danger {
      background: #dc3545;
      color: #fff;
      border-color: #dc3545;
    }

    .modal-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1.333rem;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    .modal-textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-family: monospace;
      font-size: 1.143rem;
      min-height: 200px;
      resize: vertical;
      box-sizing: border-box;
    }

    /* ===== Recorte de imágenes ===== */
    .image-crop-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4600;
      padding: 20px;
    }

    .image-crop-modal.show {
      display: flex;
    }

    .image-crop-dialog {
      background: #fff;
      border-radius: 8px;
      max-width: min(90vw, 720px);
      width: 100%;
      box-shadow: 0 12px 32px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .image-crop-header,
    .image-crop-footer {
      padding: 12px 16px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .image-crop-footer {
      border-bottom: none;
      border-top: 1px solid #e9ecef;
    }

    .image-crop-close {
      border: none;
      background: transparent;
      font-size: 1.905rem;
      cursor: pointer;
      color: #495057;
    }

    .image-crop-stage {
      position: relative;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      overflow: auto;
    }

    .image-crop-stage img {
      max-width: 100%;
      height: auto;
      display: block;
      user-select: none;
      touch-action: none;
    }

    .image-crop-selection {
      position: absolute;
      border: 2px dashed var(--theme-primary);
      background: rgba(13,110,253,0.12);
      pointer-events: none;
      display: none;
    }

    .image-crop-selection.show {
      display: block;
    }

    .image-crop-instructions {
      font-size: 1.048rem;
      color: #6c757d;
      margin: 0;
      text-align: center;
      pointer-events: none;
    }

    .image-crop-size {
      font-size: 1.143rem;
      color: #495057;
    }

    .image-crop-actions {
      display: flex;
      gap: 8px;
    }

    .image-crop-actions button {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #ced4da;
      background: #fff;
      cursor: pointer;
      font-size: 1.143rem;
      transition: background 0.2s ease;
    }

    #imageCropApplyBtn {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    #imageCropApplyBtn:disabled {
      background: #adb5bd;
      border-color: #adb5bd;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid var(--theme-primary);
    }

    .stat-label {
      font-size: 1.048rem;
      color: #6c757d;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 1.905rem;
      font-weight: 600;
      color: #212529;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .template-card {
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-card:hover {
      border-color: var(--theme-primary);
      background: #f8f9fa;
    }

    .template-card h4 {
      margin: 0 0 8px 0;
      font-size: 1.143rem;
      color: var(--theme-primary);
    }

    .template-preview {
      font-size: 0.952rem;
      color: #6c757d;
      border: 1px dashed #dee2e6;
      padding: 6px;
      border-radius: 3px;
      min-height: 40px;
    }

    /* ===== Panel lateral ===== */
    .topic-panel {
      position: fixed;
      top: var(--topbar-height);
      left: 0;
      width: 340px;
      max-width: 90vw;
      height: calc(100vh - var(--topbar-height));
      background: #fff;
      border-right: 1px solid #e5e7eb;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .08);
      transform: translateX(-100%);
      transition: transform .2s ease;
      z-index: 4500;
      display: flex;
      flex-direction: column
    }

    .topic-panel.open {
      transform: translateX(0)
    }

    /* ===== Tabla de contenidos ===== */
    .toc-panel {
      position: fixed;
      top: var(--topbar-height);
      right: 0;
      width: 300px;
      max-width: 90vw;
      height: calc(100vh - var(--topbar-height));
      background: #fff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -4px 4px 10px rgba(0, 0, 0, .08);
      transform: translateX(100%);
      transition: transform .2s ease;
      z-index: 4500;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .toc-panel.open {
      transform: translateX(0);
    }

    .toc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .toc-header strong {
      font-size: 1.238rem;
      color: #212529;
    }

    .toc-list {
      list-style: none;
      padding: 10px;
      margin: 0;
    }

    .toc-item {
      padding: 4px 0;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 2px solid transparent;
      padding-left: 8px;
    }

    .toc-item:hover {
      background: #f8f9fa;
      border-left-color: var(--theme-primary);
    }

    .toc-item.h1 {
      font-size: 1.048rem;
      font-weight: 600;
      color: var(--theme-primary);
      margin-top: 8px;
    }

    .toc-item.h2 {
      font-size: 0.952rem;
      font-weight: 500;
      color: #495057;
      padding-left: 20px;
    }

    .toc-item.h3 {
      font-size: 0.857rem;
      color: #6c757d;
      padding-left: 32px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
      gap: 10px;
    }

    .panel-header-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .panel-header strong {
      font-size: 1.238rem;
      color: #212529;
      line-height: 1.1;
    }

    .panel-topic-count {
      font-size: 0.857rem;
      color: #6c757d;
      font-weight: 500;
    }

    .panel-header-actions {
      display: flex;
      gap: 4px;
    }

    .panel-header-btn {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 3px 6px;
      cursor: pointer;
      font-size: 0.952rem;
      color: #495057;
    }

    .panel-header-btn:hover {
      background: #e9ecef;
    }

    .panel-header-btn.active {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
    }

    .panel-actions {
      padding: 6px 10px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .panel-action-btn {
      flex: 1;
      min-width: 70px;
      padding: 4px 6px;
      border: 1px solid #dee2e6;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.952rem;
    }

    .panel-action-btn:hover {
      background: #f8f9fa;
    }

    .sections-container {
      overflow-y: auto;
      flex: 1;
    }

    .section-item {
      border-bottom: 1px solid #f1f3f5;
    }

    .section-header {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      background: #f8f9fa;
      font-weight: 600;
      font-size: 1.048rem;
      gap: 6px;
      border-bottom: 1px solid #e9ecef;
    }

    .section-toggle {
      font-size: 0.857rem;
      transition: transform 0.2s;
      cursor: pointer;
      user-select: none;
      min-width: 12px;
    }

    .section-item.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-name {
      flex: 1;
      cursor: pointer;
    }

    .section-name:hover {
      color: var(--theme-primary);
    }

    .section-actions {
      display: flex;
      gap: 4px;
    }

    .section-action-btn {
      padding: 2px 5px;
      border: 1px solid #dee2e6;
      background: #fff;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.857rem;
    }

    .section-action-btn:hover {
      background: #e9ecef;
    }

    .section-count {
      font-size: 0.857rem;
      color: #6c757d;
      font-weight: normal;
    }

    .topic-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: none;
    }

    .section-item:not(.collapsed) .topic-list {
      display: block;
    }

    .topic-list li {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px 4px 24px;
      border-bottom: 1px dashed #f0f2f4;
      font-size: 0.9rem;
    }

    .topic-list li:hover {
      background: #f8f9fa;
    }

    .topic-list li.active {
      background: #e7f3ff;
      border-left: 3px solid var(--theme-primary);
    }

    .topic-number {
      font-weight: 600;
      color: var(--theme-primary);
      min-width: 20px;
    }

    .topic-list .topic-action {
      font-size: 0.952rem;
      border: 1px solid #d0d7de;
      background: #fff;
      border-radius: 3px;
      padding: 2px 5px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .topic-list .topic-action:hover {
      background: #f8f9fa;
    }

    .topic-list span.topic-title {
      white-space: nowrap;
      overflow: hidden;
      cursor: pointer;
      text-overflow: ellipsis;
      flex: 1;
    }

    .topic-context-menu {
      position: absolute;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      display: none;
      flex-direction: column;
      min-width: 180px;
      z-index: 6000;
      padding: 4px 0;
    }

    .topic-context-menu.show {
      display: flex;
    }

    .topic-context-menu button {
      background: none;
      border: none;
      text-align: left;
      padding: 8px 14px;
      font-size: 1.048rem;
      color: #212529;
      cursor: pointer;
      width: 100%;
    }

    .topic-context-menu button:hover {
      background: #f1f3f5;
    }

    .topic-context-menu button.danger {
      color: #dc3545;
    }

    .panel-backdrop {
      position: fixed;
      top: var(--topbar-height);
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, .15);
      backdrop-filter: saturate(120%) blur(1px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
      z-index: 4400;
    }

    .panel-backdrop.show {
      opacity: 1;
      pointer-events: auto
    }

    /* ===== Páginas con zoom CORREGIDO ===== */
    .page {
      width: 75.6rem;
      min-height: 106.9rem;
      padding: 4.32rem;
      margin: 5.33rem auto 1.9rem;
      box-sizing: border-box;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, .1);
      page-break-after: always;
      overflow-wrap: break-word;
      position: relative;
    }

    .page[contenteditable="true"] {
      outline: 2px solid #d1d5db;
      outline-offset: 4px;
    }

    /* ===== Icono mágico en el título ===== */
    h1 {
      font-size: 1.714rem;
      color: var(--theme-primary);
      margin: 0 0 6px 0;
      padding-bottom: 3px;
      border-bottom: 3px solid var(--theme-primary);
      line-height: 1.2;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    h1 .topic-title-text {
      flex: 1;
      cursor: pointer;
    }

    .magic-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      font-size: 1.524rem;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.05);
      border: none;
      border-radius: 50%;
      transition: all 0.3s ease;
      flex-shrink: 0;
      margin-left: 8px;
    }

    .magic-icon:hover {
      background: var(--theme-primary);
      transform: scale(1.15) rotate(15deg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    h2 {
      font-size: 1.238rem;
      color: var(--theme-primary-dark);
      margin: 8px 0 3px 0;
      font-weight: 600;
      line-height: 1.2
    }

    h3 {
      font-size: 1.048rem;
      color: var(--theme-primary);
      margin: 6px 0 2px 0;
      font-weight: 600;
      line-height: 1.2
    }

    h4 {
      font-size: 1.048rem;
      color: var(--theme-primary-dark);
      margin: 6px 0 2px 0;
      font-weight: 600;
      line-height: 1.2
    }

    p {
      margin: 2px 0;
      text-align: justify
    }

    ul, ol {
      margin: 3px 0;
      padding-left: 18px
    }

    ul li, ol li {
      margin: 1px 0
    }

    strong {
      font-weight: 600;
      color: #343a40
    }

    .small-text {
      font-size: 0.857rem;
      color: #6c757d
    }

    .highlight {
      background: #fff3cd;
      padding: 1px 3px;
      border-radius: 3px;
      font-weight: 600;
      color: #664d03
    }

    .box {
      background: #ffffff;
      border: 1px solid #dee2e6;
      border-left: 4px solid var(--theme-primary);
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 6px;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      resize: none;
      max-width: 100%;
    }

    body.edit-mode .box {
      resize: both;
      overflow: auto;
    }

    .box.note-style-classic {
      background: #ffffff;
      border-color: #dee2e6;
      border-left-color: var(--theme-primary);
      color: #212529;
    }

    .box.note-style-sky {
      background: #f1f8ff;
      border-color: #cfe2ff;
      border-left-color: #0d6efd;
      color: #0b3d91;
    }

    .box.note-style-forest {
      background: #edf7ed;
      border-color: #c6e6c1;
      border-left-color: #198754;
      color: #22543d;
    }

    .box.note-style-sunrise {
      background: #fff7e6;
      border-color: #fbd9a0;
      border-left-color: #f59f0b;
      color: #8b5e11;
    }

    .box.note-style-rose {
      background: #fdf2f8;
      border-color: #f8cddc;
      border-left-color: #c81e5d;
      color: #931946;
    }

    .box.note-style-lilac {
      background: #f3f0ff;
      border-color: #d9ccff;
      border-left-color: #7c3aed;
      color: #4c1d95;
    }

    .box.note-style-slate {
      background: #f5f7fa;
      border-color: #cfd4da;
      border-left-color: #475569;
      color: #364152;
    }

    .box.note-style-pearl {
      background: #fff4e6;
      border-color: #f5d0a9;
      border-left-color: #fd7e14;
      color: #7a3b0c;
    }

    .box.note-style-pearl::before {
      content: "💡 ";
      font-weight: 700;
    }

    .pearl {
      border-left-color: #fd7e14
    }

    .pearl::before {
      content: "💡 ";
      font-weight: 700
    }

    .note-spacer {
      min-height: 12px;
      margin: 6px 0;
    }

    .note-spacer::after {
      content: '';
    }

    .collapse-card {
      border: 1px solid #ced4da;
      border-left-width: 4px;
      border-radius: 6px;
      background: #ffffff;
      margin: 8px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: box-shadow 0.2s ease;
    }

    .collapse-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 12px;
      background: #f1f3f5;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .collapse-card-title {
      font-weight: 600;
      color: #343a40;
      flex: 1;
    }

    .collapse-card-toggle {
      border: none;
      background: var(--theme-primary);
      color: #fff;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.333rem;
      line-height: 1;
      transition: background 0.2s ease;
    }

    .collapse-card-toggle:hover {
      background: var(--theme-primary-dark);
    }

    .collapse-card-body {
      padding: 10px 12px;
    }

    .collapse-card.collapsed .collapse-card-body {
      display: none;
    }

    .collapse-card.collapsed .collapse-card-toggle::after {
      content: '+';
    }

    .collapse-card-toggle::after {
      content: '−';
      font-weight: 700;
    }

    .table-wrap {
      position: relative;
      overflow-x: auto;
      max-width: 100%
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      font-size: 0.952rem;
      margin: 6px 0;
      line-height: 1.25;
      table-layout: fixed
    }

    table th, table td {
      border: 1px solid #dee2e6;
      padding: 3px 5px;
      text-align: left;
      word-wrap: break-word
    }

    table th {
      background: #f5f7fa;
      font-weight: 600
    }

    table.table-zebra tbody tr:nth-child(even) > * {
      background: rgba(13, 110, 253, 0.04);
    }

    table.table-zebra tbody tr:nth-child(odd) > * {
      background: transparent;
    }

    .table-menu-selected {
      outline: 2px solid var(--theme-primary);
      outline-offset: 2px;
    }

    .table-column-highlight {
      background: rgba(13, 110, 253, 0.1) !important;
    }

    .table-menu {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 320px;
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.18);
      display: none;
      flex-direction: column;
      font-size: 1.048rem;
      color: #212529;
      z-index: 4100;
      max-height: calc(100vh - 40px);
      overflow: hidden;
    }

    .table-menu.show {
      display: flex;
    }

    .table-menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid #e9ecef;
      background: linear-gradient(180deg, rgba(248, 249, 250, 0.95), rgba(233, 236, 239, 0.75));
    }

    .table-menu-header-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .table-menu-title {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.952rem;
      color: #6c757d;
    }

    .table-menu-size {
      font-size: 1.238rem;
      font-weight: 600;
      color: #0d6efd;
    }

    .table-menu-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .table-menu button,
    .table-menu input,
    .table-menu select {
      font-family: inherit;
      font-size: 1.048rem;
    }

    .table-menu button {
      cursor: pointer;
      border: 1px solid #d0d5dd;
      background: #f8f9fa;
      color: #1f2937;
      border-radius: 8px;
      padding: 6px 8px;
      transition: all 0.2s ease;
    }

    .table-menu button:hover {
      background: #e9ecef;
    }

    .table-menu button.active,
    .table-menu button[data-state="active"] {
      background: rgba(13, 110, 253, 0.14);
      border-color: rgba(13, 110, 253, 0.5);
      color: #0b5ed7;
      box-shadow: inset 0 0 0 1px rgba(13, 110, 253, 0.2);
    }

    .table-menu-resize {
      background: var(--theme-primary);
      color: #fff;
      border-color: var(--theme-primary);
      padding: 6px 12px;
    }

    .table-menu-resize:hover {
      background: var(--theme-primary-dark);
    }

    .table-menu-close {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      padding: 0;
      font-size: 1.524rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid transparent;
      color: #6c757d;
    }

    .table-menu-close:hover {
      border-color: #dee2e6;
      background: rgba(0, 0, 0, 0.05);
      color: #212529;
    }

    .table-menu-tabs {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 12px 0;
    }

    .table-menu-tab {
      flex: 1;
      border-radius: 10px 10px 0 0;
      border-bottom: none;
      background: #f1f3f5;
      font-size: 1.238rem;
      padding: 8px 0;
    }

    .table-menu-tab.active {
      background: #fff;
      color: #0d6efd;
      border-color: #d0d5dd;
      border-bottom: 1px solid #fff;
      box-shadow: 0 -2px 8px rgba(15, 23, 42, 0.05);
    }

    .table-menu-body {
      padding: 12px;
      overflow-y: auto;
    }

    .table-menu-panel {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .table-menu-panel.active {
      display: flex;
    }

    .table-menu-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 10px;
      border-radius: 10px;
    }

    .table-menu-section h4 {
      margin: 0;
      font-size: 1.048rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #6c757d;
    }

    .table-menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .table-menu-grid.two-columns {
      grid-template-columns: repeat(2, 1fr);
    }

    .table-menu-grid.single-column {
      grid-template-columns: 1fr;
    }

    .table-theme-gallery {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
    }

    .table-menu .table-theme-option {
      padding: 0;
      border: none;
      background: transparent;
    }

    .table-menu .table-theme-option .table-theme-sample {
      width: 100%;
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    .table-menu .table-theme-option.active {
      background: transparent;
      border: none;
    }

    .table-menu .table-theme-option.active .table-theme-sample {
      border-color: rgba(13, 110, 253, 0.6);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.35);
    }

    .table-theme-sample {
      height: 40px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 0.857rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .table-slider-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .table-slider-row label {
      font-size: 1.048rem;
      color: #6c757d;
      font-weight: 600;
    }

    .table-slider-row input[type="range"] {
      width: 100%;
    }

    .table-slider-value {
      font-variant-numeric: tabular-nums;
      font-weight: 600;
      color: #0d6efd;
    }

    .table-preset-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .table-preset-buttons button {
      flex: 1;
      min-width: 0;
    }

    .table-border-colors {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .table-border-color-btn {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(0, 0, 0, 0.15);
      padding: 0;
    }

    .table-border-color-btn.active {
      border-width: 2px;
      border-color: #0d6efd;
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.2);
    }

    .table-border-toggle {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .table-border-toggle label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 1.048rem;
      color: #495057;
    }

    .table-border-toggle input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }

    .table-theme-default {
      background: linear-gradient(135deg, #ffffff, #f1f3f5);
      color: #212529;
    }

    .table-theme-ocean {
      background: linear-gradient(135deg, #e0efff, #f6faff);
      color: #0b5ed7;
    }

    .table-theme-forest {
      background: linear-gradient(135deg, #e4f5e9, #f3fbf5);
      color: #157347;
    }

    .table-theme-sunset {
      background: linear-gradient(135deg, #fef1dc, #fff7ea);
      color: #dc6502;
    }

    .table-theme-violet {
      background: linear-gradient(135deg, #efe7ff, #f8f4ff);
      color: #59359a;
    }

    .table-theme-rose {
      background: linear-gradient(135deg, #fde4ec, #fff4f8);
      color: #c81e5d;
    }

    .table-theme-teal {
      background: linear-gradient(135deg, #d8f3f0, #f3fbfa);
      color: #0f766e;
    }

    .table-theme-sand {
      background: linear-gradient(135deg, #f7eed0, #fdf8e7);
      color: #b68900;
    }

    .table-theme-slate {
      background: linear-gradient(135deg, #e3e8ee, #f5f7fa);
      color: #475569;
    }

    table.table-theme-default thead th {
      background: #f1f3f5;
      color: #495057;
    }

    table.table-theme-ocean thead th {
      background: #e6f0ff;
      color: #0b5ed7;
    }

    table.table-theme-forest thead th {
      background: #e5f4e9;
      color: #157347;
    }

    table.table-theme-sunset thead th {
      background: #fdebd6;
      color: #b65e04;
    }

    table.table-theme-violet thead th {
      background: #f0e8ff;
      color: #59359a;
    }

    table.table-theme-rose thead th {
      background: #fde4ee;
      color: #c81e5d;
    }

    table.table-theme-teal thead th {
      background: #daf5f1;
      color: #0f766e;
    }

    table.table-theme-sand thead th {
      background: #f8f0d9;
      color: #8b6900;
    }

    table.table-theme-slate thead th {
      background: #e7ecf2;
      color: #475569;
    }

    table.table-theme-default tbody tr:nth-child(even) > * {
      background: #f8f9fa;
    }

    table.table-theme-ocean tbody tr:nth-child(even) > * {
      background: #f6faff;
    }

    table.table-theme-forest tbody tr:nth-child(even) > * {
      background: #f3fbf5;
    }

    table.table-theme-sunset tbody tr:nth-child(even) > * {
      background: #fff7ea;
    }

    table.table-theme-violet tbody tr:nth-child(even) > * {
      background: #f8f4ff;
    }

    table.table-theme-rose tbody tr:nth-child(even) > * {
      background: #fff5fa;
    }

    table.table-theme-teal tbody tr:nth-child(even) > * {
      background: #f3fbfa;
    }

    table.table-theme-sand tbody tr:nth-child(even) > * {
      background: #fdf8e7;
    }

    table.table-theme-slate tbody tr:nth-child(even) > * {
      background: #f5f7fa;
    }

    .table-resize-handle {
      position: absolute;
      width: 14px;
      height: 14px;
      bottom: -7px;
      right: -7px;
      border-radius: 4px;
      background: #0d6efd;
      border: 2px solid #fff;
      box-shadow: 0 4px 8px rgba(13, 110, 253, 0.35);
      cursor: nwse-resize;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      transform: scale(0.9);
      z-index: 2;
    }

    .table-resize-wrapper.table-resize-mode .table-resize-handle {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    .table-resize-wrapper.table-resize-active .table-resize-handle {
      transform: scale(1.1);
    }

    .table-resize-overlay {
      position: fixed;
      inset: 0;
      background: rgba(13, 110, 253, 0.05);
      cursor: crosshair;
      z-index: 4050;
      display: none;
      pointer-events: none;
    }

    .table-resize-overlay.show {
      display: block;
    }

    .columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 6px 0
    }

    /* ===== Visor Mágico ===== */
    .magic-view {
      position: fixed;
      top: var(--topbar-height);
      left: 0;
      right: 0;
      bottom: 0;
      background: #f8f9fa;
      display: none;
      flex-direction: column;
      z-index: 3000;
      color: #212529;
      overflow: auto;
      --magic-zoom: 1;
    }

    body.magic-open .magic-view {
      display: flex
    }

    .magic-view.open {
      display: flex;
    }

    .magic-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb
    }

    .magic-close {
      background: transparent;
      border: none;
      font-size: 2.095rem;
      line-height: 1;
      color: #444;
      cursor: pointer
    }

    .magic-page {
      width: 75.6rem;
      min-height: 106.9rem;
      padding: 4.32rem;
      margin: 1.9rem auto;
      background: #fff;
      box-shadow: 0 0 15px rgba(0, 0, 0, .1);
      box-sizing: border-box;
      overflow-wrap: break-word;
      transform: scale(var(--magic-zoom, 1));
      transform-origin: top center;
    }

    .magic-page[contenteditable="true"] {
      outline: 2px solid #d1d5db;
      outline-offset: 4px;
    }

    .magic-page * {
      max-width: 100%
    }

    .magic-title {
      font-size: 1.714rem;
      color: var(--theme-primary);
      margin: 0 0 6px 0;
      padding-bottom: 3px;
      border-bottom: 2px solid var(--theme-primary);
      line-height: 1.2
    }

    /* ===== Notas flotantes ===== */
    .floating-notes-layer {
      position: fixed;
      top: var(--topbar-height);
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 3600;
    }

    body.reading-mode .floating-notes-layer {
      top: 0;
    }

    .floating-note {
      position: absolute;
      width: 240px;
      min-height: 140px;
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: auto;
      backdrop-filter: saturate(120%);
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }

    .floating-note.dragging {
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.25);
      transform: scale(1.02);
    }

    .floating-note-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: grab;
      user-select: none;
    }

    .floating-note-header:active {
      cursor: grabbing;
    }

    .floating-note-title {
      font-weight: 600;
      font-size: 0.98rem;
      flex: 1;
    }

    .floating-note-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .floating-note-style-select {
      font-size: 0.857rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 2px 6px;
      background: #fff;
      color: #212529;
    }

    .floating-note button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      padding: 2px;
      color: inherit;
    }

    .floating-note button:hover {
      opacity: 0.8;
    }

    .floating-note-body {
      flex: 1;
      font-size: 0.95rem;
      line-height: 1.35;
      outline: none;
      border-radius: 6px;
      padding: 4px;
      cursor: text;
      user-select: text;
      min-height: 80px;
      background: transparent;
    }

    .floating-note-body[contenteditable="true"]:focus {
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.5);
    }

    .floating-note-style-default {
      background: #fffbe6;
      border-color: #f2d479;
      color: #5c4b1f;
    }

    .floating-note-style-sky {
      background: #e8f4ff;
      border-color: #a8d8ff;
      color: #1b437f;
    }

    .floating-note-style-mint {
      background: #e6fff3;
      border-color: #9be7c4;
      color: #1f5c3b;
    }

    .floating-note-style-rose {
      background: #ffe8f3;
      border-color: #f3b4cf;
      color: #703049;
    }

    .floating-note-style-lilac {
      background: #f1e9ff;
      border-color: #cbb7f8;
      color: #463271;
    }

    .floating-note-style-slate {
      background: #eef1f5;
      border-color: #c5ccd6;
      color: #2f3947;
    }

    body.notes-hidden #floatingNotesLayer {
      display: none !important;
    }

    .magic-section {
      margin: 10px 0
    }

    .magic-section h4 {
      margin: 0 0 6px 0;
      font-size: 1.143rem;
      color: var(--theme-primary-dark);
    }

    .mini-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 100%;
      font-size: 0.905rem;
      line-height: 1.15;
      margin: 6px 0;
      background: #ffffff;
      color: #212529;
      table-layout: fixed
    }

    .mini-table th, .mini-table td {
      border: 1px solid #dee2e6;
      padding: 2px 4px;
      text-align: left;
      word-wrap: break-word
    }

    .mini-table th {
      background: #e9ecef;
      color: #212529;
      font-weight: 600
    }

    .tight-list {
      margin: 0;
      padding-left: 16px
    }

    .tight-list li {
      margin: 0
    }

    /* ===== Impresión SIN RESTRICCIONES ===== */
    @media print {
      body {
        background: #fff;
        margin: 0;
        padding: 0;
      }

      .topbar,
      .magic-view,
      .topic-panel,
      .toc-panel,
      .panel-backdrop,
      .edit-toolbar,
      .image-toolbar,
      .reading-mode-exit,
      .magic-icon,
      #floatingNotesLayer {
        display: none !important;
      }

      .page, .magic-page {
        box-shadow: none;
        page-break-after: always;
        outline: none !important;
        transform: none !important;
        margin: 0 !important;
        width: 100%;
        min-height: auto;
      }

      body[data-printing-section] .page:not([data-print-target]) {
        display: none !important;
      }

      body[data-printing-section] .page[data-print-target] {
        display: block !important;
      }

      @page {
        size: auto;
        margin: 10mm;
      }
    }
  </style>
</head>
<body>
  <!-- build:topics {"especialidad":"Endocrinología","secciones":[]} -->
  
  <div class="topbar">
    <div class="topbar-left">
      <button class="topbar-btn topbar-plus" title="Abrir panel de navegación"><span>☰</span> <span class="topbar-btn-label">Menú</span></button>
    </div>
    <div class="topbar-center">
      <span id="specialtyTitle" class="topbar-topic" title="Sección actual" data-document-title="Endocrinología"></span>
      <div class="zoom-controls">
        <button class="topbar-btn" id="zoomOutBtn" title="Reducir zoom">-</button>
        <span class="zoom-value" id="zoomValue">100%</span>
        <button class="topbar-btn" id="zoomInBtn" title="Aumentar zoom">+</button>
      </div>
      <button class="topbar-btn" id="tocBtn" title="Tabla de contenidos"><span>📑</span> <span class="topbar-btn-label">Índice</span></button>
      <button class="topbar-btn" id="readingModeBtn" title="Modo lectura"><span>📖</span> <span class="topbar-btn-label">Lectura</span></button>
      <button class="topbar-btn" id="statsBtn" title="Estadísticas"><span>📊</span> <span class="topbar-btn-label">Stats</span></button>
      <button class="topbar-btn" id="loadHtmlBtn" title="Cargar archivo HTML"><span>📂</span> <span class="topbar-btn-label">Abrir</span></button>
      <button class="topbar-btn" id="editBtn" title="Modo edición"><span>✏️</span> <span class="topbar-btn-label">Editar</span></button>
      <button class="topbar-btn" id="saveHtmlBtn" style="display:none;" title="Guardar como HTML"><span>💾</span> <span class="topbar-btn-label">Guardar</span></button>
      <button class="topbar-btn" id="clearAllBtn" title="Eliminar todas las secciones y temas" aria-label="Eliminar todo"><span>🗑️</span></button>
      <button class="topbar-btn" id="exportDataBtn" title="Exportar secciones y temas" aria-label="Exportar secciones y temas"><span>📤</span></button>
      <button class="topbar-btn" id="importDataBtn" title="Importar secciones y temas" aria-label="Importar secciones y temas"><span>📥</span></button>
      <button class="topbar-btn" id="exportMarkdownBtn" title="Exportar a Markdown"><span>⬇️</span> <span class="topbar-btn-label">MD</span></button>
      <button class="topbar-btn" id="copyHtmlBtn" title="Copiar HTML completo"><span>📋</span> <span class="topbar-btn-label">Copiar</span></button>
      <button class="topbar-btn" id="printCurrentBtn" title="Imprimir documento"><span>🖨️</span> <span class="topbar-btn-label">Imprimir</span></button>
    </div>
    <div class="topbar-right">
      <button class="topbar-btn" id="cacheSaveBtn" title="Guardar en caché"><span>💾</span> <span class="topbar-btn-label">Guardar</span></button>
    </div>
  </div>

  <button class="reading-mode-exit" id="readingModeExit" title="Salir del modo lectura">✕</button>

  <input type="file" id="loadHtmlInput" accept=".html" multiple />
  <input type="file" id="importDataInput" accept="application/json" />

  <!-- Barra de herramientas -->
  <div class="edit-toolbar" id="editToolbar">
    <div class="toolbar-content">
      <div class="toolbar-group">
        <span class="toolbar-label">HISTORIAL</span>
        <button id="undoBtn" title="Deshacer (Ctrl+Z)">↶</button>
        <button id="redoBtn" title="Rehacer (Ctrl+Y)">↷</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">FORMATO</span>
        <select id="fontSizeSelect" title="Tamaño">
          <option value="">Tamaño</option>
          <option value="1">Muy pequeño</option>
          <option value="2">Pequeño</option>
          <option value="3">Normal</option>
          <option value="4">Mediano</option>
          <option value="5">Grande</option>
          <option value="6">Muy grande</option>
          <option value="7">Enorme</option>
        </select>
        <button id="boldBtn" title="Negrita (Ctrl+B)"><strong>B</strong></button>
        <button id="italicBtn" title="Cursiva (Ctrl+I)"><em>I</em></button>
        <button id="underlineBtn" title="Subrayado (Ctrl+U)"><u>U</u></button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">SANGRÍA</span>
        <button id="indentBtn" title="Aumentar">→</button>
        <button id="outdentBtn" title="Disminuir">←</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">DESTACAR</span>
        <button id="highlightBtn" title="Destacar">🖍️</button>
      </div>

      <div class="toolbar-group">
        <span class="toolbar-label">COLOR</span>
        <button id="textColorBtn" title="Color">A</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">INSERTAR</span>
        <button id="insertTableBtn" title="Tabla">📊</button>
        <button id="insertUlBtn" title="Lista">•</button>
        <button id="insertOlBtn" title="Numerada">1.</button>
        <button id="insertHtmlBtn" title="HTML personalizado">&lt;/&gt;</button>
        <button id="insertTemplateBtn" title="Plantillas">📝</button>
        <button id="insertCollapseCardBtn" title="Tarjeta colapsable">📘</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">AVANZADO</span>
        <button id="copyHtmlSelectionBtn" title="Copiar HTML">&lt;&gt;</button>
        <button id="findReplaceBtn" title="Buscar">🔍</button>
        <button id="removeFormatBtn" title="Limpiar">🧹</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">NOTAS</span>
        <button id="addFloatingNoteBtn" title="Nota flotante">🗒️</button>
        <button id="toggleNotesBtn" title="Mostrar/Ocultar notas">👁️</button>
      </div>

      <div class="toolbar-separator"></div>

      <div class="toolbar-group">
        <span class="toolbar-label">TEMA</span>
        <select id="themeSelect" title="Esquema">
          <option value="theme-blue">Azul</option>
          <option value="theme-green">Verde</option>
          <option value="theme-purple">Lavanda</option>
          <option value="theme-orange">Naranja</option>
          <option value="theme-teal">Turquesa</option>
          <option value="theme-rose">Rosa</option>
          <option value="theme-sand">Arena</option>
          <option value="theme-slate">Pizarra</option>
        </select>
        <button id="duplicateTopicBtn" title="Duplicar">📑</button>
        <button id="exportTopicBtn" title="Exportar">💾</button>
      </div>
    </div>
  </div>

  <!-- Paletas de color -->
  <div class="color-palette" id="highlightPalette"></div>
  <div class="color-palette" id="textColorPalette"></div>

  <!-- Panel de herramientas de imagen -->
  <div class="image-toolbar" id="imageToolbar">
    <div class="image-toolbar-row">
      <button id="alignLeftBtn" title="Izquierda">⬅️</button>
      <button id="alignCenterBtn" title="Centro">⬌</button>
      <button id="alignRightBtn" title="Derecha">➡️</button>
      <button id="inlineBtn" title="En línea">↔️</button>
    </div>
    <div class="image-toolbar-row">
      <label for="imageAltInput">Alt:</label>
      <input type="text" id="imageAltInput" placeholder="Texto alternativo" style="flex:1; font-size: 1.048rem; padding: 0.38rem;">
      <button id="applyAltBtn" title="Aplicar texto alternativo">Aplicar</button>
    </div>
    <div class="image-toolbar-row">
      <label for="imageFrameToggle">Marco:</label>
      <input type="checkbox" id="imageFrameToggle" style="margin-right: 6px;">
      <span style="font-size: 0.952rem; color: #495057;">Agregar marco</span>
    </div>
    <div class="image-toolbar-row">
      <button id="wrapFigureBtn" title="Agregar figura" style="flex:1;">➕ Cuadro</button>
      <button id="unwrapFigureBtn" title="Quitar figura" style="flex:1;">➖ Quitar</button>
    </div>
    <div class="image-toolbar-row">
      <label>Ancho:</label>
      <div class="image-size-controls">
        <button type="button" class="image-size-btn" id="imageWidthDecrease" title="Reducir tamaño">−</button>
        <span class="size-display" id="widthDisplay">100% (200px)</span>
        <button type="button" class="image-size-btn" id="imageWidthIncrease" title="Aumentar tamaño">+</button>
      </div>
    </div>
    <div class="image-toolbar-row">
      <button id="cropImageBtn" title="Recortar imagen" style="flex: 1;">✂️ Recortar</button>
    </div>
    <div class="image-toolbar-row">
      <button id="deleteImageBtn" title="Eliminar" style="color: #dc3545; flex: 1;">🗑️ Eliminar</button>
    </div>
  </div>

  <div class="table-menu" id="tableMenu" aria-hidden="true">
    <div class="table-menu-header">
      <div class="table-menu-header-info">
        <span class="table-menu-title">Tabla seleccionada</span>
        <span class="table-menu-size" id="tableMenuSize">0 × 0</span>
      </div>
      <div class="table-menu-actions">
        <button type="button" class="table-menu-resize" id="tableResizeBtn">Tamaño</button>
        <button type="button" class="table-menu-close" id="tableMenuClose" title="Cerrar panel">×</button>
      </div>
    </div>
    <div class="table-menu-tabs" role="tablist">
      <button type="button" class="table-menu-tab active" data-tab="structure" role="tab" aria-selected="true">✏️</button>
      <button type="button" class="table-menu-tab" data-tab="style" role="tab" aria-selected="false">🎨</button>
    </div>
    <div class="table-menu-body">
      <div class="table-menu-panel active" data-panel="structure" role="tabpanel">
        <div class="table-menu-section">
          <h4>Acciones rápidas</h4>
          <div class="table-menu-grid two-columns">
            <button type="button" data-action="insert-row-above">Fila ↑</button>
            <button type="button" data-action="insert-row-below">Fila ↓</button>
            <button type="button" data-action="insert-column-left">Columna ←</button>
            <button type="button" data-action="insert-column-right">Columna →</button>
            <button type="button" data-action="delete-row">Eliminar fila</button>
            <button type="button" data-action="delete-column">Eliminar columna</button>
            <button type="button" data-action="clear-column">Limpiar columna</button>
            <button type="button" data-action="select-column">Seleccionar columna</button>
            <button type="button" data-action="toggle-header" data-stateful="true">Fila encabezado</button>
            <button type="button" data-action="toggle-zebra" data-stateful="true">Patrón cebra</button>
            <button type="button" data-action="open-tools">Más herramientas</button>
          </div>
        </div>
      </div>
      <div class="table-menu-panel" data-panel="style" role="tabpanel">
        <div class="table-menu-section">
          <h4>Temas</h4>
          <div class="table-theme-gallery">
            <button type="button" class="table-theme-option active" data-table-theme="">
              <span class="table-theme-sample table-theme-default">Base</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-ocean">
              <span class="table-theme-sample table-theme-ocean">Azul</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-forest">
              <span class="table-theme-sample table-theme-forest">Verde</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-sunset">
              <span class="table-theme-sample table-theme-sunset">Amanecer</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-violet">
              <span class="table-theme-sample table-theme-violet">Lavanda</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-rose">
              <span class="table-theme-sample table-theme-rose">Rosa</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-teal">
              <span class="table-theme-sample table-theme-teal">Turquesa</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-sand">
              <span class="table-theme-sample table-theme-sand">Arena</span>
            </button>
            <button type="button" class="table-theme-option" data-table-theme="table-theme-slate">
              <span class="table-theme-sample table-theme-slate">Gris</span>
            </button>
          </div>
        </div>
        <div class="table-menu-section">
          <h4>Espaciado</h4>
          <div class="table-slider-row">
            <label for="tableLineHeight">Interlineado</label>
            <input type="range" id="tableLineHeight" min="1" max="2" step="0.05">
            <span class="table-slider-value" id="tableLineHeightValue">1.25</span>
          </div>
          <div class="table-slider-row">
            <label for="tablePaddingY">Padding vertical</label>
            <input type="range" id="tablePaddingY" min="2" max="32" step="1">
            <span class="table-slider-value" id="tablePaddingYValue">6px</span>
          </div>
          <div class="table-slider-row">
            <label for="tableMargin">Margen exterior</label>
            <input type="range" id="tableMargin" min="0" max="48" step="1">
            <span class="table-slider-value" id="tableMarginValue">6px</span>
          </div>
          <div class="table-preset-buttons">
            <button type="button" data-table-preset="compacta">Compacta</button>
            <button type="button" data-table-preset="equilibrada">Equilibrada</button>
            <button type="button" data-table-preset="amplia">Amplia</button>
          </div>
        </div>
        <div class="table-menu-section">
          <h4>Líneas divisorias</h4>
          <div class="table-border-colors">
            <button type="button" class="table-border-color-btn" style="background:#dee2e6;" data-border-color="#dee2e6"></button>
            <button type="button" class="table-border-color-btn" style="background:#adb5bd;" data-border-color="#adb5bd"></button>
            <button type="button" class="table-border-color-btn" style="background:#0d6efd;" data-border-color="#0d6efd"></button>
            <button type="button" class="table-border-color-btn" style="background:#198754;" data-border-color="#198754"></button>
            <button type="button" class="table-border-color-btn" style="background:#fd7e14;" data-border-color="#fd7e14"></button>
            <button type="button" class="table-border-color-btn" style="background:#6f42c1;" data-border-color="#6f42c1"></button>
            <input type="color" id="tableBorderColorCustom" value="#dee2e6" title="Color personalizado">
          </div>
          <div class="table-slider-row">
            <label for="tableBorderWidth">Grosor</label>
            <input type="range" id="tableBorderWidth" min="0" max="8" step="0.5">
            <span class="table-slider-value" id="tableBorderWidthValue">1px</span>
          </div>
          <div class="table-border-toggle">
            <label><input type="checkbox" id="toggleVerticalBorders"> Ocultar verticales</label>
            <label><input type="checkbox" id="toggleHorizontalBorders"> Ocultar horizontales</label>
          </div>
          <div class="table-preset-buttons">
            <button type="button" data-border-reset="true">Restablecer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-resize-overlay" id="tableResizeOverlay" aria-hidden="true"></div>

  <div class="image-crop-modal" id="imageCropModal" aria-hidden="true">
    <div class="image-crop-dialog">
      <div class="image-crop-header">
        <strong>Recortar imagen</strong>
        <button type="button" id="imageCropCloseBtn" class="image-crop-close" title="Cerrar">&times;</button>
      </div>
      <div class="image-crop-stage" id="imageCropStage">
        <img id="imageCropPreview" alt="Vista previa de la imagen a recortar" />
        <div class="image-crop-selection" id="imageCropSelection"></div>
        <p class="image-crop-instructions">Haz clic y arrastra sobre la imagen para elegir el área a conservar.</p>
      </div>
      <div class="image-crop-footer">
        <span class="image-crop-size" id="imageCropSizeLabel">0 × 0 px</span>
        <div class="image-crop-actions">
          <button type="button" id="imageCropCancelBtn">Cancelar</button>
          <button type="button" id="imageCropApplyBtn" disabled>Aplicar recorte</button>
        </div>
      </div>
    </div>
  </div>

  <div class="template-toolbar" id="templateToolbar">
    <div class="template-toolbar-row compact">
      <label for="templateBgColor">Fondo:</label>
      <div class="template-color-palette" id="templateBgPalette"></div>
      <input type="color" id="templateBgColor" value="#ffffff">
      <button id="templateClearBgBtn" title="Quitar fondo">Sin fondo</button>
    </div>
    <div class="template-toolbar-row compact">
      <label for="templateTextColor">Texto:</label>
      <div class="template-color-palette" id="templateTextPalette"></div>
      <input type="color" id="templateTextColor" value="#212529">
      <button id="templateResetTextColorBtn" title="Restablecer color">Restablecer</button>
    </div>
    <div class="template-toolbar-row">
      <label for="templateBorderWidth">Borde:</label>
      <input type="range" id="templateBorderWidth" min="0" max="12" step="1">
      <span class="size-display" id="templateBorderWidthDisplay">1px</span>
    </div>
    <div class="template-toolbar-row compact" id="templateBorderColorRow">
      <label for="templateBorderColor">Color borde:</label>
      <div class="template-color-palette" id="templateBorderPalette"></div>
      <input type="color" id="templateBorderColor" value="#ced4da">
    </div>
    <div class="template-toolbar-row compact" id="templateAccentColorRow" style="display:none;">
      <label for="templateAccentColor">Borde izq.:</label>
      <div class="template-color-palette" id="templateAccentPalette"></div>
      <input type="color" id="templateAccentColor" value="#0d6efd">
    </div>
    <div class="template-toolbar-row" id="templateNoteStyleRow" style="display:none;">
      <label for="templateNoteStyle">Estilo:</label>
      <select id="templateNoteStyle">
        <option value="classic">Clásica</option>
        <option value="sky">Cielo suave</option>
        <option value="forest">Bosque</option>
        <option value="sunrise">Amanecer</option>
        <option value="rose">Rosada</option>
        <option value="lilac">Lavanda</option>
        <option value="slate">Gris suave</option>
        <option value="pearl">Perla</option>
        <option value="custom">Personalizado</option>
      </select>
    </div>
    <div class="template-toolbar-row" id="templateSpacingRow" style="display:none;">
      <span class="template-toolbar-static-label">Espacios:</span>
      <div class="template-spacing-buttons">
        <button type="button" id="templateAddSpaceTopBtn" title="Agregar espacio arriba">↑ +</button>
        <button type="button" id="templateAddSpaceBottomBtn" title="Agregar espacio abajo">↓ +</button>
      </div>
    </div>
    <div class="template-toolbar-row">
      <label for="templateFontSize">Tamaño:</label>
      <input type="range" id="templateFontSize" min="80" max="180" step="5">
      <span class="size-display" id="templateFontSizeDisplay">100%</span>
    </div>
    <div class="template-toolbar-row">
      <label for="templateMarginTop">Arriba:</label>
      <input type="range" id="templateMarginTop" min="0" max="120" step="1">
      <span class="size-display" id="templateMarginTopDisplay">0px</span>
    </div>
    <div class="template-toolbar-row">
      <label for="templateMarginBottom">Abajo:</label>
      <input type="range" id="templateMarginBottom" min="0" max="120" step="1">
      <span class="size-display" id="templateMarginBottomDisplay">0px</span>
    </div>
    <div class="template-toolbar-row">
      <button id="templateDeleteBtn" title="Eliminar plantilla" style="color:#dc3545; flex:1;">🗑️ Eliminar</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <!-- Panel de navegación -->
  <aside id="topic-panel" class="topic-panel">
    <div class="panel-header">
      <div class="panel-header-info">
        <strong>Navegación</strong>
        <span class="panel-topic-count" id="panelTopicCount">0 temas</span>
      </div>
      <div class="panel-header-actions">
        <button class="panel-header-btn" id="editPanelBtn" title="Editar secciones">✏️</button>
        <button class="panel-header-btn" id="addSectionBtn" title="Nueva sección">➕</button>
        <button class="panel-close">&times;</button>
      </div>
    </div>
    <div class="panel-actions">
      <button class="panel-action-btn" id="toggleAllBtn" title="Expandir/Colapsar todo">⊞</button>
      <button class="panel-action-btn" id="sortAlphaBtn">🔤</button>
      <button class="panel-action-btn" id="sortNumBtn">🔢</button>
    </div>
    <div class="sections-container" id="sectionsContainer"></div>
  </aside>

  <!-- Tabla de contenidos -->
  <aside id="toc-panel" class="toc-panel">
    <div class="toc-header">
      <strong>Tabla de Contenidos</strong>
      <button class="panel-close" id="tocClose">&times;</button>
    </div>
    <ul class="toc-list" id="tocList"></ul>
  </aside>

  <div id="panel-backdrop" class="panel-backdrop"></div>
  
  <aside id="magic-view" class="magic-view">
  </aside>

  <div id="floatingNotesLayer" class="floating-notes-layer"></div>

  <!-- Contenido mágico -->
  <div class="magic-content-container" style="display:none"></div>

  <!-- Páginas -->

  <script>
    (function() {
      let isEditMode = false;
      let isPanelEditMode = false;
      let isReadingMode = false;
      let pages = [...document.querySelectorAll('.page')];
      let globalTopicCounter = 1;
      let selectedImage = null;
      let selectedTemplateBlock = null;
      let currentZoom = 1;
      let lastRegularZoom = 1;
      let zoomBeforeMagic = null;
      let isMagicViewActive = false;
      let activeMagicSource = null;
      let activeMagicWrapper = null;
      let activeMagicPage = null;
      let allSectionsExpanded = true;
      let savedSelection = null;
      let tableMenuAPI = null;
      const cropState = {
        image: null,
        isSelecting: false,
        startX: 0,
        startY: 0,
        currentRect: null,
        scaleX: 1,
        scaleY: 1
      };

      const IMAGE_MIN_WIDTH = 60;
      const IMAGE_MAX_WIDTH = 1600;
      const IMAGE_RESIZE_STEP = 0.1;

      const NOTE_STYLE_PRESETS = [
        { id: 'default', name: 'Post-it amarillo', className: 'floating-note-style-default' },
        { id: 'sky', name: 'Azul cielo', className: 'floating-note-style-sky' },
        { id: 'mint', name: 'Verde menta', className: 'floating-note-style-mint' },
        { id: 'rose', name: 'Rosa suave', className: 'floating-note-style-rose' },
        { id: 'lilac', name: 'Lavanda', className: 'floating-note-style-lilac' },
        { id: 'slate', name: 'Gris pizarra', className: 'floating-note-style-slate' }
      ];

      let floatingNotesHidden = false;
      let floatingNoteZIndex = 10;
      let floatingNoteCreationOffset = 0;
      const floatingNoteDragState = { note: null, pointerId: null, offsetX: 0, offsetY: 0 };

      const CACHE_STORAGE_KEY = 'emi2025-editor-cache-v1';

      let sections = [];
      const AVAILABLE_THEMES = ['theme-blue', 'theme-green', 'theme-purple', 'theme-orange', 'theme-teal', 'theme-rose', 'theme-sand', 'theme-slate'];
      const DEFAULT_THEME = 'theme-blue';
      let sectionThemes = new Map();
      let currentSectionId = '';
      let currentPageRef = null;
      
      const panel = document.getElementById('topic-panel');
      const tocPanel = document.getElementById('toc-panel');
      const sectionsContainer = document.getElementById('sectionsContainer');
      const panelTopicCount = document.getElementById('panelTopicCount');
      const plusBtn = document.querySelector('.topbar-plus');
      const panelClose = document.querySelectorAll('.panel-close');
      const tocClose = document.getElementById('tocClose');
      const panelBackdrop = document.getElementById('panel-backdrop');
      const magic = document.getElementById('magic-view');
      const specialtySpan = document.getElementById('specialtyTitle');
      const modalOverlay = document.getElementById('modalOverlay');
      const modalContent = document.getElementById('modalContent');
      const floatingNotesLayer = document.getElementById('floatingNotesLayer');
      const addFloatingNoteBtn = document.getElementById('addFloatingNoteBtn');
      const toggleNotesBtn = document.getElementById('toggleNotesBtn');
      
      const editBtn = document.getElementById('editBtn');
      const saveHtmlBtn = document.getElementById('saveHtmlBtn');
      const loadHtmlBtn = document.getElementById('loadHtmlBtn');
      const loadHtmlInput = document.getElementById('loadHtmlInput');
      const editToolbar = document.getElementById('editToolbar');
      const statsBtn = document.getElementById('statsBtn');
      const clearAllBtn = document.getElementById('clearAllBtn');
      const exportDataBtn = document.getElementById('exportDataBtn');
      const importDataBtn = document.getElementById('importDataBtn');
      const importDataInput = document.getElementById('importDataInput');
      const cacheSaveBtn = document.getElementById('cacheSaveBtn');
      const editPanelBtn = document.getElementById('editPanelBtn');
      const tocBtn = document.getElementById('tocBtn');
      const readingModeBtn = document.getElementById('readingModeBtn');
      const readingModeExit = document.getElementById('readingModeExit');
      const exportMarkdownBtn = document.getElementById('exportMarkdownBtn');
      const imageToolbar = document.getElementById('imageToolbar');
      const imageAltInput = document.getElementById('imageAltInput');
      const applyAltBtn = document.getElementById('applyAltBtn');
      const imageFrameToggle = document.getElementById('imageFrameToggle');
      const wrapFigureBtn = document.getElementById('wrapFigureBtn');
      const unwrapFigureBtn = document.getElementById('unwrapFigureBtn');
      const cropImageBtn = document.getElementById('cropImageBtn');
      const imageWidthIncreaseBtn = document.getElementById('imageWidthIncrease');
      const imageWidthDecreaseBtn = document.getElementById('imageWidthDecrease');
      const widthDisplay = document.getElementById('widthDisplay');
      const imageCropModal = document.getElementById('imageCropModal');
      const imageCropStage = document.getElementById('imageCropStage');
      const imageCropPreview = document.getElementById('imageCropPreview');
      const imageCropSelection = document.getElementById('imageCropSelection');
      const imageCropApplyBtn = document.getElementById('imageCropApplyBtn');
      const imageCropCancelBtn = document.getElementById('imageCropCancelBtn');
      const imageCropCloseBtn = document.getElementById('imageCropCloseBtn');
      const imageCropSizeLabel = document.getElementById('imageCropSizeLabel');
      const templateToolbar = document.getElementById('templateToolbar');
      const templateBgColorInput = document.getElementById('templateBgColor');
      const templateClearBgBtn = document.getElementById('templateClearBgBtn');
      const templateTextColorInput = document.getElementById('templateTextColor');
      const templateResetTextColorBtn = document.getElementById('templateResetTextColorBtn');
      const templateBgPalette = document.getElementById('templateBgPalette');
      const templateTextPalette = document.getElementById('templateTextPalette');
      const templateBorderPalette = document.getElementById('templateBorderPalette');
      const templateAccentPalette = document.getElementById('templateAccentPalette');
      const templateBorderColorInput = document.getElementById('templateBorderColor');
      const templateAccentColorInput = document.getElementById('templateAccentColor');
      const templateBorderColorRow = document.getElementById('templateBorderColorRow');
      const templateAccentColorRow = document.getElementById('templateAccentColorRow');
      const templateFontSizeSlider = document.getElementById('templateFontSize');
      const templateFontSizeDisplay = document.getElementById('templateFontSizeDisplay');
      const templateMarginTopSlider = document.getElementById('templateMarginTop');
      const templateMarginTopDisplay = document.getElementById('templateMarginTopDisplay');
      const templateMarginBottomSlider = document.getElementById('templateMarginBottom');
      const templateMarginBottomDisplay = document.getElementById('templateMarginBottomDisplay');
      const templateBorderWidthSlider = document.getElementById('templateBorderWidth');
      const templateBorderWidthDisplay = document.getElementById('templateBorderWidthDisplay');
      const templateDeleteBtn = document.getElementById('templateDeleteBtn');
      const templateNoteStyleRow = document.getElementById('templateNoteStyleRow');
      const templateNoteStyleSelect = document.getElementById('templateNoteStyle');
      const templateSpacingRow = document.getElementById('templateSpacingRow');
      const templateAddSpaceTopBtn = document.getElementById('templateAddSpaceTopBtn');
      const templateAddSpaceBottomBtn = document.getElementById('templateAddSpaceBottomBtn');
      const themeSelect = document.getElementById('themeSelect');

      const templateBackgroundPaletteColors = ['#ffffff', '#f8f9fa', '#fef9e7', '#fff3cd', '#fde2e4', '#f8d7da', '#e7f3ff', '#d1e7dd', '#e9ecef'];
      const templateTextPaletteColors = ['#212529', '#343a40', '#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6f42c1', '#6c757d', '#ffffff'];
      const templateBorderPaletteColors = ['#ced4da', '#adb5bd', '#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6f42c1', '#0dcaf0', '#6c757d', '#212529'];
      const templateAccentPaletteColors = ['#0d6efd', '#198754', '#dc3545', '#fd7e14', '#6f42c1', '#ffc107', '#20c997', '#0dcaf0', '#6c757d'];
      const noteStylePresets = [
        { id: 'classic', className: 'note-style-classic', extraClasses: [] },
        { id: 'sky', className: 'note-style-sky', extraClasses: [] },
        { id: 'forest', className: 'note-style-forest', extraClasses: [] },
        { id: 'sunrise', className: 'note-style-sunrise', extraClasses: [] },
        { id: 'rose', className: 'note-style-rose', extraClasses: [] },
        { id: 'lilac', className: 'note-style-lilac', extraClasses: [] },
        { id: 'slate', className: 'note-style-slate', extraClasses: [] },
        { id: 'pearl', className: 'note-style-pearl', extraClasses: ['pearl'] }
      ];
      const NOTE_STYLE_CLASSES = noteStylePresets.map(p => p.className);
      const noteStylePresetMap = new Map(noteStylePresets.map(p => [p.id, p]));

      function getPageTheme(page) {
        if (!page) return DEFAULT_THEME;
        const classTheme = Array.from(page.classList || []).find(cls => AVAILABLE_THEMES.includes(cls));
        if (classTheme) return classTheme;
        const stored = page.dataset.theme;
        if (stored && AVAILABLE_THEMES.includes(stored)) return stored;
        return DEFAULT_THEME;
      }

      function applyThemeToPage(page, themeClass) {
        if (!page) return;
        const validTheme = AVAILABLE_THEMES.includes(themeClass) ? themeClass : DEFAULT_THEME;
        AVAILABLE_THEMES.forEach(cls => page.classList.remove(cls));
        page.classList.add(validTheme);
        page.dataset.theme = validTheme;
      }

      function syncBodyTheme(themeClass) {
        const validTheme = AVAILABLE_THEMES.includes(themeClass) ? themeClass : DEFAULT_THEME;
        AVAILABLE_THEMES.forEach(cls => document.body.classList.remove(cls));
        document.body.classList.add(validTheme);
        if (isReadingMode) {
          document.body.classList.add('reading-mode');
        }
      }

      function updateThemeSelectControl(themeClass) {
        if (!themeSelect) return;
        const validTheme = AVAILABLE_THEMES.includes(themeClass) ? themeClass : DEFAULT_THEME;
        if (themeSelect.value !== validTheme) {
          themeSelect.value = validTheme;
        }
      }

      function updateSectionIndicator(page) {
        if (!specialtySpan) return;
        const sectionName = page ? (page.dataset.sectionName || '').trim() : '';
        specialtySpan.textContent = sectionName;
      }

      function setActivePage(page) {
        if (!page) {
          currentPageRef = null;
          currentSectionId = '';
          updateSectionIndicator(null);
          updateThemeSelectControl(DEFAULT_THEME);
          syncBodyTheme(DEFAULT_THEME);
          return;
        }
        currentPageRef = page;
        const sectionId = page.dataset.sectionId || 'seccion-default';
        currentSectionId = sectionId;
        const themeClass = getPageTheme(page);
        sectionThemes.set(sectionId, themeClass);
        updateSectionIndicator(page);
        updateThemeSelectControl(themeClass);
        syncBodyTheme(themeClass);
      }

      function setSectionTheme(sectionId, themeClass) {
        const validTheme = AVAILABLE_THEMES.includes(themeClass) ? themeClass : DEFAULT_THEME;
        sectionThemes.set(sectionId, validTheme);
        pages.filter(page => page.dataset.sectionId === sectionId).forEach(page => applyThemeToPage(page, validTheme));
        if (currentSectionId === sectionId) {
          updateThemeSelectControl(validTheme);
          syncBodyTheme(validTheme);
        }
      }

      function getDocumentTitle() {
        return (specialtySpan?.dataset.documentTitle || '').trim();
      }

      function setDocumentTitle(value) {
        if (!specialtySpan) return;
        const trimmed = (value || '').trim();
        specialtySpan.dataset.documentTitle = trimmed;
      }

      initPalette(templateBgPalette, templateBackgroundPaletteColors, color => applyTemplateBackground(color));
      initPalette(templateTextPalette, templateTextPaletteColors, color => applyTemplateTextColor(color));
      initPalette(templateBorderPalette, templateBorderPaletteColors, color => applyTemplateBorderColor(color));
      initPalette(templateAccentPalette, templateAccentPaletteColors, color => applyTemplateAccentColor(color));
      const alignButtons = {
        left: document.getElementById('alignLeftBtn'),
        center: document.getElementById('alignCenterBtn'),
        right: document.getElementById('alignRightBtn'),
        inline: document.getElementById('inlineBtn')
      };
      const floatClasses = ['float-left', 'float-right', 'center-block', 'inline-image'];
      const zoomInBtn = document.getElementById('zoomInBtn');
      const zoomOutBtn = document.getElementById('zoomOutBtn');
      const zoomValue = document.getElementById('zoomValue');
      const highlightPalette = document.getElementById('highlightPalette');
      const textColorPalette = document.getElementById('textColorPalette');
      const insertTemplateBtn = document.getElementById('insertTemplateBtn');
      const insertHtmlBtn = document.getElementById('insertHtmlBtn');
      const insertTableBtn = document.getElementById('insertTableBtn');
      const insertCollapseCardBtn = document.getElementById('insertCollapseCardBtn');
      const tableMenu = document.getElementById('tableMenu');
      const tableMenuSize = document.getElementById('tableMenuSize');
      const tableResizeBtn = document.getElementById('tableResizeBtn');
      const tableMenuClose = document.getElementById('tableMenuClose');
      const tableMenuTabs = Array.from(document.querySelectorAll('.table-menu-tab'));
      const tableMenuPanels = Array.from(document.querySelectorAll('.table-menu-panel'));
      const tableThemeButtons = Array.from(document.querySelectorAll('.table-theme-option'));
      const tableLineHeightInput = document.getElementById('tableLineHeight');
      const tableLineHeightValue = document.getElementById('tableLineHeightValue');
      const tablePaddingYInput = document.getElementById('tablePaddingY');
      const tablePaddingYValue = document.getElementById('tablePaddingYValue');
      const tableMarginInput = document.getElementById('tableMargin');
      const tableMarginValue = document.getElementById('tableMarginValue');
      const tablePresetButtons = Array.from(document.querySelectorAll('[data-table-preset]'));
      const tableBorderColorButtons = Array.from(document.querySelectorAll('.table-border-color-btn'));
      const tableBorderColorCustom = document.getElementById('tableBorderColorCustom');
      const tableBorderWidthInput = document.getElementById('tableBorderWidth');
      const tableBorderWidthValue = document.getElementById('tableBorderWidthValue');
      const toggleVerticalBorders = document.getElementById('toggleVerticalBorders');
      const toggleHorizontalBorders = document.getElementById('toggleHorizontalBorders');
      const tableBorderResetBtn = document.querySelector('[data-border-reset]');
      const tableResizeOverlay = document.getElementById('tableResizeOverlay');

      const pastelColors = [
        '#FFB6C1', '#FFD1DC', '#FFC8DD', '#E7C6FF', '#C8B6FF', '#B4D4FF', '#AEC6CF', '#B2DFDB',
        '#C5E1A5', '#FFF9C4', '#FFE082', '#FFCCBC', '#D7CCC8', '#F5F5F5', '#CFD8DC', '#E1BEE7'
      ];

      const tableResizers = new WeakMap();

      if (cropImageBtn) {
        cropImageBtn.disabled = true;
      }

      const topicMenu = document.createElement('div');
      topicMenu.id = 'topicContextMenu';
      topicMenu.className = 'topic-context-menu';
      topicMenu.innerHTML = `
        <button data-action="rename">Cambiar título</button>
        <button data-action="move">Mover tema</button>
        <button data-action="duplicate">Duplicar tema</button>
        <button data-action="delete" class="danger">Eliminar tema</button>
      `;
      document.body.appendChild(topicMenu);

      let topicMenuContext = null;
      let topicMenuJustOpened = false;

      function hideTopicMenu() {
        topicMenu.classList.remove('show');
        topicMenuContext = null;
        topicMenuJustOpened = false;
      }

      function getTopicTitle(page) {
        if (!page) return '';
        const h1 = page.querySelector('h1');
        const titleSpan = h1?.querySelector('span:first-child');
        return (titleSpan?.textContent || h1?.textContent || '').trim();
      }

      function showTopicMenu(event, tema) {
        if (!tema || !tema.page) return;
        hideTopicMenu();

        const page = tema.page;
        const title = (tema.titulo || getTopicTitle(page) || 'Tema').trim();
        topicMenuContext = { page, titulo: title };

        const pageX = event.pageX || (event.clientX + window.scrollX);
        const pageY = event.pageY || (event.clientY + window.scrollY);

        topicMenu.style.left = pageX + 'px';
        topicMenu.style.top = pageY + 'px';
        topicMenu.classList.add('show');

        const rect = topicMenu.getBoundingClientRect();
        let newLeft = rect.left;
        let newTop = rect.top;

        if (rect.right > window.innerWidth) {
          newLeft = window.innerWidth - rect.width - 12;
        }
        if (rect.bottom > window.innerHeight) {
          newTop = window.innerHeight - rect.height - 12;
        }

        newLeft = Math.max(8, newLeft);
        newTop = Math.max(8, newTop);

        topicMenu.style.left = window.scrollX + newLeft + 'px';
        topicMenu.style.top = window.scrollY + newTop + 'px';

        topicMenuJustOpened = true;
        setTimeout(() => {
          topicMenuJustOpened = false;
        }, 0);
      }

      function renameTopicPage(page) {
        if (!page) return false;
        const h1 = page.querySelector('h1');
        const titleSpan = h1?.querySelector('span:first-child');
        const currentTitle = (titleSpan?.textContent || h1?.textContent || 'Tema').trim();
        const newTitle = prompt('Nuevo título para el tema:', currentTitle);
        if (!newTitle || !newTitle.trim()) return false;
        const cleanTitle = newTitle.trim();
        if (titleSpan) {
          titleSpan.textContent = cleanTitle;
        } else if (h1) {
          h1.textContent = cleanTitle;
        }
        page.dataset.topicTitle = cleanTitle;
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        setupMagicIcons();
        return true;
      }

      function moveTopicPage(page) {
        if (!page) return false;
        if (!sections.length) {
          initializeSections();
        }
        if (sections.length <= 1) {
          alert('No hay otras secciones disponibles para mover este tema.');
          return false;
        }

        const currentSection = sections.find(section => section.id === page.dataset.sectionId);
        const options = sections.map((section, idx) => `${idx + 1}. ${section.nombre}${section === currentSection ? ' (actual)' : ''}`).join('\n');
        const choice = prompt(`Mover tema a sección:\n${options}\nEscribe el número o nombre de la sección destino:`, currentSection?.nombre || '');
        if (!choice || !choice.trim()) return false;

        const trimmed = choice.trim().toLowerCase();
        let targetSection = sections.find((section, idx) => String(idx + 1) === trimmed);
        if (!targetSection) {
          targetSection = sections.find(section => section.nombre.toLowerCase() === trimmed);
        }

        if (!targetSection) {
          alert('No se encontró la sección indicada.');
          return false;
        }

        page.dataset.sectionId = targetSection.id;
        page.dataset.sectionName = targetSection.nombre;
        const targetTheme = sectionThemes.get(targetSection.id) || DEFAULT_THEME;
        sectionThemes.set(targetSection.id, targetTheme);
        applyThemeToPage(page, targetTheme);
        initializeSections();
        buildSectionsPanel();
        setActivePage(page);
        return true;
      }

      function deleteTopicPage(page) {
        if (!page) return false;
        const title = getTopicTitle(page) || 'este tema';
        if (!confirm(`¿Eliminar "${title}"?`)) {
          return false;
        }
        page.remove();
        pages = pages.filter(p => p !== page);
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        if (currentPageRef === page) {
          setActivePage(getCurrentPage());
        }
        return true;
      }

      function duplicateTopicPage(page) {
        if (!page) return null;
        const clone = page.cloneNode(true);
        const titleSpan = clone.querySelector('h1 span:first-child');
        if (titleSpan) {
          const currentTitle = titleSpan.textContent.trim();
          titleSpan.textContent = currentTitle ? `${currentTitle} (Copia)` : 'Tema (Copia)';
        }
        const newId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
        clone.dataset.topicId = newId;
        clone.contentEditable = isEditMode ? 'true' : 'false';
        applyThemeToPage(clone, getPageTheme(page));
        page.parentNode.insertBefore(clone, page.nextSibling);
        pages = [...document.querySelectorAll('.page')];
        setupMagicIcons();
        io.observe(clone);
        initializeSections();
        buildSectionsPanel();
        buildTableOfContents();
        clone.scrollIntoView({ behavior: 'smooth', block: 'start' });
        return clone;
      }

      topicMenu.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button || !topicMenuContext) return;
        event.preventDefault();
        event.stopPropagation();

        const { page } = topicMenuContext;
        if (!page) {
          hideTopicMenu();
          return;
        }

        switch (button.dataset.action) {
          case 'rename':
            renameTopicPage(page);
            break;
          case 'move':
            moveTopicPage(page);
            break;
          case 'duplicate':
            duplicateTopicPage(page);
            break;
          case 'delete':
            deleteTopicPage(page);
            break;
        }

        hideTopicMenu();
      });

      document.addEventListener('click', (event) => {
        if (topicMenuJustOpened) return;
        if (!topicMenu.contains(event.target)) {
          hideTopicMenu();
        }
      });

      document.addEventListener('scroll', hideTopicMenu, true);
      window.addEventListener('resize', hideTopicMenu);
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          hideTopicMenu();
          hideTemplateToolbar();
          hideImageToolbar();
          tableMenuAPI?.cancelResize();
          tableMenuAPI?.hide();
        }
      });

      /* === ZOOM === */
      function syncMagicZoom() {
        if (!magic) return;
        if (isMagicViewActive) {
          magic.style.setProperty('--magic-zoom', '1');
        } else {
          magic.style.removeProperty('--magic-zoom');
        }
      }

      function applyZoom(level, options = {}) {
        const { skipRemember = false } = options;
        currentZoom = Math.max(0.5, Math.min(2, level));
        document.documentElement.style.setProperty('--zoom-level', currentZoom);
        zoomValue.textContent = Math.round(currentZoom * 100) + '%';
        if (!skipRemember && !isMagicViewActive) {
          lastRegularZoom = currentZoom;
        }
        syncMagicZoom();
      }

      function updateZoom(delta) {
        applyZoom(currentZoom + delta);
      }

      zoomInBtn?.addEventListener('click', () => updateZoom(0.1));
      zoomOutBtn?.addEventListener('click', () => updateZoom(-0.1));

      /* === UTILIDADES === */
      function saveCurrentSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          savedSelection = selection.getRangeAt(0).cloneRange();
          return true;
        }
        return false;
      }

      function restoreSelection() {
        if (savedSelection) {
          if (!document.contains(savedSelection.startContainer) || !document.contains(savedSelection.endContainer)) {
            savedSelection = null;
            return false;
          }
          const selection = window.getSelection();
          selection.removeAllRanges();
          try {
            selection.addRange(savedSelection);
            return true;
          } catch (err) {
            savedSelection = null;
          }
        }
        return false;
      }

      function ensureEditableSelection() {
        if (restoreSelection()) {
          const restored = window.getSelection();
          if (restored.rangeCount > 0) {
            return restored;
          }
        }

        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          return selection;
        }

        const activeEditable = document.activeElement && document.activeElement.isContentEditable
          ? document.activeElement
          : null;
        const preferredMagic = getCurrentMagicPage();
        const target = activeEditable || preferredMagic || getCurrentPage();
        if (!target) return null;

        const range = document.createRange();
        range.selectNodeContents(target);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
        return selection;
      }

      function insertNodeAtSelection(node) {
        const selection = ensureEditableSelection();
        if (!selection || !selection.rangeCount) return null;
        const range = selection.getRangeAt(0);
        range.deleteContents();
        range.insertNode(node);
        range.setStartAfter(node);
        range.setEndAfter(node);
        selection.removeAllRanges();
        selection.addRange(range);
        savedSelection = null;
        return node;
      }

      function insertHtmlAtSelection(html) {
        const selection = ensureEditableSelection();
        if (!selection || !selection.rangeCount) return null;
        const range = selection.getRangeAt(0);
        range.deleteContents();
        const fragment = range.createContextualFragment(html);
        const nodes = Array.from(fragment.childNodes);
        range.insertNode(fragment);
        const lastNode = nodes[nodes.length - 1];
        if (lastNode) {
          range.setStartAfter(lastNode);
          range.setEndAfter(lastNode);
        }
        selection.removeAllRanges();
        selection.addRange(range);
        savedSelection = null;
        return nodes[0] || null;
      }

      function normalizeColorToHex(color, fallback = '#ffffff') {
        if (!color || color === 'transparent' || color === 'rgba(0, 0, 0, 0)' || color === 'none') {
          return fallback;
        }
        if (color.startsWith('#')) {
          if (color.length === 4) {
            return '#' + color.slice(1).split('').map(ch => ch + ch).join('');
          }
          return color;
        }
        const rgbMatch = color.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
        if (rgbMatch) {
          return '#' + rgbMatch.slice(1, 4).map(value => {
            const hex = parseInt(value, 10).toString(16);
            return hex.length === 1 ? '0' + hex : hex;
          }).join('');
        }
        const temp = document.createElement('div');
        temp.style.color = color;
        document.body.appendChild(temp);
        const computed = window.getComputedStyle(temp).color;
        document.body.removeChild(temp);
        if (computed === color) {
          return fallback;
        }
        return normalizeColorToHex(computed, fallback);
      }

      function parsePxValue(value, fallback = 0) {
        if (!value) return fallback;
        const parsed = parseFloat(value);
        return Number.isFinite(parsed) ? Math.round(parsed) : fallback;
      }

      function clearNoteStyleClasses(target) {
        if (!target || !target.classList) return;
        NOTE_STYLE_CLASSES.forEach(cls => target.classList.remove(cls));
        target.classList.remove('pearl');
      }

      function markNoteStyleAsCustom(block, target) {
        if (!block || !target) return;
        clearNoteStyleClasses(target);
        block.dataset.noteStyle = 'custom';
      }

      function getAppliedNoteStyle(block, target) {
        if (!block || !target || !target.classList?.contains('box')) {
          return 'custom';
        }
        const stored = block.dataset.noteStyle;
        if (stored && noteStylePresetMap.has(stored)) {
          return stored;
        }
        const matched = NOTE_STYLE_CLASSES.find(cls => target.classList.contains(cls));
        if (matched) {
          const preset = noteStylePresets.find(p => p.className === matched);
          if (preset) {
            block.dataset.noteStyle = preset.id;
            (preset.extraClasses || []).forEach(cls => target.classList.add(cls));
            return preset.id;
          }
        }
        return 'custom';
      }

      function applyNoteStyle(block, styleId, options = {}) {
        if (!block) return;
        const target = getTemplateTarget(block);
        if (!target || !target.classList?.contains('box')) return;
        const { skipToolbarSync = false } = options;

        if (styleId === 'custom' || !noteStylePresetMap.has(styleId)) {
          markNoteStyleAsCustom(block, target);
        } else {
          const preset = noteStylePresetMap.get(styleId);
          clearNoteStyleClasses(target);
          if (preset?.className) {
            target.classList.add(preset.className);
          }
          (preset?.extraClasses || []).forEach(cls => target.classList.add(cls));
          block.dataset.noteStyle = preset?.id || 'custom';
        }

        if (!skipToolbarSync) {
          updateTemplateToolbarState(block);
          repositionTemplateToolbar();
        }
      }

      function normalizeTemplateDataValue(value) {
        if (value === undefined || value === null) return null;
        const str = String(value);
        return str.trim() === '' ? null : str;
      }

      function readSerializedNoteStyle(block, target = getTemplateTarget(block)) {
        if (!block) return 'custom';
        const stored = block.dataset.noteStyle;
        if (stored && noteStylePresetMap.has(stored)) {
          return stored;
        }
        if (!target || !target.classList?.contains('box')) {
          return stored || 'custom';
        }
        const matched = NOTE_STYLE_CLASSES.find(cls => target.classList.contains(cls));
        if (matched) {
          const preset = noteStylePresets.find(p => p.className === matched);
          if (preset?.id) {
            return preset.id;
          }
        }
        return stored || 'custom';
      }

      function serializeTemplateBlocks(page) {
        if (!page) return [];
        return Array.from(page.querySelectorAll('.template-block')).map((block, index) => {
          const target = getTemplateTarget(block);
          const isNote = !!(target && target.classList && target.classList.contains('box'));
          return {
            index,
            isNote,
            noteStyle: readSerializedNoteStyle(block, target),
            fontScale: normalizeTemplateDataValue(block.dataset.fontScale),
            marginTop: normalizeTemplateDataValue(block.dataset.marginTop),
            marginBottom: normalizeTemplateDataValue(block.dataset.marginBottom),
            bgColor: normalizeTemplateDataValue(block.dataset.bgColor),
            textColor: normalizeTemplateDataValue(block.dataset.textColor),
            borderColor: isNote ? normalizeTemplateDataValue(block.dataset.borderColor) : null,
            accentColor: isNote ? normalizeTemplateDataValue(block.dataset.accentColor) : null,
            borderWidth: isNote ? normalizeTemplateDataValue(block.dataset.borderWidth) : null,
            borderAccentExtra: isNote ? normalizeTemplateDataValue(block.dataset.borderAccentExtra) : null
          };
        });
      }

      function restoreTemplateBlocks(page, serializedBlocks) {
        if (!page || !Array.isArray(serializedBlocks) || !serializedBlocks.length) return;
        const blocks = Array.from(page.querySelectorAll('.template-block'));

        serializedBlocks.forEach(state => {
          if (!state || typeof state.index !== 'number') return;
          const block = blocks[state.index];
          if (!block) return;

          const target = getTemplateTarget(block);
          const isNote = !!(state.isNote && target && target.classList && target.classList.contains('box'));

          if (state.fontScale !== undefined) {
            if (state.fontScale !== null) {
              block.dataset.fontScale = state.fontScale;
              block.style.fontSize = state.fontScale === '100' ? '' : state.fontScale + '%';
            } else {
              delete block.dataset.fontScale;
              block.style.fontSize = '';
            }
          }

          if (state.marginTop !== undefined) {
            if (state.marginTop !== null) {
              block.dataset.marginTop = state.marginTop;
              const topValue = parseInt(state.marginTop, 10) || 0;
              block.style.marginTop = topValue + 'px';
            } else {
              delete block.dataset.marginTop;
              block.style.marginTop = '';
            }
          }

          if (state.marginBottom !== undefined) {
            if (state.marginBottom !== null) {
              block.dataset.marginBottom = state.marginBottom;
              const bottomValue = parseInt(state.marginBottom, 10) || 0;
              block.style.marginBottom = bottomValue + 'px';
            } else {
              delete block.dataset.marginBottom;
              block.style.marginBottom = '';
            }
          }

          if (target) {
            if (state.bgColor !== undefined) {
              if (state.bgColor !== null) {
                block.dataset.bgColor = state.bgColor;
                target.style.background = state.bgColor;
              } else {
                delete block.dataset.bgColor;
                target.style.background = '';
              }
            }

            if (state.textColor !== undefined) {
              if (state.textColor !== null) {
                block.dataset.textColor = state.textColor;
                target.style.color = state.textColor;
              } else {
                delete block.dataset.textColor;
                target.style.color = '';
              }
            }
          }

          if (isNote && target) {
            if (state.noteStyle === 'custom') {
              markNoteStyleAsCustom(block, target);
            } else if (state.noteStyle && noteStylePresetMap.has(state.noteStyle)) {
              applyNoteStyle(block, state.noteStyle, { skipToolbarSync: true });
            }

            if (state.borderColor !== undefined) {
              if (state.borderColor !== null) {
                block.dataset.borderColor = state.borderColor;
                target.style.borderColor = state.borderColor;
                target.style.borderTopColor = state.borderColor;
                target.style.borderRightColor = state.borderColor;
                target.style.borderBottomColor = state.borderColor;
                if (!state.accentColor) {
                  target.style.borderLeftColor = state.borderColor;
                }
              } else {
                delete block.dataset.borderColor;
                target.style.borderColor = '';
              }
            }

            if (state.accentColor !== undefined) {
              if (state.accentColor !== null) {
                block.dataset.accentColor = state.accentColor;
                target.style.borderLeftColor = state.accentColor;
              } else {
                delete block.dataset.accentColor;
                if (state.borderColor && state.borderColor !== null) {
                  target.style.borderLeftColor = state.borderColor;
                } else {
                  target.style.borderLeftColor = '';
                }
              }
            }

            if (state.borderWidth !== undefined || state.borderAccentExtra !== undefined) {
              const widthValue = state.borderWidth !== null && state.borderWidth !== undefined
                ? Math.max(0, parseInt(state.borderWidth, 10) || 0)
                : null;
              const accentValue = state.borderAccentExtra !== null && state.borderAccentExtra !== undefined
                ? Math.max(0, parseInt(state.borderAccentExtra, 10) || 0)
                : 0;

              if (widthValue === null) {
                delete block.dataset.borderWidth;
                delete block.dataset.borderAccentExtra;
                target.style.borderWidth = '';
                target.style.borderLeftWidth = '';
                target.style.borderStyle = '';
              } else {
                updateBorderWidthDataset(block, widthValue, accentValue);
                if (widthValue <= 0) {
                  target.style.borderStyle = 'none';
                  target.style.borderWidth = '0';
                } else {
                  target.style.borderStyle = 'solid';
                  target.style.borderWidth = widthValue + 'px';
                }
                const leftWidth = Math.max(0, widthValue) + Math.max(0, accentValue);
                target.style.borderLeftWidth = leftWidth > 0 ? leftWidth + 'px' : '0';
              }
            }
          } else if (state.noteStyle) {
            block.dataset.noteStyle = state.noteStyle;
          }
        });
      }

      function insertNoteSpacer(position) {
        if (!selectedTemplateBlock) return;
        const block = selectedTemplateBlock;
        const parent = block.parentElement;
        if (!parent) return;
        const spacer = document.createElement('p');
        spacer.className = 'note-spacer';
        spacer.innerHTML = '<br>';
        if (position === 'before') {
          parent.insertBefore(spacer, block);
        } else {
          parent.insertBefore(spacer, block.nextSibling);
        }
      }

      function createTemplateBlock(template) {
        if (!template) return null;
        const block = document.createElement('div');
        block.className = 'template-block';
        block.dataset.templateBlock = 'true';
        if (template.name) {
          block.dataset.templateName = template.name;
        }
        block.dataset.fontScale = '100';
        block.setAttribute('tabindex', '0');
        const wrapper = document.createElement('div');
        wrapper.innerHTML = template.html;
        while (wrapper.firstChild) {
          block.appendChild(wrapper.firstChild);
        }
        if (template.noteStyle) {
          applyNoteStyle(block, template.noteStyle, { skipToolbarSync: true });
        }
        return block;
      }

      function getTemplateTarget(block) {
        if (!block) return null;
        if (block.classList && block.classList.contains('box')) return block;
        return block.querySelector('.box') || block;
      }

      function setPaletteActive(container, value) {
        if (!container) return;
        const normalized = normalizeColorToHex(value || '', '').toLowerCase();
        container.querySelectorAll('.template-color-swatch').forEach(swatch => {
          const swatchValue = normalizeColorToHex(swatch.dataset.value || '', '').toLowerCase();
          swatch.classList.toggle('active', normalized && swatchValue === normalized);
        });
      }

      function updateBorderWidthDataset(block, baseWidth, accentExtra) {
        if (!block) return;
        if (Number.isFinite(baseWidth)) {
          block.dataset.borderWidth = String(baseWidth);
        }
        if (Number.isFinite(accentExtra)) {
          block.dataset.borderAccentExtra = String(accentExtra);
        }
      }

      function createCollapseCardElement() {
        const card = document.createElement('div');
        card.className = 'collapse-card';
        card.innerHTML = `
          <div class="collapse-card-header">
            <span class="collapse-card-title">Título de la tarjeta</span>
            <button type="button" class="collapse-card-toggle" aria-expanded="true"></button>
          </div>
          <div class="collapse-card-body">
            <p>Contenido de la tarjeta colapsable.</p>
          </div>
        `;
        return card;
      }

      function initializeCollapseCards(root) {
        if (!root) return;
        const cards = root.classList && root.classList.contains('collapse-card')
          ? [root]
          : Array.from(root.querySelectorAll('.collapse-card'));
        cards.forEach(card => {
          const toggle = card.querySelector('.collapse-card-toggle');
          if (toggle) {
            toggle.type = 'button';
            toggle.setAttribute('aria-expanded', card.classList.contains('collapsed') ? 'false' : 'true');
          }
          const title = card.querySelector('.collapse-card-title');
          if (title) {
            title.setAttribute('contenteditable', 'true');
          }
        });
      }

      function initPalette(container, colors, onSelect) {
        if (!container) return;
        container.innerHTML = '';
        colors.forEach(color => {
          const swatch = document.createElement('button');
          swatch.type = 'button';
          swatch.className = 'template-color-swatch';
          swatch.style.setProperty('--swatch-color', color);
          swatch.dataset.value = color;
          swatch.addEventListener('click', () => onSelect(color));
          container.appendChild(swatch);
        });
      }

      function applyTemplateBackground(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target) return;
        if (!color || color === 'transparent') {
          target.style.backgroundColor = 'transparent';
          delete selectedTemplateBlock.dataset.bgColor;
          if (templateBgColorInput) {
            templateBgColorInput.value = '#ffffff';
          }
          setPaletteActive(templateBgPalette, '');
        } else {
          target.style.backgroundColor = color;
          selectedTemplateBlock.dataset.bgColor = color;
          if (templateBgColorInput) {
            templateBgColorInput.value = normalizeColorToHex(color, '#ffffff');
          }
          setPaletteActive(templateBgPalette, color);
        }
        if (target.classList.contains('box')) {
          markNoteStyleAsCustom(selectedTemplateBlock, target);
          if (templateNoteStyleSelect) {
            templateNoteStyleSelect.value = 'custom';
          }
        }
        repositionTemplateToolbar();
      }

      function applyTemplateTextColor(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target) return;
        if (!color) {
          target.style.color = '';
          delete selectedTemplateBlock.dataset.textColor;
          if (templateTextColorInput) {
            templateTextColorInput.value = '#212529';
          }
          setPaletteActive(templateTextPalette, '');
        } else {
          target.style.color = color;
          selectedTemplateBlock.dataset.textColor = color;
          if (templateTextColorInput) {
            templateTextColorInput.value = normalizeColorToHex(color, '#212529');
          }
          setPaletteActive(templateTextPalette, color);
        }
        if (target.classList.contains('box')) {
          markNoteStyleAsCustom(selectedTemplateBlock, target);
          if (templateNoteStyleSelect) {
            templateNoteStyleSelect.value = 'custom';
          }
        }
      }

      function applyTemplateBorderColor(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target || !target.classList.contains('box')) return;
        const normalized = color || '#ced4da';
        target.style.borderStyle = 'solid';
        target.style.borderColor = normalized;
        selectedTemplateBlock.dataset.borderColor = normalized;
        if (templateBorderColorInput) {
          templateBorderColorInput.value = normalizeColorToHex(normalized, '#ced4da');
        }
        setPaletteActive(templateBorderPalette, normalized);
        if (selectedTemplateBlock.dataset.accentColor) {
          target.style.borderLeftColor = selectedTemplateBlock.dataset.accentColor;
        }
        updateTemplateToolbarState(selectedTemplateBlock);
        markNoteStyleAsCustom(selectedTemplateBlock, target);
        if (templateNoteStyleSelect) {
          templateNoteStyleSelect.value = 'custom';
        }
      }

      function applyTemplateAccentColor(color) {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target || !target.classList.contains('box')) return;
        const normalized = color || selectedTemplateBlock.dataset.borderColor || '#0d6efd';
        target.style.borderLeftColor = normalized;
        selectedTemplateBlock.dataset.accentColor = normalized;
        if (templateAccentColorInput) {
          templateAccentColorInput.value = normalizeColorToHex(normalized, '#0d6efd');
        }
        setPaletteActive(templateAccentPalette, normalized);
        updateTemplateToolbarState(selectedTemplateBlock);
        markNoteStyleAsCustom(selectedTemplateBlock, target);
        if (templateNoteStyleSelect) {
          templateNoteStyleSelect.value = 'custom';
        }
      }

      function updateTemplateToolbarState(block) {
        if (!block || !templateToolbar) return;
        const target = getTemplateTarget(block);
        const computed = window.getComputedStyle(target || block);
        const isNote = target && target.classList && target.classList.contains('box');

        if (templateNoteStyleRow) {
          templateNoteStyleRow.style.display = isNote ? 'flex' : 'none';
        }

        if (templateSpacingRow) {
          templateSpacingRow.style.display = isNote ? 'flex' : 'none';
        }

        if (templateNoteStyleSelect) {
          templateNoteStyleSelect.value = isNote ? getAppliedNoteStyle(block, target) : 'custom';
        }

        if (templateBgColorInput) {
          const bgValue = block.dataset.bgColor || target?.style.backgroundColor || computed.backgroundColor;
          const normalizedBg = bgValue === 'transparent' ? '#ffffff' : normalizeColorToHex(bgValue, '#ffffff');
          templateBgColorInput.value = normalizedBg;
          setPaletteActive(templateBgPalette, bgValue === 'transparent' ? '' : normalizedBg);
        }

        if (templateTextColorInput) {
          const textValue = block.dataset.textColor || target?.style.color || computed.color;
          const normalizedText = normalizeColorToHex(textValue, '#212529');
          templateTextColorInput.value = normalizedText;
          setPaletteActive(templateTextPalette, normalizedText);
        }

        if (templateFontSizeSlider && templateFontSizeDisplay) {
          const fontScale = parseInt(block.dataset.fontScale || '100', 10) || 100;
          templateFontSizeSlider.value = fontScale;
          templateFontSizeDisplay.textContent = fontScale + '%';
        }

        if (templateMarginTopSlider && templateMarginTopDisplay) {
          const topMax = parseInt(templateMarginTopSlider.max || '120', 10);
          let marginTop = block.dataset.marginTop !== undefined
            ? parseInt(block.dataset.marginTop, 10)
            : parsePxValue(block.style.marginTop || computed.marginTop, 0);
          marginTop = Number.isFinite(marginTop) ? Math.max(0, Math.min(topMax, marginTop)) : 0;
          templateMarginTopSlider.value = marginTop;
          templateMarginTopDisplay.textContent = marginTop + 'px';
        }

        if (templateMarginBottomSlider && templateMarginBottomDisplay) {
          const bottomMax = parseInt(templateMarginBottomSlider.max || '120', 10);
          let marginBottom = block.dataset.marginBottom !== undefined
            ? parseInt(block.dataset.marginBottom, 10)
            : parsePxValue(block.style.marginBottom || computed.marginBottom, 0);
          marginBottom = Number.isFinite(marginBottom) ? Math.max(0, Math.min(bottomMax, marginBottom)) : 0;
          templateMarginBottomSlider.value = marginBottom;
          templateMarginBottomDisplay.textContent = marginBottom + 'px';
        }

        if (templateBorderWidthSlider && templateBorderWidthDisplay) {
          if (!isNote) {
            templateBorderWidthSlider.disabled = true;
            templateBorderWidthDisplay.textContent = '—';
          } else {
            templateBorderWidthSlider.disabled = false;
            const sliderMax = parseInt(templateBorderWidthSlider.max || '12', 10);
            const sliderMin = parseInt(templateBorderWidthSlider.min || '0', 10);
            const storedWidth = block.dataset.borderWidth !== undefined ? parseInt(block.dataset.borderWidth, 10) : null;
            const baseWidth = Number.isFinite(storedWidth)
              ? storedWidth
              : parsePxValue(target.style.borderTopWidth || computed.borderTopWidth, 1);
            const leftWidth = parsePxValue(target.style.borderLeftWidth || computed.borderLeftWidth, baseWidth);
            const accentExtraStored = block.dataset.borderAccentExtra !== undefined ? parseInt(block.dataset.borderAccentExtra, 10) : null;
            const accentExtra = Number.isFinite(accentExtraStored)
              ? accentExtraStored
              : Math.max(0, leftWidth - baseWidth);
            const clampedWidth = Math.max(sliderMin, Math.min(sliderMax, baseWidth));
            templateBorderWidthSlider.value = clampedWidth;
            templateBorderWidthDisplay.textContent = baseWidth + 'px';
            updateBorderWidthDataset(block, baseWidth, accentExtra);
          }
        }

        if (templateBorderColorRow) {
          templateBorderColorRow.style.display = isNote ? 'flex' : 'none';
        }

        if (templateBorderColorInput) {
          const borderValue = block.dataset.borderColor || target?.style.borderTopColor || computed.borderTopColor;
          const normalizedBorder = normalizeColorToHex(borderValue, '#ced4da');
          templateBorderColorInput.value = normalizedBorder;
          setPaletteActive(templateBorderPalette, normalizedBorder);
        }

        if (templateAccentColorRow) {
          const borderTopColor = normalizeColorToHex(target?.style.borderTopColor || computed.borderTopColor, '#ced4da');
          const borderLeftColor = normalizeColorToHex(block.dataset.accentColor || target?.style.borderLeftColor || computed.borderLeftColor, borderTopColor);
          const accentExtra = parseInt(block.dataset.borderAccentExtra || '0', 10);
          const shouldShowAccent = isNote && (borderLeftColor !== borderTopColor || accentExtra > 0);
          templateAccentColorRow.style.display = shouldShowAccent ? 'flex' : 'none';
          if (templateAccentColorInput) {
            templateAccentColorInput.value = normalizeColorToHex(borderLeftColor, borderTopColor);
            setPaletteActive(templateAccentPalette, borderLeftColor);
          }
          if (shouldShowAccent && !block.dataset.accentColor) {
            block.dataset.accentColor = borderLeftColor;
          } else if (!shouldShowAccent) {
            delete block.dataset.accentColor;
          }
        }
      }

      function updateTemplateToolbarPosition(block) {
        if (!templateToolbar || !block) return;
        templateToolbar.classList.add('show');
        const rect = block.getBoundingClientRect();
        const toolbarWidth = templateToolbar.offsetWidth || 260;
        const toolbarHeight = templateToolbar.offsetHeight || 220;

        let left = rect.right + 12;
        let top = rect.top;

        if (left + toolbarWidth > window.innerWidth - 10) {
          left = rect.left - toolbarWidth - 12;
        }

        if (left < 10) {
          left = 10;
        }

        if (top + toolbarHeight > window.innerHeight - 10) {
          top = window.innerHeight - toolbarHeight - 10;
        }

        if (top < 10) {
          top = 10;
        }

        templateToolbar.style.left = left + 'px';
        templateToolbar.style.top = top + 'px';
      }

      function repositionTemplateToolbar() {
        if (selectedTemplateBlock) {
          updateTemplateToolbarPosition(selectedTemplateBlock);
        }
      }

      function showTemplateToolbar(block) {
        if (!templateToolbar || !block) return;
        if (selectedTemplateBlock && selectedTemplateBlock !== block) {
          selectedTemplateBlock.classList.remove('selected-template');
        }
        hideImageToolbar();
        selectedTemplateBlock = block;
        block.classList.add('selected-template');
        updateTemplateToolbarState(block);
        updateTemplateToolbarPosition(block);
      }

      function hideTemplateToolbar() {
        if (selectedTemplateBlock) {
          selectedTemplateBlock.classList.remove('selected-template');
          selectedTemplateBlock = null;
        }
        if (templateToolbar) {
          templateToolbar.classList.remove('show');
        }
      }

      function sanitizeCitations(el) {
        if (!el) return;
        const patterns = [
          /\[(?:cite(?:_start|_end)?|refs?|reference)\b[^\]]*\]/gi,
          /\((?:\s*\[?(?:cite|ref)[^\)]*\)?)+\)/gi
        ];
        let html = el.innerHTML;
        patterns.forEach(re => {
          html = html.replace(re, '');
        });
        el.innerHTML = html;
      }

      function purgeUnwantedNotes(root) {
        if (!root) return;
        root.querySelectorAll('.box, p').forEach(node => {
          const t = node.textContent || '';
          if (/^\s*nota:\s*/i.test(t)) {
            node.textContent = t.replace(/^\s*nota:\s*/i, '');
          }
        });
        const kill = /basarse en guías chilenas e internacionales|manejo inicial es universal/i;
        root.querySelectorAll('.box,p,li').forEach(node => {
          if (kill.test(node.textContent || '')) {
            node.remove();
          }
        });
      }

      function normalizePearls(root) {
        if (!root) return;
        root.querySelectorAll('.box').forEach(node => {
          const t = (node.textContent || '').toLowerCase();
          if (/\bperla\b/.test(t)) {
            node.classList.add('pearl');
          }
        });
      }

      function resetInteractiveBindings(root) {
        if (!root) return;
        root.querySelectorAll('.magic-icon[data-bound], .topic-title-text[data-bound]').forEach(node => {
          node.removeAttribute('data-bound');
        });
      }

      function afterContentSanitize(root) {
        sanitizeCitations(root);
        purgeUnwantedNotes(root);
        normalizePearls(root);
        resetInteractiveBindings(root);
        initializeCollapseCards(root);
      }

      function countWords(html) {
        return html.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim().split(' ').filter(Boolean).length;
      }

      function getCurrentPage() {
        if (currentPageRef && document.body.contains(currentPageRef)) {
          return currentPageRef;
        }
        const viewportCenter = window.scrollY + window.innerHeight / 2;
        return pages.find(p => {
          const rect = p.getBoundingClientRect();
          const pageTop = rect.top + window.scrollY;
          const pageBottom = pageTop + rect.height;
          return viewportCenter >= pageTop && viewportCenter <= pageBottom;
        }) || pages[0];
      }

      function getCurrentMagicPage() {
        return document.querySelector('.magic-page');
      }

      /* === HABILITAR PEGADO DE HTML === */
      function enableHtmlPaste() {
        const editableElements = document.querySelectorAll('[contenteditable="true"]');
        editableElements.forEach(el => {
          if (el.dataset.pasteHandlerBound === 'true') return;
          el.addEventListener('paste', (e) => {
            const clipboardData = e.clipboardData;
            if (!clipboardData) return;

            const items = Array.from(clipboardData.items || []);
            const imageItems = items.filter(item => item.type && item.type.startsWith('image/'));

            if (imageItems.length) {
              e.preventDefault();
              const currentSelection = window.getSelection();
              const baseRange = currentSelection && currentSelection.rangeCount
                ? currentSelection.getRangeAt(0).cloneRange()
                : null;

              imageItems.forEach(item => {
                const file = item.getAsFile();
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                  const dataUrl = event.target?.result;
                  if (!dataUrl) return;

                  const selection = window.getSelection();
                  const range = baseRange ? baseRange.cloneRange() : selection?.getRangeAt(0)?.cloneRange();
                  if (!range) return;

                  range.deleteContents();

                  const img = document.createElement('img');
                  img.src = typeof dataUrl === 'string' ? dataUrl : '';
                  range.insertNode(img);

                  range.setStartAfter(img);
                  range.collapse(true);
                  const sel = window.getSelection();
                  if (!sel) return;
                  sel.removeAllRanges();
                  sel.addRange(range);
                  if (baseRange) {
                    baseRange.setStartAfter(img);
                    baseRange.collapse(true);
                  }
                };
                reader.readAsDataURL(file);
              });
              return;
            }

            e.preventDefault();
            const html = clipboardData.getData('text/html') || clipboardData.getData('text/plain');
            document.execCommand('insertHTML', false, html);
          });
          el.dataset.pasteHandlerBound = 'true';
        });
      }

      /* === TABLAS === */
      function wrapTableIfNeeded(table) {
        if (!table) return null;
        let wrapper = table.closest('.table-wrap');
        if (!wrapper) {
          wrapper = document.createElement('div');
          wrapper.className = 'table-wrap';
          table.parentNode?.insertBefore(wrapper, table);
          wrapper.appendChild(table);
        }
        wrapper.classList.add('table-resize-wrapper');
        if (getComputedStyle(wrapper).position === 'static') {
          wrapper.style.position = 'relative';
        }
        return wrapper;
      }

      function makeTableResizable(table) {
        if (!table) return null;

        if (tableResizers.has(table)) {
          return tableResizers.get(table);
        }

        const wrapper = wrapTableIfNeeded(table);
        if (!wrapper) return null;

        let handle = wrapper.querySelector('.table-resize-handle');
        if (!handle) {
          handle = document.createElement('div');
          handle.className = 'table-resize-handle';
          wrapper.appendChild(handle);
        }

        const state = {
          active: false,
          mode: null,
          startX: 0,
          startY: 0,
          startTableWidth: 0,
          startTableHeight: 0,
          originalWidthStyle: table.style.width,
          originalHeightStyle: table.style.height,
          columnCells: [],
          rowCells: [],
          startColumnStyles: [],
          startRowStyles: [],
          callbacks: null,
          cleanup: null
        };

        const threshold = 8;

        function exitResizeMode() {
          wrapper.classList.remove('table-resize-mode');
          wrapper.classList.remove('table-resize-active');
          table.classList.remove('table-resize-ready');
          table.style.cursor = '';
          document.body.style.userSelect = '';
          document.body.classList.remove('table-resizing');
          if (tableResizeOverlay) {
            tableResizeOverlay.classList.remove('show');
          }
        }

        function restoreOriginalDimensions() {
          if (state.mode === 'table') {
            table.style.width = state.originalWidthStyle;
            table.style.height = state.originalHeightStyle;
          } else if (state.mode === 'column') {
            state.columnCells.forEach((cell, index) => {
              const info = state.startColumnStyles[index];
              if (!info) return;
              cell.style.width = info.width;
              cell.style.minWidth = info.minWidth;
            });
          } else if (state.mode === 'row') {
            state.rowCells.forEach((cell, index) => {
              const info = state.startRowStyles[index];
              if (!info) return;
              cell.style.height = info.height;
              cell.style.minHeight = info.minHeight;
            });
          }
        }

        function finishResize(cancelled) {
          if (state.cleanup) {
            state.cleanup();
            state.cleanup = null;
          }

          const callbacks = state.callbacks;
          state.active = false;
          const mode = state.mode;
          state.mode = null;
          state.columnCells = [];
          state.rowCells = [];
          state.startColumnStyles = [];
          state.startRowStyles = [];

          if (cancelled) {
            restoreOriginalDimensions();
          } else if (mode === 'table') {
            state.originalWidthStyle = table.style.width;
            state.originalHeightStyle = table.style.height;
          }

          exitResizeMode();

          if (callbacks) {
            if (cancelled) {
              callbacks.onCancel?.();
            } else {
              callbacks.onFinish?.();
            }
          }
        }

        function applyColumnResize(deltaX) {
          if (!state.columnCells.length) return;
          const baseWidth = state.startColumnStyles[0]?.numericWidth || state.columnCells[0].offsetWidth;
          const newWidth = Math.max(40, baseWidth + deltaX);
          state.columnCells.forEach(cell => {
            cell.style.width = newWidth + 'px';
            cell.style.minWidth = newWidth + 'px';
          });
        }

        function applyRowResize(deltaY) {
          if (!state.rowCells.length) return;
          const baseHeight = state.startRowStyles[0]?.numericHeight || state.rowCells[0].offsetHeight;
          const newHeight = Math.max(24, baseHeight + deltaY);
          state.rowCells.forEach(cell => {
            cell.style.height = newHeight + 'px';
            cell.style.minHeight = newHeight + 'px';
          });
        }

        function applyTableResize(deltaX, deltaY) {
          const newWidth = Math.max(160, state.startTableWidth + deltaX);
          const newHeight = Math.max(80, state.startTableHeight + deltaY);
          table.style.width = newWidth + 'px';
          table.style.height = newHeight + 'px';
          table.dataset.tableWidth = String(newWidth);
          table.dataset.tableHeight = String(newHeight);
        }

        function onMouseMove(event) {
          if (!state.active) return;
          if (state.mode === 'column') {
            applyColumnResize(event.clientX - state.startX);
          } else if (state.mode === 'row') {
            applyRowResize(event.clientY - state.startY);
          } else {
            applyTableResize(event.clientX - state.startX, event.clientY - state.startY);
          }
        }

        function onMouseUp() {
          finishResize(false);
        }

        function onKeyDown(event) {
          if (event.key === 'Escape') {
            finishResize(true);
          }
        }

        function startResize(mode, cell, event) {
          if (!isEditMode) return;
          event.preventDefault();

          state.active = true;
          state.mode = mode;
          state.startX = event.clientX;
          state.startY = event.clientY;
          state.originalWidthStyle = table.style.width;
          state.originalHeightStyle = table.style.height;
          state.columnCells = [];
          state.rowCells = [];
          state.startColumnStyles = [];
          state.startRowStyles = [];

          if (mode === 'column' && cell) {
            const index = cell.cellIndex;
            const columnCells = Array.from(table.rows).map(row => row.cells[index]).filter(Boolean);
            state.columnCells = columnCells;
            state.startColumnStyles = columnCells.map(colCell => ({
              width: colCell.style.width,
              minWidth: colCell.style.minWidth,
              numericWidth: colCell.offsetWidth
            }));
          } else if (mode === 'row' && cell) {
            const rowCells = Array.from(cell.parentElement?.cells || []);
            state.rowCells = rowCells;
            state.startRowStyles = rowCells.map(rowCell => ({
              height: rowCell.style.height,
              minHeight: rowCell.style.minHeight,
              numericHeight: rowCell.offsetHeight
            }));
          } else {
            state.startTableWidth = table.offsetWidth;
            state.startTableHeight = table.offsetHeight;
          }

          wrapper.classList.add('table-resize-active');
          if (tableResizeOverlay) {
            tableResizeOverlay.classList.add('show');
          }
          document.body.style.userSelect = 'none';
          document.body.classList.add('table-resizing');

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp, { once: true });
          document.addEventListener('keydown', onKeyDown);

          state.cleanup = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('keydown', onKeyDown);
            document.removeEventListener('mouseup', onMouseUp);
          };
        }

        function handleTableMouseMove(event) {
          if (state.active) return;
          const cell = event.target.closest('th,td');
          if (!cell) {
            table.style.cursor = '';
            return;
          }
          const rect = cell.getBoundingClientRect();
          const offsetX = event.clientX - rect.left;
          const offsetY = event.clientY - rect.top;
          const nearRight = rect.width - offsetX <= threshold;
          const nearBottom = rect.height - offsetY <= threshold;

          if (nearRight && nearBottom) {
            table.style.cursor = 'nwse-resize';
          } else if (nearRight) {
            table.style.cursor = 'col-resize';
          } else if (nearBottom) {
            table.style.cursor = 'row-resize';
          } else {
            table.style.cursor = '';
          }
        }

        function handleTableMouseDown(event) {
          if (!isEditMode || event.button !== 0) return;
          const cell = event.target.closest('th,td');
          if (!cell) return;
          const rect = cell.getBoundingClientRect();
          const offsetX = event.clientX - rect.left;
          const offsetY = event.clientY - rect.top;
          const nearRight = rect.width - offsetX <= threshold;
          const nearBottom = rect.height - offsetY <= threshold;

          if (nearRight || nearBottom) {
            startResize(nearRight ? 'column' : 'row', cell, event);
          }
        }

        handle.addEventListener('mousedown', (event) => {
          if (event.button !== 0) return;
          startResize('table', null, event);
        });

        table.addEventListener('mousemove', handleTableMouseMove);
        table.addEventListener('mouseleave', () => {
          if (!state.active) {
            table.style.cursor = '';
          }
        });
        table.addEventListener('mousedown', handleTableMouseDown);

        const controller = {
          activate(callbacks = {}) {
            state.callbacks = callbacks;
            wrapper.classList.add('table-resize-mode');
            table.classList.add('table-resize-ready');
            return controller;
          },
          cancel() {
            if (state.active) {
              finishResize(true);
            } else {
              state.callbacks = null;
              exitResizeMode();
            }
            return controller;
          },
          isActive() {
            return state.active;
          }
        };

        tableResizers.set(table, controller);
        return controller;
      }

      function initializeTableMenu() {
        if (!tableMenu) return null;

        let selectedTable = null;
        let selectedCell = null;
        let highlightedColumnIndex = null;
        let currentResizer = null;

        const actionButtons = Array.from(tableMenu.querySelectorAll('[data-action]'));

        function hideMenu(options = {}) {
          tableMenu.classList.remove('show');
          tableMenu.setAttribute('aria-hidden', 'true');
          if (!options.preserveSelection) {
            if (selectedTable) {
              selectedTable.classList.remove('table-menu-selected');
            }
            clearColumnHighlight();
            selectedTable = null;
            selectedCell = null;
          }
        }

        function showMenu(table, cell) {
          if (!isEditMode || !table) return;
          if (!table.closest('[contenteditable="true"]')) return;
          if (selectedTable && selectedTable !== table) {
            selectedTable.classList.remove('table-menu-selected');
            clearColumnHighlight();
          }
          selectedTable = table;
          if (cell) {
            selectedCell = cell;
          } else if (!selectedCell || !selectedTable.contains(selectedCell)) {
            selectedCell = selectedTable.querySelector('td,th');
          }

          if (selectedTable) {
            selectedTable.classList.add('table-menu-selected');
          }

          updateMenuState();
          tableMenu.classList.add('show');
          tableMenu.setAttribute('aria-hidden', 'false');
        }

        function clearColumnHighlight() {
          if (!selectedTable) return;
          if (highlightedColumnIndex == null) return;
          Array.from(selectedTable.rows).forEach(row => {
            const cell = row.cells[highlightedColumnIndex];
            if (cell) cell.classList.remove('table-column-highlight');
          });
          highlightedColumnIndex = null;
        }

        function highlightColumn(index) {
          clearColumnHighlight();
          if (index == null || !selectedTable) return;
          Array.from(selectedTable.rows).forEach(row => {
            const cell = row.cells[index];
            if (cell) cell.classList.add('table-column-highlight');
          });
          highlightedColumnIndex = index;
        }

        function ensureTableDefaults(table) {
          if (!table.dataset.lineHeight) table.dataset.lineHeight = '1.25';
          if (!table.dataset.paddingY) table.dataset.paddingY = '4';
          if (!table.dataset.tableMargin) table.dataset.tableMargin = '6';
          if (!table.dataset.borderColor) table.dataset.borderColor = '#dee2e6';
          if (!table.dataset.borderWidth) table.dataset.borderWidth = '1';
          if (!table.dataset.hideVerticalBorders) table.dataset.hideVerticalBorders = 'false';
          if (!table.dataset.hideHorizontalBorders) table.dataset.hideHorizontalBorders = 'false';
        }

        function countColumns(table) {
          return Array.from(table.rows).reduce((max, row) => Math.max(max, row.cells.length), 0);
        }

        function countRows(table) {
          return Array.from(table.rows).length;
        }

        function updateSizeDisplay() {
          if (!selectedTable) return;
          const rows = countRows(selectedTable);
          const cols = countColumns(selectedTable);
          tableMenuSize.textContent = `${rows} × ${cols}`;
        }

        function applySpacing() {
          if (!selectedTable) return;
          const lineHeight = parseFloat(selectedTable.dataset.lineHeight || '1.25');
          const paddingY = parseInt(selectedTable.dataset.paddingY || '4', 10);
          const margin = parseInt(selectedTable.dataset.tableMargin || '6', 10);
          const cells = selectedTable.querySelectorAll('th,td');
          cells.forEach(cell => {
            cell.style.lineHeight = lineHeight.toString();
            cell.style.paddingTop = paddingY + 'px';
            cell.style.paddingBottom = paddingY + 'px';
          });
          selectedTable.style.marginTop = margin + 'px';
          selectedTable.style.marginBottom = margin + 'px';
          selectedTable.style.marginLeft = margin + 'px';
          selectedTable.style.marginRight = margin + 'px';
        }

        function updateSpacingControls() {
          if (!selectedTable) return;
          tableLineHeightInput.value = selectedTable.dataset.lineHeight || '1.25';
          tablePaddingYInput.value = selectedTable.dataset.paddingY || '4';
          tableMarginInput.value = selectedTable.dataset.tableMargin || '6';
          tableLineHeightValue.textContent = parseFloat(tableLineHeightInput.value).toFixed(2);
          tablePaddingYValue.textContent = `${tablePaddingYInput.value}px`;
          tableMarginValue.textContent = `${tableMarginInput.value}px`;
        }

        function updateThemeButtons() {
          if (!selectedTable) return;
          const currentTheme = selectedTable.dataset.themeClass || '';
          tableThemeButtons.forEach(btn => {
            const theme = btn.dataset.tableTheme || '';
            btn.classList.toggle('active', theme === currentTheme);
          });
        }

        function applyTheme(themeClass) {
          if (!selectedTable) return;
          const previous = selectedTable.dataset.themeClass;
          if (previous) {
            selectedTable.classList.remove(previous);
          }
          if (themeClass) {
            selectedTable.classList.add(themeClass);
            selectedTable.dataset.themeClass = themeClass;
          } else {
            delete selectedTable.dataset.themeClass;
          }
          updateThemeButtons();
        }

        const spacingPresets = {
          compacta: { lineHeight: 1.15, paddingY: 3, margin: 4 },
          equilibrada: { lineHeight: 1.3, paddingY: 5, margin: 8 },
          amplia: { lineHeight: 1.5, paddingY: 8, margin: 12 }
        };

        function updatePresetButtons() {
          if (!selectedTable) return;
          const current = {
            lineHeight: parseFloat(selectedTable.dataset.lineHeight || '1.25'),
            paddingY: parseInt(selectedTable.dataset.paddingY || '4', 10),
            margin: parseInt(selectedTable.dataset.tableMargin || '6', 10)
          };
          tablePresetButtons.forEach(btn => {
            const preset = spacingPresets[btn.dataset.tablePreset];
            if (!preset) {
              btn.classList.remove('active');
              return;
            }
            const isMatch = Math.abs(preset.lineHeight - current.lineHeight) < 0.01
              && preset.paddingY === current.paddingY
              && preset.margin === current.margin;
            btn.classList.toggle('active', isMatch);
          });
        }

        function applySpacingPreset(key) {
          const preset = spacingPresets[key];
          if (!preset || !selectedTable) return;
          selectedTable.dataset.lineHeight = preset.lineHeight.toString();
          selectedTable.dataset.paddingY = preset.paddingY.toString();
          selectedTable.dataset.tableMargin = preset.margin.toString();
          applySpacing();
          updateSpacingControls();
          updatePresetButtons();
        }

        function applyBorderStyles() {
          if (!selectedTable) return;
          const color = selectedTable.dataset.borderColor || '#dee2e6';
          const width = parseFloat(selectedTable.dataset.borderWidth || '1');
          const hideVertical = selectedTable.dataset.hideVerticalBorders === 'true';
          const hideHorizontal = selectedTable.dataset.hideHorizontalBorders === 'true';
          const cells = selectedTable.querySelectorAll('th,td');

          selectedTable.style.borderColor = color;
          selectedTable.style.borderWidth = width + 'px';
          selectedTable.style.borderStyle = 'solid';

          cells.forEach(cell => {
            cell.style.borderColor = color;
            cell.style.borderStyle = 'solid';
            cell.style.borderWidth = width + 'px';
            cell.style.borderLeftWidth = hideVertical ? '0px' : width + 'px';
            cell.style.borderRightWidth = hideVertical ? '0px' : width + 'px';
            cell.style.borderTopWidth = hideHorizontal ? '0px' : width + 'px';
            cell.style.borderBottomWidth = hideHorizontal ? '0px' : width + 'px';
          });
        }

        function updateBorderControls() {
          if (!selectedTable) return;
          const color = selectedTable.dataset.borderColor || '#dee2e6';
          const width = selectedTable.dataset.borderWidth || '1';
          const hideVertical = selectedTable.dataset.hideVerticalBorders === 'true';
          const hideHorizontal = selectedTable.dataset.hideHorizontalBorders === 'true';

          tableBorderColorButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.borderColor === color);
          });
          if (tableBorderColorCustom) {
            tableBorderColorCustom.value = color;
          }
          tableBorderWidthInput.value = width;
          tableBorderWidthValue.textContent = `${width}px`;
          toggleVerticalBorders.checked = hideVertical;
          toggleHorizontalBorders.checked = hideHorizontal;
        }

        function updateStatefulButtons() {
          actionButtons.forEach(btn => {
            if (!btn.dataset.stateful) return;
            if (!selectedTable) {
              btn.classList.remove('active');
              return;
            }
            const action = btn.dataset.action;
            if (action === 'toggle-header') {
              const hasHeader = !!selectedTable.tHead;
              btn.classList.toggle('active', hasHeader);
            }
            if (action === 'toggle-zebra') {
              const isZebra = selectedTable.classList.contains('table-zebra');
              btn.classList.toggle('active', isZebra);
            }
          });
        }

        function updateMenuState() {
          if (!selectedTable) return;
          ensureTableDefaults(selectedTable);
          updateSizeDisplay();
          updateSpacingControls();
          updatePresetButtons();
          updateThemeButtons();
          updateBorderControls();
          updateStatefulButtons();
          applySpacing();
          applyBorderStyles();
        }

        function ensureCellContext() {
          if (!selectedCell || !selectedTable || !selectedTable.contains(selectedCell)) {
            selectedCell = selectedTable?.querySelector('td,th') || null;
          }
          return selectedCell;
        }

        function insertRow(relativePosition) {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const row = cell.parentElement;
          if (!row) return;
          const section = row.parentElement;
          const columnCount = countColumns(selectedTable) || row.cells.length;
          const isHeader = section?.tagName === 'THEAD';
          const newRow = document.createElement('tr');
          for (let i = 0; i < columnCount; i++) {
            const newCell = document.createElement(isHeader ? 'th' : 'td');
            newCell.innerHTML = '<br>';
            newRow.appendChild(newCell);
          }
          if (relativePosition === 'before') {
            row.parentElement?.insertBefore(newRow, row);
          } else {
            row.parentElement?.insertBefore(newRow, row.nextSibling);
          }
          selectedCell = newRow.cells[cell.cellIndex] || newRow.cells[0] || selectedCell;
        }

        function deleteRow() {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const row = cell.parentElement;
          if (!row) return;
          const section = row.parentElement;
          const isBody = section?.tagName === 'TBODY';
          const isHeader = section?.tagName === 'THEAD';

          if (isHeader) {
            const thead = selectedTable.tHead;
            if (!thead) return;
            if (thead.rows.length <= 1) {
              thead.remove();
            } else {
              row.remove();
            }
          } else if (isBody) {
            const tbody = section;
            if (tbody && tbody.rows.length <= 1) return;
            row.remove();
          } else {
            row.remove();
          }
          selectedCell = selectedTable.querySelector('td,th');
        }

        function insertColumn(position) {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const index = cell.cellIndex;
          const rows = Array.from(selectedTable.rows);
          rows.forEach(row => {
            const tag = row.parentElement?.tagName === 'THEAD' ? 'th' : 'td';
            const newCell = document.createElement(tag);
            newCell.innerHTML = '<br>';
            const reference = row.cells[index] || null;
            if (position === 'left') {
              row.insertBefore(newCell, reference);
            } else {
              if (reference) {
                row.insertBefore(newCell, reference.nextSibling);
              } else {
                row.appendChild(newCell);
              }
            }
          });
        }

        function deleteColumn() {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const index = cell.cellIndex;
          const columnCount = countColumns(selectedTable);
          if (columnCount <= 1) return;
          Array.from(selectedTable.rows).forEach(row => {
            const target = row.cells[index];
            if (target) target.remove();
          });
          selectedCell = selectedTable.querySelector('td,th');
          clearColumnHighlight();
        }

        function clearColumn() {
          const cell = ensureCellContext();
          if (!cell || !selectedTable) return;
          const index = cell.cellIndex;
          Array.from(selectedTable.rows).forEach(row => {
            const target = row.cells[index];
            if (target) target.innerHTML = '<br>';
          });
        }

        function toggleHeaderRow() {
          if (!selectedTable) return;
          if (selectedTable.tHead) {
            const headerRow = selectedTable.tHead.rows[0];
            if (headerRow) {
              const tbody = selectedTable.tBodies[0] || selectedTable.createTBody();
              const bodyRow = document.createElement('tr');
              Array.from(headerRow.cells).forEach(th => {
                const td = document.createElement('td');
                td.innerHTML = th.innerHTML;
                td.style.cssText = th.style.cssText;
                bodyRow.appendChild(td);
              });
              tbody.insertBefore(bodyRow, tbody.firstChild || null);
              selectedCell = bodyRow.cells[0] || null;
            }
            selectedTable.tHead.remove();
            selectedTable.dataset.headerRow = 'false';
          } else {
            const tbody = selectedTable.tBodies[0];
            if (!tbody || !tbody.rows.length) return;
            const firstRow = tbody.rows[0];
            const thead = selectedTable.createTHead();
            const headerRow = document.createElement('tr');
            Array.from(firstRow.cells).forEach(td => {
              const th = document.createElement('th');
              th.innerHTML = td.innerHTML;
              th.style.cssText = td.style.cssText;
              headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            firstRow.remove();
            selectedCell = headerRow.cells[0] || null;
            selectedTable.dataset.headerRow = 'true';
          }
        }

        function toggleZebra() {
          if (!selectedTable) return;
          const isActive = selectedTable.classList.toggle('table-zebra');
          selectedTable.dataset.zebra = isActive ? 'true' : 'false';
        }

        function selectColumn() {
          const cell = ensureCellContext();
          if (!cell) return;
          highlightColumn(cell.cellIndex);
        }

        function openTools() {
          if (!selectedTable) return;
          const event = new CustomEvent('tableMenu:tools', { detail: { table: selectedTable } });
          document.dispatchEvent(event);
        }

        function handleAction(action) {
          switch (action) {
            case 'insert-row-above':
              insertRow('before');
              break;
            case 'insert-row-below':
              insertRow('after');
              break;
            case 'delete-row':
              deleteRow();
              break;
            case 'insert-column-left':
              insertColumn('left');
              break;
            case 'insert-column-right':
              insertColumn('right');
              break;
            case 'delete-column':
              deleteColumn();
              break;
            case 'clear-column':
              clearColumn();
              break;
            case 'toggle-header':
              toggleHeaderRow();
              break;
            case 'toggle-zebra':
              toggleZebra();
              break;
            case 'select-column':
              selectColumn();
              break;
            case 'open-tools':
              openTools();
              break;
          }
          updateMenuState();
        }

        actionButtons.forEach(btn => {
          btn.addEventListener('click', () => handleAction(btn.dataset.action));
        });

        tableMenuTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            if (tab.classList.contains('active')) return;
            tableMenuTabs.forEach(t => {
              t.classList.toggle('active', t === tab);
              t.setAttribute('aria-selected', t === tab ? 'true' : 'false');
            });
            const target = tab.dataset.tab;
            tableMenuPanels.forEach(panel => {
              panel.classList.toggle('active', panel.dataset.panel === target);
            });
          });
        });

        tableThemeButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            applyTheme(btn.dataset.tableTheme || '');
          });
        });

        tableLineHeightInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.lineHeight = tableLineHeightInput.value;
          tableLineHeightValue.textContent = parseFloat(tableLineHeightInput.value).toFixed(2);
          applySpacing();
        });

        tablePaddingYInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.paddingY = tablePaddingYInput.value;
          tablePaddingYValue.textContent = `${tablePaddingYInput.value}px`;
          applySpacing();
        });

        tableMarginInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.tableMargin = tableMarginInput.value;
          tableMarginValue.textContent = `${tableMarginInput.value}px`;
          applySpacing();
        });

        tablePresetButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            applySpacingPreset(btn.dataset.tablePreset);
          });
        });

        tableBorderColorButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (!selectedTable) return;
            selectedTable.dataset.borderColor = btn.dataset.borderColor || '#dee2e6';
            updateBorderControls();
            applyBorderStyles();
          });
        });

        tableBorderColorCustom?.addEventListener('input', () => {
          if (!selectedTable || !tableBorderColorCustom) return;
          selectedTable.dataset.borderColor = tableBorderColorCustom.value;
          updateBorderControls();
          applyBorderStyles();
        });

        tableBorderWidthInput?.addEventListener('input', () => {
          if (!selectedTable) return;
          selectedTable.dataset.borderWidth = tableBorderWidthInput.value;
          tableBorderWidthValue.textContent = `${tableBorderWidthInput.value}px`;
          applyBorderStyles();
        });

        toggleVerticalBorders?.addEventListener('change', () => {
          if (!selectedTable) return;
          selectedTable.dataset.hideVerticalBorders = toggleVerticalBorders.checked ? 'true' : 'false';
          applyBorderStyles();
        });

        toggleHorizontalBorders?.addEventListener('change', () => {
          if (!selectedTable) return;
          selectedTable.dataset.hideHorizontalBorders = toggleHorizontalBorders.checked ? 'true' : 'false';
          applyBorderStyles();
        });

        tableBorderResetBtn?.addEventListener('click', () => {
          if (!selectedTable) return;
          selectedTable.dataset.borderColor = '#dee2e6';
          selectedTable.dataset.borderWidth = '1';
          selectedTable.dataset.hideVerticalBorders = 'false';
          selectedTable.dataset.hideHorizontalBorders = 'false';
          updateBorderControls();
          applyBorderStyles();
        });

        tableMenuClose?.addEventListener('click', () => hideMenu());

        tableResizeBtn?.addEventListener('click', () => {
          if (!selectedTable) return;
          currentResizer = makeTableResizable(selectedTable);
          currentResizer?.activate({
            onFinish: () => {
              currentResizer = null;
              showMenu(selectedTable, selectedCell);
            },
            onCancel: () => {
              currentResizer = null;
              showMenu(selectedTable, selectedCell);
            }
          });
          hideMenu({ preserveSelection: true });
        });

        function cancelResizeMode() {
          if (currentResizer) {
            currentResizer.cancel();
            currentResizer = null;
          } else if (selectedTable && tableResizers.has(selectedTable)) {
            tableResizers.get(selectedTable)?.cancel();
          }
        }

        document.addEventListener('click', (event) => {
          if (!isEditMode) return;
          if (tableMenu.contains(event.target)) return;
          const table = event.target.closest('table');
          if (!table) {
            if (!tableMenu.contains(event.target)) {
              hideMenu();
            }
            return;
          }
          const cell = event.target.closest('td,th') || table.querySelector('td,th');
          if (!cell) return;
          showMenu(table, cell);
        });

        document.addEventListener('selectionchange', () => {
          if (!isEditMode) return;
          const selection = window.getSelection();
          if (!selection || !selection.rangeCount) return;
          const node = selection.anchorNode;
          if (!node) return;
          const element = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
          if (!element) return;
          const table = element.closest('table');
          if (!table) {
            if (tableMenu.classList.contains('show')) {
              hideMenu();
            }
            return;
          }
          const cell = element.closest('td,th') || table.querySelector('td,th');
          if (!cell) return;
          showMenu(table, cell);
        });

        return {
          hide: hideMenu,
          show: showMenu,
          refresh: updateMenuState,
          cancelResize: cancelResizeMode
        };
      }

      tableMenuAPI = initializeTableMenu();

      /* === MODAL === */
      function showModal(content) {
        hideTopicMenu();
        modalContent.innerHTML = content;
        modalOverlay.classList.add('show');
      }

      function hideModal() {
        modalOverlay.classList.remove('show');
        modalContent.innerHTML = '';
      }

      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) hideModal();
      });

      /* === INICIALIZACIÓN === */
      function initializeSections() {
        const sectionMap = new Map();
        const newThemeMap = new Map(sectionThemes);

        pages.forEach(page => {
          const sectionId = page.dataset.sectionId || 'seccion-default';
          const topicId = page.dataset.topicId || 'topic-' + Date.now();
          const h1 = page.querySelector('h1');
          const titleSpan = h1?.querySelector('span:first-child');
          const title = (titleSpan?.textContent || h1?.textContent || 'Sin título').trim();
          const existingTheme = newThemeMap.get(sectionId) || page.dataset.theme || getPageTheme(page);

          applyThemeToPage(page, existingTheme);
          newThemeMap.set(sectionId, existingTheme);

          if (!sectionMap.has(sectionId)) {
            sectionMap.set(sectionId, {
              id: sectionId,
              nombre: page.dataset.sectionName || 'Sección Principal',
              collapsed: false,
              temas: [],
              theme: existingTheme
            });
          }

          sectionMap.get(sectionId).temas.push({
            id: topicId,
            titulo: title,
            page: page,
            theme: existingTheme
          });
        });

        sectionThemes = newThemeMap;
        sections = Array.from(sectionMap.values());
      }

      pages.forEach(p => {
        afterContentSanitize(p);
        if (!p.dataset.sectionId) {
          p.dataset.sectionId = 'seccion-1';
        }
      });
      
      document.querySelectorAll('.magic-topic').forEach(m => afterContentSanitize(m));
      initializeSections();

      (function setSpecialtyFromBuildComment() {
        try {
          const html = document.documentElement.innerHTML;
          const m = html.match(/build:topics\s{([\s\S]*?)}/);
          if (m) {
            const json = JSON.parse('{' + m[1] + '}');
            if (json.especialidad && specialtySpan) {
              setDocumentTitle(json.especialidad);
            }
          }
        } catch (e) {}
      })();

      /* === ICONOS MÁGICOS EN PÁGINAS === */
      function setupMagicIcons() {
        pages.forEach(page => {
          const h1 = page.querySelector('h1');
          if (!h1) return;

          let titleSpan = h1.querySelector('.topic-title-text');
          if (!titleSpan) {
            const existingSpan = h1.querySelector('span:first-child');
            const currentTitle = (existingSpan?.textContent || h1.textContent || '').trim();
            const existingMagic = h1.querySelector('.magic-icon');

            if (existingSpan) {
              titleSpan = existingSpan;
              titleSpan.classList.add('topic-title-text');
            } else {
              titleSpan = document.createElement('span');
              titleSpan.className = 'topic-title-text';
              titleSpan.textContent = currentTitle;
            }

            h1.innerHTML = '';
            h1.appendChild(titleSpan);
            if (existingMagic) {
              h1.appendChild(existingMagic);
            }
          }

          let magicIcon = h1.querySelector('.magic-icon');
          if (!magicIcon) {
            magicIcon = document.createElement('span');
            magicIcon.className = 'magic-icon';
            magicIcon.title = 'Ver contenido mágico';
            magicIcon.textContent = '✨';
            h1.appendChild(magicIcon);
          }

          const getTitle = () => (titleSpan?.textContent || '').trim() || getTopicTitle(page) || 'Tema';

          if (!magicIcon.dataset.bound) {
            magicIcon.addEventListener('click', (e) => {
              e.stopPropagation();
              closePanel();
              activateMagicTopic(magicAnchorFor(page), getTitle(), page);
            });
            magicIcon.dataset.bound = 'true';
          }

          if (!titleSpan.dataset.bound) {
            titleSpan.title = 'Doble clic para opciones del tema';
            titleSpan.addEventListener('dblclick', (event) => {
              event.preventDefault();
              event.stopPropagation();
              showTopicMenu(event, { page, titulo: getTitle() });
            });
            titleSpan.addEventListener('click', (event) => event.stopPropagation());
            titleSpan.dataset.bound = 'true';
          }

          if (titleSpan.nextSibling !== magicIcon) {
            h1.appendChild(magicIcon);
          }
        });
      }

      setupMagicIcons();

      /* === MODO LECTURA === */
      function toggleReadingMode() {
        isReadingMode = !isReadingMode;
        document.body.classList.toggle('reading-mode', isReadingMode);
        readingModeBtn.classList.toggle('active', isReadingMode);
        
        if (isReadingMode) {
          closePanel();
          closeTocPanel();
          if (isEditMode) {
            toggleEditMode();
          }
        }
      }

      readingModeBtn?.addEventListener('click', toggleReadingMode);
      readingModeExit?.addEventListener('click', toggleReadingMode);

      /* === TABLA DE CONTENIDOS === */
      function buildTableOfContents() {
        const tocList = document.getElementById('tocList');
        tocList.innerHTML = '';
        
        pages.forEach(page => {
          const headings = page.querySelectorAll('h1, h2, h3');
          headings.forEach(heading => {
            const li = document.createElement('li');
            li.className = `toc-item ${heading.tagName.toLowerCase()}`;
            
            // Para h1, obtener solo el texto sin el icono
            if (heading.tagName === 'H1') {
              const titleSpan = heading.querySelector('span:first-child');
              li.textContent = titleSpan ? titleSpan.textContent : heading.textContent;
            } else {
              li.textContent = heading.textContent;
            }
            
            li.addEventListener('click', () => {
              heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
              closeTocPanel();
            });
            tocList.appendChild(li);
          });
        });
      }

      function openTocPanel() {
        buildTableOfContents();
        tocPanel.classList.add('open');
        panelBackdrop.classList.add('show');
      }

      function closeTocPanel() {
        tocPanel.classList.remove('open');
        if (!panel.classList.contains('open')) {
          panelBackdrop.classList.remove('show');
        }
        hideTopicMenu();
      }

      tocBtn?.addEventListener('click', () => {
        if (tocPanel.classList.contains('open')) {
          closeTocPanel();
        } else {
          closePanel();
          openTocPanel();
        }
      });

      tocClose?.addEventListener('click', closeTocPanel);

      /* === EXPORTAR MARKDOWN === */
      exportMarkdownBtn?.addEventListener('click', () => {
        let markdown = `# ${getDocumentTitle() || 'Documento'}\n\n`;
        
        pages.forEach(page => {
          const clone = page.cloneNode(true);
          markdown += htmlToMarkdown(clone.innerHTML) + '\n\n---\n\n';
        });
        
        const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const specialty = getDocumentTitle() || 'documento';
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.download = `${specialty.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      function htmlToMarkdown(html) {
        let md = html;
        
        md = md.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n');
        md = md.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n');
        md = md.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n');
        md = md.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n');
        
        md = md.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
        md = md.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
        md = md.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
        md = md.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
        md = md.replace(/<u[^>]*>(.*?)<\/u>/gi, '_$1_');
        
        md = md.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n');
        md = md.replace(/<ul[^>]*>/gi, '\n');
        md = md.replace(/<\/ul>/gi, '\n');
        md = md.replace(/<ol[^>]*>/gi, '\n');
        md = md.replace(/<\/ol>/gi, '\n');
        
        md = md.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
        
        md = md.replace(/<[^>]+>/g, '');
        
        md = md.replace(/&nbsp;/g, ' ');
        md = md.replace(/&amp;/g, '&');
        md = md.replace(/&lt;/g, '<');
        md = md.replace(/&gt;/g, '>');
        
        md = md.replace(/\n{3,}/g, '\n\n');
        
        return md.trim();
      }

      /* === MANEJO DE IMÁGENES === */
      function getImageContainer(img) {
        if (img.parentElement && img.parentElement.classList.contains('image-figure')) {
          return img.parentElement;
        }
        return img;
      }

      function setActiveAlignButton(activeClass) {
        Object.values(alignButtons).forEach(btn => btn?.classList.remove('active'));
        switch (activeClass) {
          case 'float-left':
            alignButtons.left?.classList.add('active');
            break;
          case 'center-block':
            alignButtons.center?.classList.add('active');
            break;
          case 'float-right':
            alignButtons.right?.classList.add('active');
            break;
          case 'inline-image':
            alignButtons.inline?.classList.add('active');
            break;
        }
      }

      function getImageNaturalWidth(img) {
        if (!img) return 0;
        const attrWidth = parseFloat(img.getAttribute('width') || '');
        const natural = img.naturalWidth || attrWidth || img.width || img.getBoundingClientRect().width || 0;
        if (natural > 0) {
          img.dataset.originalWidth = String(Math.round(natural));
          return natural;
        }
        const stored = parseFloat(img.dataset.originalWidth || '');
        if (!Number.isNaN(stored) && stored > 0) {
          return stored;
        }
        return 0;
      }

      function getImageWidthPx(img) {
        if (!img) return 0;
        const styleWidth = parseFloat(img.style.width || '');
        if (!Number.isNaN(styleWidth) && styleWidth > 0) {
          return styleWidth;
        }
        if (img.width) {
          return img.width;
        }
        const rectWidth = img.getBoundingClientRect().width;
        if (rectWidth > 0) {
          return rectWidth;
        }
        return getImageNaturalWidth(img) || 0;
      }

      function setImageWidthPx(img, width) {
        if (!img) return 0;
        const clamped = Math.max(IMAGE_MIN_WIDTH, Math.min(IMAGE_MAX_WIDTH, Math.round(width)));
        img.style.width = clamped + 'px';
        if (!img.style.height) {
          img.style.height = 'auto';
        }
        return clamped;
      }

      function updateWidthDisplayForImage(img) {
        if (!widthDisplay) return;
        if (!img) {
          widthDisplay.textContent = '';
          return;
        }
        const current = getImageWidthPx(img);
        const natural = getImageNaturalWidth(img);
        const percent = natural > 0 ? Math.round((current / natural) * 100) : null;
        const roundedWidth = Math.max(1, Math.round(current));
        if (percent !== null && Number.isFinite(percent)) {
          widthDisplay.textContent = `${percent}% (${roundedWidth}px)`;
        } else {
          widthDisplay.textContent = `${roundedWidth}px`;
        }
      }

      function changeSelectedImageWidth(multiplier) {
        if (!selectedImage) return;
        const current = getImageWidthPx(selectedImage) || getImageNaturalWidth(selectedImage) || 200;
        setImageWidthPx(selectedImage, current * multiplier);
        updateWidthDisplayForImage(selectedImage);
        repositionImageToolbar();
      }

      function updateToolbarPosition(img) {
        if (!imageToolbar || !img) return;

        imageToolbar.classList.add('show');

        const rect = img.getBoundingClientRect();
        const toolbarWidth = imageToolbar.offsetWidth || 240;
        const toolbarHeight = imageToolbar.offsetHeight || 160;

        let left = rect.left;
        let top = rect.top - toolbarHeight - 10;

        if (top < 10) {
          top = rect.bottom + 10;
        }

        if (top + toolbarHeight > window.innerHeight - 10) {
          top = Math.max(10, window.innerHeight - toolbarHeight - 10);
        }

        if (left + toolbarWidth > window.innerWidth - 10) {
          left = window.innerWidth - toolbarWidth - 10;
        }

        if (left < 10) {
          left = 10;
        }

        imageToolbar.style.left = left + 'px';
        imageToolbar.style.top = top + 'px';
      }

      function updateToolbarState(img) {
        if (!img) return;

        if (imageAltInput) {
          imageAltInput.value = img.getAttribute('alt') || '';
        }

        if (imageFrameToggle) {
          imageFrameToggle.checked = img.classList.contains('image-frame');
        }

        if (wrapFigureBtn && unwrapFigureBtn) {
          const isWrapped = img.parentElement?.classList.contains('image-figure') || false;
          wrapFigureBtn.disabled = isWrapped;
          unwrapFigureBtn.disabled = !isWrapped;
        }

        const container = getImageContainer(img);
        const activeFloat = floatClasses.find(cls => container.classList.contains(cls));
        setActiveAlignButton(activeFloat);

        updateWidthDisplayForImage(img);

        if (cropImageBtn) {
          cropImageBtn.disabled = false;
        }
      }

      function updateCropScale() {
        if (!imageCropPreview) return;
        const rect = imageCropPreview.getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0) {
          cropState.scaleX = imageCropPreview.naturalWidth / rect.width;
          cropState.scaleY = imageCropPreview.naturalHeight / rect.height;
        }
      }

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }

      function setCropSelection(startX, startY, currentX, currentY) {
        if (!imageCropStage || !imageCropSelection || !imageCropPreview) return;
        const stageRect = imageCropStage.getBoundingClientRect();
        const imageRect = imageCropPreview.getBoundingClientRect();
        const x1 = clamp(startX, imageRect.left, imageRect.right);
        const y1 = clamp(startY, imageRect.top, imageRect.bottom);
        const x2 = clamp(currentX, imageRect.left, imageRect.right);
        const y2 = clamp(currentY, imageRect.top, imageRect.bottom);
        const left = Math.min(x1, x2);
        const top = Math.min(y1, y2);
        const width = Math.abs(x1 - x2);
        const height = Math.abs(y1 - y2);

        cropState.currentRect = { left, top, width, height };
        imageCropSelection.style.left = (left - stageRect.left) + 'px';
        imageCropSelection.style.top = (top - stageRect.top) + 'px';
        imageCropSelection.style.width = width + 'px';
        imageCropSelection.style.height = height + 'px';

        if (width < 3 || height < 3) {
          if (imageCropSizeLabel) imageCropSizeLabel.textContent = '0 × 0 px';
          if (imageCropApplyBtn) imageCropApplyBtn.disabled = true;
          return;
        }

        const naturalWidth = Math.round(width * cropState.scaleX);
        const naturalHeight = Math.round(height * cropState.scaleY);
        if (imageCropSizeLabel) {
          imageCropSizeLabel.textContent = `${naturalWidth} × ${naturalHeight} px`;
        }
        if (imageCropApplyBtn) {
          imageCropApplyBtn.disabled = !(naturalWidth > 0 && naturalHeight > 0);
        }
      }

      function openImageCropModal(img) {
        if (!imageCropModal || !imageCropPreview) return;
        cropState.image = img;
        cropState.isSelecting = false;
        cropState.currentRect = null;
        cropState.scaleX = 1;
        cropState.scaleY = 1;
        if (imageCropSelection) {
          imageCropSelection.classList.remove('show');
        }
        if (imageCropSizeLabel) {
          imageCropSizeLabel.textContent = '0 × 0 px';
        }
        if (imageCropApplyBtn) {
          imageCropApplyBtn.disabled = true;
        }
        imageCropPreview.src = img.src;
        imageCropModal.classList.add('show');
        imageCropModal.setAttribute('aria-hidden', 'false');
        requestAnimationFrame(updateCropScale);
      }

      function closeImageCropModal() {
        if (!imageCropModal) return;
        imageCropModal.classList.remove('show');
        imageCropModal.setAttribute('aria-hidden', 'true');
        cropState.image = null;
        cropState.isSelecting = false;
        cropState.currentRect = null;
        if (imageCropSelection) {
          imageCropSelection.classList.remove('show');
        }
        if (imageCropApplyBtn) {
          imageCropApplyBtn.disabled = true;
        }
        if (imageCropSizeLabel) {
          imageCropSizeLabel.textContent = '0 × 0 px';
        }
      }

      function repositionImageToolbar() {
        if (selectedImage) {
          updateToolbarPosition(selectedImage);
        }
      }

      window.addEventListener('scroll', repositionImageToolbar, { passive: true });
      window.addEventListener('resize', repositionImageToolbar);
      window.addEventListener('scroll', repositionTemplateToolbar, { passive: true });
      window.addEventListener('resize', repositionTemplateToolbar);

      imageCropPreview?.addEventListener('load', updateCropScale);

      window.addEventListener('resize', () => {
        if (imageCropModal?.classList.contains('show')) {
          requestAnimationFrame(updateCropScale);
        }
      });

      cropImageBtn?.addEventListener('click', () => {
        if (!selectedImage) {
          alert('Selecciona una imagen para recortar.');
          return;
        }
        openImageCropModal(selectedImage);
      });

      const finishCropSelection = (event) => {
        if (!cropState.isSelecting) return;
        cropState.isSelecting = false;
        try {
          imageCropStage?.releasePointerCapture(event.pointerId);
        } catch (err) {
          /* ignore */
        }
        if (!cropState.currentRect || cropState.currentRect.width < 3 || cropState.currentRect.height < 3) {
          cropState.currentRect = null;
          imageCropSelection?.classList.remove('show');
          if (imageCropSizeLabel) imageCropSizeLabel.textContent = '0 × 0 px';
          if (imageCropApplyBtn) imageCropApplyBtn.disabled = true;
        }
      };

      imageCropStage?.addEventListener('pointerdown', (event) => {
        if (!imageCropModal?.classList.contains('show') || !cropState.image || !imageCropPreview?.complete) return;
        const imageRect = imageCropPreview.getBoundingClientRect();
        if (imageRect.width === 0 || imageRect.height === 0) return;
        const withinImage = event.clientX >= imageRect.left && event.clientX <= imageRect.right
          && event.clientY >= imageRect.top && event.clientY <= imageRect.bottom;
        if (!withinImage) return;
        cropState.isSelecting = true;
        cropState.startX = event.clientX;
        cropState.startY = event.clientY;
        setCropSelection(cropState.startX, cropState.startY, cropState.startX, cropState.startY);
        imageCropSelection?.classList.add('show');
        if (imageCropApplyBtn) imageCropApplyBtn.disabled = true;
        if (imageCropSizeLabel) imageCropSizeLabel.textContent = '0 × 0 px';
        try {
          imageCropStage.setPointerCapture(event.pointerId);
        } catch (err) {
          /* ignore */
        }
        event.preventDefault();
      });

      imageCropStage?.addEventListener('pointermove', (event) => {
        if (!cropState.isSelecting) return;
        setCropSelection(cropState.startX, cropState.startY, event.clientX, event.clientY);
        event.preventDefault();
      });

      imageCropStage?.addEventListener('pointerup', finishCropSelection);
      imageCropStage?.addEventListener('pointerleave', finishCropSelection);
      imageCropStage?.addEventListener('pointercancel', finishCropSelection);

      imageCropApplyBtn?.addEventListener('click', () => {
        if (!cropState.image || !cropState.currentRect || !imageCropPreview) return;
        const { left, top, width, height } = cropState.currentRect;
        if (width < 3 || height < 3) {
          alert('Selecciona un área mayor para recortar.');
          return;
        }
        const imageRect = imageCropPreview.getBoundingClientRect();
        const sx = Math.round((left - imageRect.left) * cropState.scaleX);
        const sy = Math.round((top - imageRect.top) * cropState.scaleY);
        const sw = Math.round(width * cropState.scaleX);
        const sh = Math.round(height * cropState.scaleY);
        if (sw <= 1 || sh <= 1) {
          alert('El recorte seleccionado es demasiado pequeño.');
          return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = sw;
        canvas.height = sh;
        const ctx = canvas.getContext('2d');
        if (!ctx) {
          alert('No se pudo preparar el recorte.');
          return;
        }

        const source = new Image();
        source.crossOrigin = 'anonymous';
        source.onload = () => {
          try {
            ctx.drawImage(source, sx, sy, sw, sh, 0, 0, sw, sh);
            const dataUrl = canvas.toDataURL('image/png');
            cropState.image.src = dataUrl;
            cropState.image.removeAttribute('height');
            cropState.image.style.height = 'auto';
            updateToolbarState(cropState.image);
            repositionImageToolbar();
            closeImageCropModal();
          } catch (error) {
            console.error('Error al recortar la imagen:', error);
            alert('No se pudo recortar la imagen.');
          }
        };
        source.onerror = () => {
          alert('No se pudo cargar la imagen para recortar.');
        };
        source.src = cropState.image.src;
      });

      imageCropCancelBtn?.addEventListener('click', closeImageCropModal);
      imageCropCloseBtn?.addEventListener('click', closeImageCropModal);

      imageCropModal?.addEventListener('click', (event) => {
        if (event.target === imageCropModal) {
          closeImageCropModal();
        }
      });

      function showImageToolbar(img) {
        hideTemplateToolbar();
        if (selectedImage && selectedImage !== img) {
          selectedImage.classList.remove('selected-image');
        }
        selectedImage = img;
        img.classList.add('selected-image');

        updateToolbarState(img);
        updateToolbarPosition(img);
      }

      function hideImageToolbar() {
        if (selectedImage) {
          selectedImage.classList.remove('selected-image');
          selectedImage = null;
        }
        imageToolbar.classList.remove('show');
        if (cropImageBtn) {
          cropImageBtn.disabled = true;
        }
      }

      document.addEventListener('click', (e) => {
        if (isEditMode && e.target.tagName === 'IMG') {
          e.preventDefault();
          showImageToolbar(e.target);
        } else if (!e.target.closest('#imageToolbar') && !e.target.closest('img') && !e.target.closest('.image-figure')) {
          hideImageToolbar();
        }

        if (isEditMode) {
          const templateBlock = e.target.closest('.template-block');
          if (templateBlock) {
            showTemplateToolbar(templateBlock);
          } else if (!e.target.closest('#templateToolbar')) {
            hideTemplateToolbar();
          }
        } else if (!e.target.closest('#templateToolbar')) {
          hideTemplateToolbar();
        }
      });

      document.addEventListener('click', (event) => {
        const toggle = event.target.closest('.collapse-card-toggle');
        if (!toggle) return;
        const card = toggle.closest('.collapse-card');
        if (!card) return;
        const collapsed = card.classList.toggle('collapsed');
        toggle.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      });

      /* === NOTAS FLOTANTES === */
      function getFloatingNoteStyle(styleId) {
        return NOTE_STYLE_PRESETS.find(preset => preset.id === styleId) || NOTE_STYLE_PRESETS[0];
      }

      function applyFloatingNoteStyle(note, styleId) {
        if (!note) return;
        const preset = getFloatingNoteStyle(styleId);
        NOTE_STYLE_PRESETS.forEach(presetOption => {
          if (presetOption.className) {
            note.classList.remove(presetOption.className);
          }
        });
        if (preset?.className) {
          note.classList.add(preset.className);
        }
        note.dataset.style = preset?.id || 'default';
      }

      function bringNoteToFront(note) {
        if (!note) return;
        floatingNoteZIndex += 1;
        note.style.zIndex = String(floatingNoteZIndex);
      }

      function clampNotePosition(note, left, top) {
        if (!floatingNotesLayer) {
          return { left: left || 0, top: top || 0 };
        }
        const layerRect = floatingNotesLayer.getBoundingClientRect();
        const computedStyle = window.getComputedStyle(floatingNotesLayer);
        const topOffset = Number.parseFloat(computedStyle.top || '0') || 0;
        const layerWidth = layerRect.width || window.innerWidth;
        const layerHeight = layerRect.height || Math.max(0, window.innerHeight - topOffset);
        const noteRect = note.getBoundingClientRect();
        const noteWidth = note.offsetWidth || noteRect.width || 240;
        const noteHeight = note.offsetHeight || noteRect.height || 140;
        const maxLeft = Math.max(0, layerWidth - noteWidth);
        const maxTop = Math.max(0, layerHeight - noteHeight);
        const clampedLeft = Math.min(Math.max(Number.isFinite(left) ? left : 0, 0), maxLeft);
        const clampedTop = Math.min(Math.max(Number.isFinite(top) ? top : 0, 0), maxTop);
        return { left: clampedLeft, top: clampedTop };
      }

      function positionFloatingNote(note, left, top) {
        if (!note) return;
        const applyPosition = () => {
          const coords = clampNotePosition(note, left, top);
          note.style.left = `${coords.left}px`;
          note.style.top = `${coords.top}px`;
          note.dataset.left = String(coords.left);
          note.dataset.top = String(coords.top);
        };

        if ((note.offsetWidth || note.getBoundingClientRect().width) === 0) {
          requestAnimationFrame(applyPosition);
        } else {
          applyPosition();
        }
      }

      function refreshToggleNotesButton() {
        if (!toggleNotesBtn) return;
        toggleNotesBtn.classList.toggle('active', !floatingNotesHidden);
        toggleNotesBtn.setAttribute('aria-pressed', floatingNotesHidden ? 'false' : 'true');
        toggleNotesBtn.title = floatingNotesHidden ? 'Mostrar notas flotantes' : 'Ocultar notas flotantes';
        toggleNotesBtn.textContent = floatingNotesHidden ? '🙈' : '👁️';
      }

      function setFloatingNotesVisibility(hidden) {
        floatingNotesHidden = !!hidden;
        document.body.classList.toggle('notes-hidden', floatingNotesHidden);
        refreshToggleNotesButton();
        if (!floatingNotesHidden) {
          clampAllFloatingNotes();
        }
      }

      function setFloatingNotesEditable(editable) {
        if (!floatingNotesLayer) return;
        const bodies = floatingNotesLayer.querySelectorAll('.floating-note-body');
        bodies.forEach(body => {
          body.contentEditable = editable ? 'true' : 'false';
        });
      }

      function startFloatingNoteDrag(note, event) {
        if (!note || !floatingNotesLayer) return;
        floatingNoteDragState.note = note;
        floatingNoteDragState.pointerId = event.pointerId;
        const rect = note.getBoundingClientRect();
        floatingNoteDragState.offsetX = event.clientX - rect.left;
        floatingNoteDragState.offsetY = event.clientY - rect.top;
        note.classList.add('dragging');
        bringNoteToFront(note);
        try {
          note.setPointerCapture(event.pointerId);
        } catch (err) {
          // Ignore pointer capture errors
        }
        event.preventDefault();
      }

      function handleFloatingNotePointerMove(event) {
        const state = floatingNoteDragState;
        if (!state.note || state.pointerId !== event.pointerId || !floatingNotesLayer) {
          return;
        }
        const layerRect = floatingNotesLayer.getBoundingClientRect();
        const newLeft = event.clientX - layerRect.left - state.offsetX;
        const newTop = event.clientY - layerRect.top - state.offsetY;
        positionFloatingNote(state.note, newLeft, newTop);
        event.preventDefault();
      }

      function endFloatingNoteDrag(event) {
        const state = floatingNoteDragState;
        if (!state.note) return;
        if (event && state.pointerId !== undefined && event.pointerId !== state.pointerId) {
          return;
        }
        try {
          state.note.releasePointerCapture(state.pointerId);
        } catch (err) {
          // Ignore errors when releasing pointer capture
        }
        state.note.classList.remove('dragging');
        floatingNoteDragState.note = null;
        floatingNoteDragState.pointerId = null;
      }

      function clearFloatingNotes() {
        if (!floatingNotesLayer) return;
        floatingNotesLayer.innerHTML = '';
        floatingNoteCreationOffset = 0;
        floatingNoteZIndex = 10;
      }

      function clampAllFloatingNotes() {
        if (!floatingNotesLayer) return;
        floatingNotesLayer.querySelectorAll('.floating-note').forEach(note => {
          const left = Number.parseFloat(note.dataset.left || note.style.left || '0');
          const top = Number.parseFloat(note.dataset.top || note.style.top || '0');
          const coords = clampNotePosition(note, left, top);
          note.style.left = `${coords.left}px`;
          note.style.top = `${coords.top}px`;
          note.dataset.left = String(coords.left);
          note.dataset.top = String(coords.top);
        });
      }

      function createFloatingNote(data = {}) {
        if (!floatingNotesLayer) return null;
        const note = document.createElement('div');
        note.className = 'floating-note';

        let noteId = data.id ? String(data.id).trim() : '';
        if (!noteId) {
          noteId = generateUniqueId('floating-note');
        }
        note.dataset.noteId = noteId;

        const styleId = data.style && getFloatingNoteStyle(String(data.style).trim())
          ? String(data.style).trim()
          : 'default';
        applyFloatingNoteStyle(note, styleId);

        const header = document.createElement('div');
        header.className = 'floating-note-header';

        const titleSpan = document.createElement('span');
        titleSpan.className = 'floating-note-title';
        titleSpan.textContent = 'Nota flotante';

        const actions = document.createElement('div');
        actions.className = 'floating-note-actions';

        const styleSelect = document.createElement('select');
        styleSelect.className = 'floating-note-style-select';
        NOTE_STYLE_PRESETS.forEach(preset => {
          const option = document.createElement('option');
          option.value = preset.id;
          option.textContent = preset.name;
          styleSelect.appendChild(option);
        });
        styleSelect.value = styleId;
        styleSelect.addEventListener('change', (event) => {
          applyFloatingNoteStyle(note, event.target.value);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.title = 'Eliminar nota';
        deleteBtn.textContent = '✖️';
        deleteBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          note.remove();
        });

        actions.appendChild(styleSelect);
        actions.appendChild(deleteBtn);

        header.appendChild(titleSpan);
        header.appendChild(actions);

        header.addEventListener('pointerdown', (event) => {
          if (event.button !== 0) return;
          if (event.target.closest('select, button')) return;
          startFloatingNoteDrag(note, event);
        });

        header.addEventListener('dblclick', () => {
          bringNoteToFront(note);
        });

        const body = document.createElement('div');
        body.className = 'floating-note-body';
        body.spellcheck = true;
        body.contentEditable = isEditMode ? 'true' : 'false';
        if (typeof data.html === 'string') {
          body.innerHTML = data.html;
        } else {
          body.innerHTML = '';
        }
        body.addEventListener('focus', () => {
          bringNoteToFront(note);
        });

        note.appendChild(header);
        note.appendChild(body);
        floatingNotesLayer.appendChild(note);

        const parsedLeft = Number.parseFloat(data.left);
        const parsedTop = Number.parseFloat(data.top);
        const defaultOffset = (floatingNoteCreationOffset += 40);
        const fallbackLeft = 40 + (defaultOffset % 120);
        const fallbackTop = 40 + (defaultOffset % 160);
        const initialLeft = Number.isFinite(parsedLeft) ? parsedLeft : fallbackLeft;
        const initialTop = Number.isFinite(parsedTop) ? parsedTop : fallbackTop;

        positionFloatingNote(note, initialLeft, initialTop);
        bringNoteToFront(note);

        if (data.focus !== false && isEditMode) {
          setTimeout(() => body.focus(), 0);
        }

        return note;
      }

      function restoreFloatingNotes(notes = [], hidden = false) {
        clearFloatingNotes();
        if (Array.isArray(notes)) {
          notes.forEach(noteData => {
            if (!noteData || typeof noteData !== 'object') return;
            createFloatingNote({
              id: noteData.id,
              style: noteData.style,
              html: typeof noteData.html === 'string' ? noteData.html : '',
              left: noteData.left,
              top: noteData.top,
              focus: false
            });
          });
        }
        setFloatingNotesVisibility(hidden);
      }

      window.addEventListener('pointermove', handleFloatingNotePointerMove);
      window.addEventListener('pointerup', endFloatingNoteDrag);
      window.addEventListener('pointercancel', endFloatingNoteDrag);
      window.addEventListener('resize', clampAllFloatingNotes);

      refreshToggleNotesButton();

      addFloatingNoteBtn?.addEventListener('click', () => {
        if (!floatingNotesLayer) return;
        if (floatingNotesHidden) {
          setFloatingNotesVisibility(false);
        }
        const note = createFloatingNote({ focus: true });
        if (note && isEditMode) {
          enableHtmlPaste();
        }
      });

      toggleNotesBtn?.addEventListener('click', () => {
        setFloatingNotesVisibility(!floatingNotesHidden);
      });

      imageWidthIncreaseBtn?.addEventListener('click', () => {
        changeSelectedImageWidth(1 + IMAGE_RESIZE_STEP);
      });

      imageWidthDecreaseBtn?.addEventListener('click', () => {
        changeSelectedImageWidth(1 - IMAGE_RESIZE_STEP);
      });

      templateBgColorInput?.addEventListener('input', (e) => {
        applyTemplateBackground(e.target.value || '#ffffff');
      });

      templateClearBgBtn?.addEventListener('click', () => {
        applyTemplateBackground('transparent');
      });

      templateTextColorInput?.addEventListener('input', (e) => {
        applyTemplateTextColor(e.target.value || '#212529');
      });

      templateResetTextColorBtn?.addEventListener('click', () => {
        applyTemplateTextColor('');
      });

      templateBorderColorInput?.addEventListener('input', (e) => {
        applyTemplateBorderColor(e.target.value || '#ced4da');
      });

      templateAccentColorInput?.addEventListener('input', (e) => {
        applyTemplateAccentColor(e.target.value || '#0d6efd');
      });

      templateBorderWidthSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const target = getTemplateTarget(selectedTemplateBlock);
        if (!target || !target.classList.contains('box')) return;
        const width = parseInt(e.target.value, 10) || 0;
        const accentExtra = parseInt(selectedTemplateBlock.dataset.borderAccentExtra || '0', 10) || 0;
        if (width <= 0) {
          target.style.borderWidth = '0';
          target.style.borderStyle = 'none';
          if (accentExtra > 0) {
            target.style.borderLeftStyle = 'solid';
            target.style.borderLeftWidth = accentExtra + 'px';
          } else {
            target.style.borderLeftWidth = '0';
          }
        } else {
          target.style.borderStyle = 'solid';
          target.style.borderWidth = width + 'px';
          target.style.borderLeftWidth = (width + Math.max(0, accentExtra)) + 'px';
        }
        if (templateBorderWidthDisplay) {
          templateBorderWidthDisplay.textContent = width + 'px';
        }
        updateBorderWidthDataset(selectedTemplateBlock, width, Math.max(0, accentExtra));
        markNoteStyleAsCustom(selectedTemplateBlock, target);
        if (templateNoteStyleSelect) {
          templateNoteStyleSelect.value = 'custom';
        }
      });

      templateFontSizeSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const size = parseInt(e.target.value, 10) || 100;
        selectedTemplateBlock.dataset.fontScale = String(size);
        selectedTemplateBlock.style.fontSize = size === 100 ? '' : size + '%';
        if (templateFontSizeDisplay) {
          templateFontSizeDisplay.textContent = size + '%';
        }
        repositionTemplateToolbar();
      });

      templateMarginTopSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const margin = parseInt(e.target.value, 10) || 0;
        selectedTemplateBlock.dataset.marginTop = String(margin);
        selectedTemplateBlock.style.marginTop = margin + 'px';
        if (templateMarginTopDisplay) {
          templateMarginTopDisplay.textContent = margin + 'px';
        }
        repositionTemplateToolbar();
      });

      templateMarginBottomSlider?.addEventListener('input', (e) => {
        if (!selectedTemplateBlock) return;
        const margin = parseInt(e.target.value, 10) || 0;
        selectedTemplateBlock.dataset.marginBottom = String(margin);
        selectedTemplateBlock.style.marginBottom = margin + 'px';
        if (templateMarginBottomDisplay) {
          templateMarginBottomDisplay.textContent = margin + 'px';
        }
        repositionTemplateToolbar();
      });

      templateNoteStyleSelect?.addEventListener('change', (event) => {
        if (!selectedTemplateBlock) return;
        const styleId = event.target.value;
        if (styleId === 'custom') {
          const target = getTemplateTarget(selectedTemplateBlock);
          if (target && target.classList.contains('box')) {
            markNoteStyleAsCustom(selectedTemplateBlock, target);
            updateTemplateToolbarState(selectedTemplateBlock);
          }
          return;
        }
        applyNoteStyle(selectedTemplateBlock, styleId);
      });

      templateAddSpaceTopBtn?.addEventListener('click', () => insertNoteSpacer('before'));
      templateAddSpaceBottomBtn?.addEventListener('click', () => insertNoteSpacer('after'));

      templateDeleteBtn?.addEventListener('click', () => {
        if (!selectedTemplateBlock) return;
        const block = selectedTemplateBlock;
        const range = document.createRange();
        range.setStartAfter(block);
        range.collapse(true);
        block.remove();
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        savedSelection = null;
        hideTemplateToolbar();
      });

      function applyFloatClass(targetClass) {
        if (!selectedImage) return;

        const container = getImageContainer(selectedImage);

        floatClasses.forEach(cls => {
          container.classList.remove(cls);
          if (container !== selectedImage) {
            selectedImage.classList.remove(cls);
          }
        });

        if (targetClass) {
          container.classList.add(targetClass);
        }

        setActiveAlignButton(targetClass || '');
        repositionImageToolbar();
      }

      alignButtons.left?.addEventListener('click', () => {
        applyFloatClass('float-left');
      });

      alignButtons.center?.addEventListener('click', () => {
        applyFloatClass('center-block');
      });

      alignButtons.right?.addEventListener('click', () => {
        applyFloatClass('float-right');
      });

      alignButtons.inline?.addEventListener('click', () => {
        applyFloatClass('inline-image');
      });

      applyAltBtn?.addEventListener('click', () => {
        if (!selectedImage || !imageAltInput) return;
        selectedImage.alt = imageAltInput.value.trim();
        selectedImage.setAttribute('alt', selectedImage.alt);
        imageAltInput.blur();
      });

      imageAltInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          applyAltBtn?.click();
        }
      });

      imageFrameToggle?.addEventListener('change', (e) => {
        if (!selectedImage) return;
        if (e.target.checked) {
          selectedImage.classList.add('image-frame');
        } else {
          selectedImage.classList.remove('image-frame');
        }
        repositionImageToolbar();
      });

      function wrapImageWithFigure() {
        if (!selectedImage || selectedImage.parentElement?.classList.contains('image-figure')) return;

        const container = getImageContainer(selectedImage);
        const existingFloat = floatClasses.find(cls => container.classList.contains(cls));

        const figure = document.createElement('figure');
        figure.classList.add('image-figure');

        if (existingFloat) {
          container.classList.remove(existingFloat);
          figure.classList.add(existingFloat);
        }

        const caption = document.createElement('figcaption');
        caption.contentEditable = 'true';
        caption.spellcheck = true;
        caption.textContent = 'Escribe una descripción';

        const parent = selectedImage.parentElement;
        parent?.insertBefore(figure, selectedImage);
        figure.appendChild(selectedImage);
        figure.appendChild(caption);

        caption.focus();

        if (wrapFigureBtn) wrapFigureBtn.disabled = true;
        if (unwrapFigureBtn) unwrapFigureBtn.disabled = false;

        updateToolbarState(selectedImage);
        updateToolbarPosition(selectedImage);
      }

      function unwrapImageFigure() {
        if (!selectedImage) return;
        const figure = selectedImage.parentElement;
        if (!figure || !figure.classList.contains('image-figure')) return;

        const existingFloat = floatClasses.find(cls => figure.classList.contains(cls));
        const parent = figure.parentElement;
        if (!parent) return;

        parent.insertBefore(selectedImage, figure);
        figure.remove();

        if (existingFloat) {
          selectedImage.classList.add(existingFloat);
        }

        if (wrapFigureBtn) wrapFigureBtn.disabled = false;
        if (unwrapFigureBtn) unwrapFigureBtn.disabled = true;

        updateToolbarState(selectedImage);
        updateToolbarPosition(selectedImage);
      }

      wrapFigureBtn?.addEventListener('click', wrapImageWithFigure);
      unwrapFigureBtn?.addEventListener('click', unwrapImageFigure);

      document.getElementById('deleteImageBtn')?.addEventListener('click', () => {
        if (selectedImage && confirm('¿Eliminar esta imagen?')) {
          selectedImage.remove();
          hideImageToolbar();
        }
      });

      /* === PALETAS DE COLOR MEJORADAS === */
      function createColorPalette(paletteId, isHighlight) {
        const palette = document.getElementById(paletteId);
        if (!palette) return;

        palette.innerHTML = '';
        
        pastelColors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.backgroundColor = color;
          swatch.title = color;
          swatch.addEventListener('click', (e) => {
            e.stopPropagation();
            applyColor(color, isHighlight);
            palette.classList.remove('show');
          });
          palette.appendChild(swatch);
        });
        
        const customSwatch = document.createElement('input');
        customSwatch.type = 'color';
        customSwatch.className = 'color-swatch';
        customSwatch.title = 'Color personalizado';
        customSwatch.style.border = '2px dashed #495057';
        customSwatch.addEventListener('change', (e) => {
          e.stopPropagation();
          applyColor(e.target.value, isHighlight);
          palette.classList.remove('show');
        });
        palette.appendChild(customSwatch);
      }

      function supportsCommand(command) {
        if (typeof document.queryCommandSupported !== 'function') return true;
        try {
          return document.queryCommandSupported(command);
        } catch (e) {
          return false;
        }
      }

      function applyColor(color, isHighlight) {
        if (!restoreSelection()) {
          alert('Por favor, selecciona el texto primero');
          return;
        }

        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) {
          alert('Por favor, selecciona el texto primero');
          savedSelection = null;
          return;
        }

        const styleWithCss = supportsCommand('styleWithCSS');
        if (styleWithCss) {
          document.execCommand('styleWithCSS', false, true);
        }

        let command = 'foreColor';
        if (isHighlight) {
          if (supportsCommand('hiliteColor')) {
            command = 'hiliteColor';
          } else if (supportsCommand('backColor')) {
            command = 'backColor';
          } else {
            command = null;
          }
        }

        let applied = false;
        if (command) {
          applied = document.execCommand(command, false, color);
        }

        if (styleWithCss) {
          document.execCommand('styleWithCSS', false, false);
        }

        if (!applied) {
          const range = selection.getRangeAt(0);
          const wrapper = document.createElement('span');
          if (isHighlight) {
            wrapper.style.backgroundColor = color;
          } else {
            wrapper.style.color = color;
          }
          try {
            range.surroundContents(wrapper);
          } catch (e) {
            const fragment = range.extractContents();
            wrapper.appendChild(fragment);
            range.insertNode(wrapper);
          }
        }

        selection.removeAllRanges();
        savedSelection = null;
      }

      createColorPalette('highlightPalette', true);
      createColorPalette('textColorPalette', false);

      document.getElementById('highlightBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (!saveCurrentSelection()) {
          alert('Por favor, selecciona el texto que deseas destacar');
          return;
        }
        
        const btn = e.currentTarget;
        const btnRect = btn.getBoundingClientRect();
        
        highlightPalette.style.left = btnRect.left + 'px';
        highlightPalette.style.top = (btnRect.bottom + 5) + 'px';
        
        textColorPalette.classList.remove('show');
        highlightPalette.classList.add('show');
      });

      document.getElementById('textColorBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        
        if (!saveCurrentSelection()) {
          alert('Por favor, selecciona el texto al que deseas cambiar el color');
          return;
        }
        
        const btn = e.currentTarget;
        const btnRect = btn.getBoundingClientRect();
        
        textColorPalette.style.left = btnRect.left + 'px';
        textColorPalette.style.top = (btnRect.bottom + 5) + 'px';
        
        highlightPalette.classList.remove('show');
        textColorPalette.classList.add('show');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('#highlightBtn') && !e.target.closest('#highlightPalette')) {
          const wasOpen = highlightPalette.classList.contains('show');
          highlightPalette.classList.remove('show');
          if (wasOpen) {
            savedSelection = null;
          }
        }
        if (!e.target.closest('#textColorBtn') && !e.target.closest('#textColorPalette')) {
          const wasOpen = textColorPalette.classList.contains('show');
          textColorPalette.classList.remove('show');
          if (wasOpen) {
            savedSelection = null;
          }
        }
      });

      /* === PLANTILLAS === */
      insertTemplateBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertTemplateBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      insertHtmlBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertHtmlBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      insertTableBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertTableBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      insertCollapseCardBtn?.addEventListener('pointerdown', () => {
        saveCurrentSelection();
      });

      insertCollapseCardBtn?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          saveCurrentSelection();
        }
      });

      document.getElementById('insertTemplateBtn')?.addEventListener('click', () => {
        if (!savedSelection) {
          const activeEditable = document.activeElement && document.activeElement.isContentEditable ? document.activeElement : null;
          const target = activeEditable || getCurrentPage() || getCurrentMagicPage();
          if (target) {
            const range = document.createRange();
            range.selectNodeContents(target);
            range.collapse(false);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            saveCurrentSelection();
          }
        }

        showModal(`
          <div class="modal-header">
            <h3>Insertar Plantilla</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <p>Selecciona una plantilla para insertar en el documento:</p>
            <div class="template-grid" id="templateGrid"></div>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
          </div>
        `);

        const templates = [
          {
            name: 'Nota Importante',
            html: '<div class="box note-style-rose"><strong>Nota importante:</strong> Escribe tu contenido aquí.</div>',
            noteStyle: 'rose'
          },
          {
            name: 'Perla Clínica',
            html: '<div class="box note-style-pearl">Escribe tu perla clínica aquí.</div>',
            noteStyle: 'pearl'
          },
          {
            name: 'Cuadro Informativo',
            html: '<div class="box note-style-classic"><strong>Título:</strong><p>Contenido del cuadro informativo.</p></div>',
            noteStyle: 'classic'
          },
          {
            name: 'Separador Simple',
            html: '<hr style="border: none; border-top: 1px solid #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Separador Doble',
            html: '<hr style="border: none; border-top: 3px double #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Separador Punteado',
            html: '<hr style="border: none; border-top: 2px dashed #dee2e6; margin: 10px 0;">'
          },
          {
            name: 'Nota de Advertencia',
            html: '<div class="box note-style-sunrise"><strong>⚠️ Advertencia:</strong> Contenido importante de advertencia.</div>',
            noteStyle: 'sunrise'
          },
          {
            name: 'Nota de Éxito',
            html: '<div class="box note-style-forest"><strong>✓ Éxito:</strong> Información positiva o exitosa.</div>',
            noteStyle: 'forest'
          },
          {
            name: 'Lista de Verificación',
            html: '<ul><li>☐ Ítem 1</li><li>☐ Ítem 2</li><li>☐ Ítem 3</li></ul>'
          },
          {
            name: 'Dos Columnas',
            html: '<div class="columns"><div><h3>Columna 1</h3><p>Contenido de la primera columna.</p></div><div><h3>Columna 2</h3><p>Contenido de la segunda columna.</p></div></div>'
          },
          {
            name: 'Cita Destacada',
            html: '<blockquote style="border-left: 4px solid var(--theme-primary); padding-left: 15px; font-style: italic; color: #6c757d; margin: 10px 0;">"Tu cita aquí"</blockquote>'
          },
          {
            name: 'Definición',
            html: '<div class="box note-style-sky"><strong>Definición:</strong> Término a definir - explicación del término.</div>',
            noteStyle: 'sky'
          }
        ];

        const grid = document.getElementById('templateGrid');
        if (grid) {
          grid.innerHTML = '';
        }
        templates.forEach(template => {
          const card = document.createElement('div');
          card.className = 'template-card';
          card.innerHTML = `
            <h4>${template.name}</h4>
            <div class="template-preview">${template.html}</div>
          `;
          card.addEventListener('click', () => {
            const block = createTemplateBlock(template);
            if (!block) return;
            const insertedBlock = insertNodeAtSelection(block);
            if (!insertedBlock) {
              alert('Selecciona un área editable antes de insertar una plantilla.');
              return;
            }

            showTemplateToolbar(insertedBlock);
            insertedBlock.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            hideModal();
          });
          grid?.appendChild(card);
        });
      });

      insertCollapseCardBtn?.addEventListener('click', () => {
        const card = createCollapseCardElement();
        initializeCollapseCards(card);
        const insertedCard = insertNodeAtSelection(card);
        if (!insertedCard) {
          alert('Selecciona un área editable antes de insertar la tarjeta.');
          return;
        }
        const title = insertedCard.querySelector('.collapse-card-title');
        if (title) {
          const range = document.createRange();
          range.selectNodeContents(title);
          range.collapse(true);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
        }
        insertedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });

      /* === PANEL LATERAL === */
      function openPanel() {
        buildSectionsPanel();
        panel.classList.add('open');
        panelBackdrop.classList.add('show');
      }

      function closePanel() {
        panel.classList.remove('open');
        if (!tocPanel.classList.contains('open')) {
          panelBackdrop.classList.remove('show');
        }
        hideTopicMenu();
      }

      const escapeAttr = (value) => {
        if (typeof value !== 'string') return '';
        if (window.CSS && typeof window.CSS.escape === 'function') {
          return window.CSS.escape(value);
        }
        return value.replace(/[^a-zA-Z0-9_\-]/g, (char) => `\\${char}`);
      };

      function magicAnchorFor(page) {
        if (!page) return '';

        const storedAnchor = page.dataset.magicAnchorId?.trim();
        if (storedAnchor) {
          const storedEl = document.getElementById(storedAnchor);
          if (storedEl) {
            if (storedEl.classList.contains('magic-topic')) {
              const tid = (page.dataset.topicId || '').trim();
              if (tid) {
                storedEl.dataset.sourceTopicId = tid;
              }
            }
            return storedAnchor;
          }
          delete page.dataset.magicAnchorId;
        }

        const tid = (page.dataset.topicId || '').trim();
        if (!tid) {
          return '';
        }

        const candidates = [`magic-topic-${tid}`, `magic-${tid}`, tid];
        for (const candidate of candidates) {
          if (!candidate) continue;
          const el = document.getElementById(candidate);
          if (el) {
            if (el.classList.contains('magic-topic')) {
              el.dataset.sourceTopicId = tid;
            }
            page.dataset.magicAnchorId = candidate;
            return candidate;
          }
        }

        const container = document.querySelector('.magic-content-container');
        if (container) {
          const selector = `.magic-topic[data-source-topic-id="${escapeAttr(tid)}"]`;
          const el = container.querySelector(selector);
          if (el && el.id) {
            page.dataset.magicAnchorId = el.id;
            return el.id;
          }
        }

        return '';
      }

      function ensureMagicTopicSource(anchorId, pageRef) {
        let resolvedId = typeof anchorId === 'string' ? anchorId.trim() : '';
        let src = resolvedId ? document.getElementById(resolvedId) : null;

        if (src && !src.classList.contains('magic-topic')) {
          src = null;
        }

        if (!src && pageRef) {
          const container = document.querySelector('.magic-content-container');
          if (container) {
            const topicId = (pageRef.dataset.topicId || '').trim();
            let baseId = resolvedId || (topicId ? `magic-topic-${topicId}` : '');
            if (!baseId) {
              baseId = generateUniqueId('magic-topic');
            }
            let candidateId = baseId;
            while (candidateId && document.getElementById(candidateId)) {
              candidateId = `${baseId}-${Math.random().toString(36).slice(2, 6)}`;
            }
            src = document.createElement('div');
            src.id = candidateId;
            src.className = 'magic-topic';
            if (topicId) {
              src.dataset.sourceTopicId = topicId;
            }
            container.appendChild(src);
            pageRef.dataset.magicAnchorId = candidateId;
            resolvedId = candidateId;
          }
        }

        if (src && !src.id) {
          let baseId = resolvedId || generateUniqueId('magic-topic');
          let uniqueId = baseId;
          while (uniqueId && document.getElementById(uniqueId)) {
            uniqueId = `${baseId}-${Math.random().toString(36).slice(2, 6)}`;
          }
          src.id = uniqueId;
          resolvedId = uniqueId;
          if (pageRef) {
            pageRef.dataset.magicAnchorId = uniqueId;
          }
        }

        return { source: src, anchorId: resolvedId };
      }

      function persistMagicEdits() {
        if (!activeMagicWrapper && !activeMagicSource) {
          return;
        }

        if (activeMagicWrapper && !document.contains(activeMagicWrapper)) {
          activeMagicWrapper = null;
        }

        if (!activeMagicSource && activeMagicWrapper && activeMagicPage) {
          const { source } = ensureMagicTopicSource('', activeMagicPage);
          activeMagicSource = source || null;
        }

        if (activeMagicSource && !document.contains(activeMagicSource)) {
          activeMagicSource = null;
        }

        if (!activeMagicSource || !activeMagicWrapper) {
          return;
        }

        activeMagicSource.innerHTML = activeMagicWrapper.innerHTML;
        afterContentSanitize(activeMagicSource);
      }

      function closeMagicView() {
        persistMagicEdits();
        if (isMagicViewActive) {
          const restoreZoom = zoomBeforeMagic ?? lastRegularZoom ?? 1;
          isMagicViewActive = false;
          zoomBeforeMagic = null;
          applyZoom(restoreZoom);
        }
        document.body.classList.remove('magic-open');
        if (!magic) return;
        magic.classList.remove('open');
        magic.style.removeProperty('--magic-zoom');
        zoomBeforeMagic = null;
        activeMagicSource = null;
        activeMagicWrapper = null;
        activeMagicPage = null;
      }

      function activateMagicTopic(anchorId, title, pageRef = null) {
        if (!magic) return;
        persistMagicEdits();
        if (!isMagicViewActive) {
          zoomBeforeMagic = currentZoom;
        }
        isMagicViewActive = true;
        applyZoom(1, { skipRemember: true });
        magic.innerHTML =
          '<div class="magic-header"><strong>✨ Visor del tema</strong><button class="magic-close">&times;</button></div>';
        const magicPage = document.createElement('div');
        magicPage.className = 'magic-page';

        const h = document.createElement('h1');
        h.className = 'magic-title';
        h.textContent = title || 'Tema';
        magicPage.appendChild(h);

        const { source: src } = ensureMagicTopicSource(anchorId, pageRef);
        const wrapper = document.createElement('div');
        wrapper.innerHTML = src ? src.innerHTML : '<p>No hay contenido adicional.</p>';
        afterContentSanitize(wrapper);

        magicPage.appendChild(wrapper);
        magic.appendChild(magicPage);
        activeMagicSource = src;
        activeMagicWrapper = wrapper;
        activeMagicPage = pageRef || null;

        if (isEditMode) {
          magicPage.contentEditable = 'true';
          enableHtmlPaste();
        }

        magic.querySelector('.magic-close')?.addEventListener('click', () => {
          closeMagicView();
        });
        syncMagicZoom();
        magic.classList.add('open');
        magic.scrollTop = 0;
        document.body.classList.add('magic-open');
      }

      function buildSectionsPanel() {
        if (!sectionsContainer) return;
        sectionsContainer.innerHTML = '';
        globalTopicCounter = 1;
        let totalTopics = 0;
        
        sections.forEach((section, sectionIdx) => {
          const sectionDiv = document.createElement('div');
          sectionDiv.className = 'section-item';
          if (section.collapsed) sectionDiv.classList.add('collapsed');
          
          const sectionHeader = document.createElement('div');
          sectionHeader.className = 'section-header';
          
          const toggle = document.createElement('span');
          toggle.className = 'section-toggle';
          toggle.textContent = '▼';
          toggle.addEventListener('click', () => {
            section.collapsed = !section.collapsed;
            sectionDiv.classList.toggle('collapsed');
          });
          
          const nameSpan = document.createElement('span');
          nameSpan.className = 'section-name';
          nameSpan.textContent = section.nombre;
          nameSpan.addEventListener('click', () => {
            section.collapsed = !section.collapsed;
            sectionDiv.classList.toggle('collapsed');
          });
          
          const countSpan = document.createElement('span');
          countSpan.className = 'section-count';
          countSpan.textContent = `(${section.temas.length})`;
          totalTopics += section.temas.length;
          
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'section-actions';
          
          const printBtn = document.createElement('button');
          printBtn.className = 'section-action-btn';
          printBtn.textContent = '🖨️';
          printBtn.title = 'Imprimir sección';
          printBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            printSection(section);
          });
          
          if (isPanelEditMode) {
            const renameBtn = document.createElement('button');
            renameBtn.className = 'section-action-btn';
            renameBtn.textContent = '✏️';
            renameBtn.title = 'Renombrar';
            renameBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              renameSection(section);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'section-action-btn';
            deleteBtn.textContent = '🗑️';
            deleteBtn.title = 'Eliminar sección';
            deleteBtn.style.color = '#dc3545';
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              deleteSection(section);
            });
            
            actionsDiv.appendChild(renameBtn);
            actionsDiv.appendChild(deleteBtn);
          }
          
          actionsDiv.appendChild(printBtn);
          
          sectionHeader.appendChild(toggle);
          sectionHeader.appendChild(nameSpan);
          sectionHeader.appendChild(countSpan);
          sectionHeader.appendChild(actionsDiv);
          
          const topicList = document.createElement('ol');
          topicList.className = 'topic-list';
          
          section.temas.forEach(tema => {
            const li = document.createElement('li');
            li.dataset.topicId = tema.id;
            
            const numSpan = document.createElement('span');
            numSpan.className = 'topic-number';
            numSpan.textContent = globalTopicCounter + '.';
            globalTopicCounter++;
            
          const btnMain = document.createElement('button');
          btnMain.className = 'topic-action';
          btnMain.title = 'Ir al tema';
          btnMain.textContent = '📄';
          const openTopic = () => {
            if (!tema.page || !tema.page.isConnected) return;
            closeMagicView();
            closePanel();
            closeTocPanel();
            tema.page.scrollIntoView({ behavior: 'smooth', block: 'start' });
          };

          btnMain.addEventListener('click', openTopic);

          const titleSpan = document.createElement('span');
          titleSpan.className = 'topic-title';
          titleSpan.textContent = tema.titulo;
          titleSpan.title = 'Doble clic para opciones del tema';
          titleSpan.addEventListener('dblclick', (event) => {
            event.preventDefault();
            event.stopPropagation();
            showTopicMenu(event, tema);
          });
          titleSpan.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            openTopic();
          });

          li.appendChild(numSpan);
          li.appendChild(btnMain);
          li.appendChild(titleSpan);
          topicList.appendChild(li);
        });
          
          sectionDiv.appendChild(sectionHeader);
          sectionDiv.appendChild(topicList);
          sectionsContainer.appendChild(sectionDiv);
        });

        if (panelTopicCount) {
          const label = totalTopics === 1 ? '1 tema' : `${totalTopics} temas`;
          panelTopicCount.textContent = label;
        }
      }

      function togglePanelEditMode() {
        isPanelEditMode = !isPanelEditMode;
        document.body.classList.toggle('panel-edit-mode', isPanelEditMode);
        editPanelBtn.classList.toggle('active', isPanelEditMode);
        buildSectionsPanel();
      }

      function toggleAllSections() {
        allSectionsExpanded = !allSectionsExpanded;
        sections.forEach(s => s.collapsed = !allSectionsExpanded);
        buildSectionsPanel();
        const btn = document.getElementById('toggleAllBtn');
        btn.textContent = allSectionsExpanded ? '⊟' : '⊞';
      }

      function renameSection(section) {
        const newName = prompt('Nuevo nombre para la sección:', section.nombre);
        if (newName && newName.trim()) {
          section.nombre = newName.trim();
          section.temas.forEach(tema => {
            tema.page.dataset.sectionName = section.nombre;
          });
          if (currentSectionId === section.id) {
            updateSectionIndicator(currentPageRef);
          }
          buildSectionsPanel();
        }
      }

      function deleteSection(section) {
        if (!confirm(`¿Eliminar toda la sección "${section.nombre}" con ${section.temas.length} tema(s)?`)) return;

        section.temas.forEach(tema => {
          tema.page.remove();
        });

        pages = pages.filter(p => p.dataset.sectionId !== section.id);
        sections = sections.filter(s => s.id !== section.id);
        sectionThemes.delete(section.id);
        buildSectionsPanel();
        if (currentPageRef && !document.body.contains(currentPageRef)) {
          setActivePage(getCurrentPage());
        }
      }

      function clearAllContent() {
        if (!confirm('¿Eliminar todas las secciones, temas y contenido adicional? Esta acción no se puede deshacer.')) {
          return;
        }

        closeMagicView();
        hideTopicMenu();
        closePanel();
        closeTocPanel();
        io.disconnect();
        pages.forEach(page => page.remove());
        pages = [];
        sections = [];
        sectionThemes = new Map();
        allSectionsExpanded = true;
        globalTopicCounter = 1;
        currentPageRef = null;
        currentSectionId = '';
        savedSelection = null;
        const magicContainer = document.querySelector('.magic-content-container');
        if (magicContainer) {
          magicContainer.innerHTML = '';
        }
        clearFloatingNotes();
        setFloatingNotesVisibility(false);
        setFloatingNotesEditable(isEditMode);
        buildSectionsPanel();
        buildTableOfContents();
        setActivePage(null);
        syncBodyTheme(DEFAULT_THEME);
        updateSectionIndicator(null);
      }

      function addNewSection() {
        const nombre = prompt('Nombre de la nueva sección:');
        if (!nombre || !nombre.trim()) return;

        const newSection = {
          id: 'seccion-' + Date.now(),
          nombre: nombre.trim(),
          collapsed: false,
          temas: []
        };

        sectionThemes.set(newSection.id, DEFAULT_THEME);
        sections.push(newSection);
        buildSectionsPanel();
      }

      function sortSectionsAlpha() {
        sections.sort((a, b) => a.nombre.localeCompare(b.nombre));
        buildSectionsPanel();
      }

      function sortSectionsNumeric() {
        sections.sort((a, b) => {
          const numA = parseInt(a.nombre.match(/\d+/)?.[0] || '999');
          const numB = parseInt(b.nombre.match(/\d+/)?.[0] || '999');
          return numA - numB;
        });
        buildSectionsPanel();
      }

      function printSection(section) {
        if (!section || !Array.isArray(section.temas)) {
          window.print();
          return;
        }

        const pagesToPrint = section.temas
          .map(topic => topic?.page)
          .filter(page => page && page.isConnected);

        if (!pagesToPrint.length) {
          alert('No hay temas disponibles en esta sección para imprimir.');
          return;
        }

        pages.forEach(page => {
          if (pagesToPrint.includes(page)) {
            page.dataset.printTarget = 'true';
          } else {
            page.dataset.prevDisplay = page.style.display || '';
            page.style.display = 'none';
          }
        });

        document.body.dataset.printingSection = 'true';

        let cleaned = false;
        const cleanup = () => {
          if (cleaned) return;
          cleaned = true;
          delete document.body.dataset.printingSection;
          pages.forEach(page => {
            if (page.dataset.printTarget) {
              delete page.dataset.printTarget;
            }
            if (page.dataset.prevDisplay !== undefined) {
              page.style.display = page.dataset.prevDisplay;
              delete page.dataset.prevDisplay;
            }
          });
          window.removeEventListener('afterprint', cleanup);
        };

        window.addEventListener('afterprint', cleanup);
        window.print();
        setTimeout(cleanup, 1200);
      }

      function printCurrentTopic() {
        window.print();
      }

      editPanelBtn?.addEventListener('click', togglePanelEditMode);
      document.getElementById('addSectionBtn')?.addEventListener('click', addNewSection);
      document.getElementById('toggleAllBtn')?.addEventListener('click', toggleAllSections);
      document.getElementById('sortAlphaBtn')?.addEventListener('click', sortSectionsAlpha);
      document.getElementById('sortNumBtn')?.addEventListener('click', sortSectionsNumeric);
      document.getElementById('printCurrentBtn')?.addEventListener('click', printCurrentTopic);
      clearAllBtn?.addEventListener('click', clearAllContent);

      const io = new IntersectionObserver((entries) => {
        const visible = entries.filter(e => e.isIntersecting).sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
        if (!visible) return;
        const tid = visible.target.dataset.topicId || '';
        sectionsContainer.querySelectorAll('li').forEach(li =>
          li.classList.toggle('active', li.dataset.topicId === tid)
        );
        setActivePage(visible.target);
      }, { root: null, threshold: [0.5, 0.75, 1] });

      pages.forEach(p => io.observe(p));

      plusBtn?.addEventListener('click', () => {
        if (panel.classList.contains('open')) {
          closePanel();
        } else {
          closeTocPanel();
          openPanel();
        }
      });
      panelClose.forEach(btn => btn.addEventListener('click', () => {
        closePanel();
        closeTocPanel();
      }));
      panelBackdrop?.addEventListener('click', () => {
        closePanel();
        closeTocPanel();
      });
      
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          closePanel();
          closeTocPanel();
          hideModal();
          hideImageToolbar();
          hideTemplateToolbar();
          closeMagicView();
          closeImageCropModal();
          highlightPalette.classList.remove('show');
          textColorPalette.classList.remove('show');
          savedSelection = null;
        }
      });

      /* === TEMA DE COLORES === */
      themeSelect?.addEventListener('change', () => {
        const targetSection = currentSectionId || (getCurrentPage()?.dataset.sectionId) || 'seccion-default';
        setSectionTheme(targetSection, themeSelect.value);
      });

      /* === EDICIÓN === */
      function toggleEditMode() {
        if (isEditMode) {
          persistMagicEdits();
        }
        isEditMode = !isEditMode;
        hideTopicMenu();

        if (isEditMode) {
          pages.forEach(page => page.contentEditable = 'true');
          const magicPage = getCurrentMagicPage();
          if (magicPage) magicPage.contentEditable = 'true';
          setFloatingNotesEditable(true);
          editToolbar.classList.add('show');
          editBtn.classList.add('active');
          editBtn.textContent = '✏️';
          saveHtmlBtn.style.display = 'inline-block';
          enableHtmlPaste();
          tableMenuAPI?.refresh();
        } else {
          pages.forEach(page => page.contentEditable = 'false');
          const magicPages = document.querySelectorAll('.magic-page');
          magicPages.forEach(mp => mp.contentEditable = 'false');
          setFloatingNotesEditable(false);
          editToolbar.classList.remove('show');
          editBtn.classList.remove('active');
          editBtn.textContent = '✏️';
          saveHtmlBtn.style.display = 'none';
          hideTemplateToolbar();
          hideImageToolbar();
          tableMenuAPI?.cancelResize();
          tableMenuAPI?.hide();
        }
      }
      
      function execCmd(command, value = null) {
        document.execCommand(command, false, value);
      }
      
      editBtn?.addEventListener('click', toggleEditMode);
      
      document.getElementById('undoBtn')?.addEventListener('click', () => execCmd('undo'));
      document.getElementById('redoBtn')?.addEventListener('click', () => execCmd('redo'));
      
      document.getElementById('fontSizeSelect')?.addEventListener('change', function() {
        if (this.value) {
          execCmd('fontSize', this.value);
          this.value = '';
        }
      });
      
      document.getElementById('boldBtn')?.addEventListener('click', () => execCmd('bold'));
      document.getElementById('italicBtn')?.addEventListener('click', () => execCmd('italic'));
      document.getElementById('underlineBtn')?.addEventListener('click', () => execCmd('underline'));
      document.getElementById('removeFormatBtn')?.addEventListener('click', () => execCmd('removeFormat'));
      document.getElementById('insertUlBtn')?.addEventListener('click', () => execCmd('insertUnorderedList'));
      document.getElementById('insertOlBtn')?.addEventListener('click', () => execCmd('insertOrderedList'));
      document.getElementById('indentBtn')?.addEventListener('click', () => execCmd('indent'));
      document.getElementById('outdentBtn')?.addEventListener('click', () => execCmd('outdent'));

      /* === INSERTAR HTML PERSONALIZADO === */
      document.getElementById('insertHtmlBtn')?.addEventListener('click', () => {
        showModal(`
          <div class="modal-header">
            <h3>Insertar HTML Personalizado</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <p>Escribe el código HTML que deseas insertar en la posición del cursor:</p>
            <textarea id="customHtmlInput" class="modal-textarea" placeholder="<div>Tu código HTML aquí...</div>"></textarea>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cancelar</button>
            <button class="modal-btn primary" id="insertCustomHtmlBtn">Insertar</button>
          </div>
        `);

        setTimeout(() => {
          document.getElementById('insertCustomHtmlBtn')?.addEventListener('click', () => {
            const htmlCode = document.getElementById('customHtmlInput').value;
            if (htmlCode.trim()) {
              const insertedNode = insertHtmlAtSelection(htmlCode);
              if (insertedNode) {
                hideModal();
              } else {
                alert('Selecciona un área editable antes de insertar HTML.');
              }
            } else {
              alert('Por favor ingresa código HTML válido');
            }
          });
        }, 100);
      });

      /* === COPIAR HTML DE SELECCIÓN === */
      document.getElementById('copyHtmlSelectionBtn')?.addEventListener('click', async () => {
        const selection = window.getSelection();
        if (!selection.rangeCount) {
          alert('Primero selecciona el texto del que quieres copiar el HTML');
          return;
        }

        const range = selection.getRangeAt(0);
        const container = document.createElement('div');
        container.appendChild(range.cloneContents());
        const html = container.innerHTML;

        if (!html) {
          alert('No hay contenido HTML en la selección');
          return;
        }

        try {
          await navigator.clipboard.writeText(html);
          showModal(`
            <div class="modal-header">
              <h3>HTML Copiado</h3>
              <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
            </div>
            <div class="modal-body">
              <p>El código HTML ha sido copiado al portapapeles.</p>
              <textarea class="modal-textarea" readonly>${html.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
            </div>
            <div class="modal-footer">
              <button class="modal-btn primary" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
            </div>
          `);
        } catch (e) {
          alert('Error al copiar: ' + e.message);
        }
      });

      /* === INSERTAR TABLA === */
      document.getElementById('insertTableBtn')?.addEventListener('click', () => {
        showModal(`
          <div class="modal-header">
            <h3>Insertar Tabla</h3>
            <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
          </div>
          <div class="modal-body">
            <label>Filas: <input type="number" id="tableRows" class="modal-input" value="3" min="1" max="20">
</label>
            <label>Columnas: <input type="number" id="tableCols" class="modal-input" value="3" min="1" max="10"></label>
          </div>
          <div class="modal-footer">
            <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cancelar</button>
            <button class="modal-btn primary" id="insertTableConfirm">Insertar</button>
          </div>
        `);
    setTimeout(() => {
      document.getElementById('insertTableConfirm')?.addEventListener('click', () => {
        const rows = parseInt(document.getElementById('tableRows').value) || 3;
        const cols = parseInt(document.getElementById('tableCols').value) || 3;
        
        let tableHTML = '<div class="table-wrap"><table><thead><tr>';
        for (let i = 0; i < cols; i++) {
          tableHTML += `<th>Encabezado ${i + 1}</th>`;
        }
        tableHTML += '</tr></thead><tbody>';
        
        for (let i = 0; i < rows; i++) {
          tableHTML += '<tr>';
          for (let j = 0; j < cols; j++) {
            tableHTML += '<td>Celda</td>';
          }
          tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table></div>';

        const insertedNode = insertHtmlAtSelection(tableHTML);
        if (insertedNode) {
          hideModal();
        } else {
          alert('Selecciona un área editable antes de insertar una tabla.');
        }
      });
    }, 100);
  });

  /* === BUSCAR Y REEMPLAZAR === */
  document.getElementById('findReplaceBtn')?.addEventListener('click', () => {
    showModal(`
      <div class="modal-header">
        <h3>Buscar y Reemplazar</h3>
        <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <label>Buscar: <input type="text" id="findText" class="modal-input" placeholder="Texto a buscar"></label>
        <label>Reemplazar con: <input type="text" id="replaceText" class="modal-input" placeholder="Texto de reemplazo"></label>
        <p id="findReplaceStatus" style="margin-top: 10px; color: #6c757d;"></p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
        <button class="modal-btn primary" id="replaceAllBtn">Reemplazar Todo</button>
      </div>
    `);

    setTimeout(() => {
      document.getElementById('replaceAllBtn')?.addEventListener('click', () => {
        const findText = document.getElementById('findText').value;
        const replaceText = document.getElementById('replaceText').value;
        const status = document.getElementById('findReplaceStatus');
        
        if (!findText) {
          status.textContent = 'Por favor ingresa el texto a buscar';
          return;
        }

        let count = 0;
        const currentPage = getCurrentPage() || getCurrentMagicPage();
        if (currentPage) {
          const html = currentPage.innerHTML;
          const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
          const newHtml = html.replace(regex, (match) => {
            count++;
            return replaceText;
          });
          currentPage.innerHTML = newHtml;
        }

        status.textContent = `Se reemplazaron ${count} coincidencia(s)`;
      });
    }, 100);
  });

  /* === DUPLICAR TEMA === */
  document.getElementById('duplicateTopicBtn')?.addEventListener('click', () => {
    const currentPage = getCurrentPage();
    if (!currentPage) return;
    duplicateTopicPage(currentPage);
  });

  /* === EXPORTAR TEMA === */
  function exportSingleTopic(page) {
    const h1 = page.querySelector('h1');
    const titleSpan = h1?.querySelector('span:first-child');
    const title = (titleSpan?.textContent || h1?.textContent || 'tema').trim();
    const magicId = magicAnchorFor(page);
    const magicContent = document.getElementById(magicId);
    
    const tempPage = page.cloneNode(true);
    tempPage.contentEditable = 'false';

    const currentTheme = document.body.className.split(' ').find(c => c.startsWith('theme-')) || 'theme-blue';

    const htmlDoc = `<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
${document.querySelector('style').textContent}
  </style>
</head>
<body class="${currentTheme}">
  ${magicContent ? '<div class="magic-content-container" style="display:none">' + magicContent.outerHTML + '</div>' : ''}
  ${tempPage.outerHTML}
</body>
</html>`;
    const blob = new Blob([htmlDoc], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.toLowerCase().replace(/\s+/g, '-')}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.getElementById('exportTopicBtn')?.addEventListener('click', () => {
    const currentPage = getCurrentPage();
    if (currentPage) {
      exportSingleTopic(currentPage);
    }
  });

  /* === ESTADÍSTICAS === */
  statsBtn?.addEventListener('click', () => {
    const totalPages = pages.length;
    const totalWords = pages.reduce((sum, p) => sum + countWords(p.innerHTML), 0);
    const avgWords = Math.round(totalWords / totalPages);
    const minWords = Math.min(...pages.map(p => countWords(p.innerHTML)));
    const maxWords = Math.max(...pages.map(p => countWords(p.innerHTML)));

    showModal(`
      <div class="modal-header">
        <h3>Estadísticas del Documento</h3>
        <button class="modal-close" onclick="document.getElementById('modalOverlay').classList.remove('show')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total de Temas</div>
            <div class="stat-value">${totalPages}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total de Palabras</div>
            <div class="stat-value">${totalWords.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Promedio por Tema</div>
            <div class="stat-value">${avgWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Mínimo</div>
            <div class="stat-value">${minWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Máximo</div>
            <div class="stat-value">${maxWords}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Secciones</div>
            <div class="stat-value">${sections.length}</div>
          </div>
        </div>
        <h4 style="margin-top: 20px;">Detalle por Tema:</h4>
        <div style="max-height: 300px; overflow-y: auto;">
          ${pages.map((p, i) => {
            const h1 = p.querySelector('h1');
            const titleSpan = h1?.querySelector('span:first-child');
            const title = (titleSpan?.textContent || h1?.textContent || `Tema ${i+1}`).trim();
            const words = countWords(p.innerHTML);
            const percentage = Math.round((words / totalWords) * 100);
            return `
              <div style="margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                <strong>${title}</strong>: ${words} palabras (${percentage}%)
                <div style="background: #dee2e6; height: 4px; border-radius: 2px; margin-top: 4px;">
                  <div style="background: var(--theme-primary); height: 100%; width: ${percentage}%; border-radius: 2px;"></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn primary" onclick="document.getElementById('modalOverlay').classList.remove('show')">Cerrar</button>
      </div>
    `);
  });
  
  document.addEventListener('keydown', (e) => {
    if (!isEditMode) return;

    if (e.ctrlKey || e.metaKey) {
      switch(e.key.toLowerCase()) {
        case 'b':
          e.preventDefault();
          execCmd('bold');
          break;
        case 'i':
          e.preventDefault();
          execCmd('italic');
          break;
        case 'u':
          e.preventDefault();
          execCmd('underline');
          break;
        case 'z':
          if (e.shiftKey) {
            e.preventDefault();
            execCmd('redo');
          } else {
            e.preventDefault();
            execCmd('undo');
          }
          break;
        case 'y':
          e.preventDefault();
          execCmd('redo');
          break;
      }
    }
  });

  /* === IMPORTAR / EXPORTAR SECCIONES === */
  function generateUniqueId(prefix) {
    return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
  }

  function collectDocumentData() {
    persistMagicEdits();
    const magicContainer = document.querySelector('.magic-content-container');
    const sectionMap = new Map();
    const seenPages = new Set();
    const exportedSections = [];
    const exportedMagicTopics = [];
    const exportedNotes = [];

    if (magicContainer) {
      magicContainer.querySelectorAll('.magic-topic').forEach(topic => {
        let topicId = (topic.id || '').trim();
        if (!topicId) {
          topicId = generateUniqueId('magic-topic');
          topic.id = topicId;
        }
        const sourceTopicId = (topic.dataset.sourceTopicId || '').trim();
        if (sourceTopicId) {
          topic.dataset.sourceTopicId = sourceTopicId;
        }
        exportedMagicTopics.push({
          id: topicId,
          html: topic.innerHTML,
          sourceTopicId: sourceTopicId || null
        });
      });
    }

    sections.forEach(section => {
      const baseSectionId = section.id || section.temas.find(t => t.page)?.page?.dataset.sectionId || generateUniqueId('seccion');
      const baseSectionName = section.nombre || section.temas.find(t => t.page)?.page?.dataset.sectionName || 'Sección';
      const sectionTheme = sectionThemes.get(baseSectionId) || section.theme || DEFAULT_THEME;
      const exportSection = {
        id: baseSectionId,
        nombre: baseSectionName,
        collapsed: !!section.collapsed,
        theme: sectionTheme,
        temas: []
      };

      sectionMap.set(baseSectionId, exportSection);
      exportedSections.push(exportSection);

      section.temas.forEach(tema => {
        const page = tema.page || pages.find(p => p.dataset.topicId === tema.id);
        if (!page) return;

        seenPages.add(page);
        page.dataset.sectionId = baseSectionId;
        if (!page.dataset.sectionName) {
          page.dataset.sectionName = baseSectionName;
        }

        let topicId = page.dataset.topicId || tema.id;
        if (!topicId) {
          topicId = generateUniqueId('topic');
          page.dataset.topicId = topicId;
        }

        const titleText = (tema.titulo || getTopicTitle(page) || '').trim() || `Tema ${exportSection.temas.length + 1}`;
        const magicId = magicAnchorFor(page);
        const magicEl = magicId ? document.getElementById(magicId) : null;
        if (magicEl && topicId) {
          magicEl.dataset.sourceTopicId = topicId;
        }

        const templateBlocks = serializeTemplateBlocks(page);
        const topicExport = {
          id: topicId,
          titulo: titleText,
          html: page.innerHTML,
          sectionId: page.dataset.sectionId,
          sectionName: page.dataset.sectionName,
          magicId: magicId || null,
          magicHtml: magicEl ? magicEl.innerHTML : null,
          theme: getPageTheme(page)
        };
        if (templateBlocks.length) {
          topicExport.templateBlocks = templateBlocks;
        }

        exportSection.temas.push(topicExport);
      });
    });

    pages.forEach(page => {
      if (seenPages.has(page)) return;

      const sectionId = page.dataset.sectionId || generateUniqueId('seccion');
      const sectionName = page.dataset.sectionName || 'Sección';
      let exportSection = sectionMap.get(sectionId);
      if (!exportSection) {
        const fallbackTheme = sectionThemes.get(sectionId) || getPageTheme(page);
        exportSection = {
          id: sectionId,
          nombre: sectionName,
          collapsed: false,
          theme: fallbackTheme,
          temas: []
        };
        sectionMap.set(sectionId, exportSection);
        exportedSections.push(exportSection);
      }

      let topicId = page.dataset.topicId;
      if (!topicId) {
        topicId = generateUniqueId('topic');
        page.dataset.topicId = topicId;
      }

      const magicId = magicAnchorFor(page);
      const magicEl = magicId ? document.getElementById(magicId) : null;
      if (magicEl && topicId) {
        magicEl.dataset.sourceTopicId = topicId;
      }

      const templateBlocks = serializeTemplateBlocks(page);
      const topicExport = {
        id: topicId,
        titulo: getTopicTitle(page) || `Tema ${exportSection.temas.length + 1}`,
        html: page.innerHTML,
        sectionId: sectionId,
        sectionName: sectionName,
        magicId: magicId || null,
        magicHtml: magicEl ? magicEl.innerHTML : null,
        theme: getPageTheme(page)
      };
      if (templateBlocks.length) {
        topicExport.templateBlocks = templateBlocks;
      }

      exportSection.temas.push(topicExport);
    });

    if (floatingNotesLayer) {
      floatingNotesLayer.querySelectorAll('.floating-note').forEach(note => {
        if (!note) return;
        let noteId = (note.dataset.noteId || '').trim();
        if (!noteId) {
          noteId = generateUniqueId('floating-note');
          note.dataset.noteId = noteId;
        }
        const body = note.querySelector('.floating-note-body');
        const left = Number.parseFloat(note.dataset.left || note.style.left || '0');
        const top = Number.parseFloat(note.dataset.top || note.style.top || '0');
        exportedNotes.push({
          id: noteId,
          html: body ? body.innerHTML : '',
          style: note.dataset.style || 'default',
          left: Number.isFinite(left) ? left : 0,
          top: Number.isFinite(top) ? top : 0
        });
      });
    }

    return {
      specialty: getDocumentTitle() || '',
      sections: exportedSections,
      magicContainerHtml: magicContainer ? magicContainer.innerHTML : '',
      magicTopics: exportedMagicTopics,
      floatingNotes: exportedNotes,
      notesHidden: floatingNotesHidden
    };
  }

  function saveToLocalCache(showFeedback = true) {
    try {
      if (!window.localStorage) {
        throw new Error('Almacenamiento local no disponible');
      }

      const snapshot = {
        version: 1,
        savedAt: new Date().toISOString(),
        zoom: isMagicViewActive ? lastRegularZoom : currentZoom,
        data: collectDocumentData()
      };

      window.localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(snapshot));

      if (showFeedback && cacheSaveBtn) {
        const oldHtml = cacheSaveBtn.innerHTML;
        cacheSaveBtn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Guardado</span>';
        setTimeout(() => {
          cacheSaveBtn.innerHTML = oldHtml;
        }, 2000);
      }

      return true;
    } catch (error) {
      console.error('Error al guardar en caché:', error);
      if (showFeedback) {
        alert('No se pudo guardar en caché: ' + error.message);
      }
      return false;
    }
  }

  function restoreFromLocalCache() {
    try {
      if (!window.localStorage) {
        return false;
      }

      const raw = window.localStorage.getItem(CACHE_STORAGE_KEY);
      if (!raw) {
        return false;
      }

      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== 'object') {
        return false;
      }

      let restored = false;

      if (parsed.data) {
        importSectionsData(parsed.data);
        restored = true;
      }

      if (typeof parsed.zoom === 'number') {
        applyZoom(parsed.zoom);
      } else {
        applyZoom(currentZoom);
      }

      return restored;
    } catch (error) {
      console.error('Error al restaurar desde caché:', error);
      return false;
    }
  }

  function downloadJsonFile(data, filename) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importSectionsData(data) {
    if (!data || !Array.isArray(data.sections)) {
      throw new Error('El archivo no contiene secciones válidas.');
    }

    const mainContainer = document.body;
    const scriptTag = document.querySelector('script');
    if (!scriptTag) {
      throw new Error('No se encontró el contenedor principal.');
    }

    io.disconnect();
    pages.forEach(page => page.remove());

    if (specialtySpan && typeof data.specialty === 'string') {
      setDocumentTitle(data.specialty);
    }

    sectionThemes = new Map();

    const magicContainer = document.querySelector('.magic-content-container');
    const magicTopicMap = new Map();
    const magicTopicBySource = new Map();
    if (magicContainer) {
      magicContainer.innerHTML = '';
      if (Array.isArray(data.magicTopics) && data.magicTopics.length) {
        data.magicTopics.forEach(topicInfo => {
          let topicId = topicInfo?.id ? String(topicInfo.id).trim() : '';
          if (!topicId) {
            topicId = generateUniqueId('magic-topic');
          }
          const sourceTopicId = topicInfo?.sourceTopicId ? String(topicInfo.sourceTopicId).trim() : '';
          const magicTopic = document.createElement('div');
          magicTopic.id = topicId;
          magicTopic.className = 'magic-topic';
          magicTopic.innerHTML = typeof topicInfo?.html === 'string' ? topicInfo.html : '';
          magicContainer.appendChild(magicTopic);
          afterContentSanitize(magicTopic);
          magicTopicMap.set(topicId, magicTopic);
          if (sourceTopicId) {
            magicTopic.dataset.sourceTopicId = sourceTopicId;
            magicTopicBySource.set(sourceTopicId, magicTopic);
          }
        });
      } else if (typeof data.magicContainerHtml === 'string') {
        magicContainer.innerHTML = data.magicContainerHtml;
        magicContainer.querySelectorAll('.magic-topic').forEach(topic => {
          afterContentSanitize(topic);
          if (topic.id) {
            const trimmedId = topic.id.trim();
            if (trimmedId && trimmedId !== topic.id) {
              topic.id = trimmedId;
            }
            if (trimmedId) {
              magicTopicMap.set(trimmedId, topic);
            }
          }
          const sourceTopicId = (topic.dataset.sourceTopicId || '').trim();
          if (sourceTopicId) {
            topic.dataset.sourceTopicId = sourceTopicId;
            magicTopicBySource.set(sourceTopicId, topic);
          }
        });
      }
    }

    const newPages = [];
    const newSections = [];

    data.sections.forEach(sectionData => {
      const sectionId = sectionData?.id ? String(sectionData.id) : generateUniqueId('seccion');
      const sectionName = sectionData?.nombre ? String(sectionData.nombre) : 'Sección';
      const sectionCollapsed = !!sectionData?.collapsed;
      const sectionTheme = AVAILABLE_THEMES.includes(sectionData?.theme) ? sectionData.theme : DEFAULT_THEME;
      sectionThemes.set(sectionId, sectionTheme);
      const sectionInfo = { id: sectionId, nombre: sectionName, collapsed: sectionCollapsed, temas: [], theme: sectionTheme };
      const topics = Array.isArray(sectionData?.temas) ? sectionData.temas : [];

      topics.forEach(topicData => {
        let topicId = topicData?.id ? String(topicData.id) : generateUniqueId('topic');
        topicId = topicId.trim();
        const topicSectionName = topicData?.sectionName ? String(topicData.sectionName) : sectionName;
        const page = document.createElement('section');
        page.className = 'page';
        page.dataset.sectionId = sectionId;
        page.dataset.sectionName = topicSectionName;
        page.dataset.topicId = topicId;
        page.innerHTML = typeof topicData?.html === 'string' ? topicData.html : '';
        mainContainer.insertBefore(page, scriptTag);
        afterContentSanitize(page);
        if (Array.isArray(topicData?.templateBlocks)) {
          restoreTemplateBlocks(page, topicData.templateBlocks);
        }
        page.contentEditable = isEditMode ? 'true' : 'false';
        const pageTheme = AVAILABLE_THEMES.includes(topicData?.theme) ? topicData.theme : sectionTheme;
        applyThemeToPage(page, pageTheme);

        const title = (topicData?.titulo && String(topicData.titulo).trim()) || getTopicTitle(page) || `Tema ${sectionInfo.temas.length + 1}`;
        sectionInfo.temas.push({ id: topicId, titulo: title, page });
        newPages.push(page);

        let resolvedMagicId = '';
        if (magicContainer) {
          const desiredMagicId = topicData?.magicId ? String(topicData.magicId).trim() : '';
          let magicTopic = desiredMagicId ? magicTopicMap.get(desiredMagicId) : null;

          if (!magicTopic && desiredMagicId) {
            const existing = document.getElementById(desiredMagicId);
            if (existing && existing.classList.contains('magic-topic')) {
              magicTopic = existing;
              magicTopicMap.set(desiredMagicId, magicTopic);
            }
          }

          if (!magicTopic) {
            magicTopic = magicTopicBySource.get(topicId);
          }

          if (!magicTopic && typeof topicData?.magicHtml === 'string') {
            let baseId = desiredMagicId || `magic-topic-${topicId}`;
            baseId = baseId.trim();
            if (!baseId) {
              baseId = generateUniqueId('magic-topic');
            }
            let uniqueId = baseId;
            while (uniqueId && (magicTopicMap.has(uniqueId) || document.getElementById(uniqueId))) {
              uniqueId = `${baseId}-${Math.random().toString(36).slice(2, 6)}`;
            }
            magicTopic = document.createElement('div');
            magicTopic.id = uniqueId;
            magicTopic.className = 'magic-topic';
            magicContainer.appendChild(magicTopic);
            magicTopicMap.set(uniqueId, magicTopic);
          }

          if (magicTopic) {
            if (!magicTopic.id) {
              let fallbackId = desiredMagicId || `magic-topic-${topicId || generateUniqueId('magic-topic')}`;
              fallbackId = (fallbackId || '').trim();
              if (!fallbackId) {
                fallbackId = generateUniqueId('magic-topic');
              }
              let finalId = fallbackId;
              while (finalId && (magicTopicMap.has(finalId) || document.getElementById(finalId))) {
                finalId = `${fallbackId}-${Math.random().toString(36).slice(2, 6)}`;
              }
              magicTopic.id = finalId;
            }
            if (typeof topicData.magicHtml === 'string') {
              magicTopic.innerHTML = topicData.magicHtml;
              afterContentSanitize(magicTopic);
            }
            if (topicId) {
              magicTopic.dataset.sourceTopicId = topicId;
              magicTopicBySource.set(topicId, magicTopic);
            }
            if (!magicTopicMap.has(magicTopic.id)) {
              magicTopicMap.set(magicTopic.id, magicTopic);
            }
            resolvedMagicId = magicTopic.id;
          }
        }

        if (resolvedMagicId) {
          page.dataset.magicAnchorId = resolvedMagicId;
        } else if (topicData?.magicId) {
          const fallbackMagicId = String(topicData.magicId).trim();
          if (fallbackMagicId) {
            page.dataset.magicAnchorId = fallbackMagicId;
          } else {
            delete page.dataset.magicAnchorId;
          }
        } else {
          delete page.dataset.magicAnchorId;
        }
      });

      newSections.push(sectionInfo);
    });

    pages = newPages;
    sections = newSections;
    allSectionsExpanded = sections.every(section => !section.collapsed);
    globalTopicCounter = 1;

    restoreFloatingNotes(Array.isArray(data.floatingNotes) ? data.floatingNotes : [], !!data.notesHidden);
    setFloatingNotesEditable(isEditMode);

    pages.forEach(page => io.observe(page));
    setupMagicIcons();
    initializeSections();
    buildSectionsPanel();
    buildTableOfContents();
    if (isEditMode) {
      enableHtmlPaste();
    }
    hideImageToolbar();
    hideTemplateToolbar();
    savedSelection = null;
    const firstPage = pages[0] || null;
    setActivePage(firstPage || null);
    window.scrollTo({ top: 0 });
  }

  exportDataBtn?.addEventListener('click', () => {
    try {
      const data = collectDocumentData();
      const specialtySlug = (data.specialty || 'documento').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '');
      const timestamp = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
      const filename = `${specialtySlug || 'documento'}-secciones-${timestamp}.json`;
      downloadJsonFile(data, filename);
      const btn = exportDataBtn;
      if (btn) {
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Exportado</span>';
        setTimeout(() => {
          btn.innerHTML = oldHtml;
        }, 2000);
      }
    } catch (error) {
      console.error('Error al exportar datos:', error);
      alert('No se pudo exportar el contenido: ' + error.message);
    }
  });

  importDataBtn?.addEventListener('click', () => {
    importDataInput?.click();
  });

  importDataInput?.addEventListener('change', async (event) => {
    const file = event.target.files && event.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const data = JSON.parse(text);
      importSectionsData(data);
      if (importDataBtn) {
        const oldHtml = importDataBtn.innerHTML;
        importDataBtn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Importado</span>';
        setTimeout(() => {
          importDataBtn.innerHTML = oldHtml;
        }, 2000);
      }
    } catch (error) {
      console.error('Error al importar datos:', error);
      alert('Error al importar datos: ' + error.message);
    } finally {
      event.target.value = '';
    }
  });

  /* === GUARDAR HTML === */
  saveHtmlBtn?.addEventListener('click', () => {
    persistMagicEdits();
    const wasEditing = isEditMode;
    if (wasEditing) {
      pages.forEach(page => page.contentEditable = 'false');
    }
    
    const toolbarWasVisible = editToolbar.classList.contains('show');
    if (toolbarWasVisible) {
      editToolbar.classList.remove('show');
    }

    const buildData = {
      especialidad: getDocumentTitle() || 'documento',
      secciones: sections.map(sec => ({
        id: sec.id,
        nombre: sec.nombre,
        theme: sectionThemes.get(sec.id) || sec.theme || DEFAULT_THEME,
        temas: sec.temas.map(t => ({
          id: t.id,
          titulo: t.titulo
        }))
      }))
    };
    
    const doctype = '<!DOCTYPE html>\n';
    let html = document.documentElement.outerHTML;
    
    const buildComment = `<!-- build:topics ${JSON.stringify(buildData)} -->`;
    html = html.replace(/<!-- build:topics.*?-->/s, buildComment);
    
    const fullHtml = doctype + html;
    
    if (toolbarWasVisible) {
      editToolbar.classList.add('show');
    }
    
    const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    
    const specialty = getDocumentTitle() || 'documento';
    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const filename = `${specialty.toLowerCase().replace(/\s+/g, '-')}-${timestamp}.html`;
    a.download = filename;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    if (wasEditing) {
      pages.forEach(page => page.contentEditable = 'true');
    }
    
    const btn = saveHtmlBtn;
    const oldText = btn.textContent;
    btn.textContent = '✅ Guardado';
    setTimeout(() => btn.textContent = oldText, 2000);
  });

  function importHtmlFile(file, existingTopicIds) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const htmlText = event.target.result;
          const parser = new DOMParser();
          const loadedDoc = parser.parseFromString(htmlText, 'text/html');

          let hasNewStructure = false;
          let importedSectionId = null;
          let importedSectionName = 'Importado';

          try {
            const buildMatch = htmlText.match(/build:topics\s({.*?})/s);
            if (buildMatch) {
              const buildData = JSON.parse(buildMatch[1]);
              if (buildData.secciones && buildData.secciones.length > 0) {
                hasNewStructure = true;
                importedSectionId = buildData.secciones[0].id;
                importedSectionName = buildData.secciones[0].nombre;
              }
            }
          } catch (error) {
            console.log('Archivo sin estructura de secciones');
          }

          const loadedSpecialty = loadedDoc.getElementById('specialtyTitle');
          if (loadedSpecialty && specialtySpan && loadedSpecialty.textContent.trim()) {
            setDocumentTitle(loadedSpecialty.textContent.trim());
          }

          const mainContainer = document.querySelector('body');
          const scriptTag = mainContainer.querySelector('script');
          const loadedPages = loadedDoc.querySelectorAll('.page');

          if (loadedPages.length === 0) {
            throw new Error(`No se encontraron secciones de contenido en ${file.name}`);
          }

          if (!hasNewStructure) {
            importedSectionId = 'seccion-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
            importedSectionName = file.name.replace(/\.html$/i, '');
          }

          loadedPages.forEach(page => {
            const clonedPage = page.cloneNode(true);
            afterContentSanitize(clonedPage);

            if (!clonedPage.dataset.sectionId) {
              clonedPage.dataset.sectionId = importedSectionId;
            }
            if (!clonedPage.dataset.sectionName) {
              clonedPage.dataset.sectionName = importedSectionName;
            }

            let topicId = clonedPage.dataset.topicId;
            if (!topicId) {
              topicId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
              clonedPage.dataset.topicId = topicId;
            } else if (existingTopicIds.has(topicId)) {
              const newId = topicId + '-' + Math.random().toString(36).substr(2, 4);
              clonedPage.dataset.topicId = newId;
              topicId = newId;
            }
            existingTopicIds.add(topicId);

            clonedPage.contentEditable = isEditMode ? 'true' : 'false';
            mainContainer.insertBefore(clonedPage, scriptTag);
          });

          const magicContainer = document.querySelector('.magic-content-container');
          if (magicContainer) {
            const loadedMagicContainer = loadedDoc.querySelector('.magic-content-container');
            if (loadedMagicContainer) {
              loadedMagicContainer.querySelectorAll('.magic-topic').forEach(topic => {
                const clonedTopic = topic.cloneNode(true);
                afterContentSanitize(clonedTopic);
                const sourceTopicId = (clonedTopic.dataset.sourceTopicId || '').trim();
                if (sourceTopicId) {
                  clonedTopic.dataset.sourceTopicId = sourceTopicId;
                } else {
                  delete clonedTopic.dataset.sourceTopicId;
                }
                magicContainer.appendChild(clonedTopic);
              });
            }
          }

          resolve();
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = () => reject(reader.error || new Error('No se pudo leer el archivo'));
      reader.readAsText(file);
    });
  }

  /* === CARGAR HTML === */
  loadHtmlBtn?.addEventListener('click', () => {
    loadHtmlInput.click();
  });

  loadHtmlInput?.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;

    const htmlFiles = files.filter(file => file.name.toLowerCase().endsWith('.html'));
    const ignoredFiles = files.filter(file => !file.name.toLowerCase().endsWith('.html'));

    if (!htmlFiles.length) {
      alert('Por favor selecciona archivos HTML válidos');
      e.target.value = '';
      return;
    }

    if (ignoredFiles.length) {
      alert(`Se ignoraron archivos no compatibles: ${ignoredFiles.map(f => f.name).join(', ')}`);
    }

    const existingTopicIds = new Set(pages.map(p => p.dataset.topicId).filter(Boolean));

    try {
      for (const file of htmlFiles) {
        await importHtmlFile(file, existingTopicIds);
      }

      pages = [...document.querySelectorAll('.page')];
      pages.forEach(p => {
        afterContentSanitize(p);
        if (!p.dataset.topicId) {
          p.dataset.topicId = 'topic-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        io.observe(p);
      });

      setupMagicIcons();
      initializeSections();
      buildSectionsPanel();
      buildTableOfContents();

      if (isEditMode) {
        pages.forEach(page => page.contentEditable = 'true');
        enableHtmlPaste();
      }

      const btn = loadHtmlBtn;
      if (btn) {
        const oldText = btn.innerHTML;
        btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Cargado</span>';
        setTimeout(() => btn.innerHTML = oldText, 2000);
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (error) {
      console.error('Error al cargar el archivo:', error);
      alert('Error al cargar archivos: ' + error.message);
    } finally {
      e.target.value = '';
    }
  });

  /* === COPIAR HTML === */
  document.getElementById('copyHtmlBtn')?.addEventListener('click', async () => {
    const doctype = '<!DOCTYPE html>\n';
    const html = doctype + document.documentElement.outerHTML;
    try {
      await navigator.clipboard.writeText(html);
      const btn = document.getElementById('copyHtmlBtn');
      const old = btn.innerHTML;
      btn.innerHTML = '<span>✅</span> <span class="topbar-btn-label">Copiado</span>';
      setTimeout(() => btn.innerHTML = old, 1500);
    } catch (e) {
      alert('No se pudo copiar el HTML');
    }
  });

  cacheSaveBtn?.addEventListener('click', () => saveToLocalCache(true));

  window.addEventListener('beforeunload', () => saveToLocalCache(false));

  const restoredFromCache = restoreFromLocalCache();
  if (!restoredFromCache) {
    buildSectionsPanel();
    buildTableOfContents();
    applyZoom(currentZoom);
  }

})();
  </script>
</body>
</html>
